# 有效集法 - 知乎
# 

*本文献给那些使用有效集法解决实际问题**，**但又想了解算法背后的工作原理或设计想法的人，例如量化投资领域组合优化器的开发人员。需要读者对等式约束优化、线性规划和不等式约束优化问题的KKT条件有初步了解。有效集法分原始~、对偶~和原-对偶~三种版本，本文只讨论原始有效集法。它是一种迭代算法。在原始有效集法中，所有的迭代点均为原始问题的可行解。算法从一个初始可行解开始，按照明确地规则迭代，并且必将在有限步内停止（严格证明请参见附录2中的最佳参考书），即得到最优解。*

*有效集算法的代数描述（参见附录1）非常复杂，但其背后的几何含义十分清楚。相信该算法的发明者最初也是先有了几何想法，然后才用代数语言严格化的。然而，国内大多数最优化理论教材只给出了有效集法的代数描述，却略去了几何想法的介绍。因此，本文着重补充该算法的几何想法（不太严格但更加直观），帮助读者更好地理解、使用、甚至改进该算法。*

## **带不等式约束的二次规划问题**

**一般形式：**

> ![min_x \quad \frac{1}{2}x^TGx+ d^Tx](https://www.zhihu.com/equation?tex=min_x+%5Cquad+%5Cfrac%7B1%7D%7B2%7Dx%5ETGx%2B+d%5ETx)![s.t. \quad a_i^Tx=b_i, i\in E](https://www.zhihu.com/equation?tex=s.t.+%5Cquad+a_i%5ETx%3Db_i%2C+i%5Cin+E)![\quad\quad\quad a_i^Tx\geq b_i, i\in I](https://www.zhihu.com/equation?tex=%5Cquad%5Cquad%5Cquad+a_i%5ETx%5Cgeq+b_i%2C+i%5Cin+I)

其中 ![x](https://www.zhihu.com/equation?tex=x) 是Nx1列向量； ![G](https://www.zhihu.com/equation?tex=G) 为NxN正定矩阵； ![d](https://www.zhihu.com/equation?tex=d) 为Nx1列向量； ![a_i](https://www.zhihu.com/equation?tex=a_i) 是第i个约束条件左端的系数向量（Nx1）， ![b_i](https://www.zhihu.com/equation?tex=b_i) 是相应约束条件右端的常数； ![E](https://www.zhihu.com/equation?tex=E) 是等式约束对应的下标集合， ![I](https://www.zhihu.com/equation?tex=I) 是不等式约束对应的下标集合。注意：由于约束条件均为线性的，因此可行域与线性规划问题完全一样，只是目标函数不同。

**应用领域：**带不等式约束的二次规划问题是量化投资中开发组合优化器所面临的主要问题。其形式可以表现为：给定一组股票各自的预期收益率、预期波动率以及两两之间的相关性，寻找这组股票上的最优资金分配权重，以使投资组合整体在其预期收益率满足要求水平（例如不低于年化6%）并且持仓分布满足各项合规和风险管理要求的条件下，达到整体预期波动率最低的状态。其它领域的应用应该也有不少，不再赘述。

**问题的几何表述：**
- **可行域：**参考线性规划问题，我们知道目标问题的可行域是 ![R^N](https://www.zhihu.com/equation?tex=R%5EN) 空间中的一个凸多面体（包括边界和内部）。例如下图中的绿色多边形区域。
- **等值面：**由于矩阵G正定，所以目标函数的等值面是 ![R^N](https://www.zhihu.com/equation?tex=R%5EN) 空间中的一族同心超椭球面，所有椭球面相似且同向（各轴同向重合）。例如下图中的同心椭圆曲线族。越内层的椭球面，目标函数在其上的取值越优（低）。
- **优化问题：**在几何表述下，我们的目标就是在可行域内找到达到同心椭圆曲线族最内层的点。例如下图中，P是无约束最优解，Q是约束最优解。
![](https://pic4.zhimg.com/v2-d8f0a9436e5c98029329819afb312c97_b.jpg)

## **求解问题的有效集法**

有效集法（Active Set Method）是求解带不等式约束的二次规划问题的一种经典算法**。**它的代数描述相当复杂（参见附录1）。第一次读到这个算法时，难免心中存疑：在面对带不等式约束的二次规划问题时，是什么样的心路历程引导前辈大师们创造出这样一个复杂的算法？事实上，复杂的有效集算法背后是一条几何意义十分清晰的搜索最优解的策略，想法非常自然。下面我们就来从头说起。

**有效集概念的提出**

当面对带不等式约束的二次规划问题时，由于等式约束问题早已破解，所以很自然地想到，要想办法把不等式约束问题转化为等式约束问题。于是就有了有效集的概念
- **有效集：**任给一个可行解，其有效集就是等号成立的所有约束条件的下标集合。显然，有效集必然包含所有等式约束，同时包含不等式约束的一个子集。
- **最优有效集：**最优解的有效集称为最优有效集**。**如果能事先得知最优有效集，那么问题迎刃而解。事实上，只需把最优有效集中的约束全部改写为等式约束，并扔掉其它约束，然后用Lagrange乘子法直接求解即可（因为这是一个仅有等式约束的优化问题）。不幸的是，我们无法事先得知最优有效集。

那么剩下的问题就是如何寻找最优有效集了。稍微思考一下你就会注意到，由于约束条件数目是有限的，而最优有效集是其子集，进而最优有效集只有有限多种可能。于是很自然地就想到了下面大名鼎鼎的暴力破解法——穷举法。

**穷举法**

每次，我们从全体约束中选出一个子集（包含全部等式约束和部分不等式约束），称之为本次尝试的**工作集**。然后假设该工作集就是最优有效集，并求解该**工作集对应的子优化问题。**一个工作集对应的子优化问题是这样定义的：在原问题中，将工作集中的约束全部改为等式约束，同时扔掉工作集之外的约束。由于这是一个等式约束问题，所以可以用Lagrange法轻松求解。之后检查该解是否是原问题的可行解（即它是否也满足工作集之外的约束）。如果是，则记录下来，否则就扔掉。遍历全部可能的子集之后，在记录下来的所有解中，选一个使目标函数值最优的即可。

> 工作集的几何意义：工作集是一组等式约束，因此对应于原始可行域多面体的一个面或一条低维棱，而不再包含多面体的内部区域。读者只需考虑三维空间中凸多面体的面或棱即可帮助理解。

上述穷举法虽然已经可以确保在有限步内获得目标问题的解，但其运算量常常超乎想象（尤其是控制标量和不等式约束条件个数较多时），所以我们在以下两方面寻求改进：
- **改进最优解的识别方式：**利用凸二次规划的特点，建立一组识别规则（实际上就是KKT条件），可直接判断一个可行解是否是最优解，因此算法一旦试出最优解就立即停止，不必遍历剩余可能性
- **改进尝试各种可能性的顺序：**不再随机选取下一次尝试的工作集，而是通过求解子优化问题找到能使目标函数值有效下降的新工作集和迭代点。

经过以上两项改进，就形成了效率大幅提高的有效集法。

**有效集法**
- **初始可行解：**有效集法需要一个初始可行解 ![x_0](https://www.zhihu.com/equation?tex=x_0) 作为迭代的起点。由于可行解与目标函数无关，所以获得初始可行解的方法与线性规划完全一致，典型方法有两阶段法和大M法，这完全是线性规划的内容，请参考线性规划的教材，这里不做赘述，因此我们假设已经获得一个初始可行解 ![x_0](https://www.zhihu.com/equation?tex=x_0)，并取其有效集为当前工作集 ![W_0](https://www.zhihu.com/equation?tex=W_0)
- **迭代：**迭代第k步后（k=0,1,2, ...），记我们得到的迭代点为 ![x_k](https://www.zhihu.com/equation?tex=x_k) ，工作集为 ![W_k](https://www.zhihu.com/equation?tex=W_k) 。根据 ![x_k](https://www.zhihu.com/equation?tex=x_k) 落在可行域（前图中多边形）上的位置，我们划分出以下四种情形。当遇到情形1时，算法停止， ![x_k](https://www.zhihu.com/equation?tex=x_k) 就是原始问题的最优解；当遇到情形2-4时，算法将按照相应规则产生下一个迭代点 ![x_{k+1}](https://www.zhihu.com/equation?tex=x_%7Bk%2B1%7D) （使目标函数值下降）和下一个工作集 ![W_{k+1}](https://www.zhihu.com/equation?tex=W_%7Bk%2B1%7D)
- **情形1：** 若 ![x_k](https://www.zhihu.com/equation?tex=x_k) 满足KKT条件，则它就是最优解，算法停止。关于不等式约束优化问题的KKT条件本身就具有清晰的几何意义，本专栏后续会单独写一篇文章介绍。此处只要明白KKT条件使我们能够直接判定当前迭代点是否是最优解，而无需像穷举法中需要算出所有可能的可行解处的函数值，才能通过全局比较判定谁是最优解，因而可能大幅降低我们的搜索工作量。情形1的例子请参见下图中 ![x_5](https://www.zhihu.com/equation?tex=x_5)
- **情形2：**若 ![x_k](https://www.zhihu.com/equation?tex=x_k) 在当前工作集（等式约束集）下已达最优，但工作集中存在至少一个约束，它原来是不等式约束，而且当 ![x_k](https://www.zhihu.com/equation?tex=x_k) 朝该不等式约束的可行一侧移动时，可以使目标函数值进一步下降，那么我们令迭代点不动（即 ![x_{k+1}=x_k](https://www.zhihu.com/equation?tex=x_%7Bk%2B1%7D%3Dx_k) ），并从工作集中去掉那个约束（即将它还原放松成不等式约束）。情形2的例子请参见下图中 ![x_0](https://www.zhihu.com/equation?tex=x_0) 和 ![x_2](https://www.zhihu.com/equation?tex=x_2)
- **情形3：**若 ![x_k](https://www.zhihu.com/equation?tex=x_k) 在当前工作集（等式约束集）下还可以改进，但步长不能走满（否则会走出原始问题的可行域），那么就取 ![x_k](https://www.zhihu.com/equation?tex=x_k) 延改进方向恰走到原始可行域边界处的位置为下一个迭代点 ![x_{k+1}](https://www.zhihu.com/equation?tex=x_%7Bk%2B1%7D) ，同时把碰到的边界处对应的不等式约束加入工作集。情形3的例子请参见下图中 ![x_3](https://www.zhihu.com/equation?tex=x_3)
- **情形4：**若 ![x_k](https://www.zhihu.com/equation?tex=x_k) 在当前工作集（等式约束集）下还可以改进，并且步长能够走满（即改进到最优仍未出原始可行域），那么就取这个最优点作为下一个迭代点 ![x_{k+1}](https://www.zhihu.com/equation?tex=x_%7Bk%2B1%7D) ，并保持工作集不变。情形4的例子请参见下图中 ![x_1](https://www.zhihu.com/equation?tex=x_1) 和 ![x_4](https://www.zhihu.com/equation?tex=x_4)

如果你仔细理解上面四种情形对应的几何含义（建议动手画一下），就会发现，其实这是再自然不过的搜索策略了。所以给你一定的时间，也能够空手推演出来。

**包含各种迭代情形的有效集法完整算例**

以下算例摘自附录2中的最佳参考书《Numerical Optimization（数值最优化）》，其迭代完美地遇到上节提到的全部四种情形。

**优化问题：**下图中下方五边形是可行域，虚线同心圆是等值线。

**迭代过程：**初始可行解是 ![x_0](https://www.zhihu.com/equation?tex=x_0) ，初始工作集是在 ![x_0](https://www.zhihu.com/equation?tex=x_0) 处相交的两条边所在直线。算法经过5步迭代找到最优解 ![x_5](https://www.zhihu.com/equation?tex=x_5) （为了与控制标量区分，本例中迭代点的序号改为上标）。每步迭代对应的情形：k=0，情形2；k=1，情形4；k=2，情形2；k=3，情形3；k=4，情形4；k=5，情形
![](https://pic4.zhimg.com/v2-02e81fbddf51b39cc1f839a2eced6ea7_b.jpg)

## **附录1：有效集法的代数描述**

在有效集法中，我们考虑一系列工作集 ![W_k](https://www.zhihu.com/equation?tex=W_k) ，它们是按一定规则选取的部分约束条件对应下标的集合。每个工作集都包含所有的等式约束，同时也包含一部分不等式约束。对每个 ![W_k](https://www.zhihu.com/equation?tex=W_k) ，我们都可以定义一个子优化问题如下：

> ![min_p\quad\frac{1}{2}p^TGp+g_k^Tp](https://www.zhihu.com/equation?tex=min_p%5Cquad%5Cfrac%7B1%7D%7B2%7Dp%5ETGp%2Bg_k%5ETp)![s.t\quad a_i^Tp=0, \quad i\in W_k](https://www.zhihu.com/equation?tex=s.t%5Cquad+a_i%5ETp%3D0%2C+%5Cquad+i%5Cin+W_k)
其中
![g_k=Gx_k+d](https://www.zhihu.com/equation?tex=g_k%3DGx_k%2Bd)

注意到这个子优化问题只有等式约束，所以可以用Lagrange乘子法直接求解，记这个最优解为 ![p_k](https://www.zhihu.com/equation?tex=p_k)。

有了上述定义，我们就可以给出完整的有效集算法。算法从一个初始可行解 ![x_0](https://www.zhihu.com/equation?tex=x_0) 开始，按照一定规则逐步迭代，迭代中的每一个 ![x_k](https://www.zhihu.com/equation?tex=x_k) 都是原问题的可行解。
![](https://pic2.zhimg.com/v2-1db7153ecc5729dcc4d7db338b3cc099_b.jpg)

## **附录2：有效集法的最佳参考书**

在笔者查阅过的参考书中，关于有效集法的最佳介绍，是Jorge Nocedal和Stephen J.Wright的著作《Numerical Optimization（数值最优化）》的第16章“Quadratic Programming”。本文内容主要节选自该书，但聚焦于有效集法的几何想法。

