# 多项式与两类斯特林数的快速计算 - 知乎
# 

## **问题简述**

> 对于所有的 ![0\le i\le n](https://www.zhihu.com/equation?tex=0%5Cle+i%5Cle+n) ,计算![\begin{Bmatrix}n\\i\end{Bmatrix} ](https://www.zhihu.com/equation?tex=%5Cbegin%7BBmatrix%7Dn%5C%5Ci%5Cend%7BBmatrix%7D+)以及 ![\begin{bmatrix}n\\i\end{bmatrix}](https://www.zhihu.com/equation?tex=%5Cbegin%7Bbmatrix%7Dn%5C%5Ci%5Cend%7Bbmatrix%7D) 。 ![(n\le 5 \cdot 10^5)](https://www.zhihu.com/equation?tex=%28n%5Cle+5+%5Ccdot+10%5E5%29)

很多时候我们会遇到需要快速求出某一整行的斯特林数（例如幂-上升下降幂的转换以及斯特林反演）。考虑到斯特林数并没有一个简洁可计算的通项公式，朴素算法时间复杂度 ![O(n^2)](https://www.zhihu.com/equation?tex=O%28n%5E2%29)，显然无法接受。

**第二类斯特林数的优化**

首先考虑优化更加常用的第二类斯特林数 ![\begin{Bmatrix}n\\i\end{Bmatrix}](https://www.zhihu.com/equation?tex=%5Cbegin%7BBmatrix%7Dn%5C%5Ci%5Cend%7BBmatrix%7D)（子集斯特林数）。首先我们利用组合数学以及容斥原理，得出下面的式子：

![\begin{Bmatrix}n\\k\end{Bmatrix}=\frac{1}{k!}\sum_{i=0}^k(-1)^k\binom ki(k-i)^n\\](https://www.zhihu.com/equation?tex=%5Cbegin%7BBmatrix%7Dn%5C%5Ck%5Cend%7BBmatrix%7D%3D%5Cfrac%7B1%7D%7Bk%21%7D%5Csum_%7Bi%3D0%7D%5Ek%28-1%29%5Ek%5Cbinom+ki%28k-i%29%5En%5C%5C)

其中 ![i](https://www.zhihu.com/equation?tex=i) 是枚举的空集个数， ![(k-1)^n](https://www.zhihu.com/equation?tex=%28k-1%29%5En)是![n](https://www.zhihu.com/equation?tex=n) 个数放进剩下 ![k-i](https://www.zhihu.com/equation?tex=k-i) 个集合中的方案数，因为集合无序，所以最后需要乘上 ![\frac{1}{k!}](https://www.zhihu.com/equation?tex=%5Cfrac%7B1%7D%7Bk%21%7D) 。

把二项式展开，得到：

![\begin{align} \begin{Bmatrix}n\\k\end{Bmatrix}&=\frac{1}{k!}\sum_{i=0}^k(-1)^i\frac{k!}{i!(k-i)!}(k-i)^n\\ &=\sum_{i=0}^k\frac{(-1)^k}{i!}\frac{(k-i)^n}{(k-i)!}\\ \end{align}\\](https://www.zhihu.com/equation?tex=%5Cbegin%7Balign%7D+%5Cbegin%7BBmatrix%7Dn%5C%5Ck%5Cend%7BBmatrix%7D%26%3D%5Cfrac%7B1%7D%7Bk%21%7D%5Csum_%7Bi%3D0%7D%5Ek%28-1%29%5Ei%5Cfrac%7Bk%21%7D%7Bi%21%28k-i%29%21%7D%28k-i%29%5En%5C%5C+%26%3D%5Csum_%7Bi%3D0%7D%5Ek%5Cfrac%7B%28-1%29%5Ek%7D%7Bi%21%7D%5Cfrac%7B%28k-i%29%5En%7D%7B%28k-i%29%21%7D%5C%5C+%5Cend%7Balign%7D%5C%5C)

这是个卷积的形式，可以利用FFT在 ![O(nlogn)](https://www.zhihu.com/equation?tex=O%28nlogn%29) 的时间内算。

（ 令![A(x)=\sum_{i=0}^n\frac{(-1)^i}{i!}x^i,B(x)=\sum_{i=0}^n\frac{i^n}{i!}x^i](https://www.zhihu.com/equation?tex=A%28x%29%3D%5Csum_%7Bi%3D0%7D%5En%5Cfrac%7B%28-1%29%5Ei%7D%7Bi%21%7Dx%5Ei%2CB%28x%29%3D%5Csum_%7Bi%3D0%7D%5En%5Cfrac%7Bi%5En%7D%7Bi%21%7Dx%5Ei) ，则 ![\begin{Bmatrix}n\\k\end{Bmatrix}=[x^k]A(x)B(x)](https://www.zhihu.com/equation?tex=%5Cbegin%7BBmatrix%7Dn%5C%5Ck%5Cend%7BBmatrix%7D%3D%5Bx%5Ek%5DA%28x%29B%28x%29) ）

## **第一类斯特林数的优化**

接下来是第一类斯特林数 ![\begin{bmatrix}n\\k\end{bmatrix}](https://www.zhihu.com/equation?tex=%5Cbegin%7Bbmatrix%7Dn%5C%5Ck%5Cend%7Bbmatrix%7D) （轮换斯特林数）的优化。

设生成函数 ![E_n(x)=\sum_{i=0}^n\begin{bmatrix}n\\i\end{bmatrix}x^i](https://www.zhihu.com/equation?tex=E_n%28x%29%3D%5Csum_%7Bi%3D0%7D%5En%5Cbegin%7Bbmatrix%7Dn%5C%5Ci%5Cend%7Bbmatrix%7Dx%5Ei) ，它同时也可以写成如下形式：

![E_n(x)=\prod_{i=0}^{n-1}(x+i)\\](https://www.zhihu.com/equation?tex=E_n%28x%29%3D%5Cprod_%7Bi%3D0%7D%5E%7Bn-1%7D%28x%2Bi%29%5C%5C)

该式可以由归纳法证明：

设初始条件为 ![n=1](https://www.zhihu.com/equation?tex=n%3D1) ，此时 ![E_1(x)=x](https://www.zhihu.com/equation?tex=E_1%28x%29%3Dx) ，显然成立。

当 ![n\gt1](https://www.zhihu.com/equation?tex=n%5Cgt1) 时，由轮换斯特林数的递推公式：

![\begin{bmatrix}n\\k\end{bmatrix}=(n-1)\begin{bmatrix}n-1\\k\end{bmatrix}+\begin{bmatrix}n-1\\k-1\end{bmatrix}\\](https://www.zhihu.com/equation?tex=%5Cbegin%7Bbmatrix%7Dn%5C%5Ck%5Cend%7Bbmatrix%7D%3D%28n-1%29%5Cbegin%7Bbmatrix%7Dn-1%5C%5Ck%5Cend%7Bbmatrix%7D%2B%5Cbegin%7Bbmatrix%7Dn-1%5C%5Ck-1%5Cend%7Bbmatrix%7D%5C%5C)可得：![\begin{align} E_n(x)&=xE_{n-1}(x)+(n-1)E_{n-1}(x)\\ &=x\prod_{i=0}^{n-2}(x+i)+(n-1)\prod_{i=0}^{n-2}(x+i)\\ &=(x+n-1)\prod_{i=0}^{n-2}(x+i)\\ &=\prod_{i=0}^{n-1}(x+i) \end{align}\\](https://www.zhihu.com/equation?tex=%5Cbegin%7Balign%7D+E_n%28x%29%26%3DxE_%7Bn-1%7D%28x%29%2B%28n-1%29E_%7Bn-1%7D%28x%29%5C%5C+%26%3Dx%5Cprod_%7Bi%3D0%7D%5E%7Bn-2%7D%28x%2Bi%29%2B%28n-1%29%5Cprod_%7Bi%3D0%7D%5E%7Bn-2%7D%28x%2Bi%29%5C%5C+%26%3D%28x%2Bn-1%29%5Cprod_%7Bi%3D0%7D%5E%7Bn-2%7D%28x%2Bi%29%5C%5C+%26%3D%5Cprod_%7Bi%3D0%7D%5E%7Bn-1%7D%28x%2Bi%29+%5Cend%7Balign%7D%5C%5C)

故原式成立。

设 ![P_n(x)=\prod_{i=0}^{\lceil \frac{n-}{2} \rceil}(x+i),Q_n(x)=\prod_{i=\lceil \frac{n-1}{2} \rceil+1}^{n-1}(x+i)](https://www.zhihu.com/equation?tex=P_n%28x%29%3D%5Cprod_%7Bi%3D0%7D%5E%7B%5Clceil+%5Cfrac%7Bn-%7D%7B2%7D+%5Crceil%7D%28x%2Bi%29%2CQ_n%28x%29%3D%5Cprod_%7Bi%3D%5Clceil+%5Cfrac%7Bn-1%7D%7B2%7D+%5Crceil%2B1%7D%5E%7Bn-1%7D%28x%2Bi%29) ,则 ![E_n(x)=P(x)Q(x)](https://www.zhihu.com/equation?tex=E_n%28x%29%3DP%28x%29Q%28x%29) ,

可以利用分治+FFT在 ![O(nlog^2n)](https://www.zhihu.com/equation?tex=O%28nlog%5E2n%29) 内出解。

考虑进一步优化，我们先假设 ![n](https://www.zhihu.com/equation?tex=n) 是偶数，那么：

![\begin{align} E_n(x)&=\Big(\prod_{i=0}^{\frac{n}{2}-1}(x+i)\Big)\Big(\prod_{i=0}^{\frac{n}{2}-1}(x+i+\frac{n}{2})\Big)\\ &=E_{\frac{n}{2}}(x)E_{\frac{n}{2}}(x+\frac{n}{2}) \end{align}\\](https://www.zhihu.com/equation?tex=%5Cbegin%7Balign%7D+E_n%28x%29%26%3D%5CBig%28%5Cprod_%7Bi%3D0%7D%5E%7B%5Cfrac%7Bn%7D%7B2%7D-1%7D%28x%2Bi%29%5CBig%29%5CBig%28%5Cprod_%7Bi%3D0%7D%5E%7B%5Cfrac%7Bn%7D%7B2%7D-1%7D%28x%2Bi%2B%5Cfrac%7Bn%7D%7B2%7D%29%5CBig%29%5C%5C+%26%3DE_%7B%5Cfrac%7Bn%7D%7B2%7D%7D%28x%29E_%7B%5Cfrac%7Bn%7D%7B2%7D%7D%28x%2B%5Cfrac%7Bn%7D%7B2%7D%29+%5Cend%7Balign%7D%5C%5C)

若 ![n ](https://www.zhihu.com/equation?tex=n+) 为奇数，则：

![E_n(x)=(x+n-1)E_{n-1}(x)\\](https://www.zhihu.com/equation?tex=E_n%28x%29%3D%28x%2Bn-1%29E_%7Bn-1%7D%28x%29%5C%5C)

 综上，我们得到如下的递归策略：

![E_n(x)=\begin{cases} E_{\frac{n}{2}}(x)E_{\frac{n}{2}}(x+\frac{n}{2})&n为偶数\\(x+n-1)E_{n-1}(x)&n为奇数 \end{cases}\\](https://www.zhihu.com/equation?tex=E_n%28x%29%3D%5Cbegin%7Bcases%7D+E_%7B%5Cfrac%7Bn%7D%7B2%7D%7D%28x%29E_%7B%5Cfrac%7Bn%7D%7B2%7D%7D%28x%2B%5Cfrac%7Bn%7D%7B2%7D%29%26n%E4%B8%BA%E5%81%B6%E6%95%B0%5C%5C%28x%2Bn-1%29E_%7Bn-1%7D%28x%29%26n%E4%B8%BA%E5%A5%87%E6%95%B0+%5Cend%7Bcases%7D%5C%5C)

时间复杂度满足 ![T(n)=T(n/2)+O(nlogn)](https://www.zhihu.com/equation?tex=T%28n%29%3DT%28n%2F2%29%2BO%28nlogn%29) ，计算得时间复杂度为 ![O(nlogn)](https://www.zhihu.com/equation?tex=O%28nlogn%29) 。

- 封面图源见水印

