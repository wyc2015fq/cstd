# Linux操作系统下 NAND FLASH驱动程序框架 - TaigaComplex求职中 - 博客园







# [Linux操作系统下 NAND FLASH驱动程序框架](https://www.cnblogs.com/TaigaCon/archive/2012/11/17/2775057.html)





当我们需要在操作系统上读写普通文件的时候，总是需要一层层往下，最终到达硬件相关操作，当然底层设备大多数都是块设备

NAND FLASH就作为一个最底层的块设备。

而我们写驱动，就是要构建硬件与操作系统之间的联系，因此我们需要知道nand flash在Linux操作系统下的框架。

框架如下：

![](https://pic002.cnblogs.com/images/2012/421096/2012111717145542.jpg)



1.即使nand flash是一个块设备，它也能作为一个字符设备使用，因为说到底，也只是从寄存器内部读取值而已。

2.对于不同的文件系统，会有不同的文件组织形式。

3.由于块设备的硬件操作繁琐，就像nand flash的读写操作就需要发送地址跟命令后才能读写数据，又比如磁盘的读写就需要选择磁头，寻道，这就花费了大量读写无关的时间

　　为了最大限度发挥读写性能，就需要用算法进行读写分类，排序等

4.nand flash协议层也是linux提供的，该成集成了nand flash共性的操作，并且向上提供操作函数

5.nand flash协议层缺少硬件的实际信息，如某些寄存器的地址，它并不清楚，因此某些参数以及nand flash协议层没有实现的函数需要硬件操作层向上提供



我们写nand flash驱动就是写的硬件相关操作层

块设备驱动编写流程如下：



![](https://pic002.cnblogs.com/images/2012/421096/2012111722504547.jpg)









当读写文件请求到来的时候，流程如下

1.通过vfs进入文件系统，

2.文件系统把文件读写转换为块设备读写，其中有运用算法对读写操作进行合并，排序等，最后把块设备读写放进队列

3.循环从队列中取出读写要求，然后用处理函数（blk_init_queue设置）进行处理。**这个函数就是连接上层（IO调度）跟底层（硬件操作）的桥梁，当我们调用add_mtd_partitions的时候，就建立了上下层的联系。**

4.对不同的处理要求，调用不同的nand的底层处理函数












