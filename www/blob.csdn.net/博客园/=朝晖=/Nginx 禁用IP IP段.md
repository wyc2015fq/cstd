# Nginx 禁用IP IP段 - =朝晖= - 博客园
# [Nginx 禁用IP IP段](https://www.cnblogs.com/dhcn/p/9967937.html)
http://www.cnblogs.com/apanly/p/5568716.html
最近公司网站被竞争对手用爬虫频繁访问，所以我们这边要禁止这些爬虫访问，我们通过nginx 指令就可以实现了
方法一：直接在LB机器上封IP
1.在 blocksip.conf 文件中加入要屏蔽的ip或者ip端
```
```bash
$
```
```bash
sudo
```
```bash
vim
```
```bash
/etc/nginx/blocksip
```
```bash
.conf
```
```bash
deny 180.168.74.26;
```
```bash
deny 91.212.45.0
```
```bash
/24
```
```bash
;
```
```
2. 在nginx.conf中包含这个文件
```
```bash
$
```
```bash
sudo
```
```bash
vim
```
```bash
/etc/nginx/nginx
```
```bash
.conf
```
```bash
http {
```
```bash
.......
```
```bash
.......
```
```bash
include
```
```bash
/etc/nginx/blocksip
```
```bash
.conf;
```
```bash
}
```
```
3.重启服务
```
```bash
$
```
```bash
sudo
```
```bash
/etc/init
```
```bash
.d
```
```bash
/nginx
```
```bash
reload
```
```
方法二：直接在APP业务机器上操作（有时候LB并不能直接操作）
这个时候我们不能通过$remote_addr获取ip，因为经过LB过来，需要同$http_x_forwarded_for获取，使用nginx map指令
1.通过map指令设置 变量
```
```bash
$
```
```bash
sudo
```
```bash
vim
```
```bash
/etc/nginx/nginx
```
```bash
.conf
```
```bash
http{
```
```bash
.......
```
```bash
.......
```
```bash
```
```bash
map $http_x_forwarded_for $ip_allowed {
```
```bash
```
```bash
default allow;
```
```bash
```
```bash
~\s*192.168.22.*$ deny;
```
```bash
```
```bash
~\s*192.168.21.11$ deny;
```
```bash
```
```bash
}
```
```bash
}
```
```
2.在vhost 的server 配置中 通过$ip_allowed变量判断
```
```bash
server{
```
```bash
........
```
```bash
........
```
```bash
```
```bash
if
```
```bash
( $ip_allowed =
```
```bash
"deny"
```
```bash
) {
```
```bash
```
```bash
return
```
```bash
403;
```
```bash
```
```bash
}
```
```bash
}
```
```
3.重启服务
```
```bash
sudo
```
```bash
/etc/init
```
```bash
.d
```
```bash
/nginx
```
```bash
reload
```
```

