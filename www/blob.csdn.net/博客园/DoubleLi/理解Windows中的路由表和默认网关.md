# 理解Windows中的路由表和默认网关 - DoubleLi - 博客园






每一个Windows系统中都具有**IP路由表**，它存储了本地计算机可以到达的网络目的地址范围和如何到达的路由信息。路由表是TCP/IP通信的基础，本地计算机上的任何TCP/IP通信都受到路由表的控制。

**理解路由表**

你可以运行 route print 或 netstat -r 显示本地计算机上的路由表，如下图所示：

C:/Documents and Settings/administrator>**route print**

=========================================================================== 
Interface List 
0x1 ........................... MS TCP Loopback interface 
0x10003 ...00 50 8d 4f 5f c5 ...... Realtek RTL8139/810x Family Fast Ethernet NIC 
=========================================================================== 
=========================================================================== 
Active Routes:
||Network Destination|Netmask|Gateway|Interface|Metric|
|----|----|----|----|----|----|
|**1**|0.0.0.0|0.0.0.0|192.168.1.1|192.168.1.6|30|
|**2**|127.0.0.0|255.0.0.0|127.0.0.1|127.0.0.1|1|
|**3**|192.168.1.0|255.255.255.0|192.168.1.6|192.168.1.6|30|
|**4**|192.168.1.240|255.255.255.240|192.168.1.8|192.168.1.6|20|
|**5**|192.168.1.240|255.255.255.240|192.168.1.7|192.168.1.6|15|
|**6**|192.168.1.6|255.255.255.255|127.0.0.1|127.0.0.1|30|
|**7**|192.168.1.255|255.255.255.255|192.168.1.6|192.168.1.6|30|
|**8**|224.0.0.0|240.0.0.0|192.168.1.6|192.168.1.6|30|
|**9**|255.255.255.255|255.255.255.255|192.168.1.6|192.168.1.6|1|



Default Gateway: 192.168.1.1 
=========================================================================== 
Persistent Routes: 
None 


路由表中的每一个路由项具有五个属性，在此我将它们分为四个部分：

1、**网络地址**（**Network Destination**）、**网络掩码**（**Netmask**）：网络地址和网络掩码相与的结果用于定义本地计算机可以到达的网络目的地址范围。通常情况下，网络目的地址范围包含以下四种：
- 
主机地址；某个特定主机的网络地址，网络掩码为255.255.255.255，如上表中的6、7、9；

- 
子网地址，某个特定子网的网络地址，如上表中的4、5；

- 
网络地址；某个特定网络的网络地址，如上表中的2、3、8；

- 
默认路由；所有未在路由表中指定的网络地址，如上表中的1，在后文将详细描述；


在添加路由时，**Windows要求输入的网络地址和网络掩码相与后的结果必须等于网络地址**，否则路由添加会失败。

2、**网关**（**Gateway**，又称为**下一跳服务器**）：在发送IP数据包时，网关定义了针对特定的网络目的地址，数据包发送到的下一跳服务器。如果是本地计算机直接连接到的网络，网关通常是本地计算机对应的网络接口，**但是此时接口必须和网关一致**；如果是远程网络或默认路由，网关通常是本地计算机所连接到的网络上的某个服务器或路由器。

3、**接口**（**Interface**）：接口定义了针对特定的网络目的地址，本地计算机用于发送数据包的网络接口。**网关必须位于和接口相同的子网（默认网关除外）**，否则造成在使用此路由项时需调用其他路由项，从而可能会导致路由死锁。

4、**跃点数**（**Metric**）：跃点数用于指出路由的成本，通常情况下代表到达目标地址所需要经过的跃点数量，一个跃点代表经过一个路由器。跃点数越低，代表路由成本越低；跃点数越高，代表路由成本越高。当具有多条到达相同目的网络的路由项时，TCP/IP会选择具有更低跃点数的路由项。

**路由确定过程**

当TCP/IP需要向某个IP地址发起通信时，它会对路由表进行评估，以确定如何发送数据包。评估过程如下：
- 
TCP/IP使用需要通信的目的IP地址和路由表中每一个路由项的网络掩码进行相与计算，如果相与后的结果匹配对应路由项的网络地址，则记录下此路由项；

- 
当计算完路由表中所有的路由项后，TCP/IP选择记录下的路由项中的**最长匹配路由**（网络掩码中具有最多“**1**”位的路由项）来和此目的IP地址进行通信。如果存在多个最长匹配路由，那么选择具有**最低跃点数**的路由项；如果存在多个具有最低跃点数的最长匹配路由，那么：
- 
如果是发送响应数据包，并且数据包的源IP地址是某个最长匹配路由的接口的IP地址，那么选择此最长匹配路由；

- 
其他情况下均根据最长匹配路由所对应的网络接口在**网络连接**的**高级设置**中的绑定优先级来决定。


**网关和接口确定过程**

在确定使用的路由项后，网关和接口通过以下方式确定：

- 
如果路由项中的网关地址为空或者为本地计算机上的某个网络接口，那么在发送数据包时：
- 
通过路由项中对应的网络接口发送；

- 
源IP地址为此网络接口的IP地址；

- 
源MAC地址为此网络接口的MAC地址；

- 
目的IP地址为接收此数据包的目的主机的IP地址；

- 
目的MAC地址为接收此数据包的目的主机的MAC地址；


- 
如果路由项中的网关地址并不属于本地计算机上的任何网络接口，那么在发送数据包时：
- 
通过路由项中对应的网络接口发送；

- 
源IP地址为路由项中对应网络接口的IP地址；

- 
源MAC地址路由项中对应网络接口的MAC地址；

- 
目的IP地址为接收此数据包的目的主机的IP地址；

- 
目的MAC地址为网关的MAC地址；


- 

在此我以上面的路由表为基础，举例进行说明：

- 
和单播IP地址 192.168.1.8 的通信：在进行相与计算时，1、3 项匹配，但是3项为最长匹配路由，因此选择3项。3项的网关地址为本地计算机的网络接口192.168.1.6，因此发送数据包时，目的IP地址为 192.168.1.8、目的MAC地址为192.168.1.8的MAC地址（通过ARP解析获得）。

- 
和单播IP地址 192.168.1.6 的通信：在进行相与计算时，1、3、6 项匹配，但是6项为最长匹配路由，因此选择6项。6项的网关地址为本地环回地址127.0.0.1，因此直接将数据包发送至本地环回地址。

- 
和单播IP地址 192.168.1.245 的通信：在进行相与计算时，1、3、4、5 项匹配，但是4、5项均为最长匹配路由，所以此时根据跃点数进行选择，5 项具有更低的跃点数，因此选择5项；在发送数据包时，目的IP地址为192.168.1.254、目的MAC地址为192.168.1.7的MAC地址 （通过ARP解析获得）。

- 
和单播IP地址 10.1.1.1 的通信：在进行相与计算时，只有 1 项匹配；在发送数据包时，目的IP地址为10.1.1.1、目的MAC地址为192.168.1.1的MAC地址（通过ARP解析获得）。

- 
和子网广播地址 192.168.1.255 的通信：在进行相与计算时，1、3、4、5、7 项匹配，但是7项为最长匹配路由，因此选择7项。7项的网关地址为本地计算机的网络接口，因此在发送数据包时，目的IP地址为 192.168.1.255，目的MAC地址为以太网广播地址FF:FF:FF:FF:FF:FF。

**默认路由与默认网关**

由 于在路由表中存储针对每个主机或子网的路由项不可行，因此提出了默认路由的概念，默认路由中的网关称为默认网关。默认路由的网络地址为0.0.0.0，网 络掩码为0.0.0.0，它匹配任何网络通信，因此当到达特定主机或特定子网的路由并未在路由表中指定时，均可以通过默认路由来进行转发。如果没有设置默 认路由，那么无法到达未在路由表中指定路由项的网络目的地址。

设 置默认路由后，把数据包的路由责任移交到了路由器，优点是简化了本地计算机上的路由表和配置，缺点则是计算机无法明确目的地址是否可达，从而可能发送针对 不可到达地址的流量。虽然位于路由路径上的路由器知道目的地址不可达时会使用ICMP目的地址不可达信息来通知原始发送主机，但是这个过程中，已经占用了 额外的网络流量。

在Windows系统中，创建默认路由可以通过以下两种方式实现：

- 
在网络接口的TCP/IP选项中设置默认网关，从而创建默认路由；

- 
使用 route add 命令添加网络地址为0.0.0.0、网络掩码为0.0.0.0的默认路由；

- 
推荐大家总是使用前一种方式。













