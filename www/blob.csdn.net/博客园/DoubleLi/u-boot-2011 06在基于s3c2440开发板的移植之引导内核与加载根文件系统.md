# u-boot-2011.06在基于s3c2440开发板的移植之引导内核与加载根文件系统 - DoubleLi - 博客园






http://www.linuxidc.com/Linux/2012-09/70510.htm  来源：Linux社区  作者：赵春江 

uboot最主要的功能就是能够引导内核启动。本文就介绍如何实现该功能，并组成一个最简单的系统，这不仅要移植uboot，还要移植linux内核及创建一个根文件系统。

首先我们对nandflash进行分区，规划好每个文件存放在nandflash的位置。下面是nandflash的分区：

第0分区：0x000000000000-0x000000080000为uboot区

第1分区：0x000000080000-0x000000100000为参数区

第2分区：0x000000200000-0x000000600000为linux内核区

第3分区：0x000000800000-0x000001000000为根文件系统区

规划好分区后，我们就可以依次完成uboot的移植，linux内核的移植，及创建一个根文件系统。我们选择cramfs作为根文件系统。

一、uboot移植

1．修改机器码，要保证uboot与linux内核的机器码一致，这样才能启动内核。

修改board/samsung/zhaocj2440/zhaocj2440.c文件中的第116行内容，把SMDK2410改为SMDK2440，即：

       gd->bd->bi_arch_number =  MACH_TYPE_SMDK2440;

因为我们的uboot移植是以uboot自带的SMDK2440开发板为模板的，所以我们还是按照SMDK2440的机器码来移植，MACH_TYPE_SMDK2440的具体数值在arch/arm/include/asm/mach-types.h文件的第1013行已有定义：

#define  MACH_TYPE_SMDK2440             1008

2．添加bootcmd和bootargs参数。其中bootcmd是为了引导内核，而bootargs是为了在加载根文件系统时，给根文件系统传递必要的参数。

可以有两种方法来设置这两个参数：

第一种方法是在uboot的提示符下直接设置bootcmd和bootargs这两个参数：

ZHAOCJ2440 #  setenv bootcmd  ' nand  read 31000000  200000  400000; bootm 31000000 '

ZHAOCJ2440 #  setenv bootargs  ' root=/dev/mtdblock3  ro  noinitrd init=/linuxrc console=ttySAC , 115200  rootfstype=cramfs  mem=64M'

ZHAOCJ2440 #  saveenv

在这里bootcmd的含义是从nandflash中读取kernel，然后利用命令bootm启动。bootargs的含义是在nandflash中的第3个分区内存放着根文件系统，它的格式是cramfs。最后还要应用saveenv命令来保存这两个变量。这时，如果你在提示符下敲入printenv命令，则会看到uboot的环境参数多了两项，如：

bootargs=root=/dev/mtdblock3  ro  noinitrd  init=/linuxrc  console=ttySAC,115200 rootfstype=cramfs  mem=64M

bootcmd=nand  read  31000000 200000  400000 ; bootm  31000000

第二种方法是在include/configs/zhaocj2440.h内定义CONFIG_BOOTARGS和CONFIG_BOOTCOMMAND这两个宏定义：

#define  CONFIG_BOOTARGS " root=/dev/mtdblock3  ro  noinitrd  init=/linuxrc console=ttySAC , 115200  rootfstype=cramfs  mem=64M"

#define  CONFIG_BOOTCOMMAND  " nand  read  31000000 200000  400000 ; bootm 31000000"

3．把移植好的uboot烧写到nandflash中的0x00000000至0x000000080000内。

二、linux内核移植

这里我们实现的是最简单的移植，即能够启动即可。

1．在下列网址下载linux内核，linux-3.4.6.tar.bz2

[www.kernel.org/pub/linux/kernel/v3.x/](http://www.kernel.org/pub/linux/kernel/v3.x/)

解压到当前目录：

tar  -xvjf linux-3.4.6.tar.bz2

2．修改主目录下的Makefile文件，第195行和第196行改写为：

ARCH            ?=arm

CROSS_COMPILE       ?= arm-linux-

3．添加机器码，使uboot与linux机器码一致，并改变内核时钟

在arch/arm/tools/mach-types文件的第207行添加下列代码：

smdk2440              MACH_SMDK2440             SMDK2440           1008



在arch/arm/mach-s3c24xx/mach-smdk2440.c文件内

第165行中的16934400改为12000000，即

       s3c24xx_init_clocks(12000000);

第178行中的S3C2440改为SMDK2440，即

MACHINE_START(SMDK2440,"SMDK2440")



4．修改内核中的分区，使其与我们事先定义的分区一致

在arch/arm/mach-s3c24xx/common-smdk.c文件内

第111行中的smdk_default_nand_part结构体改为：

static  struct  mtd_partition smdk_default_nand_part[ ] = {

       [0]= {

              .name      = "UBoot",

              .size = SZ_512K,

              .offset     = 0,

       },

       [1]= {

              .name      = "Para",

              .offset= SZ_512K,

              .size = SZ_512K,

       },

       [2]= {

              .name      = "Kernel",

              .offset= SZ_2M,

              .size = SZ_4M,

       },

       [3]= {

              .name      = "rootfs",

              .offset     = SZ_8M,

              .size = SZ_8M,

       }

};



5．改变内核的ECC类型

在drivers/mtd/nand/s3c2410.c文件内

第846行中的NAND_ECC_SOFT改为NAND_ECC_NONE，即：

       chip->ecc.mode         = NAND_ECC_NONE;

此处如果不改，虽然能够启动linux内核，但无法加载根文件系统。

6．编译内核

退回到linux-3.4.6的根目录下，复制配置文件：

cp  arch/arm/configs/s3c2410_defconfig   .config

使用menuconfig来配置内核：

make  menuconfig

在KernelFeatures下选上两项内容，即

Kernel Features --->
                [*]Use the ARM EABI to compile the kernel
                [*]Allow old ABI binaries to run with this kernel (EXPERIMENTAL)

如果不选择这两项，则在内核启动完，挂载根文件系统时会出现kernel panic:attempted to kill init的错误。

menuconfig的其他内容可以不需要改变，选择默认即可。

最后执行下面两个命令：

make clean

make zImage

等待一段时间后，在arch/arm/boot/目录下会生成zImage文件。

7．制作内核镜像

在上一步虽然我们已经生成了zImage文件，但它还不能被uboot正确引导，我们还需要给zImage文件加上64个字节的数据头，这部分内容包括CPU架构（A）、操作系统（O）、镜像类型（T）、压缩类型（C）、镜像名称（n）、镜像加载地址（a）、镜像入口（e）、源文件（d）。只有加上这些内容uboot才能正确引导内核。

mkimage工具就是uboot用来制作完成上述内容的工具。编译过uboot后，会在tools目录下生成mkimage。为了更方便地应用该工具，我们需要完成下列操作，进入tools目录，以根用户的身份执行下列命令：

cp   mkimage  /usr/bin

chmod   777   /usr/bin/mkimage

进入linux-3.4.6目录下的arch/arm/boot/目录，执行下列命令：

mkimage  -n  'linux'  -A  arm  -O  linux  -T kernel  -C  none -a  0x31000000  -e 0x31000040  -d  zImage uImage.img

uImage.img为最终我们需要烧写到nandflash中的文件。在这里，我们是把镜像加载到内存0x31000000地址内的。

8．最后，我们把uImage.img文件烧写到nandflash中的0x200000至0x600000中。









