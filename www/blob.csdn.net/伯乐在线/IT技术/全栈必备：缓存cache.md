# 全栈必备：缓存cache - 文章 - 伯乐在线
本文作者： [伯乐在线](http://blog.jobbole.com) - [abel_cao](http://www.jobbole.com/members/abel9123) 。未经作者许可，禁止转载！
欢迎加入伯乐在线 [专栏作者](http://blog.jobbole.com/99322)。
> 
Cache： a collection of data duplicating original values stored elsewhere on a computer, usually for easier access—— 维基百科
缓存是系统快速响应中的一种关键技术，是一组被保存起来以备将来使用的东西，介于应用开发和系统开发之间，是产品经理们经常顾及不到的地方，算是技术架构中的非功能性约束吧。
也就是说，缓存是系统调优时常用且行之有效的手段，无论从操作系统还是应用系统，缓存策略无处不在。
很多技术都打着缓存的旗号，所以谈起缓存往往似是而非，与语境有着紧密的关系，换个说法，来看一看缓存在不同场景的分类。
### 客户端缓存
浏览器的缓存可以将之前渲染的页面保存为文件，当用户再次访问时可用避开网络连接，从而减少负载。现在的HTML5支持了本地存储，大部分BS 应用都可以举重若轻了。
如何把客户端缓存对于业务组件透明和客户端缓存数据及时更新，是客户端缓存能否成功应用的关键。
客户端可以将内容缓存在内存，文件，或本地数据库（例如Sqlite）中。
例如，iOS 的图片缓存框架SDWeb架构如下：
![SDweb](http://jbcdn2.b0.upaiyun.com/2016/11/26fd206085897ac4373ff881c0356b43.png)
### web代理
web 代理的作用跟浏览器的内置缓存类似，只是位于浏览器和互联网之间，网络请求通过代理来中继。对于企业而言，即可以节省成本，又能提高性能。
对于Web代理而言，曾经流行的是Squid，它支持建立复杂缓存层级结构的能力，详细的日志、高性能缓存以及用户认证支持。Squid同时支持各种插件，例如Squid Guard就是一个提供URL过滤的插件，对于屏蔽某些站点和内容十分有用。如果想分析Squid的各种指标，webalizer 应该是个不错的选择。
Squid 的内部机制如下：
![Squid](http://jbcdn2.b0.upaiyun.com/2016/11/be34bf5e8440e91c7c4a6fa1c8184842.png)
### 边缘缓存
边缘缓存位于应用服务器的前面，可以处理来自不同用户的请求，主要用于向用户提供静态的内容，以减少应用服务器的介入。边缘缓存的商业化服务就是CDN了，例如AWS 的Cloud Front，我国的ChinaCache等。
边缘缓存的一个有名的开源工具就是varnish，在默认情况下进行保守缓存。也就是说，varnish 只缓存它所知的安全内容。varnish的一个特性是使用虚拟内存，精妙之处在于利用了操作系统的管理机制。varnish可以高度定制如何处理请求，缓存哪些内容。
Varnish 的内部机制如下：
![Varnish](http://jbcdn2.b0.upaiyun.com/2016/11/c789e69ccbbea7199fe3e76182259796.jpeg)
详情参见www.varnish-cache.org。
### 平台缓存
平台缓存是用来写应用的框架，或者缓存的专用库（如PHP中的Smarty模版库）。
Java 语言中，缓存框架更多，例如EHcache，Cacheonix，Voldemort，JBoss Cache等等。
看一下EHcache的系统结构结构：
![EHCache](http://jbcdn2.b0.upaiyun.com/2016/11/f6ab4c3832265df1c32e7f0ddffb3743.png)
Ehcache是一个Java实现的开源分布式缓存框架，可以让数据保存在不同服务器的内存中，在需要数据的时候可以快速存取。通过声明配置、在xml中配置、在程序里配置或者调用构造方法时传入不同的参数。
Voldemort是一款基于Java开发的分布式键-值缓存系统，像JBoss Cache一样，Voldemort同样支持多台服务器之间的缓存同步，以增强系统的可靠性和读取性能。
![Voldemort](http://jbcdn2.b0.upaiyun.com/2016/11/270d23be6a3e9bb4ec1ed2d43a43e914.jpeg)
简单来说，就平台级缓存而言，只需要在框架侧配置一下属性即可，而不需要调用特定的方法或函数。
### 应用缓存
应用级缓存，需要自己通过代码来实现缓存。这里是NoSQL的胜场，不论是Redis 还是MongoDB，都可以作为应用缓存的工具。一个典型的方式是，每分钟或一段时间后统一生成某类页面存储在缓存中，也可以在热数据变化时更新缓存。
Redis 在应用级缓存中的作用举足轻重，新浪微博有着几乎世界上最大的redis 集群。 Redis支持主从同步。数据可以从主服务器向任意数量的从服务器上同步，从服务器可以是关联其他从服务器的主服务器。这使得Redis可执行单层树复制。存盘可以有意无意的对数据进行写操作。由于完全实现了发布/订阅机制，使得从数据库在任何地方同步树时，可订阅一个频道并接收主服务器完整的消息发布记录。同步对读取操作的可扩展性和数据冗余很有帮助。
Redis 的客户端编程语言众多，可以满足绝大多数的应用。
![Redis_client](http://jbcdn2.b0.upaiyun.com/2016/11/535979ab42575e0678eca6a8bae1acd5.png)
### 数据库缓存
数据库缓存是一类特殊的缓存。大多数数据库不需要配置就可以快速运行，但并没有为特定的需求进行优化。在数据库调优的时候，缓存优化是一项很重要的工作。
以MySQL为例，MySQL中使用了查询缓冲机制，将SELECT语句和查询结果存放在缓冲区中，以后对于同样的SELECT语句，将直接从缓冲区中读取结果，以节省查询时间，提高了SQL查询的效率。
通过调节以下几个参数可以知道query_cache_size设置得是否合理：
- Qcache inserts
- Qcache hits
- Qcache lowmem prunes
- Qcache free blocks
- Qcache total blocks
当然，深入数据库还有很多值得学习的地方。
### 缓存的协议支持
对web应用而言，http1.0 提供了一些很基本的缓存特性，例如在服务器侧设置Expires 的http头来告诉客户端在重新请求文件之前缓存多久是安全的，可以通过if-modified-since 的条件请求来使用缓存。其中，发送的时间是文件最初被下载的时间，而不是即将过期的时间，如果文件没有改变，服务器可以用304-Not Modified 来应答。客户端收到304代码，就可以使用缓存的文件版本了。客户端可以设置Pragma:no-cache从服务器之间获取内容。
Http 1.1有了较大的增强，缓存系统被形式化了，引入了实体标签e-tags,是文件或对象的唯一标识。这意味着可以请求一个资源、提供所持有的文件，然后询问服务器这个文件是否有变化。如果某一个文件的e-tag 是有效的，服务器会生成304-Not Modified 应答，并提供正确文件的e－tag，否则，发送200-OK应答。以浏览器为例的示意图如下：
![这里写图片描述](http://jbcdn2.b0.upaiyun.com/2016/11/81dc77008cd105b1a69843785977c118.jpeg)
关于HTTP2.0中有关缓存的技术，还有待研究。
总而言之，缓存——cache，是一种挺复杂的技术，除了应用场景之外，更进一步，还要理解命中，Cache Miss，存储成本，索引成本，失效，替代策略的诸多概念，从而了解缓存算法，真正的掌握缓存技术。
> 
**打赏支持我写出更多好文章，谢谢！**
[打赏作者](#rewardbox)
#### 打赏支持我写出更多好文章，谢谢！
![](http://jbcdn2.b0.upaiyun.com/2016/10/cd0cb2fb6af1a3e82e1f97a8e5aebc46.jpeg)
