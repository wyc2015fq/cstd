# VS2005调试技巧集合 - gauss的专栏 - CSDN博客
2013年01月04日 00:19:37[gauss](https://me.csdn.net/mathlmx)阅读数：225
个人分类：[开发工具/调试技巧](https://blog.csdn.net/mathlmx/article/category/1317877)

下面有从浅入深的6个问题,您可以尝试回答一下
- 一个如下的语句for (int i = 0; i < 10; i++){if (i == 5)j = 5;}，什么都写在一行，你怎么在j=5前面插入断点
- 在一个1000次的循环体内部设置断点,你希望当循环进行到900次后中断,怎么才能做到呢?
- 你有一个表达式在上面循环的某一次发生了变化，你想知道是哪一次，在哪个地方，怎么才能做到？
- 你希望你的断点在被命中100次后，每命中三次中断一次，比如第103，第106，第109怎样做？
- 你有在调试一个服务程序，希望在其内部打上了断点，可是，由于这是一个公用的服务你不希望其他访问这个服务的程序被你的调试所干扰，你想怎么办？
- 怎样知道2个断点中断的时间间隔
**问题1,2**
这两个问题最简单,我在一个例子里说明
例如如下循环
for(int i=0;i<1000;i++){doSomeThing......}
在循环的大括号上单击右键，插入断点，用这个方法，可以对付那些喜欢把语句写在一行上的家伙，其实，随着.Net3.5中Linq的出现，我们肯定也会经常在在一行上写复杂的表达式，这个时候用这种插入方法会比较管用
ok，现在我们来编辑这个断点的条件，在断点上右键单击,选择如图菜单项
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/breakPoint_Condition.jpg)
在弹出的窗口中可以设置断点命中的条件i==900
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/breakpoint_condition_set.JPG)
注意我是在调试C#代码，默认的条件语句语法是C#，如果你想切换，那就需要用Ctrl-B，来插入断点，并在弹出窗口中选择语言
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/debug_setLanguage.jpg)
通过这样设置条件断点,我们就可以解决我们的问题1,2了
**问题3**
同样通过设置条件断点我们还可以解决我们的问题3,对表达式变化的跟踪
string user="yizhu2000"
for(int i=0;i<10000;i++){
DoSomething1()
.......
DoSomethingN()
}
当循环执行完毕时我们发现user变成了"smart_boy",你不知道这个值是在第几次循环的时候变化的,那么你是不是会选择打上断点,一次一次中断,来查看呢?当然不用
在循环体结束的位置我们设置一个断点,打开条件编辑窗口(打开方法同上),设置表达式为user,勾选下面的HasChanged,也就是说,你告诉断点,当user的值发生变化时才触发
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/expression_changed.JPG)
(注意:第一次执行到断点的时候,程序一定会中断,并计算这时表达式的值,所以,所谓发生变化,指的是以后执行到断点是表达式的值和第一次执行到断点时表达式的值的比较)
**问题4**
如何让断点在指定的命中次数或者大于某个次数时触发呢?方法是设定几个断点的HitCount,右键单击断点,在弹出菜单中选择Hit Count,会弹出如下窗口
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/hitcount.jpg)
在"when the break point is hit"下拉列表里,我们可以看到四个选项
break always:总是中断
break when the hit count is equal to:等于某次数时中断
beak when the hit count is a multpile of:当次数是某数的倍数时中断
break when the hit count is greater than or equal to:当大于等于某数时中断
**问题5**
前面4个问题都已经解决了,第5个问题的解决方法是利用断点的Filter功能,比如我希望断点只有被机器名为yizhu的机器访问才能触发,我可以这样设置
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/filter.JPG)
当其他机器访问程序的时候,断点将不会触发,这样做的优点是通过设置机器名,我们可以让其他机器访问的时候感觉不到断点的存在,除此之外我们可以设 置机器名,进程号,进程名,线程号,线程名作为filter,而且还可以把他们组合起来,比如我希望通过当机器yizhu的dllhost进程调用时才触 发,那么问题就可以设置为MachineName="yizhu"&ProcessName="dllhost"
**问题6**
现在我们来解决第6个问题:
在程序性能调试的时候,我们经常需要知道某段代码的执行效率,一般来说,我们可以在程序中加入时间点,通过时间点相减来取得时间间隔,这种方法有个 显而易见的缺点就是需要修改程序,想要不修改程序,就需要借助一些工具,那么有没有什么方法可以声明式的插入时间点,并计算值呢?其实断点完全可以做到
在给出方法前,我们来看看断点的另外一个设置项,When Hit,这个选项可以让我们在命中断点后做一些事情,包括输出一些内容,或者调用宏,比如输出一个程序中变量的值
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/when_hit.JPG)
我们输出了变量user的值，下面Continue Execution表示程序不会中断,输出后继续执行,注意表达式需要用{}括起来,，其他的部分会被作为字符串输出。设定WhenHit后断点变成了方形(看厌了圆断点,我还挺喜欢这个方家伙的)
在output中查看输出结果,如下:
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/value_of_user.JPG)
既然可以计算表达式，我们的第一个最简方案就出来了，也就是在程序执行到断点的时候,输出DateTime.Now,这样当然是可行的,但是我们需 要的是时间间隔,所以我们还需要自己来算个减法,还是挺麻烦的,怎么样才能让程序自己输出时间间隔呢?有一个想法是这样的,我们在上一个断点声明一个时间 变量,然后在下面的断点里用DataTime.Now减去这个变量,即
断点一的条件:{DateTime _t=DateTime.Now;}
断点二的条件:{DateTime.Now-t;}
看起来不错,但是实际运行时就有问题了,让我们看看输出吧
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/output.JPG)
上面高亮的部分说,变量申明只能在immediate window中进行,所以断点一的变量没有申明成功,关于immediatewindow,我们以后会涉猎到,反正就是说想在表达式里申明变量,没门,死路一条.那么我们怎么才能不申明变量又时间点呢?
这时我想起了Thread.SetData 方法,这个方法可以往当前线程专门提供的空间中插入一些数据,并且可以通过GetData得到数据,具体细节参考
[http://msdn2.microsoft.com/zh-cn/library/system.threading.thread.setdata(VS.80).aspx](http://msdn2.microsoft.com/zh-cn/library/system.threading.thread.setdata%28VS.80%29.aspx)
于是方案就有了,在第一个断点处把时间放入Thread的DataSlot,然后第二个断点取出来相减
断点一的条件:{Thread.SetData(Thread.GetNamedDataSlot("ExecutionTime"),DateTime.Now);}
断点二的条件:{DateTime.Now-(DateTime)System.Threading.Thread.GetData(System.Threading.Thread.GetNamedDataSlot("ExecutionTime"));}
看看输出效果
![](http://www.cnblogs.com/images/cnblogs_com/yizhu2000/Result1.JPG)
我们的目的已经达到了,output中成功的输出了时间间隔,当然,还不是很完善,首先,这个方法限于两个断点,你想多打几个断点,测试两两间的间隔还是比较麻烦.测量精度也可以提高,大家有兴趣可以自己研究这个方法的扩展
