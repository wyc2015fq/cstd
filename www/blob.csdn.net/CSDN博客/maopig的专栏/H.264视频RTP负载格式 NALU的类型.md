# H.264视频RTP负载格式/NALU的类型 - maopig的专栏 - CSDN博客
2011年08月09日 08:57:51[maopig](https://me.csdn.net/maopig)阅读数：10474
1. 网络抽象层单元类型(NALU)
NALU 头由一个字节组成, 它的语法如下:
      +===============+
      |0|1|2|3|4|5|6|7|
      +=+=+=+=+=+=+=+=+
      |F|NRI|   Type  |
      +===============+
F: 1 个比特.
  forbidden_zero_bit：在H.264规范中规定了这一位必须为0。
NRI: 2 个比特.
  nal_ref_idc：取00~11，似乎指示这个NALU的重要性, 如00的NALU解码器可以丢弃它而不影响图像的回放。不过一般情况下不太关心
这个属性。
Type: 5 个比特.
nal_unit_type：这个NALU单元的类型。简述如下:
   0     没有定义
  1-23   NAL单元   单个NAL单元包
  24     STAP-A    单一时间的组合包
  25     STAP-B    单一时间的组合包
  26     MTAP16    多个时间的组合包
  27     MTAP24    多个时间的组合包
  28     FU-A      分片的单元
  29     FU-B      分片的单元
  30-31  没有定义
2. 打包模式
  下面是RFC 3550中规定的RTP头的结构.
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |V=2|P|X|  CC   |M|     PT      |       sequence number         |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                           timestamp                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |           synchronization source (SSRC) identifier            |
      +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
      |            contributing source (CSRC) identifiers             |
      |                             ....                              |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  负载类型 Payload type (PT): 7 bits
  序列号 Sequence number (SN): 16 bits
  时间戳 Timestamp: 32 bits
  H.264 Payload格式定义了三种不同的基本的负载(Payload)结构. 接收端可能通过RTP Payload的第一个字节来识别它们.
这一个字节类似NALU头的格式, 而这个头结构的NAL单元类型字段则指出了代表的是哪一种结构,这个字节的结构如下, 可以看出它和H.264的NALU头结构是一样的.
+===============+
      |0|1|2|3|4|5|6|7|
      +=+=+=+=+=+=+=+=+
      |F|NRI|   Type  |
      +===============+
  字段 Type: 这个RTP payload中NAL单元的类型. 这个字段和H.264中类型字段的区别是, 当type的值为24 ~ 31表示这是一个特别格式的NAL单元, 而H.264中, 只取1~23是有效的值.
  24    STAP-A   单一时间的组合包
  24    STAP-B   单一时间的组合包
  26    MTAP16   多个时间的组合包
  27    MTAP24   多个时间的组合包
  28    FU-A     分片的单元
  29    FU-B     分片的单元
  30-31  没有定义
  可能的结构类型分别有:
  1. 单一NAL单元模式
     即一个RTP包仅由一个完整的NALU组成. 这种情况下RTP NAL头类型字段和原始的H.264的NALU头类型字段是一样的.
2. 组合封包模式
    即可能是由多个NAL单元组成一个RTP包. 分别有4种组合方式: STAP-A, STAP-B, MTAP16, MTAP24.那么这里的类型值分别是24, 25, 26以及27.
3. 分片封包模式
    用于把一个NALU单元封装成多个RTP包. 存在两种类型FU-A和FU-B. 类型值分别是28和29.
2.1 单一NAL单元模式
  对于NALU的长度小于MTU大小的包, 一般采用单一NAL单元模式.
  对于一个原始的H.264 NALU单元常由[Start Code] [NALU Header] [NALU Payload]三部分组成, 其中Start Code用于标示这是一个NALU 单元的开始, 必须是 "00 00 00 01"或"00 00 01", NALU头仅一个字节, 其后都是NALU单元内容.
  打包时去除"00 00 01"或"00 00 00 01"的开始码, 把其他数据封包成RTP包即可.
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |F|NRI|  type   |                                               |
      +-+-+-+-+-+-+-+-+                                               |
      |                                                               |
      |               Bytes 2..n of a Single NAL unit                 |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  如有一个H.264的NALU是这样的:
  [00 00 00 01 67 42 A0 1E 23 56 0E 2F ... ]
  这是一个序列参数集NAL单元. [00 00 00 01]是四个字节的开始码, 67是NALU头, 42开始的数据是NALU内容.
  封装成RTP包将如下:
  [RTP Header] [67 42 A0 1E 23 56 0E 2F]
  即只要去掉4个字节的开始码就可以了.
2.2 组合封包模式
  其次, 当NALU的长度特别小时, 可以把几个NALU单元封在一个RTP包中.
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          RTP Header                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |STAP-A NAL HDR |         NALU 1 Size           | NALU 1 HDR    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         NALU 1 Data                           |
      :                                                               :
      +               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |               | NALU 2 Size                   | NALU 2 HDR    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         NALU 2 Data                           |
      :                                                               :
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
2.3 Fragmentation Units (FUs).
  而当NALU的长度超过MTU时, 就必须对NALU单元进行分片封包. 也称为 Fragmentation Units(FUs).
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      | FU indicator  |   FU header   |                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
      |                                                               |
      |                         FU payload                            |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      Figure 14.  RTP payload format for FU-A
   The FU indicator octet has the following format:
+===============+
      |0|1|2|3|4|5|6|7|
      +=+=+=+=+=+=+=+=+
      |F|NRI|   Type  |
      +===============+
   The FU header has the following format:
      +===============+
      |0|1|2|3|4|5|6|7|
      +=+=+=+=+=+=+=+=+
      |S|E|R|   Type  |
      +===============+
3. SDP参数
  下面描述了如何在SDP中表示一个H.264流:
  . "m=" 行中的媒体名必须是 "video"
  . "a=rtpmap" 行中的编码名称必须是 "H264".
  . "a=rtpmap" 行中的时钟频率必须是 90000.
  . 其他参数都包括在"a=fmtp"行中.
  如:
  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; sprop-parameter-sets=Z0IACpZTBYmI,aMljiA==
  下面介绍一些常用的参数.
3.1 packetization-mode:
  表示支持的封包模式.
  当 packetization-mode 的值为 0 时或不存在时, 必须使用单一NALU单元模式.
  当 packetization-mode 的值为 1 时必须使用非交错(non-interleaved)封包模式.
  当 packetization-mode 的值为 2 时必须使用交错(interleaved)封包模式.
  这个参数不可以取其他的值.
3.2 sprop-parameter-sets:
  这个参数可以用于传输H.264的序列参数集和图像参数NAL单元. 这个参数的值采用Base64进行编码. 不同的参数集间用","号隔开.
3.3 profile-level-id:
  这个参数用于指示H.264流的profile类型和级别. 由Base16(十六进制)表示的3个字节. 第一个字节表示H.264的Profile类型, 第三个字节表示H.264的Profile级别.
3.4 max-mbps:
  这个参数的值是一个整型, 指出了每一秒最大的宏块处理速度
NALU的类型
NALU(NAL单元）的顺序要求
NALU类型
    标识NAL单元中的RBSP数据类型，其中，nal_unit_type为1， 2， 3， 4， 5及12的NAL单元称为VCL的NAL单元，其他类型的NAL单元为非VCL的NAL单元。
    0：未规定
    1：非IDR图像中不采用数据划分的片段
    2：非IDR图像中A类数据划分片段
    3：非IDR图像中B类数据划分片段
    4：非IDR图像中C类数据划分片段
    5：IDR图像的片段
    6：补充增强信息 (SEI)
    7：序列参数集
    8：图像参数集
    9：分割符
    10：序列结束符
    11：流结束符
    12：填充数据
    13 – 23：保留
    24 – 31：未规定
    H.264/AVC标准对送到解码器的NAL单元顺序是有严格要求的，如果NAL单元的顺序是混乱的，必须将其重新依照规范组织后送入解码器，否则解码器不能够正确解码。
    1. 序列参数集NAL单元(nal_unit_type为7)必须在传送所有以此参数集为参考的其他NAL单元之前传送，不过允许这些NAL单元中间出现重复的序列参数集NAL单元。所谓重复的详细解释为：序列参数集NAL单元都有其专门的标识，如果两个序列参数集NAL单元的标识相同，就可以认为后一个只不过是前一个的拷贝，而非新的序列参数集。
    2.图像参数集NAL单元(nal_unit_type为8)必须在所有以此参数集为参考的其他NAL单元之先，不过允许这些NAL单元中间出现重复的图像参数集NAL单元，这一点与上述的序列参数集NAL单元是相同的。
    3. 不同基本编码图像中的片段（slice）单元和数据划分片段（data partition）单元在顺序上不可以相互交叉，即不允许属于某一基本编码图像的一系列片段（slice）单元和数据划分片段（data partition）单元中忽然出现另一个基本编码图像的片段（slice）单元片段和数据划分片段（data partition）单元。
    4.参考图像的影响：如果一幅图像以另一幅图像为参考，则属于前者的所有片段（slice）单元和数据划分片段（data partition）单元必须在属于后者的片段和数据划分片段之后，无论是基本编码图像还是冗余编码图像都必须遵守这个规则
    5.基本编码图像的所有片段（slice）单元和数据划分片段（data partition）单元必须在属于相应冗余编码图像的片段（slice）单元和数据划分片段（data partition）单元之前。
    6.如果数据流中出现了连续的无参考基本编码图像，则图像序号小的在前面。
    7. 如果arbitrary_slice_order_allowed_flag置为1，一个基本编码图像中的片段（slice）单元和数据划分片段（data partition）单元的顺序是任意的，如果arbitrary_slice_order_allowed_flag置为零，则要按照片段中第一个宏块的位置来确定片段的顺序，若使用数据划分，则A类数据划分片段在B类数据划分片段之前，B类数据划分片段在C类数据划分片段之前，而且对应不同片段的数据划分片段不能相互交叉，也不能与没有数据划分的片段相互交叉。
    8.如果存在SEI（补充增强信息） 单元的话，它必须在它所对应的基本编码图像的片段（slice）单元和数据划分片段（data partition）单元之前，并同时必须紧接在上一个基本编码图像的所有片段（slice）单元和数据划分片段（data partition）单元后边。假如SEI属于多个基本编码图像，其顺序仅以第一个基本编码图像为参照。
    9.如果存在图像分割符的话，它必须在所有SEI 单元、基本编码图像的所有片段slice）单元和数据划分片段（data partition）单元之前，并且紧接着上一个基本编码图像那些NAL单元。
    10. 如果存在序列结束符，且序列结束符后还有图像，则该图像必须是IDR（即时解码器刷新）图像。序列结束符的位置应当在属于这个IDR图像的分割符、SEI 单元等数据之前，且紧接着前面那些图像的NAL单元。如果序列结束符后没有图像了，那么它的就在比特流中所有图像数据之后。
    11.流结束符在比特流中的最后。
    ①NALU(Network Abstract Layer Unit)：H264标准中的比特流是以NAL为单位，每个NAL单元包含一个RBSP（raw byte sequence payload，原始字节序列载荷），NALU的头信息定义了RBSP所属类型。类型一般包括序列参数集（SPS）、图像参数集（PPS）、增强信息（SEI）、条带（Slice）等，其中，SPS和PPS属于参数集，两标准采用参数集机制是为了将一些主要的序列、图像参数（解码图像尺寸、片组数、参考帧数、量化和滤波参数标记等）与其他参数分离，通过解码器先解码出来。此外，为了增强图像的清晰度，AVS-M添加了图像头（Picture
 head）信息。读取NALU流程中，每个NALU前有一个起始码0x000001，为防止 内部0x000001序列竞争，H.264编码器在最后一字节前插入一个新的字节——0x03，所以解码器检测到该序列时，需将0x03删掉，而AVS-M只需识别出起始码0x000001。
    ②读取宏块类型（mb type）和宏块编码模板（cbp）：编解码图像以宏块划分，一个宏块由一个16*16亮度块和相应的一个8*8cb和一个8*8cr色度块组成。
