# 使用游标会更好 - 左直拳的马桶_日用桶 - CSDN博客
2008年04月17日 15:02:00[左直拳](https://me.csdn.net/leftfist)阅读数：1415
使用游标会更好
左直拳
有两个表，一个比较巨大，大约1千万条记录（表Big），另一个只有5000条（表small）。
现在需要根据表small来更新表Big。
UPDATE Big SET Bf1=0 WHERE BigId IN(SELECT BigId FROM Small WHERE Sf1>0)
但是这样执行下来，速度非常慢，并且连接使用这台DB服务器的程序也都慢了下来，几近不可用。
分析这条SQL语句，使用了IN。据说IN是会分拆成一个个OR表达式的，而OR语句将不会使用索引，所以有时候遇到OR，会用UNION ALL来代替。
当然在这里用UNION ALL是不行的。
这样我猜这条SQL语句，大概会用上全表搜索，大表1千万条记录，那么至少比较1千万次，怎么会不慢呢。
于是改用游标，先将小表的记录提取出来，然后一条条的跟大表结合执行。
DECLARE curT CURSORFORSELECT BigId FROM Small WHERE Sf1>0;
DECLARE @Id INT;
OPEN curT;
FETCH NEXT FROM curT INTO @Id;
WHILE@@FETCH_STATUS= 0
BEGIN
UPDATE Big SET Bf1=0 WHERE BigId=@BigId;
FETCH NEXT FROM curT INTO @Id;
END
CLOSE curT;
DEALLOCATE curT;
这样游标里的记录数量充其量也只有5000条，BidId在大表里又有索引，分成5000次执行，虽然连接，编译花了一点时间，但与恐怖的巨大表全表搜索比较，实在算不了什么。
事实证明，以上语句在大约4分钟执行完毕，期间使用此数据库的应用程序不受影响，速度很快。
