# 数据库的自动备份 - 左直拳的马桶_日用桶 - CSDN博客
2012年08月01日 15:18:01[左直拳](https://me.csdn.net/leftfist)阅读数：1769标签：[数据库																[作业																[sql server																[database																[sql																[xp](https://so.csdn.net/so/search/s.do?q=xp&t=blog)](https://so.csdn.net/so/search/s.do?q=sql&t=blog)](https://so.csdn.net/so/search/s.do?q=database&t=blog)](https://so.csdn.net/so/search/s.do?q=sql server&t=blog)](https://so.csdn.net/so/search/s.do?q=作业&t=blog)](https://so.csdn.net/so/search/s.do?q=数据库&t=blog)
个人分类：[sql server](https://blog.csdn.net/leftfist/article/category/136470)
常常人工备份是不现实的，一定要系统自动定期备份。
备份思想：
0、定期备份，非作业莫属。
1、重要的数据应该每几个小时就做一次差异备份；普通数据每周做一次。（我们的数据库是简单恢复模式）
2、硬盘容量有限，数据库又很大，不能容纳太多备份文件，采用2个备份文件策略，轮流覆盖。所以每个数据库永远都只有2个备份文件。
备份作业：
1、获取单双周函数，用于确定备份文件名称。保持每个数据库永远只有2个备份文件
```
USE [Master]
GO
-- =============================================
-- Author:		leftfist
-- Create date: 2010
-- Description:	用于为备份文件起名
-- =============================================
CREATE FUNCTION [dbo].[jo_func_byWeek]
(
)
RETURNS TINYINT
AS
BEGIN
	DECLARE @JO INT;
	SET @JO = CONVERT(INT,DATENAME(ww,GETDATE()));
	RETURN (@JO % 2);
END
```
2、根据数据库名称，创建同名文件夹，用于存放备份文件
```
EXEC sp_configure 'show advanced options', 1
GO
RECONFIGURE
GO
EXEC sp_configure 'xp_cmdshell', 1
GO
RECONFIGURE
GO
DECLARE @folder VARCHAR(300);
SET @folder = 'c:\backup\db\';
DECLARE @name VARCHAR(50);
DECLARE @sql VARCHAR(1000);
DECLARE curT CURSOR FOR SELECT name FROM sys.databases where database_id<>2;
OPEN curT;
FETCH NEXT FROM curT INTO @name;
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @sql = 'mkdir ' + @folder + @name;
	ExEc xp_cmdshell @sql;
    FETCH NEXT FROM curT INTO @name;
END
CLOSE curT;
DEALLOCATE curT;
EXEC sp_configure 'xp_cmdshell', 0
GO
RECONFIGURE
GO
EXEC sp_configure 'show advanced options', 0
GO
RECONFIGURE
GO
```
3、备份所有数据库（tempdb除外）
```
USE [master]
GO
DECLARE @name VARCHAR(50);
declare @sql varchar(1000);
DECLARE @jo TINYINT;
DECLARE @filename NVARCHAR(100);
--[jo_func_byWeek]是自定义函数，单周返回0，双周返回1
SET @jo = [Master].dbo.[jo_func_byWeek]();
--备份所有数据库（tempdb除外）
DECLARE curT CURSOR FOR SELECT name FROM sys.databases where database_id<>2
OPEN curT;
FETCH NEXT FROM curT INTO @NAME;
WHILE @@FETCH_STATUS = 0
BEGIN
	--每个数据库存放于同名的文件夹。文件夹预先建好
	SET @filename = @name + '\' + @name + '_' + CAST(@jo AS CHAR(1)) + '.bak';
	SET @sql='BACKUP DATABASE [' + @name + '] TO DISK = ''C:\backup\db\' + @filename + ''' WITH INIT , NAME = N''' + @name + ''', NOSKIP , STATS = 10, NOFORMAT';
	EXEC(@sql);    
    FETCH NEXT FROM curT INTO @name;
END
CLOSE curT;
DEALLOCATE curT;
```
将步骤3做成一个作业，定期运行，例如周六凌晨，就可以定期得到备份文件了。
那么，作业本身怎么备份呢？
按我的理解，备份了Master、msdb、model之后，作业应该也在里面了。但怎么单独备份作业呢？
网上有高手写了2篇文章介绍，我看不大懂，先记下地址：
[SQL Server 作业的备份(备份作业非备份数据库)](http://www.jb51.net/article/30683.htm)
[SQL Server 作业同步 (结合备份作业)](http://www.jb51.net/article/30684.htm)
好在作业的更新频率并不高，我们完全可以在新增、修改作业以后，手动备份一份。
方法很简单：选中作业，右键选 编写作业脚本 就可以了。

