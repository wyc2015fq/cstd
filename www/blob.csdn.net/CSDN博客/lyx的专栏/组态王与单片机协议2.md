# 组态王与单片机协议2 - lyx的专栏 - CSDN博客





2015年11月03日 21:36:30[钱塘小甲子](https://me.csdn.net/qtlyx)阅读数：1268








**1．通讯口设置：**


       通讯方式：RS-232,RS-485,RS-422均可。


       波特率：  由单片机决定（2400，4800，9600and19200bps）。


字节数据格式：由单片机决定。
|起始位|数据位|校验位|停止位|
|----|----|----|----|




注意：在组态王中设置的通讯参数如波特率，数据位，停止位，奇偶校验必须与单片机编程中的通讯参数一致





**2．在组态王中定义设备地址的格式**


格式：＃＃．＃　


前面的两个字符是设备地址，范围为0－255，此地址为单片机的地址，由单片机中的程序决定 ；


后面的一个字符是用户设定是否打包，“0”为不打包、“1”为打包,用户一旦在定义设备时确定了打包，组态王将处理读下位机变量时数据打包的工作。




3．在组态王中定义的寄存器格式
|寄存器名称|*dd*上限|*dd*下限|数据类型|
|----|----|----|----|
|X*dd*|65535|0|FLOAT/BYTE/UINT|


斜体字*dd*代表数据地址，此地址与单片机的数据地址相对应。






注意：在组态王中定义变量时，一个X寄存器根据所选数据类型（BYTE,UINT,FLOAT）的不同分别占用一个、两个，四个字节，定义不同的数据类型要注意寄存器后面的地址，同一数据区内不可交叉定义不同数据类型的变量。为提高通讯速度建议用户使用连续的数据区。




例如，


1、在单片机中定义从地址0开始的数据类型为BYTE型的变量:


则在组态王中定义相应的变量的寄存器为X0、X1、X2、X3、X4。。。。。。。。，数据类型为BYTE，每个变量占一个字节


2、在单片机中定义从地址100开始的数据类型为UINT型的变量:


则在组态王中定义相应的变量的寄存器为X100、X102、X104、X106、X108。。。。。。。。，数据类型UINT，每个变量占两个字节


3、在单片机中定义从地址200开始的数据类型为FLOAT型的变量:


则在组态王中定义相应的变量的寄存器为X200、X204、X208、X212。。。。。。。，  数据类型FLOAT，每个变量占四个字节





**3．组态王与单片机通讯的命令格式：**


读写格式（除字头、字尾外所有字节均为ASCII码）


|字头|设备地址|标志|数据地址|数据字节数|数据…|异或|CR|
|----|----|----|----|----|----|----|----|


说明；


字头：1字节1个ASCII码，40H


设备地址： 1字节2个ASCII码，0—255（即0---0x0ffH）


标志：1字节2个ASCII码，bit0~bit7，


bit0= 0:读，bit0= 1:写。


bit1= 0：不打包。


     bit3bit2 = 00,数据类型为字节。


     bit3bit2 = 01,数据类型为字。


     bit3bit2 = 1x,数据类型为浮点数。


数据地址： 2字节4个ASCII码，0x0000~0xffff


数据字节数：1字节2个ASCII码，1—100，实际读写的数据的字节数。


数据…：为实际的数据转换为ASCII码，个数为字节数乘2。


异或：异或从设备地址到异或字节前，异或值转换成2个ASCII码


CR：0x0d。




通讯尝试恢复命令(**COMERROR**)，请求地址为0的一个BYTE数据



**3．1．上位机发送读命令**
|字头|设备地址|标志|数据地址|数据字节数|异或|CR|
|----|----|----|----|----|----|----|


下位机应答：若正常：
|字头|设备地址|数据字节数|数据…|异或|CR|
|----|----|----|----|----|----|


若不正常：
|字头|设备地址|**|异或|CR|
|----|----|----|----|----|




例1：读15号仪表，数据地址为15的数据。其中数据为100，数据类型为字节，不打包。组态王所发数据为：


|40|30|46|43|30|30|30|30|46|30|31|37|32|0d|
|----|----|----|----|----|----|----|----|----|----|----|----|----|----|
|字头|设备地址15|标志读操作字节型不打包|数据地址15|数据字节数1|异或|| | | | | | | |




若正确：
|40|30|46|30|31|36|34|37|35|0d|
|----|----|----|----|----|----|----|----|----|----|
|字头|设备地址15|数据字节数1|数据100|异或|| | | | |


若不正确：
|40|30|46|2a|2a|37|36|0d|
|----|----|----|----|----|----|----|----|
|字头|设备地址15|**|异或|| | | |








例2：读15号仪表，数据地址为15的数据。其中数据为100，数据类型为字节，打包。组态王所发数据为：


|40|30|46|43|32|30|30|30|46|30|31|37|30|0d|
|----|----|----|----|----|----|----|----|----|----|----|----|----|----|
|字头|设备地址15|标志读操作字节型打包|数据地址15|数据字节数1|异或|| | | | | | | |




若正确：
|40|30|46|30|31|36|34|37|35|0d|
|----|----|----|----|----|----|----|----|----|----|
|字头|设备地址15|数据字节数1|数据100|异或|| | | | |


若不正确：
|40|30|46|2a|2a|37|36|0d|
|----|----|----|----|----|----|----|----|
||设备地址15|**|异或|| | | |









**3.2．上位机发送写命令**
|字头|设备地址|标志|数据地址|数据字节数|数据…|异或|CR|
|----|----|----|----|----|----|----|----|


下位机应答：若正常：
|字头|设备地址|##|异或|CR|
|----|----|----|----|----|


若不正常：
|字头|设备地址|**|异或|CR|
|----|----|----|----|----|




例1：写15号仪表，数据地址为15。写数据255，数据类型为字，不打包。组态王所发数据为：


若正确：
|40|30|46|23|23|37|36|0d|
|----|----|----|----|----|----|----|----|
|字头|设备地址15|##|异或|| | | |


若不正确：
|40|30|46|2a|2a|37|36|0d|
|----|----|----|----|----|----|----|----|
|字头|设备地址15|**|异或|| | | |








例2：写15号仪表，数据地址为15。写数据65535，数据类型为浮点型，打包。组态王所发数据为：
|40|30|46|43|46|30|30|30|46|30|34|31|30|46|46|46|46|30|30| |
|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|
|字头|设备地址15|标志写操作浮点型打包|数据地址15|数据字节数4|数据65535| | | | | | | | | | | | | | |
|30|30|0d|| | | | | | | | | | | | | | | | |
|异或||| | | | | | | | | | | | | | | | | |
|||||||||||||||||||||




若正确：
|40|30|46|23|23|37|36|0d|
|----|----|----|----|----|----|----|----|
|字头|设备地址15|##|异或|| | | |


若不正确：
|40|30|46|2a|2a|37|36|0d|
|----|----|----|----|----|----|----|----|
|字头|设备地址15|**|异或|| | | |



[![[转载]组态王与单片机协议2](http://s2.sinaimg.cn/middle/6044e39et82091084c6e1&690)](http://photo.blog.sina.com.cn/showpic.html#blogid=8b2e46de0102val2&url=http://s2.sinaimg.cn/orignal/6044e39et82091084c6e1)



[![[转载]组态王与单片机协议2](http://s16.sinaimg.cn/middle/6044e39et82090c70858f&690)](http://photo.blog.sina.com.cn/showpic.html#blogid=8b2e46de0102val2&url=http://s16.sinaimg.cn/orignal/6044e39et82090c70858f)



[![[转载]组态王与单片机协议2](http://s7.sinaimg.cn/middle/6044e39et8208fc3bfd06&690)](http://photo.blog.sina.com.cn/showpic.html#blogid=8b2e46de0102val2&url=http://s7.sinaimg.cn/orignal/6044e39et8208fc3bfd06)
[![[转载]组态王与单片机协议2](http://s3.sinaimg.cn/middle/6044e39et820901cbe912&690)](http://photo.blog.sina.com.cn/showpic.html#blogid=8b2e46de0102val2&url=http://s3.sinaimg.cn/orignal/6044e39et820901cbe912)
[![[转载]组态王与单片机协议2](http://s3.sinaimg.cn/middle/6044e39et82090533e8b2&690)](http://photo.blog.sina.com.cn/showpic.html#blogid=8b2e46de0102val2&url=http://s3.sinaimg.cn/orignal/6044e39et82090533e8b2)



3、注：


    仪表内部数据为十六进制表示的十进制数。如：实时测量值为500，则用十六进制表示为1F4H。仪表通讯传输是将上述十六进制数据转化为标准ASCII码（即一字节的16进制数转化为2个ASCII码──高4位ASCII码+低4位ASCII码）。


 如：上述数据1F4H（16进制 ），传输时，转化为ASCII码则为30H、31H、46H、34H。



