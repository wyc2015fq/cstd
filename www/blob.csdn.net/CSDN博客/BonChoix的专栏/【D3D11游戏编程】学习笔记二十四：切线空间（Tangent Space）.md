# 【D3D11游戏编程】学习笔记二十四：切线空间（Tangent Space） - BonChoix的专栏 - CSDN博客





2013年02月28日 00:29:33[Brother灬Nam](https://me.csdn.net/BonChoix)阅读数：31091
所属专栏：[D3D11游戏编程](https://blog.csdn.net/column/details/d3d11-bonchoix.html)









（注：【D3D11游戏编程】学习笔记系列由CSDN作者BonChoix所写，转载请注明出处：[http://blog.csdn.net/BonChoix](http://blog.csdn.net/BonChoix)，谢谢~）



          切换空间，同局部空间、世界空间等一样，是3D图形学中众多的坐标系之一。切换空间最重要的用途之一，即法线映射（Normal Mapping）。关于法线映射的细节，将在下一篇文章中详细介绍。但在学习法线映射之前，深刻地理解切换空间非常重要。因此借这一篇文章来学习下它，以为后面学习法线映射、视差映射（Parallax Mapping）、Displacement Mapping等技术作准备。Parallax mapping、Displacement Mapping都属于bump mapping范畴，而且都基于Normal
 Mapping, 但相比Normal Mapping，后两种方法可以提供更加逼真物体表面的凹凸感。



##        1. 为什么要有切线空间？

       在3D世界中定了如此多的坐标系，每个坐标系当然都有它的用途。比如局部空间，或者叫模型空间，它的目的就是方便我们对3D模型进行建模。在这个空间中，我们不需要考虑该模型在场景中可能出现的位置、朝向等众多细节，而专注于模型本身。在世界空间中，我们关心的问题是场景中各个物体的位置、朝向，即如何构建场景，而不必关注摄像机的观察位置及其朝向。可见，一个坐标系的根本用途，即让我们在处理不同的问题时，能够以合适的参照系，抛开不相关的因素，从而减小问题的复杂度。

       直观地讲，模型顶点中的纹理坐标，就定义于切线空间。普通2维纹理坐标包含U、V两项，其中U坐标增长的方向， 即切线空间中的tangent轴，V坐标增加的方向，为切线空间中的bitangent轴。模型中不同的三角形，都有对应的切线空间，其tangent轴和bitangent轴分别位于三角形所在平面上，结合三角形面对应的法线，我们称tangant轴（T）、bitangent轴（B）及法线轴（N）所组成的坐标系，即切线空间（TBN）。

       如下图所示：

![](https://img-my.csdn.net/uploads/201302/27/1361975974_5193.png)

       在立方体中，每个面都有对应的切线空间，每个面由两个三角形组成，该两个三角形中的纹理坐标就基于相应的切线空间。



##        2. 纹理坐标与位置坐标的关系

       纹理坐标与位置坐标，可以通过切线空间联系起来。如下图所示：

![](https://img-my.csdn.net/uploads/201302/27/1361976326_6535.png)

       该图显示了一个三角形及其所在的切线空间。已知该三角形三个顶点的位置坐标：**V**0, **V**1,**V**2, 以及对应的纹理坐标：(u0,v0,), (u1, v1), (u2, v2)。 定义三角形的两条边为**E0 = V**1 –**V**0，**E1= V**2 –
**V**0，对应的纹理坐标差值：(t1,  b1) = (u1 – u0, v1– v0)， (t2,  b2) = (u2 – u0, v2– v0)。 我们有如下关系式：

E0 =t1**T**+ b1**B**

E1 = t2**T**+ b2**B**



##        3. 切线坐标系的求法

       有了以上纹理坐标与位置坐标的关系，我们便可以根据已知的信息，自己来求得任一三角形的切线坐标系了。在3D模型文件中，所有顶点的位置坐标、纹理坐标、法线等信息一般都会提供的，但却缺少切线坐标系相关信息。而在应用Normal Mapping等技术时，切线空间又是必不可少的，因此就需要我们自己手动来获取切线坐标系了。很多读取模型的库都提供了生成切线空间的功能，不过了解一下其是如何生成还是很有必要的。下面我们就来一步步地推导下切线空间的求法：

       继续从上面的纹理坐标与位置坐标的关系公式出发，把它表示成矩阵形式为：

![](https://img-my.csdn.net/uploads/201302/27/1361978093_2734.png)

把E0,E1,T，B拆成分量形式，即：

![](https://img-my.csdn.net/uploads/201302/27/1361978476_3971.png)

把![](https://img-my.csdn.net/uploads/201302/27/1361978587_4217.png)移到另一边，有：

![](https://img-my.csdn.net/uploads/201302/27/1361978691_8606.png)

根据矩阵知识，对于矩阵![](https://img-my.csdn.net/uploads/201302/27/1361978873_1409.png)， 其逆矩阵为：

![](https://img-my.csdn.net/uploads/201302/27/1361979921_5463.png)

因此以上公式可以进一步表示为：

![](https://img-my.csdn.net/uploads/201302/27/1361979170_1938.png)

至此，等号右边的数据都是已知的，因此左边的矩阵即可求得，从而得到切线空间中的T、B两轴。N轴即三角形面的法线，很容易求得。



##        4. 注意

       现在我们根据三角形的顶点位置坐标与纹理坐标，求得了该三角形所在的切线空间。但有一点要注意，这里求得的T向量和B向量一般不是标准化的（长度不为1）。这与一般其他的坐标系有所区别。在局部空间、世界空间、视角空间中，其对应的X、Y、Z轴长度都为1，究其原因主要是这几个空间中的坐标所使用的度量单位都是一样的。而在切线空间中，针对的是纹理，而纹理坐标与位置坐标显然使用不同的度量单位，比如对于纹理坐标从0到1的变化，其对应的位置坐标变化是不确定的。

       因此，这里求得T和B向量长度一般不为1， 而且对于有纹理坐标变换的情形，T和B两轴甚至不会相互垂直。

       但是，在大多数情况下，我们只需要标准化后和T、B、N向量，而不关心其相应的长度。比如在Normal Mapping中，我们使用TBN坐标系的目的只是为了把从Normal Map中得到的法线从切线空间转换到世界空间，与纹理坐标无任何关联，因此这里我们使用的TNB坐标系的三个轴全是准备化的。



##        5. 顶点的切线空间

       上面的方法求到的切线空间是基于单个三角形的，而在3D管线中，我们的处理是基于顶点进行的。因此我们需要获得顶点对应的切线空间。不过有了每个三角形的切换空间，每个顶点的切线空间就很容易处理了，即对于任一顶点，我们使用其所在的所有三角形所对应的切线空间向量的平均值，作为该顶点的切线空间。熟悉法线求法的可能会发现，这种方法与通过三角形法线求取顶点法线的方法思路是完全一样的。

       切线空间的加入，使得我们的顶点定义也要发现相应的更改了。切线空间包括TBN三个向量，大多数情况下，我们使用的切线空间这三个向量都是准备化且相互垂直的，因此，对于每个顶点，我们只要提供T、N两个向量即可，在运行时通过向量叉乘临时地计算B向量即可，这样也节省了每个顶点的数据量。

       现在，我们的顶点的定义如下所示：

```cpp
struct Vertex
{
	XMFLOAT3	pos;
	XMFLOAT3	normal;
	XMFLOAT3	tangent;
	XMFLOAT2	tex;
};
```

       这正是我们在GeometryGens.h文件中生成常见几何体时统一使用的顶点格式。在之前的程序中，我们从未使用过tangent成员，其实它就是为后面学习Normal Mapping而准备滴~



       好了，有关切线空间的相关内容就这些，下次开始进入Bump Mapping相关领域的学习。



