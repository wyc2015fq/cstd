# Linux下patch的使用 - L_Andy的专栏 - CSDN博客

2017年08月18日 10:14:22[卡哥](https://me.csdn.net/L_Andy)阅读数：221
个人分类：[Linux/Unix开发](https://blog.csdn.net/L_Andy/article/category/917442)



patch文件是由diff指令（linux diff, svn diff, git diff, git format-patch）生成的。

首先介绍一下diff指令及其常用参数：

diff：

diff的功能就是用来比较两个文件的不同，然后记录下来，也就是所谓的diff补丁。语法格式：diff 【选项】 源文件（夹） 目的文件（夹），就是要给源文件（夹）打个补丁，使之变成目的文件（夹），术语也就是“升级”。下面介绍三个最为常用选项：

-r 是一个递归选项，设置了这个选项，diff会将两个不同版本源代码目录中的所有对应文件全部都进行一次比较，包括子目录文件。

-N 选项确保补丁文件将正确地处理已经创建或删除文件的情况。

-u 选项以统一格式创建补丁文件，这种格式比缺省格式更紧凑些。


2、patch

－－－－－－－－－－－－－－－－－－

NAME

       patch - apply a diff file to an original

SYNOPSIS

       patch [options] [originalfile [patchfile]]

       but usually just

       patch -pnum <patchfile>

－－－－－－－－－－－－－－－－－－

简单的说，patch就是利用diff制作的补丁来实现源文件（夹）和目的文件（夹）的转换。这样说就意味着你可以有源文件（夹）――>目的文件（夹），也可以目的文件（夹）――>源文件（夹）。下面介绍几个最常用选项：

-p0 选项要从当前目录查找目的文件（夹）

-p1 选项要忽略掉第一层目录，从当前目录开始查找。

类似的 -p2选项要忽略第二层目录；

.......

************************************************************

在这里以实例说明：

--- old/modules/pcitable       Mon Sep 27 11:03:56 1999

+++ new/modules/pcitable       Tue Dec 19 20:05:41 2000

    如果使用参数-p0，那就表示从当前目录找一个叫做old的文件夹，在它下面寻找modules下的pcitable文件来执行patch操作。

    如果使用参数-p1，那就表示忽略第一层目录（即不管old），从当前目录寻找modules的文件夹，在它下面找pcitable。这样的前提是当前目录必须为modules所在的目录。而diff补丁文件则可以在任意位置，只要指明了diff补丁文件的路径就可以了。当然，可以用相对路径，也可以用绝对路径。不过我一般习惯用相对路径。

************************************************************

-E  选项说明如果发现了空文件，那么就删除它

-R  选项说明在补丁文件中的“新”文件和“旧”文件现在要调换过来了（实际上就是给新版本打补丁，让它变成老版本）


patch文件的结构

补丁头

补丁头是分别由---/+++开头的两行，用来表示要打补丁的文件。---开头表示旧文件，+++开头表示新文件。

一个补丁文件中的多个补丁

一个补丁文件中可能包含以---/+++开头的很多节，每一节用来打一个补丁。所以在一个补丁文件中可以包含好多个补丁。

块

块是补丁中要修改的地方。它通常由一部分不用修改的东西开始和结束。他们只是用来表示要修改的位置。他们通常以@@开始，结束于另一个块的开始或者一个新的补丁头。

块的缩进

块会缩进一列，而这一列是用来表示这一行是要增加还是要删除的。

块的第一列

+号表示这一行是要加上的。

-号表示这一行是要删除的。

没有加号也没有减号表示这里只是引用的而不需要修改。

用法：

patch -p0 < xxxx.patch   ：从当前目录查找xxxx.patch 中指定的路径的文件，打patch

patch -p1 < xxxxx.patch  ：忽略掉xxxx.patch中指定的路径的第一级目录，然后从当前目录查找文件，打patch


