# 2.4G上的无线共存问题 - 我相信...... - CSDN博客





2018年05月12日 00:00:00[半吊子全栈工匠](https://me.csdn.net/wireless_com)阅读数：1660
所属专栏：[IoT与智能硬件](https://blog.csdn.net/column/details/19754.html)










2.4 GHz无线共存已经存在至少20年了。真正的问题在于，不同的2.4 GHz无线技术满足了同一设备的不同需求，因此必须要在同时运行而不会出现明显的性能退化。本文针对对WiFi，zigbee和thread，通过工业设计、协同管理以及2.4 GHz频段物联网应用的最佳实践，尝试探索共存技术。

在家庭自动化控制器中添加WiFi有助于家庭物联网设备的增长，WiFi提供从家庭设备到互联网和云服务的连接。 ABI Research的预测表明，平均而言，2017年的每个家庭控制器有不到7个设备的出货量，但到2020年，这个数字将上升到每个家庭控制器平均控制10个设备[1]。 报告认为更广泛的无线传感器网络市场(包括家庭自动化) ，在预计2020年将发布的20亿无线传感器节点(WSN)中，七分之一的无线传感器节点将包含WiFi[2]。

物联网的发展与在家庭控制器中加入WiFi以及将家庭控制器与家庭网关/路由器的协作密切相关。

## 对WiFi共存策略的需求

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/DE2dk1GjczoGc4VHwkKakLibIbRprAlhJibgRic1DiaNctMALfdqE2ibN7wRud1uRtTPed7OavwViaZl9ELvhbics7blw/640?wx_fmt=png)

图1 | 智能家居控制器与设备之间的关系

如图1所示，预计终端设备与控制器的比例将增加，这也意味着主控制器本身在 RF流量方面会变得更加忙碌，因为它将处理更多的端点(通过IEEE 802.15.4连接)和其他低功耗无线网络。其结果是，这些控制器上低功率无线电的任务周期在不断增加。有效的共存战略必须确保对WiFi和其他无线电协议之间的干扰进行管理，并尽量减少其对整个系统性能的影响。

过去，在家庭控制器中，WiFi和低功耗、低数据率无线电之间的共存策略，例如IEEE 802.15.4和zigbee，并不是一个很大的问题，研究集中在无线网络和网络内设备之间的非托管共存，而不是设备内部的无线搭配，如图3所示。 对于数量有限的家庭控制器，一种简单的机制就是让一台无线电发射时停止在另一台无线电上的传输，很容易看出为什么这是到目前为止一个适用的方法:
- 
以前大多数家庭自动化的实现都是由自动化系统驱动的，其中Wi-Fi或以太网连接到云计算是一个辅助功能

- 
家庭网关大多只有一个低功耗无线电以及WiFi

- 
部署的家庭自动化系统总量相对较低


随着家居自动化变得越来越主流化，更多的家庭网关和接入点把低功耗无线电引入到WiFi网关。此外，除了WiFi之外，这些网关还可能有一个以上的低功耗无线电，并且在某些情况下，可以在一个网关中有多达3或4个2.4 GHz的无线电，使用蓝牙和一个或两个IEEE 802.15.4无线电(如 zigbee 和 Thread)。 因此，需要有管理的共存战略，以确保所有无线电都能成功运作。

2.4 GHz的ISM标准支持WiFi(IEEE 802.11 b/g/n)，zigbee和 Thread (IEEE 802.15.4)，蓝牙和低耗电蓝牙。这些不同的2.4 GHz无线电标准同时并同步运行，会降低一个或多个无线电的性能。 为了提高干扰的免疫性，2.4 GHz ISM 无线电标准中的每一项都支持一定程度的避免碰撞和 或消息重试能力。在低的数据吞吐率，低功率水平，和/或足够的物理分离，这些2.4 GHz的 ISM 标准可以并存，对性能没有重大影响。 然而，最近的客户趋势使得共存变得更加困难:
- 
为例“扩展范围"而增加了WiFi传输功率等级

- 
+30 dBm 的WiFi AP现在很普遍

- 
Wi-Fi 吞吐量的日益增加

- 
可达到的信噪比(SNR)，文件传输和/或视频流的高吞吐量要求可能导致2.4 GHz ISM频段内的高Wi-Fi工作周期

- 
将 Wi-Fi、 zigbee、线程和低耗电蓝牙(BLE)集成到同一个设备中，用于网关功能(这种集成是家庭自动化和安全应用程序所需要的，并且使用低耗电蓝牙更容易在端点运行)


## Wi-Fi 对 zigbee 和 Thread 的影响

在全球范围内，Wi-Fi在2.4 GHz 频带上支持多达14个20/22 MHz 频段，传输功率达到 +30 dBm。 同样地，2.4 GHz的zigbee 和 Thread支持16个在5mhz 间距的非重叠2mhz带宽频道，传输功率可达 +20 dBm。这些Wi-Fi和 zigbee/thread 通道映射如图2所示。

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/DE2dk1GjczoGc4VHwkKakLibIbRprAlhJ2LSw21cYKAWWwic9ZicDcBJJkoIVLHobGkkiauP29TIWoSjaribbEYV29A/640?wx_fmt=png)

图2 | 802.15.4 和 802.11 b/g/n 通道映射 (全球)

实际可用的频段因国家而异。例如，在美国，可以使用Wi-Fi的频段1到11，而 zigbee频道11到26也是可用的（尽管第25频道和26频道要求降低传输功率，以满足FCC的要求）。

为了更好地理解 Wi-Fi 对 zigbee 和 Thread 的影响，Silicon Labs测量了一个100% 工作周期的IEEE 802.11 n (MCS3,20mhz 带宽)阻断器在接收各种功率级传输的IEEE 802.15.4信息同时，在不同功率级传输信息。 下列三个图显示了共同通道、相邻通道和"远程"通道的结果。 该测试应用程序是利用一个基于EFR32MG1设备的测试应用程序(NodeTest)和一个控制 DUT与 RF 测试设备的测试脚本。 由于这是一个 IEEE 802.15.4的测试，与 Wi-Fi 阻塞Thread的结果相同。

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/DE2dk1GjczoGc4VHwkKakLibIbRprAlhJq7C804aI4w6DlOwooLWKvvpt12CNtdmMQHVMk2IR80Ov0aZuT8xa0g/640?wx_fmt=png)

图3 | 100%工作周期的 802.11n 阻塞器与 802.15.4的共存信道

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/DE2dk1GjczoGc4VHwkKakLibIbRprAlhJDwibmXpxNfibiaUKZ2w3vEcH0e03j9Eg9T3rPMXfKyUibib0CGpAvwbV5fg/640?wx_fmt=png)

图4 | 100%工作周期的 802.11n阻塞器与 802.15.4 的邻居信道

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/DE2dk1GjczoGc4VHwkKakLibIbRprAlhJD87MoXNzdOHFIzA01tc25SjDnKUribwyc1icm8NBImy2PV1z5SSnsCYg/640?wx_fmt=png)

图5 | 100%工作周期的 802.11n阻塞器与 802.15.4 的远程信道

根据这三个图，关于 Wi-Fi 对 zigbee / thread 的影响的主要观察结果是:

### 共存信道
- 
EFR32MG1可接收 ieee802.15.4信号，低于总 Wi-Fi 传输功率(100% 的工作周期)

- 
EM35x/EM358x 具有和无前端模块(FEM)以提高信号可接收 IEEE 802.15.4信号，低于总体 Wi-Fi 传输功率(100% 的任务周期)

- 
IEEE 802.15.4的传输也会被阻碍，如果Wi-Fi的传输功率跳过 IEEE 802.15.4的 -75 dBm 清晰通道评估(CCA)阈值


### 相邻信道
- 
在 -35 dBm 或较弱的 Wi-Fi 传输功率(100% 的任务周期)时候，EFR32MG1可接收一个-80dbm 的IEEE 802.15.4信号

- 
在 -38 dBm 或较弱 Wi-Fi 传输功率(100% 的工作周期)时，没有FEM的EM35x/EM358x可以接收一个-80dbm IEEE 802.15.4信号，有FEM LNA时，可以到 -43 dBm 或更弱。


### 远程信道
- 
在具有 -15dbm 或较弱的 Wi-Fi 传输功率(100% 的任务周期)时，EFR32MG1可接收一个 -80dbm IEEE 802.15.4信号

- 
在具有-22dbm 或较弱 Wi-Fi 传输功率(100% 的工作周期) 时，在没有FEM的 EM35x/EM358x可以接收一个 -80dbm IEEE 802.15.4信号，有FEM可以打动 -27 dBm 或更弱


在一个真实的环境中，Wi-Fi通常不是100% 的任务周期，只有在低 Wi-Fi SNR 条件下的文件传输或视频流中才能接近100%。 在之前的三个图中，EFR32MG1设备(或EM35x/EM358x) 接收的灵敏度随着 Wi-Fi阻滞器的开关而变化。最终的结果是，当无线网络关闭时，能够获悉较弱的信号，但是当强大的 Wi-Fi 正在运行(主动传输)时就无法得到。

## 非托管共存

非托管共存依赖于无线协议的固有特性、简单的配置工具或网络管理。 在 Wi-Fi和其他物联网无线电之间没有具体的握手信号。 与附近的强Wi-Fi环境中，下面的非托管共存建议可以最大限度地扩大 EFR32MG1或EM35x/EM358x信息接收成功。

### 实现频率分离

IEEE 802.15.4在共存通道操作时，与100% 的工作周期 Wi-Fi会屏蔽大部分 IEEE 802.15.4信息，这种情况必须避免。 此外，EFR32MG1在"远程"信道情况下容许20分贝强的 Wi-Fi 信号。 通过最大限度地提高Wi-Fi网络和 IEEE 802.15.4网络之间的频率分离，可以提高网络性能。

如果 Wi-Fi 和 IEEE 802.15.4在一个普通主机(MCU 控制两个射频)一起实现时，那么主机应该尽量使频率分离最大化。 对于Wi-Fi 网络，接入点(AP)建立了初始通道，在自动通道配置中，可以使用 ieee802.11 h 引入的信道切换信道将网络自由移动到另一个信道，以调度信道的变化。

### 使用带有20MHz频段的 Wi-Fi

由于 Wi-Fi/IEEE802.11 n 使用 OFDM 子载波，这些子载波的第三阶失真在 Wi-Fi 信道的两边延长了一个带宽。 802.11 n 可以在20mhz 或40mhz 模式下运行。 如果在40mhz 模式下操作，80兆赫ISM 频段的40mhz 被 Wi-Fi 频段消耗。 然而，每一段都可能受到第三阶失真的影响。 这些三阶失真可以阻断IEEE 802.15.4接收机，是相邻信道性能比远程通道性能差20分贝的主要原因。

在提出IEEE 802.11 n 的40 MHz 模式时，Wi-Fi 标准预测到了与其他2.4 GHz ISM 设备的潜在问题。任何 Wi-Fi 站都可以在 HT 功能信息中设置"40 MHz 不容忍"位。 这个比特通知 Wi-Fi的接入点，其他2.4 GHz 的 ISM 设备正在使用，迫使整个 Wi-Fi 网络处于20兆赫的状态。

如果 Wi-Fi 和 IEEE 802.15.4在一个公共主机一起实现，那么主机应该在关联期间使用 Wi-Fi设置的"四十 MHz 不容忍"位，以迫使 Wi-Fi 处于20兆赫的状态，以改善 IEEE 802.15.4性能。

如果应用程序要求 Wi-Fi 在40mhz 模式下运行，则必须在2.4 GHz 频段的两端设置 Wi-Fi信道和IEEE 802.15.4信道，使频率分离最大化。

### 增加天线隔离

最小化 ieee802.15.4 接收到的 Wi-Fi 信号强度，可以提高802.15.4的接收范围。 例如，在100% Wi-Fi 工作周期的"远程"信道中，当 EFR32MG1输入的 Wi-Fi 能量为 -15dbm 或以下时，可以收到 -80dbm IEEE 802.15.4 信息。 如果 Wi-Fi 传输功率级别为 + 10 dBm，在 Wi-Fi 发射机与 IEEE 802.15.4之间的天线隔离距离为25 dB 或更多，RF 输入就足以总是接收 -80dbm 802.15.4信号。

增加天线隔离可以通过以下方式实现:
- 
增加天线之间的距离：在开放空间中，接收到的远场功率与1/r2成正比，其中 r 是天线之间的距离

- 
利用天线的方向性：单极子天线沿着天线的轴线提供一个零，它可以直接指向 Wi-Fi 天线


### 使用 zigbee / thread 重试机制

IEEE 802.15.4规范需要在 MAC 层重试。 为了进一步提高消息传递的稳健性，协议栈要实现网络(NWK)重试，包装了 MAC 重试。 用户应用程序也可以利用 APS 重试，其中包含NWK 重试。

### 去除FEM（或 旁路 FEM LNA）

象EFR32MG1 SoC等设备可以提供近20 dBm 传输功率，在没有外部FEM的情况下具有良好的接收灵敏度。 然而，许多其他IEEE 802.15.4使用外部FEM 增加传输功率到 + 20 dBm，以增加传输范围(在允许这样做的区域，如美国)。 附加的FEM获得了增益也提高了灵敏度，但降低了在强 Wi-Fi 存在下的性能。

为了获得最佳的灵敏度，在强Wi-Fi 阻断器存在时，要么消除FEM，要么在旁路模式下操作FEM LNA。 该建议是一种权衡，因为在没有 Wi-Fi 阻断器的情况下，可以通过FEM LNA 增益来提高灵敏度。

## 托管共存

Wi-fi 传输功率越来越高、无线网络吞吐量在增加以及 Wi-Fi 和 IEEE 802.15.4集成的市场趋势有以下影响:

优点：
- 
主机可以实现 Wi-Fi 和 ieee802.15.4之间的频率分离

- 
协同定位的 Wi-Fi 可以将 Wi-Fi 网络强制到20 MHz 的带宽

- 
Wi-fi 和 IEEE 802.15.4可以在2.4 GHz 的工业、科学和医疗(ISM)中传输和接收


缺点:
- 
更高的 Wi-Fi 传输功率需要更大的天线隔离

- 
更高的 Wi-Fi 吞吐量会导致更高的 Wi-Fi 工作周期

- 
天线隔离受到设备大小的限制(只有15-20分贝的隔离并不罕见)


假设频率分离实现了"远程"信道情况，Wi-Fi 只使用20 MHz 带宽，+ 30 dBm Wi-Fi 传输功率级为100% 的任务周期，需要45 dB 天线隔离才能接收 -80dbm IEEE 802.15.4信息。 这在小型设备中通常不可能实现同时配备 Wi-Fi 和 IEEE 802.15.4。

托管共存利用了 Wi-Fi 和 IEEE 802.15.4之间的通信，以协调每个无线电对2.4 GHz ISM 频段的传输和接收。 Silicon Labs实施了一个与支持分组流量仲裁（PTA）的Wi-Fi 设备兼容的SoC 协调方案[4]。 这种基于PTA的协调使 EFR32能够在接收信息或想要发送消息时向Wi-Fi发出信号。当 Wi-Fi 设备意识到 EFR32 SoC 需要2.4 GHz 的 ISM 频段时，任何 Wi-Fi 传输都可以延迟，提高了zigbee/thread消息的可靠性。

### 支持 PTA 的硬件选项

在 IEEE 802.15.2(2003)第6条中描述了 PTA，是一个建议，而不是一个标准[4]。 802.15.2最初讨论了 IEEE 802.11 b 和 IEEE 802.15.1(蓝牙经典)之间的共存问题，但并没有描述一个精确的硬件配置。 但是，IEEE 802.15.2建议 PTA 实现考虑以下内容(以大写字母表示的 PTA 命令) :
- 
从 IEEE 802.11 b 到 PTA 的 TX REQUEST 和来自 IEEE 802.15.1到 PTA 的 TX REQUEST

- 
TX CONFIRM 从PTA到IEEE 802.11 b 和 TX CONFIRM 从 PTA 到 IEEE 802.15.1

- 
来自两个无线的STATUS信息

- 
目前及未来的TX/RX频率

- 
TX/RX开始和持续时间的未来预期

- 
数据包分组类型

- 
优先级(固定、随机或基于 QoS)


在考虑无线电状态，传输/接收和频率时，IEEE 802.15.2描述了干扰的可能性，如图7所示。

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/DE2dk1GjczoGc4VHwkKakLibIbRprAlhJPHqxic3aO5IiaEeJq6IJ00bQzZUQP5OMAsCkwoN4ZVYH615yOBG6GobA/640?wx_fmt=png)

图6| IEEE 802.15.22.4 GHz ISM 协同无线电干扰可能性

对于非托管共存的频率分离建议对于托管共存也是必要的:
- 
IEEE 802.15.2的"In-Band"等效于共存通道(对共存频道的IEEE 802.15.4， Wi-Fi有较大影响）

- 
IEEE 802.15.4 “Out-of-Band” 既包括邻近信道，也包括远程通道(远程信道对邻近信道的改善约20分贝)


因此，对于托管共存，建议继续实施所有的非托管共存建议:
- 
频率分离

- 
在20MHz频段内操作Wi-Fi

- 
天线隔离

- 
zigbee/Thread 重试机制

- 
旁路FEM LNA


在审查现有的PTA实现时，发现PT 的主要实现已经被许多制造商集成到许多 Wi-Fi 设备中，但并不是所有的 Wi-Fi 设备都支持 PTA。 图7显示了支持蓝牙的最常见的Wi-Fi/PTA实现。

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/DE2dk1GjczoGc4VHwkKakLibIbRprAlhJGsv5iaP395ANNnJpcBlwbIk6IiaOZh9gEshYXMrnFrDCXwEgBoexUyFw/640?wx_fmt=png)

图7| 典型的 Wi-Fi/ 蓝牙 PTA 实现

### 三线 PTA

常见的 PTA 配置的一个例子是图7所示的3线配置。 在这种情况下，PRIORITY信号与REQUEST和GRANT一起使用，表示正在接收或传送高优先级或低优先级的消息。当接收请求时，Wi-Fi /PTA设备将这一外部优先级请求与内部 Wi-Fi 优先级进行比较，后者可能是高/低或高/中/低，并可选择蓝牙或 Wi-Fi (注: 优先权可以作为静态或时间共享(增强)优先级实现)。
- 
静态: 在传输或接收操作的REQUEST期间，PRIORITY 不是很高就是很低

- 
共享时间: 在REQUEST 声明后，PRIORITY不是高就是低，但在接收操作期间切换到低，在传输操作期间高


由于IEEE 802.15.4 时相对较低的 RF 任务周期，静态优先权总是可以在 Wi-Fi/PTA输入中与在2线模式下操作的 EFR32 PTA 输入始终可以断言静态优先权。 这样就释放了EFR32上的 GPIO 引脚，并且消除了电路板的痕迹。

在Silicon Labs的测试中：

#### 在活动的 Wi-Fi 中，网络建立成功
- 
PTA功能大大提高了802.15.4的网络简历成功。 在远程信道的用例，改进最显著

- 
由于网络的建立使用了广播、非 ack 消息，所以没有吞吐量流量的健壮性好

- 
在远程信道上表现最好，但当与Wi-Fi共存或相邻信道时，则会退化

- 
当 Wi-Fi 主要在高频工作周期传输时受到的影响最大


#### MAC在活动的 Wi-Fi 中重试
- 
PTA功能大大减少了802.15.4 MAC 重试; 当 CoEx zigbee 传输时，重试几乎被消除了

- 
即使启用了 PTA 功能，MAC 还是要重试:

- 
在远程信道上减少最多，但当与Wi-Fi 共存或相邻信道时会降级

- 
当 CoEx zigbee 主要在高 Wi-Fi RF 任务周期接收时受到的影响最大


#### 活动 Wi-Fi 期间的消息失败
- 
PTA特性大大降低了802.15.4消息失败。 当 CoEx zigbee 正在传输而不是与 Wi-Fi 共存信道时，消息失败几乎消失了

- 
即使启用了 PTA 功能，消息仍会丢失

- 
在远程信道上减少最多，但当与 Wi-Fi 共存或相邻通道时会降级

- 
当 CoEx zigbee 主要在高 Wi-Fi RF 任务周期接收时受到的影响最大


图8显示了一个由Silicon Labs进行的测试结果，并强调了 PTA 在启用时，在 Wi-Fi 存在下对 zigbee 消息失败率的正面影响。 通过重新启用 APS (如下图2所示的测试中禁用) ，消息失败会进一步减少。

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/DE2dk1GjczoGc4VHwkKakLibIbRprAlhJHvd7fP77sboz0rPT0iagyu5vQic8VPzMomQPQghM420Uayb97vOrib2TQ/640?wx_fmt=png)

图8 | 消息失败(%) : CoEx Wi-Fi流->远程Wi-Fi&远程zigbee ->CoEx zigbee RX 流

## 结论

随着物联网的发展和发展，越来越多的Wi-Fi网关将增加蓝牙、zigbee、Thread和其他无线协议，以便与家庭和建筑物中的连接设备进行通信。 此外，随着家庭和智能建筑系统越来越多地增加云连接，越来越多的家庭控制器会将 Wi-Fi添加到现有的低功耗无线设备上。 因此，包括 Wi-Fi 和其他2.4 GHz 协议的网关/控制器类型设备的数量将大幅增加，其中包括低耗电蓝牙(BLE)和 IEEE 802.15.4-based zigbee 和 Thread。

配置强大的 Wi-Fi 会对对 IEEE 802.15.4性能产生重大影响。 通过非托管和托管的共存技术，可以提高具有共存 Wi-Fi的性能。非托管共存包括:
- 
实现频率分离

- 
使用带有20兆赫频带的 Wi-Fi

- 
增加天线隔离

- 
使用 zigbee / thread 重试机制

- 
去除FEM或旁路FEM LNA 


随着市场趋势朝向更高的 Wi-Fi TX 功率、更高的 Wi-Fi 吞吐量以及将 Wi-Fi 和 IEEE 802.15.4集成到同一个设备中，单靠非托管技术可能是不够的，因此需要一个托管共存的解决方案。 即使有一个托管共存的解决方案，所有非托管共存的方案仍然是必要的。

当使用 PTA 时，性能有了很大的改善:

#### 改善组网的成功率
- 
但是，网络的形成利用了广播信息，这些信息没有重试

- 
如果可能的话，在加入IEEE 802.15.4网络的设备中，通过临时减少 Wi-Fi 流量，可以进一步提高组网的成功率 #### 大幅减少MAC重试

- 
减少消息延迟

- 
提高端节点电池寿命

- 
频率分离仍然很重要，因为最好的管理共存性能是为了"远程"通道





#### 大幅减少消息失败
- 
即使在高 Wi-Fi 的工作周期，IEEE 802.15.4网络仍在运行。





本文编译自http://www.embedded-computing.com/embedded-computing-design/driving-wi-fi-zigbee-and-thread-coexistence-in-the-2-4-ghz

参考文献: 

[1] ABI Research (2015), “Home Automation Systems Market Data 2Q 2015”

 [2] OnWorld (2015), “WSN Markets”

 [3] Thonet, G., Allard-Jacquin, P., Colle, P. (2008), “zigbee – Wi-Fi Coexistence: White Paper and Test Report”. 

[4] 1. IEEE (2003), “802.15.2: IEEE Recommendation for Information Technology – Telecommunications and information exchange between systems – Local and metropolitan area networks – Specific requirements Part 15.2: Coexistence of Wireless Personal Area Networks with Other Wireless Devices Operating in Unlicensed Frequency Bands”, IEEE







