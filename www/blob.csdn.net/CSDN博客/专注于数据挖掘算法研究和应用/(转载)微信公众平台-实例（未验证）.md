# (转载)微信公众平台 - 实例（未验证） - 专注于数据挖掘算法研究和应用 - CSDN博客





2013年04月22日 17:04:46[fjssharpsword](https://me.csdn.net/fjssharpsword)阅读数：4608









如何部署自己的公众平台： 

    1.打开http://mp.weixin.qq.com 注册/登录 

    2.进入高级功能菜单，选择编辑模式或开发者模式(本例子属于开发者模式-需要自己拥有服务器) 

    3.进入开发者模式，注册成为开发者，配置接口信息。如： 

        URL：http://192.168.1.1/wx_sample.php 

        Token：weixin (自己填写一个) 

    4.打开wx_sample.php    $wechatObj->valid(); 这个方法进行验证 

    5.验证成功，关闭wx_sample.php    $wechatObj->valid(); 

    6.马上使用手机，访问属于自己的公众平台吧 



本例代码测试方法： 

    1.打开手机微信 

    2.关注公众账号：****

    3.发送一条信息：q北京遇上西雅图 

    4.返回一条磁力链接 

    5.系统返回的是迅雷磁力链接，请您使用电脑版迅雷或手机版迅雷，进行下载观看 


原理： 


    1.接收用户数据,如：q北京遇上西雅图 


    2.到bt搜索引擎进行查询数据 


    3.返回一条磁力链接 


    ps:由于没有申请到内测资格，有很多功能都受到限制，如：5秒超时解决不了， 


    无法主动推送，批量推送，模拟登录又不方便等等。。。 




## [PHP]代码




|`001`|```php<?php```|
|----|----|


|`002`|```php/**```|
|----|----|


|`003`|`  ````php* wechat php test```|
|----|----|


|`004`|`  ````php*/```|
|----|----|


|`005`|```phpheader(``````php'Content-Type:text/html;charset=utf8'``````php);```|
|----|----|


|`006`|```phpdate_default_timezone_set(``````php'RPC'``````php);```|
|----|----|


|`007`|` `|
|----|----|


|`008`|```php//define your token```|
|----|----|


|`009`|```phpdefine(``````php"TOKEN"``````php,``````php"2snH21PBqF7UK"``````php);``````php//自定义```|
|----|----|


|`010`|```php$wechatObj``````php=``````phpnew``````phpwechatCallbackapiTest();```|
|----|----|


|`011`|```php//$wechatObj->valid();//第一次验证token时使用```|
|----|----|


|`012`|```php$wechatObj``````php->responseMsg();```|
|----|----|


|`013`|` `|
|----|----|


|`014`|```phpclass``````phpwechatCallbackapiTest```|
|----|----|


|`015`|```php{```|
|----|----|


|`016`|`    ````phpprivate``````php$keyword``````php;```|
|----|----|


|`017`|`     `|
|----|----|


|`018`|`    ````phppublic``````phpfunction``````phpvalid()```|
|----|----|


|`019`|`    ````php{```|
|----|----|


|`020`|`        ````php$echoStr``````php=``````php$_GET``````php[``````php"echostr"``````php];```|
|----|----|


|`021`|` `|
|----|----|


|`022`|`        ````php//valid signature , option```|
|----|----|


|`023`|`        ````phpif``````php(``````php$this``````php->checkSignature()){```|
|----|----|


|`024`|`            ````phpecho``````php$echoStr``````php;```|
|----|----|


|`025`|`            ````phpexit``````php;```|
|----|----|


|`026`|`        ````php}```|
|----|----|


|`027`|`    ````php}```|
|----|----|


|`028`|`     `|
|----|----|


|`029`|`    ````phppublic``````phpfunction``````phpresponseMsg()```|
|----|----|


|`030`|`    ````php{```|
|----|----|


|`031`|`        ````php//get post data, May be due to the different environments```|
|----|----|


|`032`|`        ````php$postStr``````php=``````php$GLOBALS``````php[``````php"HTTP_RAW_POST_DATA"``````php];```|
|----|----|


|`033`|` `|
|----|----|


|`034`|`        ````php//extract post data```|
|----|----|


|`035`|`        ````phpif``````php(!``````phpempty``````php(``````php$postStr``````php)){```|
|----|----|


|`036`|`                 `|
|----|----|


|`037`|`                ````php$postObj``````php= simplexml_load_string(``````php$postStr``````php,``````php'SimpleXMLElement'``````php, LIBXML_NOCDATA);```|
|----|----|


|`038`|`                ````php$fromUsername``````php=``````php$postObj``````php->FromUserName;```|
|----|----|


|`039`|`                ````php$toUsername``````php=``````php$postObj``````php->ToUserName;```|
|----|----|


|`040`|`                ````php$this``````php->keyword = trim(``````php$postObj``````php->Content);```|
|----|----|


|`041`|`                ````php$time``````php= time();```|
|----|----|


|`042`|`                ````php$textTpl``````php= "<xml>```|
|----|----|


|`043`|`                            ````php<ToUserName><![CDATA[%s]]></ToUserName>```|
|----|----|


|`044`|`                            ````php<FromUserName><![CDATA[%s]]></FromUserName>```|
|----|----|


|`045`|`                            ````php<CreateTime>%s</CreateTime>```|
|----|----|


|`046`|`                            ````php<MsgType><![CDATA[%s]]></MsgType>```|
|----|----|


|`047`|`                            ````php<Content><![CDATA[%s]]></Content>```|
|----|----|


|`048`|`                            ````php<FuncFlag>0</FuncFlag>```|
|----|----|


|`049`|`                            ````php</xml>";```|
|----|----|


|`050`|`                ````phpif``````php(!``````phpempty``````php(``````php$this``````php->keyword ))```|
|----|----|


|`051`|`                ````php{```|
|----|----|


|`052`|`                    ````phpif``````php(``````php$this``````php->keyword == 999){```|
|----|----|


|`053`|`                        ````php$msgType``````php=``````php"text"``````php;```|
|----|----|


|`054`|`                        ````php$contentStr``````php=``````php'当您搜索：q北京遇上西雅图，系统返回的是迅雷磁力链接，请您使用电脑版迅雷或手机版迅雷，进行下载观看。'``````php;``````php//'参数:1, 按下载数查询;参数:2, 按时间查询;参数:5, 按质量查询; 精确查询请添加双引号; 例如: q"北京遇上西雅图"  1';```|
|----|----|


|`055`|`                        ````phpecho``````php$resultStr``````php= sprintf(``````php$textTpl``````php,``````php$fromUsername``````php,``````php$toUsername``````php,``````php$time``````php,``````php$msgType``````php,``````php$contentStr``````php);```|
|----|----|


|`056`|`                        ````phpexit``````php;```|
|----|----|


|`057`|`                    ````php}```|
|----|----|


|`058`|`                    ````phppreg_match(``````php'#^q(.*)#'``````php,``````php$this``````php->keyword,``````php$str``````php);```|
|----|----|


|`059`|`                    ````phpif``````php(``````php$str``````php[1]){```|
|----|----|


|`060`|`                        ````php$data``````php=``````php$this``````php->getQueryParam(``````php$str``````php[1]);```|
|----|----|


|`061`|`                        ````php$contents``````php=``````php$this``````php->getQueryList(``````php$data``````php);```|
|----|----|


|`062`|`                        ````php$resutl``````php=``````php$this``````php->getQueryResult(``````php$contents``````php);```|
|----|----|


|`063`|`                        ````php$link``````php=``````phpstr_replace``````php(``````php'&'``````php,``````php'&'``````php,urldecode(``````php$resutl``````php[1]));``````php//组装磁力链接```|
|----|----|


|`064`|`                        ````phpif``````php(``````php$link``````php){```|
|----|----|


|`065`|`                            ````php$msgType``````php=``````php"text"``````php;```|
|----|----|


|`066`|`                            ````php$contentStr``````php=``````php$link``````php;```|
|----|----|


|`067`|`                            ````phpecho``````php$resultStr``````php= sprintf(``````php$textTpl``````php,``````php$fromUsername``````php,``````php$toUsername``````php,``````php$time``````php,``````php$msgType``````php,``````php$contentStr``````php);```|
|----|----|


|`068`|`                        ````php}```|
|----|----|


|`069`|`                    ````php}``````phpelse``````php{```|
|----|----|


|`070`|`                        ````php$msgType``````php=``````php"text"``````php;```|
|----|----|


|`071`|`                        ````php$contentStr``````php=``````php'请您输入q进行查询,例如: q北京遇上西雅图     更多帮助请输入999'``````php;```|
|----|----|


|`072`|`                        ````phpecho``````php$resultStr``````php= sprintf(``````php$textTpl``````php,``````php$fromUsername``````php,``````php$toUsername``````php,``````php$time``````php,``````php$msgType``````php,``````php$contentStr``````php);```|
|----|----|


|`073`|`                    ````php}```|
|----|----|


|`074`|`                ````php}``````phpelse``````php{```|
|----|----|


|`075`|`                    ````phpecho``````php"Input something..."``````php;```|
|----|----|


|`076`|`                ````php}```|
|----|----|


|`077`|` `|
|----|----|


|`078`|`        ````php}``````phpelse``````php{```|
|----|----|


|`079`|`            ````phpecho``````php""``````php;```|
|----|----|


|`080`|`            ````phpexit``````php;```|
|----|----|


|`081`|`        ````php}```|
|----|----|


|`082`|`         `|
|----|----|


|`083`|`    ````php}```|
|----|----|


|`084`|`         `|
|----|----|


|`085`|`    ````phpprivate``````phpfunction``````phpcheckSignature()```|
|----|----|


|`086`|`    ````php{```|
|----|----|


|`087`|`        ````php$signature``````php=``````php$_GET``````php[``````php"signature"``````php];```|
|----|----|


|`088`|`        ````php$timestamp``````php=``````php$_GET``````php[``````php"timestamp"``````php];```|
|----|----|


|`089`|`        ````php$nonce``````php=``````php$_GET``````php[``````php"nonce"``````php];```|
|----|----|


|`090`|`                 `|
|----|----|


|`091`|`        ````php$token``````php= TOKEN;```|
|----|----|


|`092`|`        ````php$tmpArr``````php=``````phparray``````php(``````php$token``````php,``````php$timestamp``````php,``````php$nonce``````php);```|
|----|----|


|`093`|`        ````phpsort(``````php$tmpArr``````php);```|
|----|----|


|`094`|`        ````php$tmpStr``````php= implode(``````php$tmpArr``````php);```|
|----|----|


|`095`|`        ````php$tmpStr``````php= sha1(``````php$tmpStr``````php);```|
|----|----|


|`096`|`         `|
|----|----|


|`097`|`        ````phpif``````php(``````php$tmpStr``````php==``````php$signature``````php){```|
|----|----|


|`098`|`            ````phpreturn``````phptrue;```|
|----|----|


|`099`|`        ````php}``````phpelse``````php{```|
|----|----|


|`100`|`            ````phpreturn``````phpfalse;```|
|----|----|


|`101`|`        ````php}```|
|----|----|


|`102`|`    ````php}```|
|----|----|


|`103`|`     `|
|----|----|


|`104`|`    ````php//返回q=查询```|
|----|----|


|`105`|`    ````phpfunction``````phpgetQueryResult(``````php$contents``````php){```|
|----|----|


|`106`|`        ````php$result``````php=``````phparray``````php();```|
|----|----|


|`107`|`        ````phppreg_match(``````php'#<a onclick="fclck\(this.href\)" href="(.*)" title="Download via magnet-link">\[magnet-link\]</a>#iUs'``````php,``````php$contents``````php,``````php$content``````php);```|
|----|----|


|`108`|`        ````php$result``````php=``````php$content``````php;```|
|----|----|


|`109`|`        ````phpreturn``````php$result``````php;```|
|----|----|


|`110`|`    ````php}```|
|----|----|


|`111`|`     `|
|----|----|


|`112`|`     `|
|----|----|


|`113`|`    ````php//获取btdigg.org 的查询数据```|
|----|----|


|`114`|`    ````phpfunction``````phpgetQueryList(``````php$data``````php){```|
|----|----|


|`115`|`        ````php$data``````php[``````php'order'``````php] =``````php$data``````php[``````php'order'``````php] ?``````php$data``````php[``````php'order'``````php] : 0;```|
|----|----|


|`116`|`        ````php$data``````php[``````php'p'``````php] = 0;```|
|----|----|


|`117`|`        ````php$ch``````php= curl_init();```|
|----|----|


|`118`|` `|
|----|----|


|`119`|`        ````phpcurl_setopt(``````php$ch``````php, CURLOPT_URL,``````php'https://btdigg.org/search?'``````php.http_build_query(``````php$data``````php));```|
|----|----|


|`120`|`        ````phpcurl_setopt(``````php$ch``````php, CURLOPT_RETURNTRANSFER, true);```|
|----|----|


|`121`|`        ````phpcurl_setopt(``````php$ch``````php, CURLOPT_USERAGENT,``````php'Google Bot'``````php);```|
|----|----|


|`122`|`        ````phpcurl_setopt(``````php$ch``````php, CURLOPT_TIMEOUT, 4);```|
|----|----|


|`123`|`        ````phpcurl_setopt(``````php$ch``````php, CURLOPT_SSL_VERIFYPEER, 0);```|
|----|----|


|`124`|`        ````phpcurl_setopt(``````php$ch``````php, CURLOPT_FRESH_CONNECT, true);```|
|----|----|


|`125`|`         `|
|----|----|


|`126`|`        ````php$result``````php= curl_exec(``````php$ch``````php);```|
|----|----|


|`127`|`        ````phpcurl_close(``````php$ch``````php);```|
|----|----|


|`128`|`        ````phpreturn``````php$result``````php;```|
|----|----|


|`129`|`    ````php}```|
|----|----|


|`130`|` `|
|----|----|


|`131`|`    ````php//获取查询参数```|
|----|----|


|`132`|`    ````phpfunction``````phpgetQueryParam(``````php$str``````php){```|
|----|----|


|`133`|`        ````php$data``````php=``````phparray``````php();```|
|----|----|


|`134`|`        ````php$string``````php=``````phpexplode``````php(``````php' '``````php,``````php$str``````php);```|
|----|----|


|`135`|`         `|
|----|----|


|`136`|`        ````php//是数组 and 最后一个数组是数字```|
|----|----|


|`137`|`        ````php$last``````php=``````phparray_pop``````php(``````php$string``````php);```|
|----|----|


|`138`|`        ````phpif``````php(``````phpis_numeric``````php(``````php$last``````php)){```|
|----|----|


|`139`|`            ````php$data``````php[``````php'q'``````php] = implode(``````php' '``````php,``````php$string``````php);```|
|----|----|


|`140`|`            ````php$data``````php[``````php'order'``````php] =``````php$last``````php;```|
|----|----|


|`141`|`        ````php}``````phpelse``````php{```|
|----|----|


|`142`|`            ````php$data``````php[``````php'q'``````php] =``````php$str``````php;```|
|----|----|


|`143`|`        ````php}```|
|----|----|


|`144`|`        ````phpreturn``````php$data``````php;```|
|----|----|


|`145`|`    ````php}```|
|----|----|


|`146`|`     `|
|----|----|


|`147`|```php}```|
|----|----|


|`148`|` `|
|----|----|


|`149`|```php?>```|
|----|----|











