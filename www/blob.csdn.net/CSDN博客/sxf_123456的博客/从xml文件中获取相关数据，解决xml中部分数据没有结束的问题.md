# 从xml文件中获取相关数据，解决xml中部分数据没有结束的问题 - sxf_123456的博客 - CSDN博客
2017年08月08日 20:25:31[sxf_0123](https://me.csdn.net/sxf_123456)阅读数：188
个人分类：[python](https://blog.csdn.net/sxf_123456/article/category/7078196)
*#!/usr/bin/env python**#encoding=utf-8**"""**@version:v1.0**@author:sxf**@software:PyCharm**@file:fgqgspl.py**@time:2017-08-05**"""***import  **sys
**import  **re
**import  **os
**import  **codecs
**from **xml.dom **import **minidom
**"""****#获取原数据中含有批量关键字的数据****def get_batch_data(reader,writer):****    input_file = codecs.open(reader,"r","utf-8") #指定utf-8编码格式打开****    if os.path.exists(writer):****        os.remove(writer)****    write_file = open(writer,'a+')****    pattern = re.compile(r'.*批量.*')****    for line in input_file:****        match=pattern.match(line)****        if match:****            write_file.write(line)****    input_file.close()****    write_file.close()****"""****"""****#获取错误数据****def get_irregul_data(reader,writer_fgq,writer_fgq_no_onu,writer_pon,writer_pon_no_onu,writer_normal_pon_fgq):****    input_file = open(reader,"r")****    flag = 1****    pattern = re.compile(r'.*分光器光衰批量查询.*')****    fgq_no_end_count = 0  # 统计分光器中数据出错数量****    fgq_no_onu_count = 0  # 统计分光器中str[3]没有onu数量****    fgq_normal_count = 0  #统计分光器中数据正确数量****    pon_no_end_count = 0  # 统计PON光衰中数据出错数量****    pon_no_onu_count = 0  #统计PON光衰中str[3]没有onu数量****    pon_normal_count = 0  #统计PON光衰中数据正确数量****    if os.path.exists(writer_fgq):****        os.remove(writer_fgq)****    write_fgq = open(writer_fgq,"a+")  #存放分光器中数据没有结束的数据****    if os.path.exists(writer_pon):****        os.remove(writer_pon)****    write_pon = open(writer_pon,"a+")  #存放PON中数据没有结束的数据****    if os.path.exists(writer_fgq_no_onu):****        os.remove(writer_fgq_no_onu)****    write_fgq_onu = open(writer_fgq_no_onu,"a+")  #存放分光器中没有onu的数据（无法获取除ip和areaid以外的数据）****    if os.path.exists(writer_pon_no_onu):****        os.remove(writer_pon_no_onu)****    write_pon_onu = open(writer_pon_no_onu,"a+")  #存放PON中没有onu的数据（无法获取除ip和areaid以外的数据）****    if os.path.exists(writer_normal_pon_fgq):****        os.remove(writer_normal_pon_fgq)****    write_normal_pon_fgq = open(writer_normal_pon_fgq,"a+")  #存放批量中正确的数据****    for line in input_file:****        match = pattern.match(line)****        str = line.split('^')****        if match:****           try:****               pos_last_onu = str[3].index("</root>")****               fgq_normal_count = fgq_normal_count + 1****               write_normal_pon_fgq.write(line)****           except ValueError:****               fgq_no_end_count = fgq_no_end_count + 1****               write_fgq.write(line)****           try:****               pos_no_onu = str[3].index("onu")****           except ValueError:****               fgq_no_onu_count = fgq_no_onu_count + 1****               write_fgq_onu.write(line)****        else:****            try:****                pos_last_onu = str[3].index("</root>")****                pon_normal_count = pon_normal_count + 1****                write_normal_pon_fgq.write(line)****            except ValueError:****                pon_no_end_count = pon_no_end_count + 1****                write_pon.write(line)****            try:****                pos_no_onu = str[3].index("onu")****            except ValueError:****                pon_no_onu_count = pon_no_onu_count + 1****                write_pon_onu.write(line)****    print("fgq_no_end_count:",fgq_no_end_count)****    print("fgq_no_onu_count:", fgq_no_onu_count)****    print("fgq_normal_count:",fgq_normal_count)****    print("pon_no_end_count:", pon_no_end_count)****    print("pon_no_onu_count:",pon_no_onu_count)****    print("pon_normal_count:",pon_normal_count)****    input_file.close()****    write_fgq.close()****    write_fgq_onu.close()****    write_pon.close()****    write_pon_onu.close()****"""****"""****#处理错误数据****def deal_irregular_data(reader_fgq_irreg,reader_pon_irreg,writer_toxml):****    fgq_input_file = open(reader_fgq_irreg,"r")****    pon_input_file = open(reader_pon_irreg,"r")****    if os.path.exists(writer_toxml):****        os.remove(writer_toxml)****    xml_output_file = open(writer_toxml,"a+")****    for line in fgq_input_file:****        str = line.split('^')****        last_char = line[len(line)-2]****        if (('a'<=last_char and last_char<='z') or ('A'<=last_char and last_char<='Z')):****            # 获取最后17个字符****            str_last_ten = line[len(line) - 18:len(line) - 1]****            str_ten_reverse = str_last_ten[::-1]  #字符串反转****            i=0****            while (i < 17):****                if str_ten_reverse[i] == ' ':****                    space_pos = i****                    break****                i = i + 1****            fgq_str3 = line[0:len(line)-(space_pos+2)]****            fgq_str3 = fgq_str3 + "/>" + "</equip></equips></root>****\n****"****        elif ('0'<=last_char and last_char<='9'):****            fgq_str3 = line[0:len(line)-1]+"****\"****"+"/>" + "</equip></equips></root>****\n****"****        elif (last_char == '='):****            fgq_str3 = line[0:len(line)-1]+"****\"****"+"null"+"****\"****"+"/>" + "</equip></equips></root>****\n****"****        elif (last_char == '"'):****            last_second_char = line[len(line)-3]****            if last_second_char == '=':****                fgq_str3 = line[0:len(line)-1]+"null"+"****\"****"+"/>" + "</equip></equips></root>****\n****"****            else:****                fgq_str3 = line[0:len(line)-1]+"/>" + "</equip></equips></root>****\n****"****        elif (last_char == '.'):****            fgq_str3 = line[0:len(line) - 1] + "****\"****"+"/>" + "</equip></equips></root>****\n****"****        elif (last_char == '_'):****            fgq_str3 = line[0:len(line)- 1] + "=" + "****\"****" + "null" + "****\"****" + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == '-'):****            fgq_str3 = line[0:len(line) - 1] + "****\"****" + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == ' '):****            fgq_str3 = line[0:len(line) - 1] + "/>" + "</equip></equips></root>****\n****"****        else:****            pass****        xml_output_file.write(fgq_str3)****    for line in pon_input_file:****        str = line.split('^')****        last_char = line[len(line) - 2]****        if (('a' <= last_char and last_char <= 'z') or ('A' <= last_char and last_char <= 'Z')):****            # 获取最后17个字符****            str_last_ten = line[len(line) - 18:len(line) - 1]****            str_ten_reverse = str_last_ten[::-1]  # 字符串反转****            i = 0****            while (i < 17):****                if str_ten_reverse[i] == ' ':****                    space_pos = i****                    break****                i = i + 1****            pon_str3 = line[0:len(line) - (space_pos + 2)]****            pon_str3 = pon_str3 + "/> " + "</equip></equips></root>****\n****"****        elif ('0' <= last_char and last_char <= '9'):****            pon_str3 = line[0:len(line) - 1] + "****\"****" + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == '='):****            pon_str3 = line[0:len(line) - 1] + "****\"****" + "null" + "****\"****" + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == '"'):****            last_second_char = line[len(line) - 3]****            if last_second_char == '=':****                pon_str3 = line[0:len(line) - 1] + "null" + "****\"****"  + "/>" + "</equip></equips></root>****\n****"****            else:****                pon_str3 = line[0:len(line) - 1] + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == '.'):****            pon_str3 = line[0:len(line) - 1] + "****\"****" + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == '.'):****            pon_str3 = line[0:len(line) - 1] + "****\"****" + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == '_'):****            pon_str3 = line[0:len(line) - 1] + "=" + "****\"****" + "null" + "****\"****" + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == '-'):****            pon_str3 = line[0:len(line) - 2]  + "null"  + "****\"****" + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == ' '):****            pon_str3 = line[0:len(line) - 1] + "/>" + "</equip></equips></root>****\n****"****        elif (last_char == '>'):****            pon_str3 = line[0:len(line) - 1] + "</equip></equips></root>****\n****"****        else:****            pass****        xml_output_file.write(pon_str3)****    fgq_input_file.close()****    pon_input_file.close()****    xml_output_file.close()****#从批量数据文件中取数据，设置为新的xml解析格式****def  write_batch_toxml(reader,writer):****    input_file = open(reader,"r")****    flag = 1****    if os.path.exists(writer):****        os.remove(writer)****    write_new_xml_file = open(writer, "a+")****    string = "<?xml version='1.0' encoding='UTF-8'?>"****    for line in input_file:****        # print(line)****        # break****        str = line.split('^')****        # 获得ip****        pos_ip = str[2].index("ip")****        pos_ip = pos_ip + len("ips><equip id=****\"****1****\"****")****        pos_downport = str[2].index("downport")****        str_ip = str[2][pos_ip:pos_downport - 1]****        # 获得areaid****        pos_areaid = str[2].index("areaid")****        pos_areaid = pos_areaid - 1****        pos_accesstype = str[2].index("accesstype")****        pos_accesstype = pos_accesstype - 1****        str_areaid = str[2][pos_areaid:pos_accesstype]****        try:****            pos_onu = str[3].index("onu")****            pos_last_onu = str[3].index("</equip>")****            start = pos_onu - 1****            end = pos_last_onu + len("</equip>")****            if flag == 1:****                onu_after = string + "<roots>" + "<equip " + str_ip + str_areaid + ">" + str[3][start:end]****                flag = 0****            else:****                onu_after = "<equip " + str_ip + str_areaid + ">" + str[3][start:end]****            write_new_xml_file.write(onu_after)****        except ValueError:****            try:****                pos_loads = str[2].index("loids")****                pos_loads = pos_loads + len("loids='")****                pos_equips = str[2].index("</equips>")****                str_loads = str[2][pos_loads:pos_equips - 4]****                i = 0****                loads = str_loads.split(',')****                while (i < len(loads)):  # loids="ms4229098252,ms9448317699,ms6277099537,ms3889819869" 转化为xml格式****                    if (i == 0):****                        if (len(loads) == 1):****                            loads_str = "<equip " + str_ip + str_areaid + ">" + "</equip>"****                            # print(loads_str)****                            # break****                        else:****                            loads_str = "<equip " + str_ip + str_areaid + ">"****                    elif (i == len(loads) - 1):****                        loads_str = "<onu " + "load=" + "****\"****" + loads[i] + "****\"****" + " />" + "</equip>"****                    else:****                        loads_str = "<onu " + "load=" + "****\"****" + loads[i] + "****\"****" + " />"****                    write_new_xml_file.write(loads_str)****                    i = i + 1****            except ValueError:  #str[2]中没有loads****                loads_str = "<equip " + str_ip + str_areaid + ">" + "</equip>"****                print(loads_str)****                break****                write_new_xml_file.write(loads_str)****    write_new_xml_file.write("</roots>")****    input_file.close()****    write_new_xml_file.close()****"""****def **get_attrvalue(root_node,attrname):
    **try**:
        **if **root_node.getAttribute(attrname):
            **return **root_node.getAttribute(attrname)
        **else**:
            **return ****"null"****except **AttributeError:
        *# print(root_node,attrname)***return ****"null"****def **get_xml_node(root_node,node_name):
    **if **root_node.getElementsByTagName(node_name):
        **return **root_node.getElementsByTagName(node_name)
    **else**:
        **return ****"null"***#解析xml，获取相应的值***def **get_xml_data(xml_file):
    *# writer = "C:\\Users\\sxf\\Desktop\\test\\pl_irreg_xml\\optical_data_1.txt"*writer = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pl_irreg_xml****\\****optical_data_2.txt"****if **os.path.exists(writer):
        os.remove(writer)
    write_fp = open(writer,**'a+'**)
    doc = minidom.parse(xml_file)
    root = doc.documentElement
    nodes = get_xml_node(root,**'equip'**)
    **if **nodes == **"null"**: *#节点中不存在equip节点*print(**"nodes="**,nodes)
        **return**str2 = **"areaid" **+ **"****\t\t\t****" **+ **"ip" **+ **"****\t\t\t****" **+ **"loid" **+ **"****\t\t****" **+ **"RxPower" **+ **"****\t****" **+ **"TxPower" **+ **"****\t****" **+ **"PRxPower" **+ \
           **"****\b****"**+**"PTxPower" **+ **"****\b****" **+ **"DownOp" **+ **"****\b****" **+ **"UpOp" **+ **"****\n****"**write_fp.write(str2)
    **for **node **in **nodes:
        ip = get_attrvalue(node,**'ip'**)
        areaid = get_attrvalue(node,**'areaid'**)
        child_node = get_xml_node(node,**"onu"**)
        **for **child_node_1 **in **child_node:
            loid = get_attrvalue(child_node_1, **"loid"**)
            RxPower = get_attrvalue(child_node_1, **"RxPower"**)
            TxPower = get_attrvalue(child_node_1, **"TxPower"**)
            PRxPower = get_attrvalue(child_node_1, **"PRxPower"**)
            PTxPower = get_attrvalue(child_node_1, **"PTxPower"**)
            DownOpticalLess = get_attrvalue(child_node_1, **"DownOpticalLess"**)
            UpOpticalLess = get_attrvalue(child_node_1, **"UpOpticalLess"**)
            str_pre = areaid + **"****\t****" **+ ip  + **"****\t****" **+ loid + **"****\t****" **+ RxPower + **"****\t****" **+ TxPower + **"****\t****" **+ PRxPower
            str_after = **"****\t\t****" **+ PTxPower + **"****\t\t****" **+ DownOpticalLess + **"****\t\t****" **+ UpOpticalLess +**"****\n****"**str1 = str_pre + str_after
            write_fp.write(str1)
    write_fp.close()
**if **__name__==**'__main__'**:
    source_reader = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****opticaldata_dy_20170803.csv"**pl_writer = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pl_data.txt"***# get_batch_data(source_reader,pl_writer)*pl_reader = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pl_data.txt"**writer_fgq = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****fgq_pl_irregular.txt"**writer_pon = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pon_pl_irregular.txt"**writer_fgq_no_onu = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****fgq_no_onu.txt"**writer_pon_no_onu = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pon_no_onu.txt"**writer_normal_pon_fgq = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****normal_pon_fgq.txt"***# get_irregul_data(pl_reader, writer_fgq, writer_fgq_no_onu , writer_pon , writer_pon_no_onu,writer_normal_pon_fgq)*reader_fgq_irreg = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****fgq_pl_irregular.txt"**reader_pon_irreg = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pon_pl_irregular.txt"**writer_toxml = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pl_irreg_toxml.txt"***# deal_irregular_data(reader_fgq_irreg, reader_pon_irreg, writer_toxml)**    #非正常的数据转换为新的xml格式*writer_xml =**"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pl_test_data_xml.xml"***# write_batch_toxml(writer_toxml,writer_xml)**    #正常的数据转换为新的xml格式*writer_normal_xml = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pl_normal_data_xml.xml"***# write_batch_toxml(writer_normal_pon_fgq, writer_normal_xml)**    #获取xml文件中相应的值**    # get_data = "C:\\Users\\sxf\\Desktop\\test\\pl_irreg_xml\\pl_test_data_xml.xml_Format.xml"*get_data = **"C:****\\****Users****\\****sxf****\\****Desktop****\\****test****\\****pl_irreg_xml****\\****pl_normal_data_xml.xml_Format.xml"**get_xml_data(get_data)
