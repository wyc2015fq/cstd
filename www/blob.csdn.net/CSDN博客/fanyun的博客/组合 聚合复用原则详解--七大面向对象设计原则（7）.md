# 组合/聚合复用原则详解--七大面向对象设计原则（7） - fanyun的博客 - CSDN博客
2016年07月19日 21:56:13[老樊Lu码](https://me.csdn.net/fanyun_01)阅读数：5195
所属专栏：[C/C++/C#开发实战365](https://blog.csdn.net/column/details/c-plus-plus-01.html)
**组合/聚合复用原则来源：**
       在面向对象的设计中，如果直接继承基类，会破坏封装，因为继承将基类的实现细节暴露给子类；如果基类的实现发生改变，则子类的实现也不得不发生改变；从基类继承而来的实现是静态的，不可能在运行时发生改变，没有足够的灵活性。于是就提出了组合/聚合复用原则，也就是在实际开发设计中，尽量使用合成/聚合，不要使用类继承。即在一个新的对象里面使用一些已有的对象，使之成为新对象的一部分，新对象通过向这些对象的委派达到复用已有功能的目的。就是说要尽量的使用合成和聚合，而不是继承关系达到复用的目的。
**组合/聚合复用原则定义：**
        合成/聚合复用原则经常又叫做合成复用原则。该原则就是在一个新的对象里面使用一些已有的对象，使之成为新对象的一部分：新的对象通过向这些对象的委派达到复用已有功能的目的。
**组合/聚合复用原则作用：**
        组合/聚合可以使系统更加灵活，降低类与类之间的耦合度，一个类的变化对其他类造成的影响相对较少；其次才考虑继承，在使用继承时，需要严格遵循里氏代换原则，有效使用继承会有助于对问题的理解，降低复杂度，而滥用继承反而会增加系统构建和维护的难度以及系统的复杂度，因此需要慎重使用继承复用。 由于组合或聚合关系可以将已有的对象（也可称为成员对象）纳入到新对象中，使之成为新对象的一部分，因此新对象可以调用已有对象的功能，这样做可以使得成员对象的内部实现细节对于新对象不可见，所以这种复用又称为“黑箱”复用，相对继承关系而言，其耦合度相对较低，成员对象的变化对新对象的影响不大，可以在新对象中根据实际需要有选择性地调用成员对象的操作；合成复用可以在运行时动态进行，新对象可以动态地引用与成员对象类型相同的其他对象。
**组合/聚合复用原则示例：**
        合成（Composition，也有翻译成组合）和聚合（Aggregation），都是关联的特殊种类。聚合表示一种弱的“拥有”关系，体现的是A对象可以包含B对象，但B对象不是A对象的一部分；合成（组合）是一种强的“拥有”关系，体现了严格的部分与整体的关系，部分和整体的生命周期是一样的。聚合/组合UML示意图如图1所示：
![](https://img-blog.csdn.net/20160719135508592?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)
       在我们的日常开发中，经常遇到新的数据库或股市行情源替换问题，如下面的情况。产品初始开发采用A公司的行情源，与行情源操作有关的类如CustomerData类等都需要连接行情源，连接行情源的方法getConnection()封装在DataUtil类中，由于需要重用DataUtil类的getConnection()方法，设计人员将CustomerData作为DataUtil类的子类，初始设计方案结构如图2所示：
![](https://img-blog.csdn.net/20160719135526249?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)
         随着产品的正式上线，需要更加稳定快速的行情源，于是决定使用B公司行情源，但是B公司行情源数据解析模式和A公司不一样。因此需要增加一个新的DataUtilB类来连接B行情源，由于在初始设计方案中CustomerData和DataUtil之间是继承关系，因此在更换行情连接方式时需要修改CustomerData类的源代码，将CustomerData作为DataUtilB的子类，这将违反开闭原则。当然也可以修改DataUtil类的源代码，同样会违反开闭原则。
         现使用合成复用原则对其进行重构。重构后的方案如图3所示：
![](https://img-blog.csdn.net/20160719135550562?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)
        重构后的CustomerData和DataUtil之间的关系由继承关系变为关联关系，采用依赖注入的方式将DataUtil对象注入到CustomerData中，可以使用构造注入，也可以使用Setter注入。如果需要对DataUtil的功能进行扩展，可以通过其子类来实现，如通过子类DataUtilB来连接B行情源。由于CustomerData针对DataUtil编程，根据里氏代换原则，DataUtil子类的对象可以覆盖DataUtil对象，只需在CustomerData中注入子类对象即可使用子类所扩展的方法。例如在CustomerData中注入DataUtilB对象，即可实现接入B行情源，原有代码不需要修改，且还可以很方便地增加新的行情接入。
**合成/聚合复用优缺点和继承复用优缺点总结：**
合成/聚合复用：
(1).优点：
        新对象存取成分对象的唯一方法是通过成分对象的接口； 这种复用是黑箱复用，因为成分对象的内部细节是新对象所看不见的；这种复用支持包装；这种复用所需的依赖较少； 每一个新的类可以将焦点集中在一个任务上； 这种复用可以在运行时动态进行，新对象可以使用合成/聚合关系将新的责任委派到合适的对象。
(2).缺点：
         通过这种方式复用建造的系统会有较多的对象需要管理。
继承复用:
(1).优点：
        新的实现较为容易，因为基类的大部分功能可以通过继承关系自动进入派生类；修改或扩展继承而来的实现较为容易。
(2).缺点：
        继承复用破坏包装，因为继承将基类的实现细节暴露给派生类，这种复用也称为白箱复用； 如果基类的实现发生改变，那么派生类的实现也不得不发生改变；从基类继承而来的实现是静态的，不可能在运行时发生改变，不够灵活。
**组合/聚合复用原则使用总结：**
        合成和聚合均是关联的特殊情况。聚合用来表示“拥有”关系或者整体与部分的关系；而合成则用来表示一种强得多的“拥有”关系。在一个合成关系里面，部分和整体的生命周期是一样的。一个合成的新的对象完全拥有对其组成部分的支配权，包括它们的创建和销毁等。使用程序语言的术语来说，组合而成的新对象对组成部分的内存分配、内存释放有绝对的责任。要正确的选择合成/复用和继承，必须透彻地理解里氏替换原则和Coad法则。（Coad法则由Peter
 Coad提出，总结了一些什么时候使用继承作为复用工具的条件。Coad法则：只有当以下Coad条件全部被满足时，才应当使用继承关系）
(1).子类是基类的一个特殊种类，而不是基类的一个角色。区分“Has-A”和“Is-A”。只有“Is-A”关系才符合继承关系，“Has-A”关系应当用聚合来描述。 
(2).永远不会出现需要将子类换成另外一个类的子类的情况。如果不能肯定将来是否会变成另外一个子类的话，就不要使用继承。 
(3).子类具有扩展基类的责任，而不是具有置换掉（override）或注销掉（Nullify）基类的责任。如果一个子类需要大量的置换掉基类的行为，那么这个类就不应该是这个基类的子类。 
(4).只有在分类学角度上有意义时，才可以使用继承。不要从工具类继承。
