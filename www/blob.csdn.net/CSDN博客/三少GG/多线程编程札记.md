# 多线程编程札记 - 三少GG - CSDN博客
2014年01月23日 20:28:00[三少GG](https://me.csdn.net/scut1135)阅读数：893
个人分类：[重构C/C++](https://blog.csdn.net/scut1135/article/category/621651)

**pthread:**
pthread_create是UNIX环境创建线程函数
头文件
　　#include<pthread.h>
函数声明
　　int pthread_create(pthread_t*restrict tidp,const pthread_attr_t *restrict_attr,void*（*start_rtn)(void*),void *restrict arg);
返回值
　　若成功则返回0，否则返回出错编号
　　返回成功时，由tidp指向的内存单元被设置为新创建线程的线程ID。attr参数用于制定各种不同的线程属性。新创建的线程从start_rtn函数的地址开始运行，该函数只有一个万能指针参数arg，如果需要向start_rtn函数传递的参数不止一个，那么需要把这些参数放到一个结构中，然后把这个结构的地址作为arg的参数传入。
**注意点：**
1. 待传递参数写在**堆区**， 用**new**指针生成。
2. 参数需子线程释放，避免内存泄露。
3. 多参数传递参见...brain.
4.  detached版本：
如果你的主线程，也就是main函数执行的那个线程，在其他线程退出之前就已经退出，那么带来的bug则不可估量。通过pthread_join函数会让主线程阻塞，直到所有线程都已经退出。可以通过pthread_join()函数来使主线程阻塞等待其他线程退出，这样主线程可以清理其他线程的环境。但是还有一些线程，**更喜欢自己来清理退出的状态，他们也不愿意主线程调用pthread_join来等待它们**。我们将这一类线程的属性称为detached。如果我们在调用pthread_create()函数的时候将属性设置为NULL，则表明我们希望所创建的线程采用默认的属性，也就是joinable。如果需要将属性设置为detached，则参考下面的例子：
pthread_attr_t attr;
pthread_t thread;
thread_attr_init (&attr);
pthread_attr_setdetachstate (**&****attr**, **PTHREAD_CREATE_DETACHED**);
pthread_create (&thread, **&****attr**, &thread_function, NULL);
pthread_attr_destroy (&attr);
5.
如果想传递参数给线程函数，可以通过其参数arg，其类型是void *。如果你需要传递多个参数的话，可以考虑将这些参数组成一个结构体来传递。另外，**由于类型是void *，所以你的参数不可以被提前释放掉。**
6.pthread_create函数创建失败最可能的原因应该就是系统资源不足，根据经验，线程的默认堆栈大小是1MB，就是说，系统每创建一个线程就要至少提供1MB的内存，那么，创建线程失败，极有可能就是内存不够用了。从代码中看不出有内存泄露的现象，有malloc的地方就会有free对应。而仍然出现问题，那么，唯一的解释就是pthread_create会导致内存泄露! pthread_create创建的线程结束后，系统并未回收其资源，从而导致了泄露。然后从网上查了相关资料如下：
　　线程的分离状态决定一个线程以什么样的方式来终止自己。线程的默认属性是非分离状态，这种情况下，原有的线程等待创建的线程结束。只有当pthread_join()函数返回时，创建的线程才算终止，才能释放自己占用的系统资源。而分离线程不是这样子的，它没有被其他的线程所等待，自己运行结束了，线程也就终止了，马上释放系统资源。程序员应该根据自己的需要，选择适当的分离状态。
　　从上面的描述中可以得知如果调用pthread_create函数创建一个默认非分离状态的线程，如果不用pthread_join()函数，线程结束时并不算终止，所以仍然会占用系统资源。
7. detach的第二种方式：
可以调用 pthread_detach() 函数分离线程：
　　pthread_t tid;
　　pthread_create(&tid, NULL, test, NULL);
　　pthread_detach(tid);
　　当然，也可以在 thread function 中调用。
　　void* test(void* arg)
　　{
　　…..
　　pthread_detach(pthread_self());
　　return NULL;
　　}
8. C++版本的pthread和threadpool 参见...brain项目。
