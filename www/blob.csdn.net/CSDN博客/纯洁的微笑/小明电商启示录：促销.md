# 小明电商启示录：促销 - 纯洁的微笑 - CSDN博客
2018年12月26日 09:09:00[微笑很纯洁](https://me.csdn.net/ityouknow)阅读数：54
![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/PgqYrEEtEnrnarTt8jAGnemGV8N0LSB1eFk71oA84c2TXvG68EWJIqia4Te4d8CFDKspFhwCic6OlAqVY7DLlJ7g/640?wx_fmt=jpeg)
优惠促销平台的总结:
- 
领券次数的设计#领券#
- 
领取次数的设计#优惠#
- 
算价公式#优惠#
- 
优惠分摊#优惠#
- 
促销模型（promo）#优惠#
- 
优惠优先级#优惠#
- 
优惠互斥#优惠#
- 
优惠类型#优惠#
- 
算价流程#优惠#
- 
算价单位#优惠#
本文将从上述十个方面分别简述。
一:领券次数的设计#领券#
常见的限制有：
- 
每个用户在某个活动中最多领取N张。
- 
每个活动最多领取M张。
**1.最简单粗暴的方式:**
使用insert select where语句。
**优点:**表少。
**缺点:**查询量比较大。where条件可能涉及user_id,coupon_code和activity_id。为此要设计多个索引。索引的增加又影响插入性能。
**2.麻烦但合理的方式:**
增加领券记录表(receive_code,activity_id,receive_count)。
每成功领取一张，receive_count加1。
**receivec_code是关键设计。**
- 
如果是每个用户在某个活动中最多领取N张，则编码为user_id:activity_id。为什么不是activity_id。因为user_id数量远大于活动数量。以user_id开头更容易利用索引。
- 
如果是每个活动最多领取M张，则编码是activity_id。
- 
如果一个活动既有用户限制，又有活动限制，则在领券时更新两条记录。
领取记录如何初始化? 使用insert on duplicate key update。
领取成功与否根据返回上述sql的返回值判断。
二:领取次数的设计#优惠#
存储次数的方式有两种:
**方式一:扣减**。初始值为最大值，每领取1张减1。
**优点:**只要判断receive_count>=0，就可确认是否有资格领取。计算剩余次数方便。
**缺点:**max_receive_count调整后，需更新所有领取记录。
**方式二:累加**。初始值为0，每领取1张加1。
**优点:**调整max_receive_count时，不改动领取记录。
**缺点:**判断是否有资格领取时，需要实时读取max_receive_count，剩余次数需要实时计算。
为什么会有这两种区别?
这两种本质上解决的问题是一样，只是表达方式不一样。具体的选择要看场景。
举些例子:
某批库存的预扣数(下单成功尚未支付的数量)使用的计数方式为累加方式。
用户领券的剩余次数通常采用扣减方式。
再扩展一下思路:
如果你来设计排序权重。你会选择数值越小，位置越考前。还是数值越大，位置越考前。你的选择如何影响你的代码逻辑？置顶功能怎么写?请想一想。
三:算价公式#优惠#
计算商品价格是每个交易系统逃不过的坎。抛弃复杂的优惠规则，其核心的算价公式就一个:商品售价*数量-sum(优惠金额)=商品小计。
计算出每个商品的小计就能得出订单总价。
广义的商品不仅有sku，运费也是特殊商品。理解了这一点，算价抽象层次就上升了一个台阶。
商品售价来源于定价系统，也可由调用方传入。
优惠活动围绕 商品原价，商品数量和商品小计等要素做各种文章，如:
- 
商品原价:商品7折，第二杯半价，满99包邮
- 
商品数量:买2免1
- 
商品小计:满100减20
算价的核心过程就是计算出优惠在哪些商品上生效，每个商品能得到多少优惠金额。
优惠金额不仅仅只有金额，还有对应的活动id，对应的优惠券码。有了这些信息就可以统计:
- 
商品参加了哪些优惠活动
- 
是否使用了优惠券
- 
每个活动实际产生的优惠金额。
- 
商品享受多少优惠。
这为什么这样设计？这点类似于日志回放。只要记录算价过程中产生各种过程数据，结果可以反复计算。
四:优惠分摊#优惠#
假设5个商品要分摊一个20元的优惠，如何处理才是稳妥的？
按照数量来分摊，还是按照金额占比来分摊?
按照数量明显不对，那只能按照金额。按照金额分摊时要注意哪些事:
- 
商品得到的优惠金额之和要等于优惠金额
- 
分摊时，要按照顺序来分摊，保证稳定性。
**a.如何分摊？**
以分蛋糕为例，妈妈切一块给小明，再切一块给小红，再切一块给小强，最后剩余的一块给小白。
同样的道理:
- 
计算a商品的可分摊金额9.501元，零头抹去，得9.50元。剩余10.5元。
- 
计算b商品的可分摊金额6.00元，得6.00元，剩余4.5元。
- 
c商品是最后一个商品，直接得4.5元，剩余0元。
**b.注意事项**
- 
抹去的零头会累计到剩余优惠金额。
- 
虽然用了乘法导致精度损失，但是在分摊过程中，使用的是减法，总分摊金额不受影响。
- 
优惠金额是40元，但商品实际金额只有20元，如何处理？在分摊之前进行预处理，取最小优惠金额。
- 
分摊过程中，涉及到比例的计算，可以用bigdecimal，但结果要转为int或long。
- 
同时注意舍入方式，建议使用截断的方式，不做四舍五入。
五:促销模型（promo）#优惠#
我把促销分为两部分:**外部活动**和**内部优惠**。
**外部活动**包含活动基本要素和外部系统要素。
- 
活动基本要素:名称，有效期，活动方式。
- 
外部系统要素:积分，新老用户，用户等级，店铺列表，下单量，购买渠道，论坛帖子数。
基本要素中的活动方式很重要，可以是全场活动，可以是优惠券，也可是口令。当活动方式为优惠券时可以设置总券数和用户可领取券数。
优惠对接的外部系统越多，可用的外部要素越多，但算价接口入参也越多。
**内部优惠**依托于算价公式的各种要素。用一句话来说概括:在满足特定条件的情况下，指定范围的商品可以享受特定优惠。这些优惠按照各种角度可以整理为:
- 
优惠要素:商品单价调整，商品小计调整。
- 
商品类型:运费调整，sku调整。
- 
数值类型:按比例调整，按固定数值调整。
组合太多，为了便于开展业务，可以整理为几种优惠类型:
- 
商品单价打折，商品金额减价
- 
运费单价打折，运费金额调整
- 
免邮，免单
- 
赠送商品
**为什幺分成两部分？**
a.按照改动风险来说:
外部活动变动对算价影响小，开发难度低，测试成本低。
内部优惠变动对算价影响大，开发难度高，测试成本高。
b.按照变化程度来说:
外部活动灵活，内部优惠求稳，两者要隔离。
六:优惠优先级#优惠#
**1.为什么要有优惠优先级？**
举个例子，营销搞了n全场活动:全场满200减40,图书品类7折，小家电8折，还有神券满200减100。如果没有优先级，怎么算价。
优先级分三种:活动优先级，不同优惠优先级，同种优惠优先级。
默认优先级如下:
a.活动优先级:全场>优惠券
b.不同优惠优先级:
- 
免单>商品单价调整>商品小计调整。
- 
赠送>非赠送
- 
sku>运费
c.同种优惠优先级
满400减80 >满200减40>满100减20
**2.优先级能调整？**
能调整，但只能调整同种优惠优先级。这种调整方式的影响范围小，可控。
其他类型的优先级设置为不可整。如果能调整，运营可能都搞不清楚优惠后的金额。
**3.优先级如何影响算价？**
在算价过程中，需要把可用的优惠组成链（chain）。chain的节点顺序需要按照优先级进行排列。先处理高优先级的优惠，再处理低优先级的。
七:优惠互斥#优惠#
为什么要有优惠互斥？假如有三个活动:满600减300，满400减200，满200减100的活动，如果用户下单金额为700，在没有互斥规则的情况下，最终只有700-300-200-100=100。所以要引入互斥。
互斥的方式有两种:商品项的**唯一互斥**和商品项的**排他互斥。**
**a.唯一互斥**
每个商品项在同一种活动方式下只能参加一种优惠类型。换成数据库的说法是（商品项，活动方式，优惠方式）是唯一主键。
举个例子：购买一台3999手机手机可以参加全场满2000减500的活动，又可以使用一张满200减100的代金券。但不能同时参加两个全场的满减活动。
**b.排他互斥**
商品享受某种优惠后，不能再参加其他优惠。
如参加商品单价调整（打折）的商品不能再享受商品小计调整的优惠（满减）。参加全场满减优惠的商品不能再使用优惠券的优惠。
举个例子:购买3999手机享受满4000减2000的优惠后，不能再使用优惠券。
**c.对算价的影响？**
在算价过程中，需要为商品算价项增加 排斥优惠列表，在又要优惠金额中增加属性记录优惠金额所属的活动方式和优惠方式。
在判断优惠能生效在哪些商品时，都必须看看是否有互斥规则。
不得不感慨:算价的坑真深
八:优惠类型#优惠#
优惠特别多，为此需要将优惠归纳为n种优惠类型。问题来了，每种优惠类型覆盖的条件和优惠效果有哪些？因此需要总一下。
**1.优惠条件的划分:**
a.sku范围:
- 
包含哪些sku
- 
排斥哪些sku
- 
包含哪些运营类目
- 
排除哪些运营类目
b.金额范围:
- 
订单商品金额累超过x元
- 
指定sku累计金额超过y元
c.数量范围:
sku数量超过n个
d.运输方式:
运输方式为平邮
e.特殊:
跳过优惠条件。
**2.优惠效果的划分：**
a.商品价格调整:
- 
新商品价格调整为老价格的m%
- 
新商品价格下调n%。
- 
新商品价格调整为x元
- 
新商品价格下调y元
- 
商品包含sku和运费。
b.商品小计调整类型如下:
- 
小计下调x元。
- 
小计下调n%
c.其他类型太多，就不列举了。
**3.对算价的影响**
a.编写算价代码，更好组织逻辑。
以sku范围为例，可以提炼出SkuFinder，专门用于过滤。倘若增加新的sku范围条件，也只需要修改SkuFinder,修改范围小，测试成本低。
b.好的分类，是成功的一半。
分类的好处使得代码逻辑更周全，不容易遗漏。同时可尽量复用逻辑，而避免产生太多重复代码。
九:算价流程#优惠#
有了优惠，有了订单，如何计算金额？此时需要用算价流程将之串联。
**a.筛选活动**
目的是找出生效中的促销活动。考虑到性能，避免网络io。可以将活动数据读入本地内存。通过定时刷新+mq刷新保证活动数据的一致性。
全场活动的过滤比较复杂，过滤条件与外部活动要素有关，如:用户积分，商店id，下单时间，购买渠道等等。
优惠券活动通过活动id反查即可。
此外可以增加一些特殊活动，处理历史逻辑。
**b.初始化金额**
商品金额可以从定价系统读取，也可以通过接口传入。
金额建议转化成最小辅币单位，以Long或Integer存储。调整jvm参数【-XX:AutoBoxCacheMax=NNN】可提高部分性能。
**c.构建算价链**
找出有效活动之后，就可以转为chain。一个活动
对应一个算价节点。
根据已定义好的优先级对chain进行排序。
另外支持自定义排序，需要调用方传入已排序的活动id列表。
同时对商品项也做排序，防止同样商品项因加入顺序不一致，导致商品价格有差异。
**d.计算包邮金额**
在购物车展示包邮金额。
但包邮活动已经通过promo进行配置，放弃静态配置。同时可能还有其他活动导致包邮金额降低，如618活动，订单39元包邮。海外电商的运费死贵死贵，除非买了amazon的prime会员。所以运费活动还是有的。
因此需要计算出最低消费金额。
**e.反复执行算价。**
执行算价的过程分为两部分:判断订是否符合条件(match)，为指定范围的商品计算分摊优惠金额(calcAndshare)。
1.match逻辑:
要基于SkuFinder,SkuCounter,SkuAmounter，为每种优惠类型定制条件过滤，比如参加5折的商品不能再参加满减。因此在满减的算价逻辑中，要设置【排斥参加折扣优惠商品】。
2.calcAndShare逻辑:
- 
找出可分摊的商品时，要考虑到互斥条件!!!
- 
计算可优惠金额时，注意金额的四舍五入逻辑，注意对比可优惠金额与当前的商品小计。及时处理可优惠金额为0的情况。
- 
分摊可优惠金额时，要采取合理的分摊方式。底线是可优惠金额=sum（商品分摊金额）
**f.组装算价结果**
组装算价逻辑比较简单，需要输出核心结果有
- 
商品项的累计优惠金额
- 
商品项的最新小计
- 
商品项的现价
- 
商品项的定价
- 
现价是原价的x%
- 
现价相比原价下降y%
这些计算可能会产生重复调用，因此引入缓存记录计算结果。简单统计，可减少1/3的计算量。
十:算价单位#优惠#
**1.为什么要有算价单位?**
手机在美国卖699.99刀，在韩国卖688,000韩元。在印度买3,999卢比。
因此给韩国用户计算优惠金额时，不希望出现价格为14,247,147.12韩元的情况。给印度用户计算金额时不希望出现3567.23的价格。要去掉小数，但是不能影响金额计算。
因此需要引入算价单位来解决此问题。
**2.了解换算关系**
大部分国家都有主币和辅币，但日韩没有辅币。
虽然印度有辅币，但是在交易过程中，不希望使用辅币，因为购买力小。
通常来说1主币=100辅币，如：1元=100分，1英镑=100便士。
换个角度来说：主币就是整数部分，辅币就是小数部分。
默认情况是1算价单位=0.01主币。如果日韩，则设置为1算价单位=1主币
**3.不同的换算比例如何优惠金额？**
以订单满99元减33％为例（优惠金额向上去整）
1算价单位＝0.01元，优惠金额为3267算价单位，等于32.67元
1算价单位＝0.1元，优惠金额为 327算价单位，等于32.7元
1算价单位＝1元，优惠金额 为33算价单位，等于33元
从上面得知：每个算价单位的兑换比例越低，优惠金额越精确。
**4.引入了算价单位后，在系统上要做哪些调整？**
- 
在初始化商品信息时，对商品价格、运费要进行单位转化。
- 
优惠活动的金额，也要进行转化，包括条件金额和折扣金额。
- 
组装计算结果时，及时转化为原始单位。
-END-
**纯洁的微笑**
**一个有故事的程序员**
![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/PgqYrEEtEnqjV7GOKB2htgfZjgMjqxftxfmmdrLiaMKpyicTmLLX5fUjb6YxA6Z5Bhcozb3p0uMV7wqdKED89HZA/640?wx_fmt=jpeg)
