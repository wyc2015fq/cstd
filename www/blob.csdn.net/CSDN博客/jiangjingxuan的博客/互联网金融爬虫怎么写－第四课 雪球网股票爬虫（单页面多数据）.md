# 互联网金融爬虫怎么写－第四课 雪球网股票爬虫（单页面多数据） - jiangjingxuan的博客 - CSDN博客





2017年02月27日 09:28:55[jiangjingxuan](https://me.csdn.net/jiangjingxuan)阅读数：694








哈哈，我又来了，话说出教程就是这么任性，咱们乘热打铁，把上节课分析完成但是没写的代码给完成了！

> 
工具要求与基础知识：


**工具要求：**

教程中主要使用到了 1、神箭手云爬虫 框架  这个是爬虫的基础，2、Chrome浏览器和Chrome的插件XpathHelper 这个用来测试Xpath写的是否正确 3、Advanced REST Client用来模拟提交请求

**基础知识：**

本教程中主要用到了一些基础的js和xpath语法，如果对这两种语言不熟悉，可以提前先学习下，都很简单。

> 
三步走


还记得我们在遥远的电商系列爬虫教程的第一课里提到具体写爬虫的几个步骤吗？我们沿着路径再来走一遍：

第一步：确定入口URL

暂且使用这个第一页的ajax的url链接：

```
http://xueqiu.com/stock/cata/stocklist.json?page=1&size=30&order=desc&orderby=percent&type=11%2C12
```



第二步：区分内容页和中间页

这次大家有点犯难了，虽然说每一个股票都有一个单独的页面，但是列表页的信息已经蛮多的了，光爬取列表页信息就已经够了，那怎么区分内容页和中间页呢？其实我们只需要将内容页和中间页的正则设置成一样的既可。如下：

```
http://xueqiu.com/stock/cata/stocklist\\.json\\?page=\\d+&size=30&order=desc&orderby=percent&type=11%2C12
```



在提醒大家一下，这里之所以转义符用了两个是因为在神箭手中，设置正则时，是字符串设置，需要对转义符再做一次转义。

第三步：内容页抽取规则

由于ajax返回的是json，而神箭手是支持jsonpath的提取方式的，因此提取规则就很简单了。不过这里要特殊注意的是，由于我们是在列表页抽取数据，因此数据最顶层相当于是一个列表，我们需要在顶层的field上设置一个列表数据的值。具体抽取规则如下：



```
![复制代码](http://common.cnblogs.com/images/copycode.gif)

fields: [

{

name:"stocks",

selector:"$.stocks",

selectorType:SelectorType.JsonPath,

repeated:true,

children:[

{

name:"code",

alias:"代码",

selector:"$.code",

selectorType:SelectorType.JsonPath,

},

{

name:"name",

alias:"名称",

selector:"$.name",

selectorType:SelectorType.JsonPath,

},

{

name:"current",

alias:"当前价格",

selector:"$.current",

selectorType:SelectorType.JsonPath,

},

{

name:"high",

alias:"最高价格",

selector:"$.high",

selectorType:SelectorType.JsonPath,

},

{

name:"low",

alias:"最低价格",

selector:"$.low",

selectorType:SelectorType.JsonPath,

}

]

}

]

![复制代码](http://common.cnblogs.com/images/copycode.gif)
```



我简单抽取了一些信息，其他信息都类似。

好了，主要的代码基本已经写好了，剩下的还需要解决两个问题

1.爬取前需要先访问一下首页获取cookie

2.虽然可以直接加入下一页，但是一共有多少页并不知道。

首先对于第一点，我们只需要在beforeCrawl回调中访问一下首页即可，神箭手会自动对cookie进行处理和保存，具体代码如下：



```
configs.beforeCrawl =function(site){

    site.requestUrl("http://xueqiu.com");

};
```



好了，除了下一页基本已经没什么问题了，我们先测试一下看看效果：

![](http://images2015.cnblogs.com/blog/954944/201607/954944-20160729150413919-1342181450.png)




数据已经出来了，没问题，第一页的数据都有了，那下一页怎么处理呢？我们有两个方案：

第一个方案：

我们可以看到json的返回值中有一个count字段，这个字段目测应该是总数据量的值，那没我们根据这个值，再加上单页数据条数，我们就可以判断总共有多少页了。

第二个方案：

我们先访问一下，假设页数很大，看看会雪球会返回什么，我们尝试访问第500页，可以看到返回值中的stocks是0个，那么我们可以根据是否有数据来判断需不需要加下一页。

两个方案各有利弊，我们这里选择用第一个方案来处理，具体代码如下：



```
![复制代码](http://common.cnblogs.com/images/copycode.gif)

configs.onProcessHelperPage =function(page, content, site){

if(page.url.indexOf("page=1&size=30") !== -1){

//如果是第一页

varresult = JSON.parse(page.raw);

varcount = result.count.count;

varpage_num = Math.ceil(count/30);

if(page_num > 1){

for(vari = 2;i<=page_num;i++){

site.addUrl("http://xueqiu.com/stock/cata/stocklist.json?page="+i+"&size=30&order=desc&orderby=percent&type=11%2C12");

}

}

}

};

![复制代码](http://common.cnblogs.com/images/copycode.gif)
```



好了，通过三课的艰苦奋战，终于完成了雪球沪深一览的征服。先看下跑出来的效果。

![](http://images2015.cnblogs.com/blog/954944/201607/954944-20160729150347763-188220000.png)




完整代码如下：



```
![复制代码](http://common.cnblogs.com/images/copycode.gif)

varconfigs = {

domains: ["xueqiu.com"],

scanUrls: ["http://xueqiu.com/stock/cata/stocklist.json?page=1&size=30&order=desc&orderby=percent&type=11%2C12"],

contentUrlRegexes: ["http://xueqiu.com/stock/cata/stocklist\\.json\\?page=\\d+&size=30&order=desc&orderby=percent&type=11%2C12"],

helperUrlRegexes: ["http://xueqiu.com/stock/cata/stocklist\\.json\\?page=\\d+&size=30&order=desc&orderby=percent&type=11%2C12"],

fields: [

{

name:"stocks",

selector:"$.stocks",

selectorType:SelectorType.JsonPath,

repeated:true,

children:[

{

name:"code",

alias:"代码",

selector:"$.code",

selectorType:SelectorType.JsonPath,

},

{

name:"name",

alias:"名称",

selector:"$.name",

selectorType:SelectorType.JsonPath,

},

{

name:"current",

alias:"当前价格",

selector:"$.current",

selectorType:SelectorType.JsonPath,

},

{

name:"high",

alias:"最高价格",

selector:"$.high",

selectorType:SelectorType.JsonPath,

},

{

name:"low",

alias:"最低价格",

selector:"$.low",

selectorType:SelectorType.JsonPath,

}

]

}

]

};

configs.onProcessHelperPage =function(page, content, site){

if(page.url.indexOf("page=1&size=30") !== -1){

//如果是第一页

varresult = JSON.parse(page.raw);

varcount = result.count.count;

varpage_num = Math.ceil(count/30);

if(page_num > 1){

for(vari = 2;i<=page_num;i++){

site.addUrl("http://xueqiu.com/stock/cata/stocklist.json?page="+i+"&size=30&order=desc&orderby=percent&type=11%2C12");

}

}

}

};

configs.beforeCrawl =function(site){

site.requestUrl("http://xueqiu.com");

};

varcrawler =newCrawler(configs);

crawler.start();

![复制代码](http://common.cnblogs.com/images/copycode.gif)
```

这样我们的雪球网股票爬虫就算大功告成，当然我们还可以把type的设置模板化。不过这个是一些高级的方法，我们会在后面的课程中再去详细描述。



