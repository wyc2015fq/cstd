# TCP为什么需要3次握手与4次挥手 - A784586的专栏：任何事都存在 Plan B ！ - CSDN博客





2017年03月09日 19:35:42[QuJack](https://me.csdn.net/A784586)阅读数：291








1.[TCP为什么需要3次握手与4次挥手](https://www.baidu.com/link?url=37K-ABTBgcPcLpabsjineL_WdzW4aVY7O4JiD1cczpk112Zd8qzW9SD46CP6mcHoc2bVTBsWbs5x177S8Qe4NKI9Ua0vqtiurUkxGvSvDaW&wd=&eqid=ba6f5ea70046f94a0000000358bd01ac)

**为什么是三次握手捏：：：**

**         三次握手可以简单看做是****客户发送请求****，服务器对客户的请求进行****确认****，客户对服务器的确认再进行****确认****。**

**         如果采用两次握手，假设下面这种情况，客户向服务器发送请求，服务器没有对客户的请求进行确认（因为网络的延迟他可能没有收到这个请求）。客户收不到这个确认于是过一段时间他在向服务器发起连接请求并顺利完成数据传输，但是过了一段时间这个请求到达了服务器而服务器误以为这是一个新的连接请求于是对这个请求进行确认并发送确认给客户但是客户没有发起过连接请求因此它不会理会服务器的确认，服务器以为这个连接已经建立好了于是一直等待客户发送数据，这样就会****造成服务器的资源浪费****。如果采用三次握手上述情况客户不会向服务器的确认进行确认，这样服务器收不到确认它就知道客户没有要发起请求的连接，于是不会再等待。**

** 三次握手主要是为了****防止已失效的连接请求报文突然到达服务器，造成服务器的等待和资源的浪费****。**

**为什么是四次挥手捏???**

**        在三次握手的过程中，****SYN和ACK****是一起发送的但是在四次挥手的时候****FIN和ACK****却不是一起发送的而是分开发送的，为什么呢？？？那是因为啊，****TCP连接是全双工****的也就是说接收到FIN只是说没有数据再发过来但是还是可以发送数据的，也就是****接受到一个FIN只是关闭了一个方向的数据传输****，另一个方向还可以继续发送数据。在四次挥手的时候也是这样前两次挥手只是确认关闭了一个方向的数据，加上后面两次挥手才真正的关闭了整个全双工连接。**

**       当socket在****ESTABISHED状态****时，他想主动关闭连接于是向对方发送****FIN请求****，发送完FIN请求后它处于FIN_WAIT_1状态，当对方确认ACK报文后则处于FIN_WAIT_2状态。****FIN_WAIT_2表示半连接****，也就是有一方要求关闭连接，另一方收到请求但是告诉她我还有一些数据要发送稍后会关闭。TIME_WAIT状态表示收到对方的FIN并发送出ACK.****如果三次握手可能在关闭后还有一个方向没有关闭。**






**【注意】中断连接端可以是Client端，也可以是Server端。**

假设Client端发起中断连接请求，也就是发送FIN报文。Server端接到FIN报文后，意思是说"我Client端没有数据要发给你了"，但是如果你还有数据没有发送完成，则不必急着关闭Socket，可以继续发送数据。所以你先发送ACK，"告诉Client端，你的请求我收到了，但是我还没准备好，请继续你等我的消息"。这个时候Client端就进入FIN_WAIT状态，继续等待Server端的FIN报文。当Server端确定数据已发送完成，则向Client端发送FIN报文，"告诉Client端，好了，我这边数据发完了，准备好关闭连接了"。Client端收到FIN报文后，"就知道可以关闭连接了，但是他还是不相信网络，怕Server端不知道要关闭，所以发送ACK后进入TIME_WAIT状态，如果Server端没有收到ACK则可以重传。“，Server端收到ACK后，"就知道可以断开连接了"。Client端等待了2MSL后依然没有收到回复[
 这里应该是重传的FIN ]，则证明Server端已正常关闭，那好，我Client端也可以关闭连接了。Ok，TCP连接就这样关闭了！




**【问题1】为什么连接的时候是三次握手，关闭的时候却是四次握手？**

答：因为当Server端收到Client端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中ACK报文是用来应答的，SYN报文是用来同步的。但是关闭连接时，当Server端收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉Client端，"你发的FIN报文我收到了"。只有等到我Server端所有的报文都发送完了，我才能发送FIN报文，因此不能一起发送。故需要四步握手。

**【问题2】为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？**

答：虽然按道理，四个报文都发送完毕，我们可以直接进入CLOSE状态了，但是我们必须假象网络是不可靠的，有可以最后一个ACK丢失。所以TIME_WAIT状态就是用来重发可能丢失的ACK报文。















