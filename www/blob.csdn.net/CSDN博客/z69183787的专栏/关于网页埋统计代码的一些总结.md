# 关于网页埋统计代码的一些总结 - z69183787的专栏 - CSDN博客
2016年11月30日 11:59:49[OkidoGreen](https://me.csdn.net/z69183787)阅读数：2839
埋点样例
http://xxx.xxxxx.com/dog.gif?__hlt=www.xxxx.com&__ppp=&__had=%7B%22eventid%22%3A6912%2C%22topicid%22%3A1%2C%22type%22%3A%22emidas_activity%22%2C%22reqid%22%3A%221480478515383_ZADVG9%22%2C%22module%22%3A%22emidas_activity_close%22%2C%22source%22%3A%22%22%2C%22kid%22%3A0%2C%22note%22%3A%22%22%2C%22promoid%22%3A%22814ac22a-2c27-9106-86c4-e1cdb0a27cfb%22%2C%22latitude%22%3A%22%22%2C%22longtitude%22%3A%22%22%2C%22version%22%3A%22%22%7D&force=1480478520388&__hsr=1600x900&__hsc=24bit&__hlh=http%3A%2F%2Fevent.meituan.com%2Fmidas%2F1activities%2Fa6912RpzqEWEp1RKI%2Findex.html&__mv=%7C%7C0%7C0
背景:
一个网站上线,开发者除了保证网站功能正常,体验优好之外,还有一项重要的工作是数据收集,通过收集用户的行为数据可以帮助了解网站的功能是否满足用户的需求,导流方式是否有效,新功能上线后是否效果是否达到设计初衷,根据数据指引有效优化产品体验以及发现新的产品方向是产品经理的必备技能,而如何采集准确并且足够的网站数据则应该是开发者的责任.在大数据处理能力越来越强下,以及机器学习等依赖数据哺育的工具进化下,采集足够多的数据往往是网站向着良性方向进化的必备条件;
**工具:**
网站的数据采集有很多现成的工具,如[google Analytics](https://link.zhihu.com/?target=https%3A//www.google.com/analytics/), [百度统计](https://link.zhihu.com/?target=http%3A//tongji.baidu.com/), [友盟+](https://link.zhihu.com/?target=https%3A//web.umeng.com/main.php%3Fc%3Duser%26a%3Dindex)等,往往通过在页面上接入js
 SDK代码,如下图所示![](http://image101.360doc.com/DownloadImg/2016/11/2913/85659743_1.png)
而在实际采集过程中,数据是如何传递过去的呢,我们随便打开一个埋有百度统计的网站, 打开chrome的开发者工具,勾选Preserve log![](http://image101.360doc.com/DownloadImg/2016/11/2913/85659743_2.png)可以发现在页面点击一个链接或者做一些其他操作,在Networking tab下可以看到hm.gif的网络请求, 这里由于统计的数据发送涉及到第三方网址,涉及跨域问题,而图片请求天然是跨域的,所以业界的通用做法是构造一个空的gif用于向第三方网站,
 而真正需要统计的参数往往是通过url进行传递,
如图所示的url 是[http://hm.baidu.com/hm.gif?cc=0&ck=1&cl=24-bit&ds=1920x1200&ep=%5B%7Bx%3A-109%2Cy%3A1691%2Ct%3Aa%2Cu%3Ahttp%253A%252F%252Fwww.tmsf.com%252Finfo%252Fnews_newsinfo_330386914_33_1.htm%7D%5D&et=2&fl=23.0&ja=0&ln=zh-CN&lo=0<=1475204293&nv=0&rnd=1043816232&si=bbb8b9db5fbc7576fd868d7931c80ee1&st=4&su=http%3A%2F%2Fwww.tmsf.com%2F&v=1.1.29&lv=3](https://link.zhihu.com/?target=http%3A//hm.baidu.com/hm.gif%3Fcc%3D0%26ck%3D1%26cl%3D24-bit%26ds%3D1920x1200%26ep%3D%255B%257Bx%253A-109%252Cy%253A1691%252Ct%253Aa%252Cu%253Ahttp%25253A%25252F%25252Fwww.tmsf.com%25252Finfo%25252Fnews_newsinfo_330386914_33_1.htm%257D%255D%26et%3D2%26fl%3D23.0%26ja%3D0%26ln%3Dzh-CN%26lo%3D0%26lt%3D1475204293%26nv%3D0%26rnd%3D1043816232%26si%3Dbbb8b9db5fbc7576fd868d7931c80ee1%26st%3D4%26su%3Dhttp%253A%252F%252Fwww.tmsf.com%252F%26v%3D1.1.29%26lv%3D3)
通过查看分析具体的请求,和业务相关的请求都跟在url里的?之后以'&a=111'对不同的参数进行传递
![](http://image101.360doc.com/DownloadImg/2016/11/2913/85659743_3.png)
这些数据通过统计服务处理后在服务端整合显示的是如下图所示:
![](http://image101.360doc.com/DownloadImg/2016/11/2913/85659743_4.png)
**重要指标:**
pv(页面展现数量), uv(访问用户数), 跳出率(在进入页面后未访问其他页面,未做任何操作后在一定时间内离开该页面的比例), 平均访问时长,访问用户的用户属性(用户特征,使用设备, 地域分布),访问来源(访问网站页面前的上一个页面,往往是导流效果的来源分析),通过以上数据的展示和分析可以得到一个网站的基本访问情况分析.
**数据采集:**
那么如果有些数据这些第三方服务提供方没有提供,或者不想自己网站的数据被第三方掌握,就必须自己搭建一套数据采集平台,这里来说说如果自己搭建的话在前端页面上怎么进行埋点;
首先在本质上我们还是应该创建一个最为基本的发送统计的发送函数,用于创建img,发送统计请求到数据采集平台;
```
function sendUrl(url) {
    let img = new Image();  // 创建一个img对象
    let key = 'project_log_' // 为本次数据请求创建一个唯一id
        + Math.floor(Math.random() * 2147483648).toString(36); 
    window[key] = img;   // 用一个数组维护img对象
    img.onload = img.onerror = img.onabort = function () {
        img.onload = img.onerror = img.onabort = null;  // 清除img元素
        window[key] = null;
        img = null;  
    };
    img.src = url;  // img对象赋值url后自动发送请求,无需插入到页面元素中去
}
```
然后定义一套数据格式规则,如:1.gif?q=xxx&fr=xxx&refer=xxx&p=xxxx&xxxxx
q表示页面搜索词; fr表示页面的上游页面时什么, refer是指从来源页面, p表示事件类型等;
常用指标的统计方法:
**访问时长:**
```
var st = new Date().getTime();  // 在页面加载运行js时记录当前时间
$(window).on('beforeunload', function () {
    var et = new Date().getTime();
    var stayTime = et - st;
    
}); // 在页面要unload触发'beforeunload'事件时进行时间差计算得到访问时长
```
**聚焦时间:**
与访问时间不同,由于页面可以通过tab切换导致虽然页面没有unload但实际处于失去焦点状态, 因此需要订阅focusIn与focusOut两个事件,在focusIn时开始计时, 在focusOut时停止计时,在页面unload时将focus时间进行累加得到聚焦时间;
**Pv:**
传统意义上每次页面刷新代表着一次新的pv, 也就是每次统计js执行时都+1, 而现在页面很多都用到了ajax技术来进行无刷新获取展现页面来替代翻页,如瀑布流页面通过下来加载新的页面,这时候页面不重新刷新,因此可以在ajax请求接口处进行埋点进行pv累加;
**单项PV:**
页面上部分元素有单独统计pv的需要,有些页面元素不是页面展现都展现,或者需要统计类似于某一广告的展现次数,这种需要需要在url里单独定义参数来标识;
**事件:**
以click事件为例,类似于绑定事件的过程,在click响应函数中获取元素的对象, 如下所示, tracker是定义的发送埋点数据的模块,在对应事件发生时,除了定义了事件类型之外,一般还需要获取发生事件元素的一些特征参数,如:元素名,元素包含的text, id等;
```
$('.topic-list a').on('click', function () {
        if (!$(this).data('tid')) {
             return;
        }
        tracker.send({
              'p': tracker.events.list.click.topic,
              'rec_topic_title': $(this).text(),
              'rec_topic_id': $(this).data('tid')
        });
});
```
hover这一事件需要监听元素从mouseEnter事件到mouseOut事件触发时间大于一定时间,比如500ms可以视作一次hover触发.
