# spring+jotm 多数据源事务管理(二)hibernate - z69183787的专栏 - CSDN博客
2014年04月02日 10:31:12[OkidoGreen](https://me.csdn.net/z69183787)阅读数：965
JOTM (Java Open Transaction Manager)是由ObjectWeb协会开发的功能完整的且资源开放的独立的事务管理器。
它提供了 JAVA 应用程序的事务支持，而且与 JTA（ JAVA 事务 API）兼容。您可以在[JOTM home page](http://jotm.objectweb.org/) 了解到更多的详细信息。
**下载地址：[http://forge.ow2.org/projects/jotm/](http://forge.ow2.org/projects/jotm/)**
本文介绍如何在spring配置文件中加入jotm来实现多数据源事务控制。
使用hibernate关联jotm也很方便，先看一个没有使用jotm的例子：
Xml代码  ![收藏代码](http://hanqunfeng.iteye.com/images/icon_star.png)
- <?xmlversion="1.0"encoding="UTF-8"?>
- <beansxmlns="http://www.springframework.org/schema/beans"
- xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"xmlns:p="http://www.springframework.org/schema/p"
- xmlns:aop="http://www.springframework.org/schema/aop"xmlns:context="http://www.springframework.org/schema/context"
- xmlns:tx="http://www.springframework.org/schema/tx"xmlns:util="http://www.springframework.org/schema/util"
- xmlns:jee="http://www.springframework.org/schema/jee"
- xsi:schemaLocation="  
-             http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd  
-             http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd  
-             http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd  
-             http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd  
-             http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.5.xsd  
-             http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.5.xsd">
- 
- 
- <beanid="dataSource1"
- class="org.apache.commons.dbcp.BasicDataSource">
- <propertyname="driverClassName">
- <value>${datasource1.driver}</value>
- </property>
- <propertyname="url">
- <value>${datasource1.url}</value>
- </property>
- <propertyname="username">
- <value>${datasource1.username}</value>
- </property>
- <propertyname="password">
- <value>${datasource1.password}</value>
- </property>
- <propertyname="initialSize">
- <value>5</value>
- </property>
- <propertyname="maxActive">
- <value>10</value>
- </property>
- </bean>
- 
- <beanid="dataSource2"
- class="org.apache.commons.dbcp.BasicDataSource">
- <propertyname="driverClassName">
- <value>${datasource2.driver}</value>
- </property>
- <propertyname="url">
- <value>${datasource2.url}</value>
- </property>
- <propertyname="username">
- <value>${datasource2.username}</value>
- </property>
- <propertyname="password">
- <value>${datasource2.password}</value>
- </property>
- <propertyname="initialSize">
- <value>5</value>
- </property>
- <propertyname="maxActive">
- <value>10</value>
- </property>
- </bean>
- 
- <beanid="sessionFactory1"
- class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
- <propertyname="dataSource"ref="dataSource1"/>
- <propertyname="mappingLocations"value="${das.mapping.locations}"/>
- <propertyname="hibernateProperties">
- <props>
- <propkey="hibernate.dialect">
-                     ${hibernate.dialect}  
- </prop>
- <propkey="hibernate.show_sql">
-                     ${hibernate.show_sql}  
- </prop>
- <propkey="hibernate.use_sql_comments">
-                     ${hibernate.use_sql_comments}  
- </prop>
- </props>
- </property>
- </bean>
- 
- 
- <beanid="sessionFactory2"
- class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
- <propertyname="dataSource"ref="dataSource2"/>
- <propertyname="mappingLocations"value="${history.mapping.locations}"/>
- <propertyname="hibernateProperties">
- <props>
- <propkey="hibernate.dialect">
-                     ${hibernate.dialect}  
- </prop>
- <propkey="hibernate.show_sql">
-                     ${hibernate.show_sql}  
- </prop>
- <propkey="hibernate.use_sql_comments">
-                     ${hibernate.use_sql_comments}  
- </prop>
- </props>
- </property>
- </bean>
- 
- 
- 
- 
- <beanid="transactionManager1"
- class="org.springframework.orm.hibernate3.HibernateTransactionManager">
- <propertyname="sessionFactory"ref="sessionFactory1"/>
- </bean>
- <beanid="transactionManager2"
- class="org.springframework.orm.hibernate3.HibernateTransactionManager">
- <propertyname="sessionFactory"ref="sessionFactory2"/>
- </bean>
- 
- <aop:configproxy-target-class="true">
- <aop:pointcutid="servicePoint1"
- expression="execution (* com.xxx.function..service.*.*Service*.*(..))"/>
- <aop:advisorpointcut-ref="servicePoint1"id="txAdvisor1"
- advice-ref="txAdvice1"/>
- </aop:config>
- 
- <aop:configproxy-target-class="true">
- <aop:pointcutid="servicePoint2"
- expression="execution (* com.xxx.function..service.*.*Service*.*(..))"/>
- <aop:advisorpointcut-ref="servicePoint2"id="txAdvisor2"
- advice-ref="txAdvice2"/>
- </aop:config>
- 
- 
- <tx:adviceid="txAdvice1"transaction-manager="transactionManager1">
- <tx:attributes>
- <tx:methodname="find*"read-only="true"/>
- <tx:methodname="get*"read-only="true"/>
- <tx:methodname="query*"read-only="true"/>
- <tx:methodname="load*"read-only="true"/>
- <tx:methodname="add*"propagation="REQUIRED"rollback-for="java.lang.Exception"/>
- <tx:methodname="create*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="save*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="update*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="modify*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="delete*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="remove*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="apply*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="handle*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- </tx:attributes>
- </tx:advice>
- <tx:adviceid="txAdvice2"transaction-manager="transactionManager2">
- <tx:attributes>
- <tx:methodname="find*"read-only="true"/>
- <tx:methodname="get*"read-only="true"/>
- <tx:methodname="query*"read-only="true"/>
- <tx:methodname="load*"read-only="true"/>
- <tx:methodname="add*"propagation="REQUIRED"rollback-for="java.lang.Exception"/>
- <tx:methodname="create*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="save*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="update*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="modify*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="delete*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="remove*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="apply*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="handle*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="do*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- </tx:attributes>
- </tx:advice>
- 
- 
- </beans>
    下面看加入jotm的例子：
Xml代码  ![收藏代码](http://hanqunfeng.iteye.com/images/icon_star.png)
- <?xmlversion="1.0"encoding="UTF-8"?>
- <beansxmlns="http://www.springframework.org/schema/beans"
- xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"xmlns:p="http://www.springframework.org/schema/p"
- xmlns:aop="http://www.springframework.org/schema/aop"xmlns:context="http://www.springframework.org/schema/context"
- xmlns:tx="http://www.springframework.org/schema/tx"xmlns:util="http://www.springframework.org/schema/util"
- xmlns:jee="http://www.springframework.org/schema/jee"xmlns:security="http://www.springframework.org/schema/security"
- xsi:schemaLocation="  
-             http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd  
-             http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd  
-             http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd  
-             http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd  
-             http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.5.xsd  
-             http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.5.xsd  
-             http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.xsd"  
- default-lazy-init="true">
- 
- 
- <beanid="jotm"class="org.springframework.transaction.jta.JotmFactoryBean"/>
- 
- <beanid="transactionManager"
- class="org.springframework.transaction.jta.JtaTransactionManager">
- <propertyname="userTransaction"ref="jotm"/>
- </bean>
- 
- <beanid="dataSource1"class="org.enhydra.jdbc.pool.StandardXAPoolDataSource"
- destroy-method="shutdown">
- <propertyname="dataSource">
- <beanclass="org.enhydra.jdbc.standard.StandardXADataSource"
- destroy-method="shutdown">
- <propertyname="transactionManager"ref="jotm"/>
- <propertyname="driverName"value="${datasource1.driver}"/>
- <propertyname="url"value="${datasource1.url}"/>
- </bean>
- </property>
- <propertyname="user"value="${datasource1.username}"/>
- <propertyname="password"value="${datasource1.password}"/>
- </bean>
- 
- <beanid="dataSource2"class="org.enhydra.jdbc.pool.StandardXAPoolDataSource"
- destroy-method="shutdown">
- <propertyname="dataSource">
- <beanclass="org.enhydra.jdbc.standard.StandardXADataSource"
- destroy-method="shutdown">
- <propertyname="transactionManager"ref="jotm"/>
- <propertyname="driverName"value="${datasource2.driver}"/>
- <propertyname="url"value="${datasource2.url}"/>
- </bean>
- </property>
- <propertyname="user"value="${datasource2.username}"/>
- <propertyname="password"value="${datasource2.password}"/>
- </bean>
- 
- 
- 
- 
- <beanid="sessionFactory1"
- class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
- <propertyname="dataSource"ref="dataSource1"/>
- <propertyname="mappingLocations"value="${hibernate.mapping.locations}"/>
- <propertyname="hibernateProperties">
- <props>
- <propkey="hibernate.dialect">
-                     ${hibernate.dialect}  
- </prop>
- <propkey="hibernate.show_sql">
-                     ${hibernate.show_sql}  
- </prop>
- <propkey="hibernate.use_sql_comments">
-                     ${hibernate.use_sql_comments}  
- </prop>
- </props>
- </property>
- </bean>
- 
- 
- <beanid="sessionFactory2"
- class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
- <propertyname="dataSource"ref="dataSource2"/>
- <propertyname="mappingLocations"value="${hibernate.mapping.special}"/>
- <propertyname="hibernateProperties">
- <props>
- <propkey="hibernate.dialect">
-                     ${hibernate.dialect}  
- </prop>
- <propkey="hibernate.show_sql">
-                     ${hibernate.show_sql}  
- </prop>
- <propkey="hibernate.use_sql_comments">
-                     ${hibernate.use_sql_comments}  
- </prop>
- </props>
- </property>
- </bean>
- 
- <aop:configproxy-target-class="true">
- <aop:pointcutid="servicePoint"
- expression="execution (* com.xxx.function.*.service.*.*Service*.*(..))"/>
- <aop:advisorpointcut-ref="servicePoint"id="txAdvisor"
- advice-ref="defaultTxAdvice"/>
- </aop:config>
- 
- <tx:adviceid="defaultTxAdvice"transaction-manager="transactionManager">
- <tx:attributes>
- <tx:methodname="find*"read-only="true"/>
- <tx:methodname="get*"read-only="true"/>
- <tx:methodname="query*"read-only="true"/>
- <tx:methodname="load*"read-only="true"/>
- <tx:methodname="add*"propagation="REQUIRED"rollback-for="java.lang.Exception"/>
- <tx:methodname="create*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="save*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="update*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="modify*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="delete*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="remove*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="apply*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- <tx:methodname="handle*"propagation="REQUIRED"
- rollback-for="java.lang.Exception"/>
- </tx:attributes>
- </tx:advice>
- 
- 
- 
- </beans>
 另外，在使用jotm时，可能会抛如下异常：
Java代码  ![收藏代码](http://hanqunfeng.iteye.com/images/icon_star.png)
- java.lang.NoSuchMethodError at:sun.rmi.transport.ObjectTable.getStub(Ljava/rmi/Remote;)Ljava/rmi/server/RemoteStub;  
此时，在项目编译路径下新建一个属性文件，名称：carol.properties，即可解决问题。
Java代码  ![收藏代码](http://hanqunfeng.iteye.com/images/icon_star.png)
- # JNDI (Protocol Invocation)  
- carol.protocols=jrmp  
- # Local RMI Invocation  
- carol.jvm.rmi.local.call=true
- # do not use CAROL JNDI wrapper  
- carol.start.jndi=false
- # do not start a name server  
- carol.start.ns=false
- carol.start.rmi=false
- # Naming Factory  
- carol.jndi.java.naming.factory.url.pkgs=org.apache.naming  
- 
ok。
