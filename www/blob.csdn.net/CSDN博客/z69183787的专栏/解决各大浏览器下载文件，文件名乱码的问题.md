# 解决各大浏览器下载文件，文件名乱码的问题 - z69183787的专栏 - CSDN博客
2018年06月30日 20:55:19[OkidoGreen](https://me.csdn.net/z69183787)阅读数：2850
https://blog.csdn.net/fengchao2016/article/details/55188805
最近做项目，采用Spring MVC做控制层，下载文件的文件名总是在主流浏览器上显示乱码，Firfox不是乱码了，IE下又成了乱码。也是烦，IE总是独树一帜，没办法，只能让程序去适应，在网上也搜索了很多，但是解决的不理想，主要是IE11作为主流浏览器后，很多人之前提出的方案都失效了。 
简单来说，之前使用request获取header中的user-agent，通过MSIE关键字来判断是否是IE浏览器，如果是IE浏览器，使用utf-8对文件名编码就可以了。然而，IE11的user-agent已经没有了MSIE关键字了，下面就是IE11的request header：
```xml
```
- 
    User-Agent:Mozilla/5.0 (Windows NT 6.3; WOW64; Trident/7.0; LCJB; rv:11.0) like Gecko  
- 
可以看出，MSIE关键字已经没有，但是咱们还可以使用Trident关键字来判断 ，然而，我在使用win10上的Edge浏览器进行下载时，仍然是乱码，仔细看，原来Edge浏览器的user-agent又发生了变化，MSIE和Trident关键字都没有了，增加了Edge关键字，当前我用电脑还是win8，这里就不贴出最新的Edge浏览器的request header了，感兴趣的可以进开发者模式看一下。
解决方案如下：
好了，我们现在需要使用Trident和Edge关键字来判断是否是微软的浏览器（微软抛弃了IE，开始使用Edge了），代码如下(判断是否是ie浏览器如下)：
```xml
```
- 
    public class HttpUtils {  
- 
        private static String[] IEBrowserSignals = {"MSIE", "Trident", "Edge"};  
- 
- 
        public static boolean isMSBrowser(HttpServletRequest request) {  
- 
            String userAgent = request.getHeader("User-Agent");  
- 
            for (String signal : IEBrowserSignals) {  
- 
                if (userAgent.contains(signal))  
- 
                    return true;  
- 
            }  
- 
            return false;  
- 
        }  
- 
    }  
那么在下载时，首先判断是否是微软的浏览器，如果是，用utf-8对文件名进行编码，如果不是，使用万能解决乱码代码：
```xml
```
- 
               response.setContentType("application/octet-stream");  
- 
               boolean isMSIE = HttpUtils.isMSBrowser(request);  
- 
               if (isMSIE) {  
- 
	            //IE浏览器的乱码问题解决
- 
                    fileName = URLEncoder.encode(fileName, "UTF-8");  
- 
               } else {  
- 
	            //万能乱码问题解决
- 
                    fileName = new String(fileName.getBytes("UTF-8"), "ISO-8859-1");  
- 
               }  
- 
               response.setHeader("Content-disposition", "attachment;filename=\"" + fileName + "\"");  
- 
               //剩下的就是将文件流输出到response  
- 
	       //FileCopyUtils.copy(inputStream, response.getOutputStream);
这样就可以在目前IE8-IE11、Edge、Firefox和chrome浏览器下载文件时，中文字符不再乱码了。
ps：Firefox下载英文+中文组合的文件名的问题，注意这句话：
```xml
response.setHeader("Content-disposition","attachment;filename=\"" + fileName + "\"");
```
设置response的Content-disposition项时，filename的值要加上双引号，如果不加双引号，在Firefox下载文件时，如果文件名是英文+中文的组合，比如：dota2的新手攻略.docx,这个文件在Firefox下载时，下载下来的文件名只有dota2了。只有加了双引号后，文件名才和代码设置的文件名一致。因为这个双引号是在字符串里，所需需要加反斜杠\来进行转义。
