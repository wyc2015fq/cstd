# httpclient4.5获取和设置cookie - z69183787的专栏 - CSDN博客
2017年11月25日 00:12:55[OkidoGreen](https://me.csdn.net/z69183787)阅读数：9735
```java
public static void main(String[] args) {
    CookieStore cookieStore = new BasicCookieStore();
	CloseableHttpClient httpClient = HttpClients.custom()
             .setDefaultCookieStore(cookieStore)
             .build();
     try {
     	
          HttpPost post = new HttpPost("http://www.baiduc.com");
          BasicClientCookie cookie = new BasicClientCookie("name", "zhaoke"); 
          cookie.setVersion(0);  
          cookie.setDomain("/pms/");   //设置范围
          cookie.setPath("/"); 
          cookieStore.addCookie(cookie);
          httpClient.execute(post);//
          List<Cookie> cookies = cookieStore.getCookies();
          for (int i = 0; i < cookies.size(); i++) {
              System.out.println("Local cookie: " + cookies.get(i));
          }
        } catch (Exception e) {
			e.printStackTrace();
		}finally{
			
		}
	}
```
# 一、HttpClient简介
    HttpClient是一个客户端的HTTP通信实现库，它不是一个浏览器。关于HTTP协议，可以搜索相关的资料。它设计的目的是发送与接收HTTP报文。它不会执行嵌入在页面中JavaScript代码，所以当需要抓取通过AJAX技术获取实际内容的页面时需要使用WebClient等其他开源库。HttpClient最新版已经到第5版，但已经稳定的应该是4.5.2版本，官方网址：[http://hc.apache.org/](http://hc.apache.org/)。
# 二、HttpClient简单使用
    HttpClient的主要用途是接收HTTP响应的内容，下面介绍HttpClient的简单使用，抓取博客园的首页。至于HttpClient4.5的常用API可以参考这篇文章：[http://liangbizhi.github.io/httpclient-4-3-x-chapter-1/](http://liangbizhi.github.io/httpclient-4-3-x-chapter-1/)。
```
```java
package
```
```java
com.httpclient.demo;
```
```java
import
```
```java
java.io.IOException;
```
```java
import
```
```java
java.nio.charset.Charset;
```
```java
import
```
```java
java.util.regex.Matcher;
```
```java
import
```
```java
java.util.regex.Pattern;
```
```java
import
```
```java
org.apache.http.HttpEntity;
```
```java
import
```
```java
org.apache.http.HttpStatus;
```
```java
import
```
```java
org.apache.http.client.ClientProtocolException;
```
```java
import
```
```java
org.apache.http.client.methods.CloseableHttpResponse;
```
```java
import
```
```java
org.apache.http.client.methods.HttpGet;
```
```java
import
```
```java
org.apache.http.entity.ContentType;
```
```java
import
```
```java
org.apache.http.impl.client.CloseableHttpClient;
```
```java
import
```
```java
org.apache.http.impl.client.HttpClients;
```
```java
import
```
```java
org.apache.http.util.EntityUtils;
```
```java
public
```
```java
class
```
```java
SimpleHttpClient
 {
```
```java
```
```java
//
 使用HttpClient获取博客园首页
```
```java
```
```java
public
```
```java
static
```
```java
void
```
```java
main(String[]
 args)
```
```java
throws
```
```java
ClientProtocolException,
 IOException {
```
```java
```
```java
String
 targetUrl =
```
```java
"http://www.cnblogs.com/"
```
```java
;
```
```java
```
```java
```
```java
//
 1.建立HttpClient对象
```
```java
```
```java
CloseableHttpClient
 client = HttpClients.createDefault();
```
```java
```
```java
//
 2.建立Get请求
```
```java
```
```java
HttpGet
 get =
```
```java
new
```
```java
HttpGet(targetUrl);
```
```java
```
```java
//
 3.发送Get请求
```
```java
```
```java
CloseableHttpResponse
 res = client.execute(get);
```
```java
```
```java
//
 4.处理请求结果
```
```java
```
```java
if
```
```java
(res.getStatusLine().getStatusCode()
 == HttpStatus.SC_OK) {
```
```java
```
```java
HttpEntity
 entity = res.getEntity();
```
```java
```
```java
ContentType
 contentType = ContentType.getOrDefault(entity);
```
```java
```
```java
Charset
 charset = contentType.getCharset();
```
```java
```
```java
String
 mimeType = contentType.getMimeType();
```
```java
```
```java
//
 获取字节数组
```
```java
```
```java
byte
```
```java
[]
 content = EntityUtils.toByteArray(entity);
```
```java
```
```java
if
```
```java
(charset
 ==
```
```java
null
```
```java
)
 {
```
```java
```
```java
//
 默认编码转成字符串
```
```java
```
```java
String
 temp =
```
```java
new
```
```java
String(content);
```
```java
```
```java
String
 regEx =
```
```java
"(?=<meta).*?(?<=charset=[\\'|\\\"]?)([[a-z]|[A-Z]|[0-9]|-]*)"
```
```java
;
```
```java
```
```java
Pattern
 p = Pattern.compile(regEx, Pattern.CASE_INSENSITIVE);
```
```java
```
```java
Matcher
 m = p.matcher(temp);
```
```java
```
```java
if
```
```java
(m.find()
 && m.groupCount() ==
```
```java
1
```
```java
)
 {
```
```java
```
```java
charset
 = Charset.forName(m.group(
```
```java
1
```
```java
));
```
```java
```
```java
}
```
```java
else
```
```java
{
```
```java
```
```java
charset
 = Charset.forName(
```
```java
"ISO-8859-1"
```
```java
);
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
```
```java
System.out.println(
```
```java
new
```
```java
String(content,
 charset));
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
}
```
```
# 三、HttpClient模拟登陆
     HTTP协议本来是无状态的，但为了保持会话的状态，使用Cookie保存Session信息，当向服务器发送请求时会附加一些会话信息，从而能区分不同会话的状态。用户登陆过程，其实简单而言，就是首先验证用户名与密码，然后服务器生成会话信息保存到本地，最后用户凭借会话信息能够访问类似用户信息等需登陆的网页。
    HttpClient4.5通过CookieStore保存用户的会话信息，还提供HttpClientContext保存用户连接的信息。下面是一个使用HttpClient模拟知乎登陆的简单案例。
```
```java
package
```
```java
com.httpclient.demo;
```
```java
import
```
```java
java.io.IOException;
```
```java
import
```
```java
java.util.LinkedList;
```
```java
import
```
```java
java.util.List;
```
```java
import
```
```java
org.apache.http.Consts;
```
```java
import
```
```java
org.apache.http.NameValuePair;
```
```java
import
```
```java
org.apache.http.client.CookieStore;
```
```java
import
```
```java
org.apache.http.client.config.CookieSpecs;
```
```java
import
```
```java
org.apache.http.client.config.RequestConfig;
```
```java
import
```
```java
org.apache.http.client.entity.UrlEncodedFormEntity;
```
```java
import
```
```java
org.apache.http.client.methods.CloseableHttpResponse;
```
```java
import
```
```java
org.apache.http.client.methods.HttpGet;
```
```java
import
```
```java
org.apache.http.client.methods.HttpPost;
```
```java
import
```
```java
org.apache.http.client.protocol.HttpClientContext;
```
```java
import
```
```java
org.apache.http.cookie.Cookie;
```
```java
import
```
```java
org.apache.http.impl.client.BasicCookieStore;
```
```java
import
```
```java
org.apache.http.impl.client.CloseableHttpClient;
```
```java
import
```
```java
org.apache.http.impl.client.HttpClients;
```
```java
import
```
```java
org.apache.http.message.BasicNameValuePair;
```
```java
import
```
```java
org.apache.http.util.EntityUtils;
```
```java
/**
```
```java
```
```java
*
 模拟登陆知乎
```
```java
```
```java
*/
```
```java
public
```
```java
class
```
```java
ZhiHuTest
 {
```
```java
```
```java
public
```
```java
static
```
```java
void
```
```java
main(String[]
 args)
```
```java
throws
```
```java
java.text.ParseException
 {
```
```java
```
```java
String
 name =
```
```java
"username"
```
```java
;
```
```java
```
```java
String
 password =
```
```java
"password"
```
```java
```
```java
```
```java
//
 全局请求设置
```
```java
```
```java
RequestConfig
 globalConfig = RequestConfig.custom().setCookieSpec(CookieSpecs.STANDARD).build();
```
```java
```
```java
//
 创建cookie store的本地实例
```
```java
```
```java
CookieStore
 cookieStore =
```
```java
new
```
```java
BasicCookieStore();
```
```java
```
```java
//
 创建HttpClient上下文
```
```java
```
```java
HttpClientContext
 context = HttpClientContext.create();
```
```java
```
```java
context.setCookieStore(cookieStore);
```
```java
```
```java
//
 创建一个HttpClient
```
```java
```
```java
CloseableHttpClient
 httpClient = HttpClients.custom().setDefaultRequestConfig(globalConfig)
```
```java
```
```java
.setDefaultCookieStore(cookieStore).build();
```
```java
```
```java
CloseableHttpResponse
 res =
```
```java
null
```
```java
;
```
```java
```
```java
//
 创建本地的HTTP内容
```
```java
```
```java
try
```
```java
{
```
```java
```
```java
try
```
```java
{
```
```java
```
```java
//
 创建一个get请求用来获取必要的Cookie，如_xsrf信息
```
```java
```
```java
HttpGet
 get =
```
```java
new
```
```java
HttpGet(
```
```java
"http://www.zhihu.com/"
```
```java
);
```
```java
```
```java
res
 = httpClient.execute(get, context);
```
```java
```
```java
//
 获取常用Cookie,包括_xsrf信息
```
```java
```
```java
System.out.println(
```
```java
"访问知乎首页后的获取的常规Cookie:==============="
```
```java
);
```
```java
```
```java
for
```
```java
(Cookie
 c : cookieStore.getCookies()) {
```
```java
```
```java
System.out.println(c.getName()
 +
```
```java
":
 "
```
```java
+
 c.getValue());
```
```java
```
```java
}
```
```java
```
```java
res.close();
```
```java
```
```java
//
 构造post数据
```
```java
```
```java
List<NameValuePair>
 valuePairs =
```
```java
new
```
```java
LinkedList<NameValuePair>();
```
```java
```
```java
valuePairs.add(
```
```java
new
```
```java
BasicNameValuePair(
```
```java
"email"
```
```java
,
 name));
```
```java
```
```java
valuePairs.add(
```
```java
new
```
```java
BasicNameValuePair(
```
```java
"password"
```
```java
,
 password));
```
```java
```
```java
valuePairs.add(
```
```java
new
```
```java
BasicNameValuePair(
```
```java
"remember_me"
```
```java
,
```
```java
"true"
```
```java
));
```
```java
```
```java
UrlEncodedFormEntity
 entity =
```
```java
new
```
```java
UrlEncodedFormEntity(valuePairs,
 Consts.UTF_8);
```
```java
```
```java
entity.setContentType(
```
```java
"application/x-www-form-urlencoded"
```
```java
);
```
```java
```
```java
//
 创建一个post请求
```
```java
```
```java
HttpPost
 post =
```
```java
new
```
```java
HttpPost(
```
```java
"https://www.zhihu.com/login/email"
```
```java
);
```
```java
```
```java
//
 注入post数据
```
```java
```
```java
post.setEntity(entity);
```
```java
```
```java
res
 = httpClient.execute(post, context);
```
```java
```
```java
//
 打印响应信息，查看是否登陆是否成功
```
```java
```
```java
System.out.println(
```
```java
"打印响应信息==========="
```
```java
);
```
```java
```
```java
HttpClientUtils.printResponse(res);
```
```java
```
```java
res.close();
```
```java
```
```java
System.out.println(
```
```java
"登陆成功后,新的Cookie:==============="
```
```java
);
```
```java
```
```java
for
```
```java
(Cookie
 c : context.getCookieStore().getCookies()) {
```
```java
```
```java
System.out.println(c.getName()
 +
```
```java
":
 "
```
```java
+
 c.getValue());
```
```java
```
```java
}
```
```java
```
```java
//
 构造一个新的get请求，用来测试登录是否成功
```
```java
```
```java
HttpGet
 newGet =
```
```java
new
```
```java
HttpGet(
```
```java
"http://www.zhihu.com/question/following"
```
```java
);
```
```java
```
```java
res
 = httpClient.execute(newGet, context);
```
```java
```
```java
String
 content = EntityUtils.toString(res.getEntity());
```
```java
```
```java
System.out.println(
```
```java
"登陆成功后访问的页面==============="
```
```java
);
```
```java
```
```java
System.out.println(content);
```
```java
```
```java
res.close();
```
```java
```
```java
}
```
```java
finally
```
```java
{
```
```java
```
```java
httpClient.close();
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
catch
```
```java
(IOException
 e) {
```
```java
```
```java
e.printStackTrace();
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
}
```
```
