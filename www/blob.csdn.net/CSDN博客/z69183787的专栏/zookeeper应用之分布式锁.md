# zookeeper应用之分布式锁 - z69183787的专栏 - CSDN博客
2018年02月23日 17:37:47[OkidoGreen](https://me.csdn.net/z69183787)阅读数：137
zookeeper在项目中有很多应用，其中一个比较常见的的就是分布式锁，zookeeper实现分布式锁的原理是根据zookeeper创建的临时有序节点，每次zookeeper在同一个目录下创建的临时有序节点是有序的，会自动累加，如果本次操作创建的节点在目录内是最小节点，则获得锁，否则阻塞等待锁，并且总是在前一个节点上注册watcher监视前一个节点的释放，较小的节点释放后，等待的节点对应的操作获得锁，以此类推，代码简单实现如下：
```java
public
```
```java
class
```
```java
ZKDisLock
 {
```
```java
```
```java
private
```
```java
static
```
```java
final
```
```java
Logger
 SERVICE_LOG = LoggerFactory.getLogger(LogConstants.SERVICE_LOG);
```
```java
```
```java
//锁目录
```
```java
```
```java
private
```
```java
static
```
```java
final
```
```java
String
 BASE_PATH =
```
```java
"/disLock"
```
```java
;
```
```java
```
```java
private
```
```java
static
```
```java
final
```
```java
String
 SPLIT_FLAG =
```
```java
"_"
```
```java
;
```
```java
```
```java
private
```
```java
Integer
 sessionOut;
```
```java
```
```java
private
```
```java
String
 zkHost;
```
```java
```
```java
private
```
```java
ZooKeeper
 zooKeeper;
```
```java
```
```java
//当前锁节点名称
```
```java
```
```java
private
```
```java
String
 lockNode;
```
```java
```
```java
//等待锁节点名称
```
```java
```
```java
private
```
```java
String
 waitNode;
```
```java
```
```java
private
```
```java
CountDownLatch
 countDownLatch;
```
```java
```
```java
public
```
```java
ZKDisLock(Integer
 sessionOut, String zkHost) {
```
```java
```
```java
this
```
```java
.sessionOut
 = sessionOut;
```
```java
```
```java
this
```
```java
.zkHost
 = zkHost;
```
```java
```
```java
}
```
```java
```
```java
//ZKDisLock初始化
```
```java
```
```java
public
```
```java
void
```
```java
init()
```
```java
throws
```
```java
DisLockException
 {
```
```java
```
```java
try
```
```java
{
```
```java
```
```java
zooKeeper
 =
```
```java
new
```
```java
ZooKeeper(zkHost,
 sessionOut,
```
```java
new
```
```java
Watcher()
 {
```
```java
```
```java
@Override
```
```java
```
```java
public
```
```java
void
```
```java
process(WatchedEvent
 watchedEvent) {
```
```java
```
```java
}
```
```java
```
```java
});
```
```java
```
```java
//判断有无根目录，没有的话创建
```
```java
```
```java
Stat
 stat = zooKeeper.exists(BASE_PATH,
```
```java
false
```
```java
);
```
```java
```
```java
if
```
```java
(stat
 ==
```
```java
null
```
```java
)
 {
```
```java
```
```java
zooKeeper.create(BASE_PATH,
```
```java
null
```
```java
,
 ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
catch
```
```java
(Exception
 e) {
```
```java
```
```java
SERVICE_LOG.info(
```
```java
"zk初始化失败"
```
```java
);
```
```java
```
```java
throw
```
```java
new
```
```java
DisLockException(
```
```java
"zk初始化失败"
```
```java
);
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
```
```java
//加锁
```
```java
```
```java
public
```
```java
void
```
```java
lock(String
 content)
```
```java
throws
```
```java
DisLockException
 {
```
```java
```
```java
if
```
```java
(zooKeeper
 ==
```
```java
null
```
```java
)
 {
```
```java
```
```java
throw
```
```java
new
```
```java
DisLockException(
```
```java
"zk未初始化"
```
```java
);
```
```java
```
```java
}
```
```java
```
```java
try
```
```java
{
```
```java
```
```java
//创建节点
```
```java
```
```java
String
 itemName = zooKeeper.create(BASE_PATH +
```
```java
"/"
```
```java
+
 content + SPLIT_FLAG,
```
```java
null
```
```java
,
 ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);
```
```java
```
```java
//判断节点是否是目录中同一个content的最小节点
```
```java
```
```java
if
```
```java
(isLowestNode(content,
 itemName)) {
```
```java
```
```java
SERVICE_LOG.info(
```
```java
"线程："
```
```java
+
 Thread.currentThread().getId() +
```
```java
",加锁成功,节点名称："
```
```java
+
 lockNode);
```
```java
```
```java
return
```
```java
;
```
```java
```
```java
}
```
```java
else
```
```java
{
```
```java
```
```java
SERVICE_LOG.info(
```
```java
"线程："
```
```java
+
 Thread.currentThread().getId() +
```
```java
",等待锁："
```
```java
+
 waitNode);
```
```java
```
```java
//不是最小节点，等待锁释放
```
```java
```
```java
waitForLock(sessionOut);
```
```java
```
```java
//锁释放后，再次判断下是否是最小节点
```
```java
```
```java
if
```
```java
(isLowestNode(content,
 itemName)) {
```
```java
```
```java
SERVICE_LOG.info(
```
```java
"线程："
```
```java
+
 Thread.currentThread().getId() +
```
```java
",获得锁,节点名称："
```
```java
+
 lockNode);
```
```java
```
```java
return
```
```java
;
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
catch
```
```java
(Exception
 e) {
```
```java
```
```java
SERVICE_LOG.error(
```
```java
"加锁异常"
```
```java
);
```
```java
```
```java
throw
```
```java
new
```
```java
DisLockException(
```
```java
"加锁异常"
```
```java
);
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
```
```java
//判断是否是最小节点
```
```java
```
```java
private
```
```java
boolean
```
```java
isLowestNode(String
 content, String itemName)
```
```java
throws
```
```java
Exception
 {
```
```java
```
```java
```
```java
//获取所有子节点
```
```java
```
```java
List<String>
 nodeNames = zooKeeper.getChildren(BASE_PATH,
```
```java
null
```
```java
);
```
```java
```
```java
List<String>
 itemNodes =
```
```java
new
```
```java
ArrayList<>();
```
```java
```
```java
lockNode
 = itemName;
```
```java
```
```java
```
```java
//过滤content节点
```
```java
```
```java
for
```
```java
(String
 name : nodeNames) {
```
```java
```
```java
if
```
```java
(name.split(SPLIT_FLAG)[
```
```java
0
```
```java
].toString().equals(content))
 {
```
```java
```
```java
itemNodes.add(name);
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
```
```java
//排序
```
```java
```
```java
Collections.sort(itemNodes);
```
```java
```
```java
//最小节点返回
```
```java
```
```java
if
```
```java
(itemName.equals(BASE_PATH
 +
```
```java
"/"
```
```java
+
 itemNodes.get(
```
```java
0
```
```java
)))
 {
```
```java
```
```java
return
```
```java
true
```
```java
;
```
```java
```
```java
}
```
```java
```
```java
```
```java
//非最小节点，找到前一个节点
```
```java
```
```java
int
```
```java
nodeIndex
 = Collections.binarySearch(itemNodes, itemName.substring(itemName.lastIndexOf(
```
```java
"/"
```
```java
)
 +
```
```java
1
```
```java
));
```
```java
```
```java
waitNode
 = itemNodes.get(nodeIndex -
```
```java
1
```
```java
);
```
```java
```
```java
return
```
```java
false
```
```java
;
```
```java
```
```java
}
```
```java
```
```java
//等待锁
```
```java
```
```java
private
```
```java
void
```
```java
waitForLock(
```
```java
final
```
```java
Integer
 waitTime)
```
```java
throws
```
```java
Exception
 {
```
```java
```
```java
```
```java
//判断等待节点是否释放，同时注册watcher，通知释放事件
```
```java
```
```java
Stat
 stat = zooKeeper.exists(BASE_PATH +
```
```java
"/"
```
```java
+
 waitNode,
```
```java
new
```
```java
Watcher()
 {
```
```java
```
```java
@Override
```
```java
```
```java
public
```
```java
void
```
```java
process(WatchedEvent
 watchedEvent) {
```
```java
```
```java
SERVICE_LOG.info(
```
```java
"watch
 proceess "
```
```java
+
 watchedEvent.toString());
```
```java
```
```java
if
```
```java
(countDownLatch
 !=
```
```java
null
```
```java
)
 {
```
```java
```
```java
//锁释放，通知等待节点
```
```java
```
```java
countDownLatch.countDown();
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
```
```java
});
```
```java
```
```java
```
```java
//如果等待的锁不存在返回
```
```java
```
```java
if
```
```java
(stat
 ==
```
```java
null
```
```java
)
 {
```
```java
```
```java
return
```
```java
;
```
```java
```
```java
}
```
```java
```
```java
```
```java
//存在，等待
```
```java
```
```java
countDownLatch
 =
```
```java
new
```
```java
CountDownLatch(
```
```java
1
```
```java
);
```
```java
```
```java
countDownLatch.await(waitTime,
 TimeUnit.MILLISECONDS);
```
```java
```
```java
}
```
```java
```
```java
//释放锁
```
```java
```
```java
public
```
```java
void
```
```java
unLock()
```
```java
throws
```
```java
DisLockException
 {
```
```java
```
```java
try
```
```java
{
```
```java
```
```java
//删除锁节点
```
```java
```
```java
zooKeeper.delete(lockNode,
 -
```
```java
1
```
```java
);
```
```java
```
```java
SERVICE_LOG.info(
```
```java
"线程："
```
```java
+
 Thread.currentThread().getId() +
```
```java
",解锁成功，节点名称："
```
```java
+
 lockNode);
```
```java
```
```java
lockNode
 =
```
```java
null
```
```java
;
```
```java
```
```java
zooKeeper.close();
```
```java
```
```java
}
```
```java
catch
```
```java
(Exception
 e) {
```
```java
```
```java
String
 errorMsg =
```
```java
"解锁异常,节点名称："
```
```java
+
 lockNode;
```
```java
```
```java
SERVICE_LOG.error(errorMsg);
```
```java
```
```java
throw
```
```java
new
```
```java
DisLockException(errorMsg);
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
}
```

以上是用zookeeper实现分布式锁的一个简单实现，可能有些地方并不太严谨，但是足以说明问题，下面来测试下这个分布式锁：
```java
public
```
```java
static
```
```java
void
```
```java
main(String[]
 args)
```
```java
throws
```
```java
Exception{
```
```java
```
```java
ExecutorService
 executorService= Executors.newFixedThreadPool(
```
```java
40
```
```java
);
```
```java
```
```java
String
 content=
```
```java
"abcdefg"
```
```java
;
```
```java
```
```java
String
 zkHost=
```
```java
"127.0.0.1"
```
```java
;
```
```java
```
```java
Integer
 sessionOut=
```
```java
30000
```
```java
;
```
```java
```
```java
//创建10个线程测试
```
```java
```
```java
for
```
```java
(
```
```java
int
```
```java
i=
```
```java
0
```
```java
;i<
```
```java
10
```
```java
;++i){
```
```java
```
```java
ZKDisLock
 disLock=
```
```java
new
```
```java
ZKDisLock(sessionOut,zkHost);
```
```java
```
```java
disLock.init();
```
```java
```
```java
executorService.submit(
```
```java
new
```
```java
TestJob(disLock,content));
```
```java
```
```java
}
```
```java
}
```
```java
//测试任务
```
```java
private
```
```java
static
```
```java
class
```
```java
TestJob
```
```java
implements
```
```java
Runnable{
```
```java
```
```java
private
```
```java
ZKDisLock
 disLock;
```
```java
```
```java
private
```
```java
String
 content;
```
```java
```
```java
public
```
```java
TestJob(ZKDisLock
 disLock, String content) {
```
```java
```
```java
this
```
```java
.disLock
 = disLock;
```
```java
```
```java
this
```
```java
.content
 = content;
```
```java
```
```java
}
```
```java
```
```java
@Override
```
```java
```
```java
public
```
```java
void
```
```java
run()
 {
```
```java
```
```java
try
```
```java
{
```
```java
```
```java
disLock.lock(content);
```
```java
```
```java
Thread.sleep(
```
```java
2000
```
```java
);
```
```java
```
```java
disLock.unLock();
```
```java
```
```java
}
```
```java
catch
```
```java
(Exception
 e){
```
```java
```
```java
System.out.println(e.getMessage());
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
}
```

运行结果如下：
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
436
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
73
```
```java
)
 ## 线程：
```
```java
13
```
```java
,等待锁：abcdefg_0000000327
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
436
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
73
```
```java
)
 ## 线程：
```
```java
19
```
```java
,等待锁：abcdefg_0000000328
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
436
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
70
```
```java
)
 ## 线程：
```
```java
16
```
```java
,加锁成功,节点名称：/disLock/abcdefg_0000000327
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
438
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
73
```
```java
)
 ## 线程：
```
```java
22
```
```java
,等待锁：abcdefg_0000000329
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
441
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
73
```
```java
)
 ## 线程：
```
```java
25
```
```java
,等待锁：abcdefg_0000000330
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
444
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
73
```
```java
)
 ## 线程：
```
```java
28
```
```java
,等待锁：abcdefg_0000000331
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
456
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
73
```
```java
)
 ## 线程：
```
```java
31
```
```java
,等待锁：abcdefg_0000000332
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
460
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
73
```
```java
)
 ## 线程：
```
```java
34
```
```java
,等待锁：abcdefg_0000000333
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
464
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
73
```
```java
)
 ## 线程：
```
```java
37
```
```java
,等待锁：abcdefg_0000000334
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
03
```
```java
,
```
```java
469
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
73
```
```java
)
 ## 线程：
```
```java
40
```
```java
,等待锁：abcdefg_0000000335
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
05
```
```java
,
```
```java
442
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
16
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000327
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
05
```
```java
,
```
```java
443
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
118
```
```java
)
 ## watch proceess WatchedEvent state:SyncConnected type:NodeDeleted path:/disLock/abcdefg_0000000327
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
05
```
```java
,
```
```java
444
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
76
```
```java
)
 ## 线程：
```
```java
13
```
```java
,获得锁,节点名称：/disLock/abcdefg_0000000328
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
07
```
```java
,
```
```java
449
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
118
```
```java
)
 ## watch proceess WatchedEvent state:SyncConnected type:NodeDeleted path:/disLock/abcdefg_0000000328
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
07
```
```java
,
```
```java
449
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
13
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000328
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
07
```
```java
,
```
```java
451
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
76
```
```java
)
 ## 线程：
```
```java
19
```
```java
,获得锁,节点名称：/disLock/abcdefg_0000000329
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
09
```
```java
,
```
```java
459
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
118
```
```java
)
 ## watch proceess WatchedEvent state:SyncConnected type:NodeDeleted path:/disLock/abcdefg_0000000329
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
09
```
```java
,
```
```java
459
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
19
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000329
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
09
```
```java
,
```
```java
461
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
76
```
```java
)
 ## 线程：
```
```java
22
```
```java
,获得锁,节点名称：/disLock/abcdefg_0000000330
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
11
```
```java
,
```
```java
469
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
118
```
```java
)
 ## watch proceess WatchedEvent state:SyncConnected type:NodeDeleted path:/disLock/abcdefg_0000000330
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
11
```
```java
,
```
```java
469
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
22
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000330
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
11
```
```java
,
```
```java
471
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
76
```
```java
)
 ## 线程：
```
```java
25
```
```java
,获得锁,节点名称：/disLock/abcdefg_0000000331
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
13
```
```java
,
```
```java
480
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
118
```
```java
)
 ## watch proceess WatchedEvent state:SyncConnected type:NodeDeleted path:/disLock/abcdefg_0000000331
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
13
```
```java
,
```
```java
480
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
25
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000331
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
13
```
```java
,
```
```java
482
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
76
```
```java
)
 ## 线程：
```
```java
28
```
```java
,获得锁,节点名称：/disLock/abcdefg_0000000332
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
15
```
```java
,
```
```java
488
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
118
```
```java
)
 ## watch proceess WatchedEvent state:SyncConnected type:NodeDeleted path:/disLock/abcdefg_0000000332
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
15
```
```java
,
```
```java
488
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
28
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000332
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
15
```
```java
,
```
```java
490
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
76
```
```java
)
 ## 线程：
```
```java
31
```
```java
,获得锁,节点名称：/disLock/abcdefg_0000000333
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
17
```
```java
,
```
```java
498
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
118
```
```java
)
 ## watch proceess WatchedEvent state:SyncConnected type:NodeDeleted path:/disLock/abcdefg_0000000333
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
17
```
```java
,
```
```java
498
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
31
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000333
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
17
```
```java
,
```
```java
500
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
76
```
```java
)
 ## 线程：
```
```java
34
```
```java
,获得锁,节点名称：/disLock/abcdefg_0000000334
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
19
```
```java
,
```
```java
506
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
118
```
```java
)
 ## watch proceess WatchedEvent state:SyncConnected type:NodeDeleted path:/disLock/abcdefg_0000000334
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
19
```
```java
,
```
```java
506
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
34
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000334
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
19
```
```java
,
```
```java
508
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
76
```
```java
)
 ## 线程：
```
```java
37
```
```java
,获得锁,节点名称：/disLock/abcdefg_0000000335
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
21
```
```java
,
```
```java
516
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
118
```
```java
)
 ## watch proceess WatchedEvent state:SyncConnected type:NodeDeleted path:/disLock/abcdefg_0000000335
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
21
```
```java
,
```
```java
516
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
37
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000335
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
21
```
```java
,
```
```java
518
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
76
```
```java
)
 ## 线程：
```
```java
40
```
```java
,获得锁,节点名称：/disLock/abcdefg_0000000336
```
```java
17
```
```java
-
```
```java
12
```
```java
-
```
```java
20
```
```java
15
```
```java
:
```
```java
03
```
```java
:
```
```java
23
```
```java
,
```
```java
527
```
```java
INFO 
 service(ZKDisLock.java:
```
```java
137
```
```java
)
 ## 线程：
```
```java
40
```
```java
,解锁成功，节点名称：/disLock/abcdefg_0000000336
```

从以上结果可以看到，线程16最先获得锁，创建最小节点 /disLock/abcdefg_0000000327，其次是线程13等待线程16的锁释放，其对应节点是/disLock/abcdefg_0000000328，等待abcdefg_0000000327释放，线程16锁释放后，线程13获得锁，其次是线程19等在线程13之后，以此类推，最后所有线程都获得了锁并且成功解锁，另外上述运行结果也展示了线程之间的锁的交接时通过注册的watcher传递的。以上的测试结果表明，我们实现的分布式锁可以正确的运行，达到了预期效果。
