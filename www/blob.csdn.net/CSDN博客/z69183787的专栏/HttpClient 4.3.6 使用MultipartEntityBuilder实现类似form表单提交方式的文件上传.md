# HttpClient 4.3.6 使用MultipartEntityBuilder实现类似form表单提交方式的文件上传 - z69183787的专栏 - CSDN博客
2015年07月17日 14:13:25[OkidoGreen](https://me.csdn.net/z69183787)阅读数：24049
个人分类：[Httpclient-简介](https://blog.csdn.net/z69183787/article/category/2185975)

```
<dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpclient</artifactId>
            <version>4.5</version>
        </dependency>
        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpmime</artifactId>
            <version>4.5</version>
        </dependency>
```
最近在做 Android 端文件上传，要求采用 form 表单的方式提交，项目使用的 afinal 框架有文件上传功能，但是始终无法与php写的服务端对接上，无法上传成功。读源码发现：afinal 使用了某大神写的 [MultipartEntity.java](https://github.com/yangfuhai/afinal/blob/master/src/net/tsz/afinal/http/MultipartEntity.java) 生成
 form 表单内容，然而生成的内容格式不够标准，而且还存在诸多问题，如：首先将所有文件读入到内存，再生成字节流写入到 socket。那么问题来了：如果是几百MB的文件怎么办？
      几番搜索，受到 [这篇文章](http://my.oschina.net/weichou/blog/352044)（已被我转载，但是示例代码已过期）的启发，我辗转找到了 [Apache
 源码 httpcomponents-client-4.3.6-src.zip](http://hc.apache.org/downloads.cgi)，在一个示例里面发现了一个重要的组件 MultipartEntityBuilder, 可以生成 form 表单格式的 HttpEntity, 有了 HttpEntity, 无论你是什么 http 框架，应该都可以使用。
不知道怎么使用？like this:
[?](http://my.oschina.net/weichou/blog/352753#)
```
```java
HttpPost httppost =
```
```java
new
```
```java
HttpPost(url);
```
```java
...
```
```java
final
```
```java
HttpEntity entity = makeMultipartEntity(params, files);
```
```java
httppost.addHeader(entity.getContentType());
```
```java
//httppost.addHeader(entity.getContentEncoding());    //null
```
```java
httppost.setEntity(entity);
```
```java
HttpResponse response = getHttpClient().execute(httppost);
```
```java
...
```
```java
private
```
```java
static
```
```java
HttpClient mClient;
```
```java
private
```
```java
static
```
```java
HttpClient getHttpClient() {
```
```java
```
```java
if
```
```java
(mClient ==
```
```java
null
```
```java
) {
```
```java
```
```java
//if(Build.VERSION.SDK_INT >= 9);    //将不走本类的Case，基于HttpURLConnection
```
```java
```
```java
if
```
```java
(Build.VERSION.SDK_INT >=
```
```java
8
```
```java
) {
```
```java
```
```java
mClient = AndroidHttpClient.newInstance(getUserAgent());
```
```java
```
```java
}
```
```java
else
```
```java
{
```
```java
```
```java
mClient =
```
```java
new
```
```java
DefaultHttpClient();
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
```
```java
return
```
```java
mClient;
```
```java
}
```
```
MultipartEntityBuilder 用法整理如下：
需要用到 [httpcomponents-client-4.3.6-bin.zip](http://hc.apache.org/downloads.cgi) 中的 httpmime-4.3.6.jar 和 httpcore-4.3.3.jar
[?](http://my.oschina.net/weichou/blog/352753#)
```
```java
public
```
```java
static
```
```java
HttpEntity makeMultipartEntity(List<NameValuePair> params,
```
```java
final
```
```java
Map<String, File> files) {
```
```java
```
```java
MultipartEntityBuilder builder = MultipartEntityBuilder.create();
```
```java
```
```java
builder.setMode(HttpMultipartMode.BROWSER_COMPATIBLE);
```
```java
//如果有SocketTimeoutException等情况，可修改这个枚举
```
```java
```
```java
//builder.setCharset(Charset.forName("UTF-8"));
 //不要用这个，会导致服务端接收不到参数
```
```java
```
```java
if
```
```java
(params !=
```
```java
null
```
```java
&& params.size() >
```
```java
0
```
```java
) {
```
```java
```
```java
for
```
```java
(NameValuePair p : params) {
```
```java
```
```java
builder.addTextBody(p.getName(), p.getValue(), ContentType.TEXT_PLAIN.withCharset(
```
```java
"UTF-8"
```
```java
));
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
```
```java
if
```
```java
(files !=
```
```java
null
```
```java
&& files.size() >
```
```java
0
```
```java
) {
```
```java
```
```java
Set<Entry<String, File>> entries = files.entrySet();
```
```java
```
```java
for
```
```java
(Entry<String, File> entry : entries) {
```
```java
```
```java
builder.addPart(entry.getKey(),
```
```java
new
```
```java
FileBody(entry.getValue()));
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
```
```java
return
```
```java
builder.build();
```
```java
}
```
```
另附上 Apache 示例，可在[httpcomponents-client-4.3.6-bin.zip](http://hc.apache.org/downloads.cgi) 中找到。
[?](http://my.oschina.net/weichou/blog/352753#)
```
```java
/*
```
```java
```
```java
* ====================================================================
```
```java
```
```java
* Licensed to the Apache Software Foundation (ASF) under one
```
```java
```
```java
* or more contributor license agreements.  See the NOTICE file
```
```java
```
```java
* distributed with this work for additional information
```
```java
```
```java
* regarding copyright ownership.  The ASF licenses this file
```
```java
```
```java
* to you under the Apache License, Version 2.0 (the
```
```java
```
```java
* "License"); you may not use this file except in compliance
```
```java
```
```java
* with the License.  You may obtain a copy of the License at
```
```java
```
```java
*
```
```java
```
```java
*   http://www.apache.org/licenses/LICENSE-2.0
```
```java
```
```java
*
```
```java
```
```java
* Unless required by applicable law or agreed to in writing,
```
```java
```
```java
* software distributed under the License is distributed on an
```
```java
```
```java
* "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
```
```java
```
```java
* KIND, either express or implied.  See the License for the
```
```java
```
```java
* specific language governing permissions and limitations
```
```java
```
```java
* under the License.
```
```java
```
```java
* ====================================================================
```
```java
```
```java
*
```
```java
```
```java
* This software consists of voluntary contributions made by many
```
```java
```
```java
* individuals on behalf of the Apache Software Foundation.  For more
```
```java
```
```java
* information on the Apache Software Foundation, please see
```
```java
```
```java
* <http://www.apache.org/>.
```
```java
```
```java
*
```
```java
```
```java
*/
```
```java
package
```
```java
org.apache.http.examples.entity.mime;
```
```java
import
```
```java
java.io.File;
```
```java
import
```
```java
org.apache.http.HttpEntity;
```
```java
import
```
```java
org.apache.http.client.methods.CloseableHttpResponse;
```
```java
import
```
```java
org.apache.http.client.methods.HttpPost;
```
```java
import
```
```java
org.apache.http.entity.ContentType;
```
```java
import
```
```java
org.apache.http.entity.mime.MultipartEntityBuilder;
```
```java
import
```
```java
org.apache.http.entity.mime.content.FileBody;
```
```java
import
```
```java
org.apache.http.entity.mime.content.StringBody;
```
```java
import
```
```java
org.apache.http.impl.client.CloseableHttpClient;
```
```java
import
```
```java
org.apache.http.impl.client.HttpClients;
```
```java
import
```
```java
org.apache.http.util.EntityUtils;
```
```java
/**
```
```java
```
```java
* Example how to use multipart/form encoded POST request.
```
```java
```
```java
*/
```
```java
public
```
```java
class
```
```java
ClientMultipartFormPost {
```
```java
```
```java
public
```
```java
static
```
```java
void
```
```java
main(String[] args)
```
```java
throws
```
```java
Exception {
```
```java
```
```java
if
```
```java
(args.length !=
```
```java
1
```
```java
)  {
```
```java
```
```java
System.out.println(
```
```java
"File path not given"
```
```java
);
```
```java
```
```java
System.exit(
```
```java
1
```
```java
);
```
```java
```
```java
}
```
```java
```
```java
CloseableHttpClient httpclient = HttpClients.createDefault();
```
```java
```
```java
try
```
```java
{
```
```java
```
```java
HttpPost httppost =
```
```java
new
```
```java
HttpPost(
```
```java
"http://localhost:8080"
```
```java
+
```
```java
```
```java
"/servlets-examples/servlet/RequestInfoExample"
```
```java
);
```
```java
```
```java
FileBody bin =
```
```java
new
```
```java
FileBody(
```
```java
new
```
```java
File(args[
```
```java
0
```
```java
]));
```
```java
```
```java
StringBody comment =
```
```java
new
```
```java
StringBody(
```
```java
"A binary file of some kind"
```
```java
, ContentType.TEXT_PLAIN);
```
```java
```
```java
HttpEntity reqEntity = MultipartEntityBuilder.create()
```
```java
```
```java
.addPart(
```
```java
"bin"
```
```java
, bin)
```
```java
```
```java
.addPart(
```
```java
"comment"
```
```java
, comment)
```
```java
```
```java
.build();
```
```java
```
```java
httppost.setEntity(reqEntity);
```
```java
```
```java
System.out.println(
```
```java
"executing request "
```
```java
+ httppost.getRequestLine());
```
```java
```
```java
CloseableHttpResponse response = httpclient.execute(httppost);
```
```java
```
```java
try
```
```java
{
```
```java
```
```java
System.out.println(
```
```java
"----------------------------------------"
```
```java
);
```
```java
```
```java
System.out.println(response.getStatusLine());
```
```java
```
```java
HttpEntity resEntity = response.getEntity();
```
```java
```
```java
if
```
```java
(resEntity !=
```
```java
null
```
```java
) {
```
```java
```
```java
System.out.println(
```
```java
"Response content length: "
```
```java
+ resEntity.getContentLength());
```
```java
```
```java
}
```
```java
```
```java
EntityUtils.consume(resEntity);
```
```java
```
```java
}
```
```java
finally
```
```java
{
```
```java
```
```java
response.close();
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
finally
```
```java
{
```
```java
```
```java
httpclient.close();
```
```java
```
```java
}
```
```java
```
```java
}
```
```java
}
```
```
