# Mybatis分页和Spring的集成 - z69183787的专栏 - CSDN博客
2015年10月07日 11:15:31[OkidoGreen](https://me.csdn.net/z69183787)阅读数：1381
https://github.com/miemiedev/mybatis-paginator
写了一个[Mybatis分页控件](https://github.com/miemiedev/mybatis-paginator)，在这记录一下使用方式。
在Maven中加入依赖：
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```xml
<
```
```xml
dependencies
```
```xml
>
```
```xml
```
```xml
...
```
```xml
```
```xml
<
```
```xml
dependency
```
```xml
>
```
```xml
```
```xml
<
```
```xml
groupId
```
```xml
>com.github.miemiedev</
```
```xml
groupId
```
```xml
>
```
```xml
```
```xml
<
```
```xml
artifactId
```
```xml
>mybatis-paginator</
```
```xml
artifactId
```
```xml
>
```
```xml
```
```xml
<
```
```xml
version
```
```xml
>1.2.17</
```
```xml
version
```
```xml
>
```
```xml
```
```xml
</
```
```xml
dependency
```
```xml
>
```
```xml
```
```xml
...
```
```xml
</
```
```xml
dependencies
```
```xml
>
```
```
Mybatis配置文件添加分页插件：
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```xml
<?
```
```xml
xml
```
```xml
version
```
```xml
=
```
```xml
"1.0"
```
```xml
encoding
```
```xml
=
```
```xml
"UTF-8"
```
```xml
?>
```
```xml
<!
```
```xml
DOCTYPE
```
```xml
configuration
```
```xml
```
```xml
PUBLIC "-//ibatis.apache.org//DTD Config 3.0//EN"
```
```xml
```
```xml
"http://ibatis.apache.org/dtd/ibatis-3-config.dtd">
```
```xml
<
```
```xml
configuration
```
```xml
>
```
```xml
```
```xml
<
```
```xml
plugins
```
```xml
>
```
```xml
```
```xml
<
```
```xml
plugin
```
```xml
interceptor
```
```xml
=
```
```xml
"com.github.miemiedev.mybatis.paginator.OffsetLimitInterceptor"
```
```xml
>
```
```xml
```
```xml
<
```
```xml
property
```
```xml
name
```
```xml
=
```
```xml
"dialectClass"
```
```xml
value
```
```xml
=
```
```xml
"com.github.miemiedev.mybatis.paginator.dialect.OracleDialect"
```
```xml
/>
```
```xml
```
```xml
</
```
```xml
plugin
```
```xml
>
```
```xml
```
```xml
</
```
```xml
plugins
```
```xml
>
```
```xml
</
```
```xml
configuration
```
```xml
>
```
```
创建一个查询，内容可以是任何Mybatis表达式，包括foreach和if等：
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```xml
<
```
```xml
select
```
```xml
id
```
```xml
=
```
```xml
"findByCity"
```
```xml
resultType
```
```xml
=
```
```xml
"map"
```
```xml
>
```
```xml
```
```xml
select * from TEST_USER where city = #{city};
```
```xml
</
```
```xml
select
```
```xml
>
```
```
Dao中的方法或许是这样（用接口也是类似）：
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```java
public
```
```java
List findByCity(String city, PageBounds pageBounds){
```
```java
```
```java
Map<String, Object> params =
```
```java
new
```
```java
HashMap<String, Object>();
```
```java
```
```java
params.put(
```
```java
"city"
```
```java
,city);
```
```java
```
```java
return
```
```java
getSqlSession().selectList(
```
```java
"db.table.user.findByCity"
```
```java
, params, pageBounds);
```
```java
}
```
```
调用方式（分页加多列排序）：
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```java
int
```
```java
page =
```
```java
1
```
```java
;
```
```java
//页号
```
```java
int
```
```java
pageSize =
```
```java
20
```
```java
;
```
```java
//每页数据条数
```
```java
String sortString =
```
```java
"age.asc,gender.desc"
```
```java
;
```
```java
//如果你想排序的话逗号分隔可以排序多列
```
```java
PageBounds pageBounds =
```
```java
new
```
```java
PageBounds(page, pageSize , Order.formString(sortString));
```
```java
List list = findByCity(
```
```java
"BeiJing"
```
```java
,pageBounds);
```
```java
//获得结果集条总数
```
```java
PageList pageList = (PageList)list;
```
```java
System.out.println(
```
```java
"totalCount: "
```
```java
+ pageList.getPaginator().getTotalCount());
```
```
PageList类是继承于ArrayList的，这样Dao中就不用为了专门分页再多写一个方法。
使用PageBounds这个对象来控制结果的输出，常用的使用方式一般都可以通过构造函数来配置。
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```java
new
```
```java
PageBounds();
```
```java
//默认构造函数不提供分页，返回ArrayList
```
```java
new
```
```java
PageBounds(
```
```java
int
```
```java
limit);
```
```java
//取TOPN操作，返回ArrayList
```
```java
new
```
```java
PageBounds(Order... order);
```
```java
//只排序不分页，返回ArrayList
```
```java
new
```
```java
PageBounds(
```
```java
int
```
```java
page,
```
```java
int
```
```java
limit);
```
```java
//默认分页，返回PageList
```
```java
new
```
```java
PageBounds(
```
```java
int
```
```java
page,
```
```java
int
```
```java
limit, Order... order);
```
```java
//分页加排序，返回PageList
```
```java
new
```
```java
PageBounds(
```
```java
int
```
```java
page,
```
```java
int
```
```java
limit, List<Order> orders,
```
```java
boolean
```
```java
containsTotalCount);
```
```java
//使用containsTotalCount来决定查不查询totalCount，即返回ArrayList还是PageList
```
```
=========================================
如果用的是Spring MVC的话可以把JSON的配置写成这样：
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
`<``mvc:annotation-driven``>`
`    ``<``mvc:message-converters``register-defaults``=``"true"``>`
`        ``<``bean``class``=``"org.springframework.http.converter.StringHttpMessageConverter"``> `
`            ``<``constructor-arg``value``=``"UTF-8"``/>        `
`        ``</``bean``>`
`        ``<``bean``class``=``"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"``>`
`            ``<``property``name``=``"objectMapper"``>`
`                ``<``bean``class``=``"com.github.miemiedev.mybatis.paginator.jackson2.PageListJsonMapper"``/>`
`            ``</``property``>`
`        ``</``bean``>`
`    ``</``mvc:message-converters``>`
`</``mvc:annotation-driven``>`
```
那么在Controller就可以这样用了：
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```java
@ResponseBody
```
```java
@RequestMapping
```
```java
(value =
```
```java
"/findByCity.json"
```
```java
)
```
```java
public
```
```java
List findByCity(
```
```java
@RequestParam
```
```java
String city,
```
```java
```
```java
@RequestParam
```
```java
(required =
```
```java
false
```
```java
,defaultValue =
```
```java
"1"
```
```java
)
```
```java
int
```
```java
page,
```
```java
```
```java
@RequestParam
```
```java
(required =
```
```java
false
```
```java
,defaultValue =
```
```java
"30"
```
```java
)
```
```java
int
```
```java
limit,
```
```java
```
```java
@RequestParam
```
```java
(required =
```
```java
false
```
```java
) String sort,
```
```java
```
```java
@RequestParam
```
```java
(required =
```
```java
false
```
```java
) String dir) {
```
```java
```
```java
return
```
```java
userService.findByCity(city,
```
```java
new
```
```java
PageBounds(page, limit, Order.create(sort,dir)));
```
```java
}
```
```
然后序列化后的JSON字符串就会变成这样的：
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
`{`
`    ``"items"``:[`
`        ``{``"NAME"``:``"xiaoma"``,``"AGE"``:30,``"GENDER"``:1,``"ID"``:3,``"CITY"``:``"BeiJing"``},`
`        ``{``"NAME"``:``"xiaoli"``,``"AGE"``:30,``"SCORE"``:85,``"GENDER"``:1,``"ID"``:1,``"CITY"``:``"BeiJing"``},`
`        ``{``"NAME"``:``"xiaowang"``,``"AGE"``:30,``"SCORE"``:92,``"GENDER"``:0,``"ID"``:2,``"CITY"``:``"BeiJing"``},`
`        ``{``"NAME"``:``"xiaoshao"``,``"AGE"``:30,``"SCORE"``:99,``"GENDER"``:0,``"ID"``:4,``"CITY"``:``"BeiJing"``}`
`    ``],`
`    ``"slider"``: [1, 2, 3, 4, 5, 6, 7],`
`    ``"hasPrePage"``: ``false``,`
`    ``"startRow"``: 1,`
`    ``"offset"``: 0,`
`    ``"lastPage"``: ``false``,`
`    ``"prePage"``: 1,`
`    ``"hasNextPage"``: ``true``,`
`    ``"nextPage"``: 2,`
`    ``"endRow"``: 30,`
`    ``"totalCount"``: 40351,`
`    ``"firstPage"``: ``true``,`
`    ``"totalPages"``: 1346,`
`    ``"limit"``: 30,`
`    ``"page"``: 1`
`}`
```
=========================================
在SpringMVC中使用JSTL的话可以参考一下步骤（懒人用法）
在Spring配置文件中加入拦截器,或则参考拦截器实现定义自己的拦截器
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
`<mvc:interceptors>`
`    ``<mvc:interceptor>`
`        ``<mvc:mapping path=``"/**"``/>`
`        ``<bean ``class``=``"com.github.miemiedev.mybatis.paginator.springmvc.PageListAttrHandlerInterceptor"``/>`
`    ``</mvc:interceptor>`
`</mvc:interceptors>`
```
然后Controller方法可以这样写
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```java
@RequestMapping
```
```java
(value =
```
```java
"/userView.action"
```
```java
)
```
```java
public
```
```java
ModelAndView userView(
```
```java
@RequestParam
```
```java
String city,
```
```java
```
```java
@RequestParam
```
```java
(required =
```
```java
false
```
```java
,defaultValue =
```
```java
"1"
```
```java
)
```
```java
int
```
```java
page,
```
```java
```
```java
@RequestParam
```
```java
(required =
```
```java
false
```
```java
,defaultValue =
```
```java
"30"
```
```java
)
```
```java
int
```
```java
limit,
```
```java
```
```java
@RequestParam
```
```java
(required =
```
```java
false
```
```java
) String sort,
```
```java
```
```java
@RequestParam
```
```java
(required =
```
```java
false
```
```java
) String dir) {
```
```java
```
```java
List users = userService.findByCity(city,
```
```java
new
```
```java
PageBounds(page, limit, Order.create(sort,dir)));
```
```java
```
```java
return
```
```java
new
```
```java
ModelAndView(
```
```java
"account/user"
```
```java
,
```
```java
"users"
```
```java
, users);
```
```java
}
```
```
JSP中就可以这样用了，拦截器会将PageList分拆添加Paginator属性，默认命名规则为"原属性名称"+"Paginator"
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```java
<table>
```
```java
```
```java
<c:forEach items=
```
```java
"${users}"
```
```java
var=
```
```java
"user"
```
```java
>
```
```java
```
```java
<tr>
```
```java
```
```java
<td>${user[
```
```java
'ID'
```
```java
]}</td>
```
```java
```
```java
<td>${user[
```
```java
'NAME'
```
```java
]}</td>
```
```java
```
```java
<td>${user[
```
```java
'AGE'
```
```java
]}</td>
```
```java
```
```java
</tr>
```
```java
```
```java
</c:forEach>
```
```java
</table>
```
```java
上一页: ${usersPaginator.prePage}
```
```java
当前页: ${usersPaginator.page}
```
```java
下一页: ${usersPaginator.nextPage}
```
```java
总页数: ${usersPaginator.totalPages}
```
```java
总条数: ${usersPaginator.totalCount}
```
```java
更多属性参考Paginator类提供的方法
```
```
=========================================
如果用如下方法设置pageBounds，当前这个查询就可以用两个线程同时查询list和totalCount了
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```xml
pageBounds.setAsyncTotalCount(true);
```
```
如果所有的分页查询都是用异步的方式查询list和totalCount，可以在插件配置加入asyncTotalCount属性
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```xml
<
```
```xml
plugin
```
```xml
interceptor
```
```xml
=
```
```xml
"com.github.miemiedev.mybatis.paginator.OffsetLimitInterceptor"
```
```xml
>
```
```xml
```
```xml
<
```
```xml
property
```
```xml
name
```
```xml
=
```
```xml
"dialectClass"
```
```xml
value
```
```xml
=
```
```xml
"com.github.miemiedev.mybatis.paginator.dialect.OracleDialect"
```
```xml
/>
```
```xml
```
```xml
<
```
```xml
property
```
```xml
name
```
```xml
=
```
```xml
"asyncTotalCount"
```
```xml
value
```
```xml
=
```
```xml
"true"
```
```xml
/>
```
```xml
</
```
```xml
plugin
```
```xml
>
```
```
但是你仍然可以用下面代码强制让这个查询不用异步
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```xml
pageBounds.setAsyncTotalCount(false);
```
```
当然需要注意的是，只要你用到了异步查询，由于里面使用了线程池，所以在使用时就要加入清理监听器，以便在停止服务时关闭线程池。需要在web.xml中加入
[?](http://my.oschina.net/miemiedev/blog/135516#)
```
```xml
<
```
```xml
listener
```
```xml
>
```
```xml
```
```xml
<
```
```xml
listener-class
```
```xml
>com.github.miemiedev.mybatis.paginator.CleanupMybatisPaginatorListener</
```
```xml
listener-class
```
```xml
>
```
```xml
</
```
```xml
listener
```
```xml
>
```
```
完。
