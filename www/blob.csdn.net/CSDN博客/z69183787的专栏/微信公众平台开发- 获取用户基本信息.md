# 微信公众平台开发- 获取用户基本信息 - z69183787的专栏 - CSDN博客
2015年05月29日 10:12:35[OkidoGreen](https://me.csdn.net/z69183787)阅读数：2040
转自：http://www.cnblogs.com/txw1958/p/weixin76-user-info.html
在本文中，特别要注意的是有两个不同的Access Token，他们产生的方式不一样，一种是使用AppID和AppSecret获取的access_token，一种是OAuth2.0授权中产生的access_token，方倍工作室分别称为全局Access Token和授权Access
 Token。
一、通过全局Access Token获取用户基本信息
1. 用户关注以及回复消息的时候，均可以获得用户的OpenID
```
![复制代码](http://common.cnblogs.com/images/copycode.gif)
<xml>
    <ToUserName><![CDATA[gh_b629c48b653e]]></ToUserName>
    <FromUserName><![CDATA[ollB4jv7LA3tydjviJp5V9qTU_kA]]></FromUserName>
    <CreateTime>1372307736</CreateTime>
    <MsgType><![CDATA[event]]></MsgType>
    <Event><![CDATA[subscribe]]></Event>
    <EventKey><![CDATA[]]></EventKey>
</xml>
![复制代码](http://common.cnblogs.com/images/copycode.gif)
```
其中的FromUserName就是OpenID
2. 然后使用access_token接口，请求获得全局Access Token
```
https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
```
返回结果：
```
{
    "access_token": "NU7Kr6v9L9TQaqm5NE3OTPctTZx797Wxw4Snd2WL2HHBqLCiXlDVOw2l-Se0I-WmOLLniAYLAwzhbYhXNjbLc_KAA092cxkmpj5FpuqNO0IL7bB0Exz5s5qC9Umypy-rz2y441W9qgfnmNtIZWSjSQ",
    "expires_in": 7200
}
```
3. 再使用全局ACCESS_TOKEN获取OpenID的详细信息
```
https://api.weixin.qq.com/cgi-bin/user/info?access_token=ACCESS_TOKEN&openid=OPENID
```
返回如下：
```
![复制代码](http://common.cnblogs.com/images/copycode.gif)
{
    "subscribe": 1,
    "openid": "oLVPpjqs2BhvzwPj5A-vTYAX4GLc",
    "nickname": "刺猬宝宝",
    "sex": 1,
    "language": "zh_CN",
    "city": "深圳",
    "province": "广东",
    "country": "中国",
    "headimgurl": "http://wx.qlogo.cn/mmopen/JcDicrZBlREhnNXZRudod9PmibRkIs5K2f1tUQ7lFjC63pYHaXGxNDgMzjGDEuvzYZbFOqtUXaxSdoZG6iane5ko9H30krIbzGv/0",
    "subscribe_time": 1386160805
}
![复制代码](http://common.cnblogs.com/images/copycode.gif)
```
至此，获得用户的基本信息。
这种方式最适合用户在关注的时候，回复一条欢迎关注+用户昵称的信息，如关注下面公众账号时的回复所示。扫描二维码可体验。
![](http://images.cnitblog.com/blog2015/340216/201503/220830544693840.jpg)![](http://images.cnitblog.com/blog2015/340216/201505/062301526422208.png)![](http://images.cnitblog.com/blog2015/340216/201505/051941286262567.png)
二、通过OAuth2.0方式弹出授权页面获得用户基本信息
1. 首先配置回调域名
![](http://images.cnitblog.com/blog/340216/201311/09104700-65c3e92a2eb84f5f8cc51d2f40d613d4.jpg)
 2. 构造请求url如下：
```
https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx8888888888888888&redirect_uri=http://mascot.duapp.com/oauth2.php&response_type=code&scope=snsapi_userinfo&state=1#wechat_redirect
```
页面URL中的
```
scope=snsapi_userinfo 表示应用授权作用域为请求用户信息
```
```
★ 如果使用别人的AppID和AppSecret，那么获得的OpenID是那个有高级接口权限的服务号的，这里可以通过消息回复，获取本公众账号下的OpenID，带入回调中，与另一个OpenID进行关联也可以使用开放平台的UnionID功能来得到用户在自己账号下的OpenID 
https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx8888888888888888&redirect_uri=http://mascot.duapp.com/oauth2.php?userid=oc7tbuPA9BgUCLADib5nB3k2KWWg&response_type=code&scope=snsapi_userinfo&state=1#wechat_redirect
```
将该链接回复给关注用户，用户点击后，弹出应用授权界面
![](http://images.cnitblog.com/blog2015/340216/201505/051940302041382.png)
3. 回调页面得到链接如下，回调url中将包含参数code
```
http://mascot.duapp.com/oauth2.php?code=00b788e3b42043c8459a57a8d8ab5d9f&state=1
或者 http://mascot.duapp.com/oauth2.php?userid=oc7tbuPA9BgUCLADib5nB3k2KWWg&code=00b788e3b42043c8459a57a8d8ab5d9f&state=1
```
4. 再使用code换取oauth2的授权access_token
url如下：
```
https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx8888888888888888&secret=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&code=00b788e3b42043c8459a57a8d8ab5d9f&grant_type=authorization_code
```
获得授权Access Token:
```
![复制代码](http://common.cnblogs.com/images/copycode.gif)
{
    "access_token": "OezXcEiiBSKSxW0eoylIeAsR0GmYd1awCffdHgb4fhS_KKf2CotGj2cBNUKQQvj-G0ZWEE5-uBjBz941EOPqDQy5sS_GCs2z40dnvU99Y5AI1bw2uqN--2jXoBLIM5d6L9RImvm8Vg8cBAiLpWA8Vw",
    "expires_in": 7200,
    "refresh_token": "OezXcEiiBSKSxW0eoylIeAsR0GmYd1awCffdHgb4fhS_KKf2CotGj2cBNUKQQvj-G0ZWEE5-uBjBz941EOPqDQy5sS_GCs2z40dnvU99Y5CZPAwZksiuz_6x_TfkLoXLU7kdKM2232WDXB3Msuzq1A",
    "openid": "oLVPpjqs9BhvzwPj5A-vTYAX3GLc",
    "scope": "snsapi_userinfo,"
}
![复制代码](http://common.cnblogs.com/images/copycode.gif)
```
5. 再使用授权Access Token获取用户信息
url如下：
```
https://api.weixin.qq.com/sns/userinfo?access_token=OezXcEiiBSKSxW0eoylIeAsR0GmYd1awCffdHgb4fhS_KKf2CotGj2cBNUKQQvj-G0ZWEE5-uBjBz941EOPqDQy5sS_GCs2z40dnvU99Y5AI1bw2uqN--2jXoBLIM5d6L9RImvm8Vg8cBAiLpWA8Vw&openid=oLVPpjqs9BhvzwPj5A-vTYAX3GLc
```
返回如下
```
![复制代码](http://common.cnblogs.com/images/copycode.gif)
{
    "openid": "oLVPpjqs9BhvzwPj5A-vTYAX3GLc",
    "nickname": "刺猬宝宝",
    "sex": 1,
    "language": "zh_CN",
    "city": "深圳",
    "province": "广东",
    "country": "中国",
    "headimgurl": "http://wx.qlogo.cn/mmopen/utpKYf69VAbCRDRlbUsPsdQN38DoibCkrU6SAMCSNx558eTaLVM8PyM6jlEGzOrH67hyZibIZPXu4BK1XNWzSXB3Cs4qpBBg18/0",
    "privilege": []
}
![复制代码](http://common.cnblogs.com/images/copycode.gif)
```
获取用户信息完成。
最终得到用户信息如下所示
![](http://images.cnitblog.com/blog2015/340216/201505/051947109386654.png)![](http://images.cnitblog.com/blog2015/340216/201505/051947235321474.png)
此方法详细过程可参考 [微信公众平台开发（71）OAuth2.0网页授权](http://www.cnblogs.com/txw1958/p/weixin71-oauth20.html)
这种方法适合，
1. 在朋友圈中获得用户的信息.
2. 在网页中获得用户信息。
3. 在自定义菜单中获得用户信息。
需要说明的是，如果在已经有OAuth2.0网页授权权限的服务号中用这种方法，会自动转换成方法三中的那样，没有“微信登录”提示框出来。
可以微信扫描下面的二维码，然后回复“授权”体验这样的获取方式。
![](http://images.cnitblog.com/blog2015/340216/201505/051942323604862.jpg)![](http://images.cnitblog.com/blog2015/340216/201505/051940123297209.png)
三、通过OAuth2.0方式不弹出授权页面获得用户基本信息
1. 配置回调域名
![](http://images.cnitblog.com/blog/340216/201311/09104700-65c3e92a2eb84f5f8cc51d2f40d613d4.jpg)
2. 构造请求url如下：
```
https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx8888888888888888&redirect_uri=http://mascot.duapp.com/oauth2.php&response_type=code&scope=snsapi_base&state=1#wechat_redirect
```
页面URL中的
```
scope=snsapi_base 表示应用授权作用域为 不弹出授权页面，直接跳转，只获取用户openid
```
3. 返回回调页面如下
```
http://israel.duapp.com?code=02a9bed29b2185a9f0ed3a48fe56e700&state=1
```
这里获得到了code
4. 再使用code获取OpenID
url如下：
```
https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx8888888888888888&secret=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&code=02a9bed29b2185a9f0ed3a48fe56e700&grant_type=authorization_code
```
返回如下
```
![复制代码](http://common.cnblogs.com/images/copycode.gif)
{
    "access_token": "OezXcEiiBSKSxW0eoylIeAsR0GmYd1awCffdHgb4fhS_KKf2CotGj2cBNUKQQvj-oJ9VmO-0Z-_izfnSAX_s0aqDsYkW4s8W5dLZ4iyNj5Y6vey3dgDtFki5C8r6D0E6mSVxxtb8BjLMhb-mCyT_Yg",
    "expires_in": 7200,
    "refresh_token": "OezXcEiiBSKSxW0eoylIeAsR0GmYd1awCffdHgb4fhS_KKf2CotGj2cBNUKQQvj-oJ9VmO-0Z-_izfnSAX_s0aqDsYkW4s8W5dLZ4iyNj5YBkF0ZUH1Ew8Iqea6x_itq13sYDqP1D7ieaDy9u2AHHw",
    "openid": "oLVPpjqs9BhvzwPj5A-vTYAX3GLc",
    "scope": "snsapi_base"
}
![复制代码](http://common.cnblogs.com/images/copycode.gif)
```
5. 然后获取全局Access Token【以下与方法一中相同】
```
https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
```
返回结果：
```
{
    "access_token": "NU7Kr6v9L9TQaqm5NE3OTPctTZx797Wxw4Snd2WL2HHBqLCiXlDVOw2l-Se0I-WmOLLniAYLAwzhbYhXNjbLc_KAA092cxkmpj5FpuqNO0IL7bB0Exz5s5qC9Umypy-rz2y441W9qgfnmNtIZWSjSQ",
    "expires_in": 7200
}
```
6. 再使用全局ACCESS_TOKEN获取OpenID的详细信息
```
https://api.weixin.qq.com/cgi-bin/user/info?access_token=ACCESS_TOKEN&openid=OPENID
```
返回如下：
```
![复制代码](http://common.cnblogs.com/images/copycode.gif)
{
    "subscribe": 1,
    "openid": "oLVPpjqs2BhvzwPj5A-vTYAX4GLc",
    "nickname": "刺猬宝宝",
    "sex": 1,
    "language": "zh_CN",
    "city": "深圳",
    "province": "广东",
    "country": "中国",
    "headimgurl": "http://wx.qlogo.cn/mmopen/JcDicrZBlREhnNXZRudod9PmibRkIs5K2f1tUQ7lFjC63pYHaXGxNDgMzjGDEuvzYZbFOqtUXaxSdoZG6iane5ko9H30krIbzGv/0",
    "subscribe_time": 1386160805
}
![复制代码](http://common.cnblogs.com/images/copycode.gif)
```
成功获得用户基本信息。
这种适合已经有OAuth2.0网页授权的服务号在网页中使用，且不会弹出“微信登录”页面。减少给用户的打扰。
四、使用哪种方法最合适
供参考
1. 服务号 
有高级接口权限：　　消息回复中三种都可以　　 自定义菜单中使用方法三 (招商银行信用卡中心使用方法三，康盛微社区使用方法二)
没有高级接口权限：　消息回复中使用方法二 　　自定义菜单中使用方法二 (没有高级权限需要借用别人的Appid和AppSecret)
2. 订阅号
已认证有获取用户信息权限 　　 消息回复中使用方法一 　　自定义菜单中使用方法二 　　 (没有高级权限需要借用别人的Appid和AppSecret)
未认证没有获取用户信息权限 　　 消息回复中使用方法二 　自定义菜单中暂无方法 　　　 (没有高级权限需要借用别人的Appid和AppSecret，方倍工作室使用的就是这种)
