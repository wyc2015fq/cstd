# Hibernate乐观锁实现之Version - z69183787的专栏 - CSDN博客
2014年04月02日 19:46:21[OkidoGreen](https://me.csdn.net/z69183787)阅读数：2162
通过在表中及POJO中增加一个version字段来表示记录的版本，来达到多用户同时更改一条数据的冲突
数据库脚本：
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)createtable studentVersion (id varchar(**32**),name varchar(**32**),ver int);
POJO
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)package Version;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBlockStart.gif)publicclass Student {
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)private String id;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)private String name;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)privateint version;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockStart.gif)public String getId() {
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)return id;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockEnd.gif)}
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockStart.gif)publicvoid setId(String id) {
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)this.id = id;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockEnd.gif)}
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockStart.gif)public String getName() {
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)return name;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockEnd.gif)}
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockStart.gif)publicvoid setName(String name) {
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)this.name = name;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockEnd.gif)}
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockStart.gif)publicint getVersion() {
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)return version;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockEnd.gif)}
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockStart.gif)publicvoid setVersion(int version) {
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)this.version = version;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockEnd.gif)}
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBlockEnd.gif)}
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
注解形式：
```java
private int version;
 @Version
 @Column(name = "version")
public int getVersion() {
		return version;
}
private void setVersion(int version) {
		this.version = version;
}
```
xml文件形式：
Student.hbm.xml
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<?xml version="1.0" encoding="utf-8"?>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<!--
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)    Mapping file autogenerated by MyEclipse - Hibernate Tools
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)-->
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<hibernate-mapping>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<class name="Version.Student" table="studentVersion">
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<id name="id" unsaved-value="null">
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<generator class="uuid.hex"></generator>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)</id>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<!--version标签必须跟在id标签后面-->
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<version name="version" column="ver" type="int"></version>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="name" type="string" column="name"></property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)</class>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)</hibernate-mapping>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
Hibernate.cfg.xml
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<?xml version='1.0' encoding='UTF-8'?>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<!DOCTYPE hibernate-configuration PUBLIC
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)          "-//Hibernate/Hibernate Configuration DTD 3.0//EN"
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)          "http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd">
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<!-- Generated by MyEclipse Hibernate Tools.                   -->
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<hibernate-configuration>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<session-factory>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="connection.username">root</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="connection.url">
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)        jdbc:mysql://localhost:3306/schoolproject?characterEncoding=gb2312&useUnicode=true
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="dialect">
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)        org.hibernate.dialect.MySQLDialect
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="myeclipse.connection.profile">mysql</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="connection.password">1234</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="connection.driver_class">
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)        com.mysql.jdbc.Driver
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="hibernate.dialect">
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)        org.hibernate.dialect.MySQLDialect
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="hibernate.show_sql">true</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="current_session_context_class">thread</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<property name="jdbc.batch_size">15</property>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)<mapping resource="Version/Student.hbm.xml"/>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)</session-factory>
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)</hibernate-configuration>
测试代码：
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)package Version;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)import java.io.File;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)import java.util.Iterator;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)import java.util.Set;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)import org.hibernate.Session;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)import org.hibernate.SessionFactory;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)import org.hibernate.Transaction;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)import org.hibernate.cfg.Configuration;
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBlockStart.gif)publicclass Test {
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockStart.gif)publicstaticvoid main(String[] args) {
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        String filePath=System.getProperty("user.dir")+File.separator+"src/Version"+File.separator+"hibernate.cfg.xml";
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        File file=new File(filePath);
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        System.out.println(filePath);
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        SessionFactory sessionFactory=new Configuration().configure(file).buildSessionFactory();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        Session session=sessionFactory.openSession();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        Transaction t=session.beginTransaction();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        Student stu=new Student();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        stu.setName("tom11");
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        session.save(stu);
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        t.commit();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockStart.gif)/*
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)         * 模拟多个session操作student数据表
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockEnd.gif)*/
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        Session session1=sessionFactory.openSession();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        Session session2=sessionFactory.openSession();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        Student stu1=(Student)session1.createQuery("from Student s where s.name='tom11'").uniqueResult();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        Student stu2=(Student)session2.createQuery("from Student s where s.name='tom11'").uniqueResult();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)//这时候，两个版本号是相同的
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        System.out.println("v1="+stu1.getVersion()+"--v2="+stu2.getVersion());
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        Transaction tx1=session1.beginTransaction();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        stu1.setName("session1");
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        tx1.commit();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)//这时候，两个版本号是不同的，其中一个的版本号递增了
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        System.out.println("v1="+stu1.getVersion()+"--v2="+stu2.getVersion());
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        Transaction tx2=session2.beginTransaction();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        stu2.setName("session2");
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)        tx2.commit();
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubBlockEnd.gif)    }
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBlockEnd.gif)}
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
运行结果：
Hibernate: insert into studentVersion (ver, name, id) values (?, ?, ?)
Hibernate: select student0_.id as id0_, student0_.ver as ver0_, student0_.name as name0_ from studentVersion student0_ where student0_.name='tom11'
Hibernate: select student0_.id as id0_, student0_.ver as ver0_, student0_.name as name0_ from studentVersion student0_ where student0_.name='tom11'
v1=0--v2=0
Hibernate: update studentVersion set ver=?, name=? where id=? and ver=?
v1=1--v2=0
Hibernate: update studentVersion set ver=?, name=? where id=? and ver=?
Exception in thread "main" org.hibernate.StaleObjectStateException: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect): [Version.Student#4028818316cd6b460116cd6b50830001]
可以看到，第二个“用户”session2修改数据时候，记录的版本号已经被session1更新过了，所以抛出了红色的异常，我们可以在实际应用中处理这个异常，例如在处理中重新读取数据库中的数据，同时将目前的数据与数据库中的数据展示出来，让使用者有机会比较一下，或者设计程序自动读取新的数据
注意：如果手工设置stu.setVersion()自行更新版本以跳过检查,则这种乐观锁就会失效，应对方法可以将Student.java的setVersion设置成private
