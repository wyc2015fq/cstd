# C3P0配置实战 - z69183787的专栏 - CSDN博客
2014年04月02日 10:20:14[OkidoGreen](https://me.csdn.net/z69183787)阅读数：8637
个人分类：[数据库连接池-JNDI](https://blog.csdn.net/z69183787/article/category/2175417)
*C3P0：* 一个开源的JDBC连接池，它实现了数据源和JNDI绑定，支持JDBC3规范和JDBC2的标准扩展。目前使用它的开源项目有Hibernate，Spring等。
默认情况下（即没有配置连接池的情况下），Hibernate会采用内建的连接池。但这个连接池性能不佳，因此官方也只是建议仅在开发环境下使用。Hibernate支持第三方的连接池，官方推荐的连接池是C3P0,Proxool。
这里说一下为什么一定要使用C3P0吧：
1）hibernate官网推荐
2)  解决数据库重启后tomcat在不需要重启的情况下即可重新获得数据连接的问题。
下载：[http://www.mchange.com/projects/c3p0/index.html](http://www.mchange.com/projects/c3p0/index.html)
这里说一下如何配置，网上其实有好多，我只是根据项目需要整理了一下，一共3种，大家根据需要来配置。
一。JNDI（项目比较常用，最简单，与代码无关联）
1)在tomcat或者项目中引入最新版的C3P0的JAR包（我是用的是c3p0-0.9.2.1.jar）
如果启动时报类没有找到：Caused by: java.lang.NoClassDefFoundError: com/mchange/v2/ser/Indirector，
则需要加入mchange-commons-java-0.2.3.4.jar。
2)修改tomcat中的数据源配置，如下：
Xml代码  ![收藏代码](http://hanqunfeng.iteye.com/images/icon_star.png)
- <Resourcename="jdbc/dbsource"
- type="com.mchange.v2.c3p0.ComboPooledDataSource"
- maxPoolSize="50"minPoolSize="5"acquireIncrement="2"initialPoolSize="10"maxIdleTime="60"
- factory="org.apache.naming.factory.BeanFactory"
- user="xxxx"password="xxxx"
- driverClass="oracle.jdbc.driver.OracleDriver"
- jdbcUrl="jdbc:oracle:thin:@192.168.x.x:1521:orcl"
- idleConnectionTestPeriod="10"/>
**参数说明：**
（1）idleConnectionTestPeriod
当数据库重启后或者由于某种原因进程被杀掉后，C3P0不会自动重新初始化数据库连接池，当新的请求需要访问数据库的时候，此时会报错误(因为连接失效)，同时刷新数据库连接池，丢弃掉已经失效的连接，当第二个请求到来时恢复正常。
C3P0目前没有提供当获取已建立连接失败后重试次数的参数，只有获取新连接失败后重试次数的参数(**acquireRetryAttempts【默认为30】** )。
要解决此问题，可以通过设置**idleConnectionTestPeriod【默认为0，表示不检查** 】参数折中解决，该参数的作用是设置系统自动检查连接池中连接是否正常的一个频率参数，时间单位是秒 。
（2）**acquireIncrement**
当连接池中的的连接耗尽的时候c3p0一次同时获取的连接数，也就是说，如果使用的连接数已经达到了maxPoolSize，c3p0会立即建立新的连接。
（3）**maxIdleTime**
另外，C3P0默认不会close掉不用的连接池，而是将其回收到可用连接池中，这样会导致，连接数越来越大，所以需要设置maxIdleTime【默认0，表示永远不过期】，单位是秒，maxIdleTime表示idle状态的connection能存活的最大时间。
3)项目中正常引入这个数据源即可，代码不需要任何修改
二。Hibernate（spring+hibernate）：不推荐，完全可以使用第一种和第三种方法代替。
1)项目中引入C3P0的JAR
2)修改Hibernate中的配置（我使用的是Spring+Hibernate），如下：
Xml代码  ![收藏代码](http://hanqunfeng.iteye.com/images/icon_star.png)
- <beanid="sessionFactory"
- class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
- <propertyname="dataSource"ref="dataSource"/>
- <propertyname="mappingLocations"value="${hibernate.mapping.locations}"/>
- <propertyname="hibernateProperties">
- <props>
- <propkey="hibernate.dialect">
-                     ${hibernate.dialect}  
- </prop>
- <propkey="hibernate.show_sql">
-                     ${hibernate.show_sql}  
- </prop>
- <propkey="hibernate.use_sql_comments">
-                     ${hibernate.use_sql_comments}  
- </prop>
- 
- <propkey="hibernate.connection.provider_class">
-                     org.hibernate.connection.C3P0ConnectionProvider  
- </prop>
- <!--连接池的最小连接数 -->
- <propkey="hibernate.c3p0.min_size">
-                     5  
- </prop>
- <!--最大连接数 -->
- <propkey="hibernate.c3p0.max_size">
-                     50  
- </prop>
- <!--连接超时时间 -->
- <propkey="hibernate.c3p0.timeout">
-                     120  
- </prop>
- <!--statemnets缓存大小 -->
- <propkey="hibernate.c3p0.max_statements">
-                     100  
- </prop>
- <!--每隔多少秒检测连接是否可正常使用 -->
- <propkey="hibernate.c3p0.idle_test_period">
-                     120  
- </prop>
- <!--当池中的连接耗尽的时候，一次性增加的连接数量,默认为3 -->
- <propkey="hibernate.c3p0.acquire_increment">
-                     2  
- </prop>
- <!-- 每次都验证连接是否可用 -->
- <propkey="hibernate.c3p0.validate">
-                     true  
- </prop>
- </props>
- </property>
- </bean>
- 
 3)这里的dataSource可以是jndi。
三。dataSource（spring，开发常用）
如果使用spring，同时项目中不使用jndi，又不想配置到Hibernate中，可以直接将C3P0配置到dataSource中即可，如下：
Xml代码  ![收藏代码](http://hanqunfeng.iteye.com/images/icon_star.png)
- <beanid="dataSource"class="com.mchange.v2.c3p0.ComboPooledDataSource"destroy-method="close">
- <propertyname="driverClass"><value>oracle.jdbc.driver.OracleDriver</value></property>
- <propertyname="jdbcUrl"><value>jdbc:oracle:thin:@localhost:1521:Test</value></property>
- <propertyname="user"><value>Kay</value></property>
- <propertyname="password"><value>root</value></property>
- <!--连接池中保留的最小连接数。-->
- <propertyname="minPoolSize"value="10"/>
- <!--连接池中保留的最大连接数。Default: 15 -->
- <propertyname="maxPoolSize"value="100"/>
- <!--最大空闲时间,1800秒内未使用则连接被丢弃。若为0则永不丢弃。Default: 0 -->
- <propertyname="maxIdleTime"value="1800"/>
- <!--当连接池中的连接耗尽的时候c3p0一次同时获取的连接数。Default: 3 -->
- <propertyname="acquireIncrement"value="3"/>
- <propertyname="maxStatements"value="1000"/>
- <propertyname="initialPoolSize"value="10"/>
- <!--每60秒检查所有连接池中的空闲连接。Default: 0 -->
- <propertyname="idleConnectionTestPeriod"value="60"/>
- <!--定义在从数据库获取新连接失败后重复尝试的次数。Default: 30 -->
- <propertyname="acquireRetryAttempts"value="30"/>
- <propertyname="breakAfterAcquireFailure"value="true"/>
- <propertyname="testConnectionOnCheckout"value="false"/>
- </bean>
参考资料：
参数说明：[http://baike.baidu.com/view/920062.htm](http://baike.baidu.com/view/920062.htm)
Hibernate连接池配置：[http://dengjianqiang200.blog.163.com/blog/static/658119201032313017139](http://dengjianqiang200.blog.163.com/blog/static/658119201032313017139)
Jndi 与 c3p0 结合：[http://yakar.iteye.com/blog/356243](http://yakar.iteye.com/blog/356243)
C3P0容错和自动重连特性：[http://hi.baidu.com/ivexrhlaozbdqtq/item/ad9572973a5312f2291647b1](http://hi.baidu.com/ivexrhlaozbdqtq/item/ad9572973a5312f2291647b1)
