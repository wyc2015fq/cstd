# 垂直拆分和水平拆分 - Spark高级玩法 - CSDN博客
2018年03月23日 00:00:00[Spark高级玩法](https://me.csdn.net/rlnLo2pNEfx9c)阅读数：249
## **垂直拆分**
垂直拆分就是要把表按模块划分到不同数据库表中（当然原则还是不破坏第三范式），这种拆分在大型网站的演变过程中是很常见的。当一个网站还在很小的时候，只有小量的人来开发和维护，各模块和表都在一起，当网站不断丰富和壮大的时候，也会变成多个子系统来支撑，这时就有按模块和功能把表划分出来的需求。其实，相对于垂直切分更进一步的是服务化改造，说得简单就是要把原来强耦合的系统拆分成多个弱耦合的服务，通过服务间的调用来满足业务需求看，因此表拆出来后要通过服务的形式暴露出去，而不是直接调用不同模块的表，淘宝在架构不断演变过程，最重要的一环就是服务化改造，把用户、交易、店铺、宝贝这些核心的概念抽取成独立的服务，也非常有利于进行局部的优化和治理，保障核心模块的稳定性。如下图 
**缺点** 垂直拆分单表在大数据量的表中依然存在性能瓶颈
![640?wx_fmt=png&wxfrom=5&wx_lazy=1](https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/adI0ApTVBFVacn50auMODzWclnwQZ3CT8C6N0lXXia5A1ne72NxibKiafKu4r1kwvLcSWdX0G0WIv99w7Pz5XYZibg/640?wx_fmt=png&wxfrom=5&wx_lazy=1)
通常会按照一下原则拆分 
1. 把不常⽤的字段单独放在⼀张表; 
2. 把text，blob等⼤字段拆分出来放在附表中; 
3.  经常组合查询的列放在⼀张表中;
**垂直拆分**更多时候就应该在数据表设计之初就执⾏的步骤，然后查询的时候⽤jion关键起来即可; 
如果系统过于庞大，拆分的表可以放在不同的数据库中，甚至不同的Server中，怎样划分Server就要根据功能模块和项目实际划分。而有些频繁使用的数据也一定要做读写分离；
比如微博和阿里。读和写都比较频繁，肯定会做读写分离。 
如果日志信息也放在了数据库中的一张表中，每天近千万条的日志，那么一天表中的数据量就会很大，在做查询或者其他更新数据时，就会很缓慢，那这时就要考虑**水平拆分**了。
## **水平拆分**
上面谈到垂直切分只是把表按模块划分到不同数据库，甚至数据库也分为了不同Server，但**没有解决单表大数据量的问题**，而**水平切分**就是**要把一个表按照某种规则把数据划分到不同表或数据库里**。例如像计费系统和日志系统。通过按时间来划分表就比较合适，因为系统都是处理某一时间段的数据。而像SaaS应用，通过按用户维度来划分数据比较合适，因为用户与用户之间的隔离的，一般不存在处理多个用户数据的情况，简单的按user_id范围来水平切分
![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/adI0ApTVBFVacn50auMODzWclnwQZ3CT1AYyXVBHXFSGSLXhqpTdhr8a2ib5MVJwibM5hGa85f05mthMHIicVSvEQ/640?wx_fmt=png)
**拆分原则**
通常情况下，我们使⽤取模的⽅式来进⾏表的拆分;⽐如⼀张有400W的⽤户表users，为提高其查询效率我们把其分成4张表users1，users2，users3，users4 ，通过用id取模的方法把数据分散到四张表内Id%4+1 = [1,2,3,4]然后查询，更新，删除。 
例如：id = 17,17%4 + 1 = 2, $tableName = ‘users’.’2’ 
`Select * from users2 where id = 17;`
在insert时还需要⼀张临时表uid_temp来提供自增的id,该表的唯⼀⽤处就是提供⾃增的ID;
insertinto uid_temp values(null);
得到⾃增的ID后,又通过取模法进行分表插⼊;  
**注意**：进行水平拆分后的表,字段的列和类型和原表保持一致,但是要记得去掉auto_increment自增长。
**另外部分业务逻辑也可以通过地区，年份等字段来进行归档拆分**
进⾏拆分后的表，只能满足部分查询的高效查询需求，这时我们就要在产品策划上，从界⾯上**约束用户查询⾏为**。 
比如我们是按年来进行归档拆分的，这个时候在页⾯设计上就约束⽤户必须要先选择年,然后才能进行查询;  
在做分析或者统计时，由于是自己公司内部工作的需求，多点等待其实是没关系的，并且并发很低，这个时候可以⽤union把所有表都组合成⼀张视图来进⾏查询，然后再进⾏查询;
## **垂直与水平联合切分**
由上面可知垂直切分能更清晰化模块划分，区分治理，水平切分能解决大数据量性能瓶颈问题，因此常常就会把两者结合使用，这在大型网站里是种常见的策略
**案例：**
以mysql为例，简单购物系统暂设涉及如下表： 
 1. 产品表（数据量10w，稳定） 　 
 2. 订单表（数据量200w，且有增长趋势） 　  
 3. 用户表 （数据量100w，且有增长趋势）　 
**垂直拆分：**
解决问题： 表与表之间的io竞争 
不解决问题： 单表中数据量增长出现的压力 
方案：
![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/adI0ApTVBFVacn50auMODzWclnwQZ3CTfLQtyZZZ7rMsPtKny1452vLt4HicsMvwb3orQA43cblxMzQB1F5bYCQ/640?wx_fmt=png)**水平拆分：**
解决问题： 单表中数据量增长出现的压力 
不解决问题： 表与表之间的io争夺 
方案：
![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/adI0ApTVBFVacn50auMODzWclnwQZ3CTC83ZRDYrRpvm6eq7utEPw3tWncmr69JXBYFTu9TtoaUZjOR3niaia2qg/640?wx_fmt=png)
本文原文链接，请点击阅读原文。
**推荐阅读：**
1，[HBase学习—高表与宽表的选择](http://mp.weixin.qq.com/s?__biz=MzA3MDY0NTMxOQ==&mid=2247484419&idx=1&sn=78b39975f5f41b193d5a508b6150755e&chksm=9f38e72ba84f6e3df903b6dbe2b2ed51797851a46e6084ebbb21ac0aeee0f59755c8fc5ffb9d&scene=21#wechat_redirect)
2，[结合源码彻底讲解Aggregate vs treeAggregate](http://mp.weixin.qq.com/s?__biz=MzA3MDY0NTMxOQ==&mid=2247484410&idx=1&sn=cbb9edefd09bf010410a9fd679ec2caf&chksm=9f38e0d2a84f69c4c8dc23da08fae992b24732c81cd5c271fd47234ae1a8d457867c5063c81b&scene=21#wechat_redirect)
3，[Spark的Ml pipeline](http://mp.weixin.qq.com/s?__biz=MzA3MDY0NTMxOQ==&mid=2247484270&idx=1&sn=69153063accd105649d4466d938012da&chksm=9f38e046a84f69505d954726c65d940f9a370342755ae2ce7456134ef4b9a6eafb1350a4dfb6&scene=21#wechat_redirect)
4，[Spark源码系列之Standalone模式下Spark应用的整个启动过程](http://mp.weixin.qq.com/s?__biz=MzA3MDY0NTMxOQ==&mid=2247483817&idx=1&sn=3ff54dcd88b44a3522439f46e4c64b5c&chksm=9f38e281a84f6b971208a945ed5cf0a199d17eaa1418504dded52b63c300194670752068a048&scene=21#wechat_redirect)
![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/adI0ApTVBFWF1rkKibTzeA8PicbicYXBsH26a9PXg2HNnlEt1thHBFxUtEjicACeaSlRWictpPziaMdibXmYq34dWfQ9w/640?wx_fmt=png)
