# UDP分包问题 - 建建的博客 - CSDN博客
2017年03月24日 10:03:41[纪建](https://me.csdn.net/u013898698)阅读数：2281
   1.在进行UDP编程的时候,我们最容易想到的问题就是,一次发送多少bytes好?     
   当然,这个没有唯一答案，相对于不同的系统,不同的要求,其得到的答案是不一样的,我这里仅对     
   像ICQ一类的发送聊天消息的情况作分析，对于其他情况，你或许也能得到一点帮助:     
   首先,我们知道,TCP/IP通常被认为是一个四层协议系统,包括链路层,网络层,运输层,应用层.     
   UDP属于运输层,下面我们由下至上一步一步来看:     
   以太网(Ethernet)数据帧的长度必须在46-1500字节之间,这是由以太网的物理特性决定的.     
   这个1500字节被称为链路层的MTU(最大传输单元).     
   但这并不是指链路层的长度被限制在1500字节,其实这这个MTU指的是链路层的数据区.     
   并不包括链路层的首部和尾部的18个字节.     
   所以,事实上,这个1500字节就是网络层IP数据报的长度限制.     
   因为IP数据报的首部为20字节,所以IP数据报的数据区长度最大为1480字节.     
   而这个1480字节就是用来放TCP传来的TCP报文段或UDP传来的UDP数据报的.     
   又因为UDP数据报的首部8字节,所以UDP数据报的数据区最大长度为1472字节.     
   这个1472字节就是我们可以使用的字节数。:)     
   当我们发送的UDP数据大于1472的时候会怎样呢？     
   这也就是说IP数据报大于1500字节,大于MTU.这个时候发送方IP层就需要分片(fragmentation).     
   把数据报分成若干片,使每一片都小于MTU.而接收方IP层则需要进行数据报的重组.     
   这样就会多做许多事情,而更严重的是,由于UDP的特性,当某一片数据传送中丢失时,接收方便     
   无法重组数据报.将导致丢弃整个UDP数据报。     
   因此,在普通的局域网环境下，我建议将UDP的数据控制在1472字节以下为好.     
   进行Internet编程时则不同,因为Internet上的路由器可能会将MTU设为不同的值.     
   如果我们假定MTU为1500来发送数据的,而途经的某个网络的MTU值小于1500字节,那么系统将会使用一系列的机     
   制来调整MTU值,使数据报能够顺利到达目的地,这样就会做许多不必要的操作.     
   鉴于Internet上的标准MTU值为576字节,所以我建议在进行Internet的UDP编程时.     
   最好将UDP的数据长度控件在548字节(576-8-20)以内.     
   2.UDP数据报的覆盖和重叠问题?     
   有的兄弟说使用UDP编程时会出现数据的覆盖和重叠问题,     
   所谓覆盖,即发送第一条消息为"第一条",第二条消息为"第二条".     
   而接收到的两条消息皆为"第一条".     
   而重叠,即指当发送"第一条","第二条"两条消息后.     
   收到的第一条消息可能是不固定的,比如"第一条第二","第一条第二条"等.     
   这种重叠的情况在TCP编程中是常见的.     
   但是在我的编程经验中，从来没有遇到过这两种情况.     
   我在局域网中在机器A用使死循环连续不断的向机器B发送UDP数据报.     
   但一直没有出现上面的两个问题.     
   因此我认为,根据UDP协议的特性,不会象基于字节流连接的TCP一样出现重叠问题.     
   有兄弟说,他在局域网试也没有问题,但在Internet上会.是不是路由器对数据进行组合,     
   或者说两条消息同时到达？     
   我想两条消息到达的时延无论如何不会比在局域网中的时延短吧?即时有,那种机率也是很少的.     
   而对于路由数据进行了重组,我认为,即使假定路由器对数据进行了重组,这也对导致UDP数据报     
   在接收时发现数据报中的校验和与数据不一致而丢弃该数据报。     
