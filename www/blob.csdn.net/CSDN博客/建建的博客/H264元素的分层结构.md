# H264元素的分层结构 - 建建的博客 - CSDN博客
2018年04月27日 11:10:07[纪建](https://me.csdn.net/u013898698)阅读数：80
**H264元素的分层结构**
H.264编码器输出的Bit流中，每个Bit都隶属于某个句法元素。句法元素被组织成有层次的结构，分别描述各个层次的信息。
![](http://hi.csdn.net/attachment/201008/18/0_1282095853LJjW.gif)
          在H.264 中，句法元素共被组织成  序列、图像、片、宏块、子宏块五个层次。在这样的结构中，***每一层的头部和它的数据部分形成管理与被管理的强依赖关系，头部的句法元素是该层数据的核心，而一旦头部丢失，数据部分的信息几乎不可能再被正确解码出来***，尤其在序列层及图像层。
![264句法元素的分层结构](http://hi.csdn.net/attachment/201004/9/0_12708045694Axb.gif)
        在 H.264 中，分层结构最大的不同是取消了序列层和图像层，并将原本属于序列和图像头部的大部分句法元素游离出来形成序列和图像两级参数集，其余的部分则放入片层。 
        参数集是一个独立的数据单位，不依赖于参数集外的其他句法元素。一个参数集不对应某一个特定的图像或序列，同一序列参数集可以被多个图像参数集引用，同理，同一个图像参数集也可以被多个图像引用。只在编码器认为需要更新参数集的内容时，才会发出新的参数集。
      复杂通信中的码流中可能出现的数据单位：
![264句法元素的分层结构](http://hi.csdn.net/attachment/201004/9/0_1270804572nX3l.gif)
**IDR:** 在H.264中，图像以序列为单位进行组织。**一个序列的第一个图像叫做 IDR 图像（立即刷新图像），IDR 图像都是 I 帧图像。H.264 引入 IDR 图像是为了解码的重同步，当解码器解码到 IDR 图像时，立即将参考帧队列清空，将已解码的数据全部输出或抛弃，重新查找参数集，开始一个新的序列。***这样，如果前一个序列出现重大错误，在这里可以获得重新同步的机会。IDR图像之后的图像永远不会使用IDR之前的图像的数据来解码。      *IDR 图像一定是 I 图像，但 I 图像不一定是 IDR 图像。I帧之后的图像有可能会使用I帧之前的图像做运动参考。
** H264码流结构**
**1. H264分层结构**
H.263定义的码流结构是分级结构，共四层。自上而下分别为：图像层(picturelayer)、块组层(GOB layer)、宏块层(macroblock layer)和块层(block layer)。而与H.263相比，H.264的码流结构和H.263的有很大的区别，它采用的不再是严格的分级结构。
H.264的功能分为两层，视频编码层（VCL）和网络提取层（NAL）VCL数据即被压缩编码后的视频数据序列。在VCL数据要封装到NAL单元中之后，才可以用来传输或存储。
NAL单元格式[2] 表1所示：
    NAL头RBSPNAL头RBSP
RBSP：封装于网络抽象单元的数据称之为原始字节序列载荷RBSP，它是NAL的基本传输单元。其中，RBSP又分为视频编码数据和控制数据。其基本结构是：在原始编码数据的后面填加了结尾比特。一个bit“1”若干比特“0”，以便字节对齐。
**RBSP的类型**： 
RBSP 类型之一 PS: 包括序列参数集 SPS  和 图像参数集 PPS 
        SPS 包含的是针对一连续编码视频序列的参数，如标识符 seq_parameter_set_id、帧数及 POC 的约束、参考帧数目、解码图像尺寸和帧场编码模式选择标识等等。 
        PPS对应的是一个序列中某一幅图像或者某几幅图像，其参数如标识符 pic_parameter_set_id、可选的 seq_parameter_set_id、熵编码模式选择标识、片组数目、初始量化参数和去方块滤波系数调整标识等等。 
**NALU类型 **
       标识NAL单元中的RBSP数据类型，其中，nal_unit_type为1， 2， 3， 4， 5及12的NAL单元称为VCL的NAL单元，其他类型的NAL单元为非VCL的NAL单元。 
0：未规定 
1：非IDR图像中不采用数据划分的片段 
2：非IDR图像中A类数据划分片段 
3：非IDR图像中B类数据划分片段 
4：非IDR图像中C类数据划分片段 
5：IDR图像的片段 
6：补充增强信息 (SEI) 
7：序列参数集 
8：图像参数集 
9：分割符 
10：序列结束符 
11：流结束符 
12：填充数据 
13 – 23：保留 
24 – 31：未规定 
**2. H.264码流结构图**
通过相关知识的查阅，概括出H.264的码流结构图[2]如图1所示：
![](https://img-blog.csdn.net/20130912141333281?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveHhxMTIzMzIx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)
图1 H.264的码流结构
**3 H.264码流分析的应用**
在有些时候，需要从H.264码流中直接取得相关信息（如：图像的宽度和图像的高度等等信息）。下面介绍下取得相关信息的方法：
图像的相关信息存储在网络提取层（NAL）的RBSP结构中，要取得图像的相关信息，既要获得图像的相关位。需依据RBSP结构，获得pic_width_in_mbs_minus1和pic_height_in_map_units_minus1两个值，那么宽度为(pic_width_in_mbs_minus1+1)*16，高度为(pic_height_in_map_units_minus1+1)*16，但是有些情况还得考虑nNum_Ref_Frames的值，一般为1。
**3.1**获得试验数据****
设备：SUNNIC（IP Cam）
名字：ST100factory
Firmware版本：p8b8
视频格式：H.264
(1)将设备分辨率设成176*144，使用Ethereal等抓包工具抓得一组数据，并去掉相应的RTP头后，该数据为0x00,0x00,0x00,0x01,0x67,0x42,0x00,0x1E,0x99,0xA0,0xB1,0x31。
(2)将设备分辨率设成720*240，使用Ethereal等抓包工具抓得一组数据，并去掉相应的RTP头后，该数据为0x00,0x00,0x00,0x01,0x67,0x42,0xE0,0x1E,0xDA,0x82,0xD1,0xF1。
(3)将设备分辨率设成720*480，使用Ethereal等抓包工具抓得一组数据，并去掉相应的RTP头后，该数据为0x00,0x00,0x00,0x01,0x67,0x42,0xE0,0x1E,0xDB,0x82,0xD1,0xF1。
