# 微信开放平台开发(2) 网站应用微信登录 - weixin_33985507的博客 - CSDN博客
2016年06月01日 11:43:00[weixin_33985507](https://me.csdn.net/weixin_33985507)阅读数：7
关键字：微信公众平台 微信开放平台 微信登录 微信扫码登录 使用微信账号登录网站
作者：方倍工作室 
原文：[http://www.cnblogs.com/txw1958/p/weixin-qrlogin.html](http://www.cnblogs.com/txw1958/p/weixin-qrlogin.html)
在这篇微信公众平台开发教程中，我们将介绍如何使用微信开放平台接口实现微信扫码登录的功能。
#### 准备工作
网站应用微信登录是基于[OAuth2.0协议标准](http://oauth.net/2/)构建的微信OAuth2.0授权登录系统。
在进行微信OAuth2.在进行微信OAuth2.0授权登录接入之前，在微信开放平台注册开发者帐号，并拥有一个已审核通过的网站应用，并获得相应的AppID和AppSecret，申请微信登录且通过审核后，可开始接入流程。
![](https://images2015.cnblogs.com/blog/340216/201512/340216-20151222115118765-1676768555.png)
#### 授权流程说明
微信OAuth2.0授权登录让微信用户使用微信身份安全登录第三方应用或网站，在微信用户授权登录已接入微信OAuth2.0的第三方应用后，第
三方可以获取到用户的接口调用凭证（access_token），通过access_token可以进行微信开放平台授权关系接口调用，从而可实现获取微
信用户基本开放信息和帮助用户实现基础开放功能等。
微信OAuth2.0授权登录目前支持authorization_code模式，适用于拥有server端的应用授权。该模式整体流程为：
- 
1. 第三方发起微信授权登录请求，微信用户允许授权第三方应用后，微信会拉起应用或重定向到第三方网站，并且带上授权临时票据code参数；
- 
2. 通过code参数加上AppID和AppSecret等，通过API换取access_token；
- 
3. 通过access_token进行接口调用，获取用户基本数据资源或帮助用户实现基本操作。
获取access_token时序图：
![](https://res.wx.qq.com/open/zh_CN/htmledition/res/img/pic/web-wxlogin/12168b9.png)
##### 第一步：请求CODE
登录方倍工作室微信登录网站应用
```
http://weixin.fangbei.org/login.php
```
打开后，应用会生成state参数，跳转到以下链接：（登录前请注意已获取相应网页授权作用域（scope=snsapi_login））
```
https://open.weixin.qq.com/connect/qrconnect?appid=wxed782be999f86e0e&redirect_uri=http%3A%2F%2Fweixin.fangbei.org%2Flogin.php&response_type=code&scope=snsapi_login&state=123#wechat_redirect
```
若提示“该链接无法访问”，请检查参数是否填写错误，如redirect_uri的域名与审核时填写的授权域名不一致或scope不为snsapi_login。
###### 参数说明
|参数|是否必须|说明|
|----|----|----|
|appid|是|应用唯一标识|
|redirect_uri|是|重定向地址，需要进行UrlEncode|
|response_type|是|填code|
|scope|是|应用授权作用域，拥有多个作用域用逗号（,）分隔，网页应用目前仅填写snsapi_login即可|
|state|否|用于保持请求和回调的状态，授权请求后原样带回给第三方。该参数可用于防止csrf攻击（跨站请求伪造攻击），建议第三方带上该参数，可设置为简单的随机数加session进行校验|
###### 返回说明
此时，PC网站上显示如下二维码
![](https://images2015.cnblogs.com/blog/340216/201601/340216-20160107155902309-1192283481.jpg)
用户允许授权后，将会重定向到redirect_uri的网址上，并且带上code和state参数
```
http://weixin.fangbei.org/login.php?code=0317a2c31ccd5eadf1a7a8fffd4a7dbf&state=123
```
为了满足网站更定制化的需求，我们还提供了第二种获取code的方式，支持网站将微信登录二维码内嵌到自己页面中，用户使用微信扫码授权后通过JS将code返回给网站。
JS微信登录主要用途：网站希望用户在网站内就能完成登录，无需跳转到微信域下登录后再返回，提升微信登录的流畅性与成功率。 网站内嵌二维码微信登录JS实现办法：
###### 步骤1：在页面中先引入如下JS文件（支持https）：
```
<script src="http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js"></script>
```
###### 步骤2：在需要使用微信登录的地方实例以下JS对象：
```
![复制代码](https://common.cnblogs.com/images/copycode.gif)
        <script>
            var obj = new WxLogin({
              id: "login_container",
              appid: "wxed782be999f86e0e",
              scope: "snsapi_login",
              redirect_uri: encodeURIComponent("http://" + window.location.host + "/login.php"),
              state: Math.ceil(Math.random()*1000),
              style: "black",
              href: ""});
        </script>
![复制代码](https://common.cnblogs.com/images/copycode.gif)
```
参数说明
|参数|是否必须|说明|
|----|----|----|
|id|是|第三方页面显示二维码的容器id|
|appid|是|应用唯一标识，在微信开放平台提交应用审核通过后获得|
|scope|是|应用授权作用域，拥有多个作用域用逗号（,）分隔，网页应用目前仅填写snsapi_login即可|
|redirect_uri|是|重定向地址，需要进行UrlEncode|
|state|否|用于保持请求和回调的状态，授权请求后原样带回给第三方。该参数可用于防止csrf攻击（跨站请求伪造攻击），建议第三方带上该参数，可设置为简单的随机数加session进行校验|
|style|否|提供"black"、"white"可选，默认为黑色文字描述。详见文档底部FAQ|
|href|否|自定义样式链接，第三方可根据实际需求覆盖默认样式。详见文档底部FAQ|
完整代码如下
```
![复制代码](https://common.cnblogs.com/images/copycode.gif)
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
    </head>
    <body>
        <span id="login_container"></span>
        <script src="http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js"></script>
        <script>
            var obj = new WxLogin({
              id: "login_container",
              appid: "wxed782be999f86e0e",
              scope: "snsapi_login",
              redirect_uri: encodeURIComponent("http://" + window.location.host + "/login.php"),
              state: Math.ceil(Math.random()*1000),
              style: "black",
              href: ""});
        </script>
    </body>
</html>
![复制代码](https://common.cnblogs.com/images/copycode.gif)
```
页面显示效果如下 
![](https://images2015.cnblogs.com/blog/340216/201601/340216-20160107164740528-260107651.jpg)
##### 第二步：通过code获取access_token
通过code获取access_token
https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&secret=SECRET&code=CODE&grant_type=authorization_code
###### 参数说明
|参数|是否必须|说明|
|----|----|----|
|appid|是|应用唯一标识，在微信开放平台提交应用审核通过后获得|
|secret|是|应用密钥AppSecret，在微信开放平台提交应用审核通过后获得|
|code|是|填写第一步获取的code参数|
|grant_type|是|填authorization_code|
###### 返回说明
正确的返回：
```
![复制代码](https://common.cnblogs.com/images/copycode.gif)
{
    "access_token": "OezXcEiiBSKSxW0eoylIeFy2HFC4Bxv9JvC0Sgj4Px4_8TX1ci3jF_QP_6sWjvx2rCAUjXEP1_9edZdJLf3MIwii2N8cnTooDfx7nYpFRmOSZyq4gb2FNdWJr__KUqPtcfVUvg6XBTucZZ4zH6v8VQ",
    "expires_in": 7200,
    "refresh_token": "OezXcEiiBSKSxW0eoylIeFy2HFC4Bxv9JvC0Sgj4Px4_8TX1ci3jF_QP_6sWjvx2lW60INlf6AK1q21rW7mJyc5yG3GZ9p1psANOKTi2EZUQXA6CnwSXxDQlJ3421tEOvCWIrJhkA8oTqjsLKYG-yg",
    "openid": "oJekJs2faTQ47FGjDOEIyOPMN97s",
    "scope": "snsapi_login",
    "unionid": "o4wcnw02YjFUYglZxV0LwcBkVF6Y"
}
![复制代码](https://common.cnblogs.com/images/copycode.gif)
```
参数说明
|参数|说明|
|----|----|
|access_token|接口调用凭证|
|expires_in|access_token接口调用凭证超时时间，单位（秒）|
|refresh_token|用户刷新access_token|
|openid|授权用户唯一标识|
|scope|用户授权的作用域，使用逗号（,）分隔|
|unionid|当且仅当该网站应用已获得该用户的userinfo授权时，才会出现该字段。|
错误返回样例：
`{"errcode":40029,"errmsg":"invalid code"}`
##### 刷新access_token有效期
access_token是调用授权关系接口的调用凭证，由于access_token有效期（目前为2个小时）较短，当access_token超时后，可以使用refresh_token进行刷新，access_token刷新结果有两种：
- 
1. 若access_token已超时，那么进行refresh_token会获取一个新的access_token，新的超时时间；
- 
2. 若access_token未超时，那么进行refresh_token不会改变access_token，但超时时间会刷新，相当于续期access_token。
refresh_token拥有较长的有效期（30天），当refresh_token失效的后，需要用户重新授权。
###### 请求方法
获取第一步的code后，请求以下链接进行refresh_token：
https://api.weixin.qq.com/sns/oauth2/refresh_token?appid=APPID&grant_type=refresh_token&refresh_token=REFRESH_TOKEN
###### 参数说明
|参数|是否必须|说明|
|----|----|----|
|appid|是|应用唯一标识|
|grant_type|是|填refresh_token|
|refresh_token|是|填写通过access_token获取到的refresh_token参数|
###### 返回说明
正确的返回：
```
{ 
"access_token":"ACCESS_TOKEN", 
"expires_in":7200, 
"refresh_token":"REFRESH_TOKEN", 
"openid":"OPENID", 
"scope":"SCOPE" 
}
```
|参数|说明|
|----|----|
|access_token|接口调用凭证|
|expires_in|access_token接口调用凭证超时时间，单位（秒）|
|refresh_token|用户刷新access_token|
|openid|授权用户唯一标识|
|scope|用户授权的作用域，使用逗号（,）分隔|
错误返回样例：
`{"errcode":40030,"errmsg":"invalid refresh_token"}`
##### 注意：
1、Appsecret 是应用接口使用密钥，泄漏后将可能导致应用数据泄漏、应用的用户数据泄漏等高风险后果；存储在客户端，极有可能被恶意窃取（如反编译获取Appsecret）；
2、access_token 为用户授权第三方应用发起接口调用的凭证（相当于用户登录态），存储在客户端，可能出现恶意获取access_token 后导致的用户数据泄漏、用户微信相关接口功能被恶意发起等行为；
3、refresh_token 为用户授权第三方应用的长效凭证，仅用于刷新access_token，但泄漏后相当于access_token 泄漏，风险同上。
建议将secret、用户数据（如access_token）放在App云端服务器，由云端中转接口调用请求。
##### 第三步：通过access_token调用接口
获取access_token后，进行接口调用，有以下前提：
- 
1. access_token有效且未超时；
- 
2. 微信用户已授权给第三方应用帐号相应接口作用域（scope）。
对于接口作用域（scope），能调用的接口有以下：
|授权作用域（scope）|接口|接口说明|
|----|----|----|
|snsapi_base|/sns/oauth2/access_token|通过code换取access_token、refresh_token和已授权scope|
|/sns/oauth2/refresh_token|刷新或续期access_token使用| |
|/sns/auth|检查access_token有效性| |
|snsapi_userinfo|/sns/userinfo|获取用户个人信息|
其中snsapi_base属于基础接口，若应用已拥有其它scope权限，则默认拥有snsapi_base的权限。使用snsapi_base
可以让移动端网页授权绕过跳转授权登录页请求用户授权的动作，直接跳转第三方网页带上授权临时票据（code），但会使得用户已授权作用域（scope）
仅为snsapi_base，从而导致无法获取到需要用户授权才允许获得的数据和基础功能。
接口调用方法可查阅[《微信授权关系接口调用指南》](https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&id=open1419316518&lang=zh_CN)
下面是获取用户个人信息，并dump出来
```
![复制代码](https://common.cnblogs.com/images/copycode.gif)
array(10) {
  ["openid"]=>
  string(28) "oJekJs2faTQ47FGjDOEIyOPMN97s"
  ["nickname"]=>
  string(15) "方倍工作室"
  ["sex"]=>
  int(1)
  ["language"]=>
  string(5) "zh_CN"
  ["city"]=>
  string(6) "海淀"
  ["province"]=>
  string(6) "北京"
  ["country"]=>
  string(6) "中国"
  ["headimgurl"]=>
  string(139) "http://wx.qlogo.cn/mmopen/Q3auHgzwzM7zdkiaZFdM5qrwk1iaEESVjfhWVHNg22teOnfKSPpKDE0l2yfQm1hM9AeT8pO1BKElntEBZ7DxibzdteBp3H3yXESwPYUkhibNObs/0"
  ["privilege"]=>
  array(0) {
  }
  ["unionid"]=>
  string(28) "o4wcnw02YjFUYglZxV0LwcBkVF6Y"
}
![复制代码](https://common.cnblogs.com/images/copycode.gif)
```
完整代码实现如下
```
![复制代码](https://common.cnblogs.com/images/copycode.gif)
<?php
/*
    方倍工作室 http://www.fangbei.org/
    CopyRight 2014 All Rights Reserved
    微信开放平台接口SDK
*/
define('APPID',        "wxed782be999f86e0e");
define('APPSECRET',    "72edec63779f7aa16a3a33447e2c70fb");
class class_weixin
{
    var $appid = APPID;
    var $appsecret = APPSECRET;
    //构造函数，获取Access Token
    public function __construct($appid = NULL, $appsecret = NULL)
    {
        if($appid && $appsecret){
            $this->appid = $appid;
            $this->appsecret = $appsecret;
        }
    }
    /*
    *  PART1 网站应用
    */
    //生成扫码登录的URL
    public function qrconnect($redirect_url, $scope, $state = NULL)
    {
        $url = "https://open.weixin.qq.com/connect/qrconnect?appid=".$this->appid."&redirect_uri=".urlencode($redirect_url)."&response_type=code&scope=".$scope."&state=".$state."#wechat_redirect";
        return $url;
    }
    //生成OAuth2的Access Token
    public function oauth2_access_token($code)
    {
        $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=".$this->appid."&secret=".$this->appsecret."&code=".$code."&grant_type=authorization_code";
        $res = $this->http_request($url);
        return json_decode($res, true);
    }
    //获取用户基本信息（OAuth2 授权的 Access Token 获取 未关注用户，Access Token为临时获取）
    public function oauth2_get_user_info($access_token, $openid)
    {
        $url = "https://api.weixin.qq.com/sns/userinfo?access_token=".$access_token."&openid=".$openid."&lang=zh_CN";
        $res = $this->http_request($url);
        return json_decode($res, true);
    }
    //HTTP请求（支持HTTP/HTTPS，支持GET/POST）
    protected function http_request($url, $data = null)
    {
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, FALSE);
        if (!empty($data)){
            curl_setopt($curl, CURLOPT_POST, 1);
            curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
        }
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, TRUE);
        $output = curl_exec($curl);
        curl_close($curl);
        return $output;
    }
}
![复制代码](https://common.cnblogs.com/images/copycode.gif)
```
接口调用方法如下
```
![复制代码](https://common.cnblogs.com/images/copycode.gif)
<?php
header("Content-type: text/html; charset=utf-8");
require_once('wxopen.class.php');
$weixin = new class_weixin();
if (!isset($_GET["code"])){
    $redirect_url = 'http://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
    $jumpurl = $weixin->qrconnect($redirect_url, "snsapi_login", "123");
    Header("Location: $jumpurl");
}else{
    $oauth2_info = $weixin->oauth2_access_token($_GET["code"]);
    $userinfo = $weixin->oauth2_get_user_info($oauth2_info['access_token'], $oauth2_info['openid']);
    var_dump($userinfo);
}
![复制代码](https://common.cnblogs.com/images/copycode.gif)
```
##### F.A.Q
###### 1. 什么是授权临时票据（code）？
答：第三方通过code进行获取access_token的时候需要用到，code的超时时间为10分钟，一个code只能成功换取一次 access_token即失效。code的临时性和一次保障了微信授权登录的安全性。第三方可通过使用https和state参数，进一步加强自身授权 登录的安全性。
###### 2. 什么是授权作用域（scope）？
答：授权作用域（scope）代表用户授权给第三方的接口权限，第三方应用需要向微信开放平台申请使用相应scope的权限后，使用文档所述方式让用户进行授权，经过用户授权，获取到相应access_token后方可对接口进行调用。
###### 3. 网站内嵌二维码微信登录JS代码中style字段作用？
答：第三方页面颜色风格可能为浅色调或者深色调，若第三方页面为浅色背景，style字段应提供"black"值（或者不提供，black为默认值），则对应的微信登录文字样式为黑色。相关效果如下：
![](https://res.wx.qq.com/open/zh_CN/htmledition/res/img/pic/web-wxlogin/22168b9.png)![](https://res.wx.qq.com/open/zh_CN/htmledition/res/img/pic/web-wxlogin/32168b9.png)
若提供"white"值，则对应的文字描述将显示为白色，适合深色背景。相关效果如下：
![](https://res.wx.qq.com/open/zh_CN/htmledition/res/img/pic/web-wxlogin/42168b9.png)![](https://res.wx.qq.com/open/zh_CN/htmledition/res/img/pic/web-wxlogin/52168b9.png)
###### 4.网站内嵌二维码微信登录JS代码中href字段作用？
答：如果第三方觉得微信团队提供的默认样式与自己的页面样式不匹配，可以自己提供样式文件来覆盖默认样式。举个例子，如第三方觉得默认二维码过大，可以提供相关css样式文件，并把链接地址填入href字段
```
.impowerBox .qrcode {width: 200px;}
.impowerBox .title {display: none;}
.impowerBox .info {width: 200px;}
.status_icon {display：none}
.impowerBox .status {text-align: center;}
```
相关效果如下：
![](https://res.wx.qq.com/open/zh_CN/htmledition/res/img/pic/web-wxlogin/62168b9.png)![](https://res.wx.qq.com/open/zh_CN/htmledition/res/img/pic/web-wxlogin/72168b9.png)
