# kafkaæ¶ˆæ¯å­˜å‚¨è®¾è®¡ - weixin_33985507çš„åšå®¢ - CSDNåšå®¢
2017å¹´09æœˆ23æ—¥ 18:25:00[weixin_33985507](https://me.csdn.net/weixin_33985507)é˜…è¯»æ•°ï¼š17
æ¶ˆæ¯é˜Ÿåˆ—çš„å¼•å…¥ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨MQï¼Ÿ
MQï¼ˆMessage Queueï¼‰ï¼Œä¸€ç§è·¨è¿›ç¨‹çš„é€šä¿¡æœºåˆ¶ï¼Œç”¨äºä¸Šä¸‹æ¸¸ä¼ é€’æ¶ˆæ¯ã€‚èƒ½è¾¾åˆ°è§£è€¦ã€å¼‚æ­¥ã€æ¶ˆå³°é™æµçš„ä½œç”¨ã€‚ä¸¾å‡ ä¸ªå¯¹åº”çš„é€‚ç”¨ä¾‹å­ã€‚
**è§£è€¦**
1. æ¯”å¦‚å®šæ—¶ä»»åŠ¡ä¾èµ–çš„åœºæ™¯ï¼Œæ™šä¸Šéœ€è¦è·‘ä¸€äº›å®šæ—¶ç»Ÿè®¡ä»»åŠ¡ï¼Œä»»åŠ¡2ä¾èµ–ä»»åŠ¡1çš„ç»“æœï¼Œä»»åŠ¡3ä¾èµ–ä»»åŠ¡2çš„æ¥å£ï¼Œä¸€èˆ¬å¼€å‘äººå‘˜ä¼šåœ¨æ¯ä¸ªå®šæ—¶ä»»åŠ¡ä¹‹é—´ï¼Œé¢„ç•™ä¸€äº›æ—¶é—´bufferå¤„ç†ã€‚ä½†æ˜¯ï¼Œå½“æŸä¸€å¤©å…¶ä¸­ä¸€ä¸ªä»»åŠ¡è¶…å‡ºå¸¸è§„æ—¶é—´ï¼Œä»»åŠ¡å°±è·‘ä¹±å¥—äº†ï¼Œç¬¬äºŒå¤©è‚¯å®šå°±æœ‰äººæ¥æ‰¾åˆ°ä½ äº†ã€‚è¿™ä¸ªåœºæ™¯å°±å¾ˆé€‚åˆç”¨MQå»è§£è€¦ï¼Œå½“ä»»åŠ¡1å®Œæˆåï¼Œé€šçŸ¥åˆ°ä»»åŠ¡2ï¼Œä»»åŠ¡äºŒé€šè¿‡è®¢é˜…æ¶ˆæ¯å»å®ç°è§¦å‘ã€‚
2. æ¯”å¦‚ç»Ÿä¸€å……å€¼ç½‘å…³æœåŠ¡ï¼ŒæŸä¸ªäº§å“æ¥å…¥ç»Ÿä¸€å……å€¼æœåŠ¡çš„å¾®ä¿¡æ¸ é“å……å€¼ã€‚å……å€¼æˆåŠŸåï¼Œå¾®ä¿¡æœåŠ¡ç«¯ä¼šé€šçŸ¥åˆ°ç»Ÿä¸€å……å€¼æœåŠ¡ç«¯ï¼Œå› ä¸ºè¿™äº›æ˜¯å¼‚æ­¥çš„è°ƒç”¨ï¼Œä¸”æ˜¯å…¬ç½‘æ¥å£ï¼Œæ—¶é—´ä¼šç›¸å¯¹é•¿ä¸€äº›ï¼Œä¸šåŠ¡ä¸Šäº§å“æ¥å…¥æ–¹ä¼šæœ‰éœ€æ±‚æƒ³çŸ¥é“ï¼Œåˆ°è´¦çš„ç»“æœã€‚è¿™ä¸ªåˆ°è´¦é€šçŸ¥å°±å¾ˆé€‚åˆMQå»å®ç°ã€‚å¦‚æœï¼Œè¿™é‡Œç”±å……å€¼ç½‘å…³æœåŠ¡è°ƒç”¨ä¸Šæ¸¸æ¥é€šçŸ¥ç»“æœçš„è¯ï¼Œæ¯æ¬¡æ–°å¢è°ƒç”¨æ–¹ï¼Œå……å€¼ç½‘å…³æœåŠ¡éƒ½éœ€è¦ä¿®æ”¹ä»£ç å‘å¸ƒï¼Œä¾èµ–åè½¬äº†ã€‚å……å€¼ç½‘å…³+MQçš„æ–¹å¼ï¼Œä¸šåŠ¡è°ƒç”¨æ–¹å»è®¢é˜…æ¶ˆæ¯å®ç°è§£è€¦ã€‚
**å¼‚æ­¥**
1.åœºæ™¯ä¸Šæ¸¸ä¸å…³å¿ƒæ‰§è¡Œç»“æœã€‚å¼‚æ­¥ï¼Œrpcæ¡†æ¶å¼‚æ­¥è°ƒç”¨ä¹Ÿå¯ä»¥ã€‚åŒºåˆ«å°±æ˜¯MQæ¶ˆæ¯ä¼šè½åœ°ï¼Œå¹¶ä¸”æ¶ˆæ¯ä¸­é—´ä»¶éƒ½ä¼šæœ‰HAçš„æ¶‰åŠï¼Œèƒ½ä¿è¯æ¶ˆæ¯è¯­ä¹‰çš„å®ç°ï¼ˆè‡³å°‘ä¸€æ¬¡ã€è‡³å°‘ä¸€æ¬¡ã€è‡³å¤šä¸€æ¬¡ï¼‰ã€‚rpcå¼‚æ­¥è¯·æ±‚æœ¬èº«ä¹Ÿä¼šæœ‰æœ¬åœ°å†…å­˜é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ•°æ®ä¸æ˜¯è¦æ±‚å¾ˆé‡è¦çš„åœºæ™¯ï¼Œå·®ä¸å¤šã€‚åªæ˜¯åœ¨å·¥ç¨‹ä¸Šï¼Œæœ‰ä¸€ç‚¹ï¼Œä½¿ç”¨rpcå¤„ç†è¿™ç§ä¸šåŠ¡ï¼Œç»éªŒä¸Šè¦å•æ‹‰å‡ºä¸€ä¸ªæœåŠ¡å»è°ƒç”¨ä¸‹æ¸¸ï¼Œå› ä¸ºä¾èµ–å€’ç½®äº†ã€‚æ¯å¢åŠ æ¥å…¥æ–¹æˆ–è€…ä¸šåŠ¡æœ‰ä¿®æ”¹ï¼Œéƒ½è¦æä¾›æœåŠ¡çš„å·¥ç¨‹å»ä¿®æ”¹å‘å¸ƒï¼ˆæœ‰ç»éªŒçš„åŒå­¦åº”è¯¥æ·±æœ‰ä½“ä¼šï¼‰ï¼Œä½œä¸ºåŸºç¡€æœåŠ¡çš„è¯ï¼Œåº”è¯¥å‡å°‘è¿™ç§ä¾èµ–å€’ç½®çš„å‘å¸ƒï¼Œç‹¬ç«‹å‡ºæ¥ä¸€ä¸ªæœåŠ¡å¤„ç†çš„è¯ï¼Œä¼šå‡å°‘é£é™©ã€‚
ä¸šåŠ¡çš„è¯ï¼Œå¤„ç†æ¨èæ—¥å¿—ï¼Œå¤„ç†appåŸ‹ç‚¹çš„ç»Ÿè®¡æ•°æ®
**æ¶ˆå³°é™æµ**
è¿™ä¸ªåº”è¯¥æ˜¯MQå¦ä¸€ä¸ªæœ€ä¸»è¦çš„ä½œç”¨ä¹‹ä¸€ã€‚åšæ´»åŠ¨è®¿é—®é‡é™¡å¢ï¼Œä¸‹æ¸¸å¤„ç†ä¸è¿‡æ¥çš„æ—¶å€™ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¾¾åˆ°é™æµçš„ä½œç”¨ã€‚å·¥ç¨‹ä¸Šæœ‰ä¸ªC10Ké—®é¢˜ï¼ˆè™½ç„¶ç°åœ¨å·²ç»æœ‰ç°åœ¨æˆ‘ä»¬æ—©å·²ç»çªç ´äº†C10Kè¿™ä¸ªç“¶é¢ˆï¼Œå…·ä½“çš„æ€è·¯å°±æ˜¯é€šè¿‡å•ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹æœåŠ¡äºå¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œé€šè¿‡å¼‚æ­¥ç¼–ç¨‹å’Œäº‹ä»¶è§¦å‘æœºåˆ¶æ›¿æ¢è½®è®­ï¼ŒIO é‡‡ç”¨éé˜»å¡çš„æ–¹å¼ï¼ˆreactoræ¨¡å‹ï¼‰ï¼Œå‡å°‘ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ï¼Œç­‰ç­‰ï¼‰ã€‚ä½†æ˜¯è¿™ä¸ªè¦æ±‚ä¸‹æ¸¸çš„æœåŠ¡åŒ…æ‹¬å­˜å‚¨å’Œä¾èµ–ï¼Œéƒ½è¦åšåˆ°è¿™ç‚¹ï¼Œå“ªä¸ªç¯èŠ‚å¼±éƒ½ä¸è¡Œã€‚å¯èƒ½è¿˜ä¼šæµªè´¹èµ„æºï¼Œå¹³æ—¶çš„é‡ç”¨ä¸ç€é‚£ä¹ˆå¤šæœåŠ¡å™¨ã€‚
ç›¸åº”çš„ï¼Œé‚£äº›è°ƒç”¨æ–¹éœ€è¦è¢«è°ƒç”¨æ–¹ç«‹åˆ»è¿”å›ç»“æœçš„éœ€æ±‚ï¼Œå°±ä¸é€‚ç”¨äºMQï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡å»è€ƒè™‘ï¼Œè„±ç¦»äº†ä¸šåŠ¡å»å¼•å…¥æ–°æŠ€æœ¯å°±æ˜¯è€æµæ°“ã€‚
**ä¸šåŠ¡ä¸Šæœ‰å¯¹æ¶ˆæ¯ç»„ä»¶çš„éœ€æ±‚åï¼Œå¸‚é¢ä¸Šé™†ç»­å‡ºç°äº†å¾ˆå¤šæˆç†Ÿçš„æ¶ˆæ¯ä¸­é—´ä»¶**
IBM webSphere MQ*ã€*Apache ActiveMQã€LinkedIn Kafkaã€é˜¿é‡Œ rocketMQã€
javaç¤¾åŒºè‚¯å®šè¦è·Ÿç€ä¸€èµ·ç©çš„ï¼Œç¤¾åŒºä¹Ÿå®šä¹‰jmsè§„èŒƒï¼ˆ[JMSè§„èŒƒç™¾åº¦è¯æ¡](https://link.jianshu.com?t=https://baike.baidu.com/item/JMS/2836691?fr=aladdin)ï¼‰***maid***ã€‚è¿™äº›æ¶ˆæ¯ç»„ä»¶ï¼Œå‰ä¸¤ä¸ªæ˜¯åŸºäºjmsè§„èŒƒå®ç°çš„ï¼Œåä¸¤ä¸ªæ²¡æœ‰ï¼ŒrocketMQå¼€å§‹æ˜¯kafkaçš„javaç‰ˆå®ç°ï¼Œç°åœ¨å·²ç»ä»Apacheç¤¾åŒºæ­£å¼æ¯•ä¸šï¼ˆ17-0925ï¼‰ï¼Œæˆä¸ºApacheé¡¶çº§é¡¹ç›®ã€‚åœ¨åŸæœ‰è®¾è®¡çš„åŸºç¡€ä¸Šï¼Œæ¯”å¦‚æä¾›äº‹åŠ¡æ¶ˆæ¯ç­‰ä¸€äº›åŠŸèƒ½ï¼Œkafka0.11ç‰ˆå¼€å§‹ä¹Ÿæä¾›å¯äº‹åŠ¡çš„æ”¯æŒï¼Œè¿˜æ²¡å‘å¸ƒå¤ªä¹…ï¼Œæ•ˆæœè¿˜æœ‰å¾…è§‚å¯Ÿï¼›ä½†æ˜¯éƒ½ç”¨åˆ«çš„æ–¹å¼å®ç°äº†jmså®šä¹‰çš„ä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚å‘å¸ƒè®¢é˜…ï¼Œç‚¹å¯¹ç‚¹é€šä¿¡ã€‚
**å¦‚ä½•è®¾è®¡å®ç°ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼š**
å®ç°ä¸€ä¸ªæ¶ˆæ¯ç»„ä»¶ä¸å¯é¿å…çš„è¦å¤„ç†å¦‚ä¸‹é—®é¢˜ï¼ˆ[æ¶ˆæ¯ä¸­é—´ä»¶ç²¾è¦è®¾è®¡](https://link.jianshu.com?t=https://tech.meituan.com/mq-design.html)ï¼‰ï¼š
1.é€šä¿¡åè®®çš„é€‰æ‹©
2.æ¶ˆæ¯çš„åˆ†å¸ƒå¼å­˜å‚¨è®¾è®¡ï¼Œå…³ç³»å‹æ•°æ®åº“ ç£ç›˜ kvå­˜å‚¨
3.å¦‚ä½•åˆ†å¸ƒå¼è®¾è®¡ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¿è¯é«˜åå
4.å¦‚ä½•å®ç°é¡ºåºæ¶ˆè´¹
5.å¦‚ä½•ä¿è¯HAï¼Œåœ¨é«˜ååå’ŒHAä¸Šåšå¹³è¡¡
6.äº‹åŠ¡æ¶ˆæ¯çš„æ”¯æŒ
7.pushè¿˜æ˜¯pull
8.å•æ’­ã€å¹¿æ’­ã€è®¢é˜…å‘å¸ƒçš„å®ç°
9.æ€§èƒ½çš„ä¼˜åŒ–ï¼ŒåŒæ­¥å¼‚æ­¥ã€æ‰¹é‡ç­‰
ä»¥ä¸Šé—®é¢˜æœ‰äº¤å‰ï¼Œä»¥è¿™äº›é—®é¢˜å‡ºå‘ï¼Œçœ‹çœ‹kafkaæ˜¯å¦‚ä½•è®¾è®¡å®ç°çš„ã€‚
**ä¸€.kafkaåŸºæœ¬æ¦‚å¿µçš„ä»‹ç»**
1.**topics ä¸»é¢˜**ï¼Œé˜Ÿåˆ—çš„é€»è¾‘æ¦‚å¿µã€‚å¯ä»¥æœ‰å¤šä¸ªproducerç”Ÿäº§æ¶ˆæ¯å¾€topicå‘é€ï¼Œæœ‰ä¸ªconsumerä»topicæ¶ˆè´¹æ¶ˆæ¯ã€‚
![6630851-46739e8650c1da09.png](https://upload-images.jianshu.io/upload_images/6630851-46739e8650c1da09.png)
topicç»“æ„å›¾
topicæœ‰partitionç»„æˆï¼Œpartitionä¸ªæ•°æœ‰server.propertyé…ç½®æ–‡ä»¶æŒ‡å®šï¼Œpartitionçš„æœåŠ¡å™¨çš„åˆ†å¸ƒï¼Œä¼šç”±ç®—æ³•å‡åˆ†åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚æ¯ä¸ªpartitionä¸Šçš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ä¸å¯å˜çš„ã€‚
![6630851-7343aa2fe5dea5da.png](https://upload-images.jianshu.io/upload_images/6630851-7343aa2fe5dea5da.png)
partitionä¸Šç”Ÿäº§æ¶ˆè´¹æƒ…å†µ
ç”Ÿäº§çš„æ¶ˆæ¯ï¼Œæ˜¯ä»¥logçš„æ–‡ä»¶æ ¼å¼å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ã€‚å…·ä½“æ ¼å¼ä¸‹è¾¹ä¼šå•ç‹¬å†è¯´ä¸‹ã€‚æ¯æ¡æ¶ˆæ¯æœ‰ä¸€ä¸ªä½ç§»ä¿¡æ¯offsetï¼Œç”Ÿäº§è€…åœ¨é˜Ÿåˆ—å°¾æ·»åŠ æ¶ˆæ¯ï¼Œoffset+1ã€‚ç”Ÿäº§è€…æ¶ˆè´¹æ¶ˆæ¯çš„è¿›åº¦ä½ç½®ä¹Ÿæ˜¯ç”¨offsetæ ‡è®°ï¼Œæ¶ˆè´¹åï¼Œæ¶ˆæ¯æ˜¯ä¸åˆ é™¤çš„ï¼Œæ‰€ä»¥å¯ä»¥æŒ‡å®šoffseté‡æ–°æ¶ˆè´¹ã€‚**offsetçš„å€¼çš„æäº¤å­˜å‚¨æ˜¯æ”¾åˆ°å®¢æˆ·ç«¯å®Œæˆçš„**ï¼Œ**æ‰€ä»¥æœåŠ¡ç«¯æ˜¯æ— æ¶ˆè´¹çŠ¶æ€çš„**ã€‚
offsetçš„å­˜å‚¨ä½ç½®è€ç‰ˆæœ¬æ˜¯æ”¾åˆ°zookeeperä¸Šï¼Œè€ƒè™‘åˆ°é›†ç¾¤topicå¾ˆå¤šçš„è¯ï¼Œzookeeperçš„è¯»å†™æ“ä½œå¾ˆé¢‘ç¹ï¼Œzookeeperæ˜¯ä¸é€‚åˆæœ‰å¤§é‡å†™å…¥æ“ä½œçš„ã€‚æ‰€ä»¥æ–°ç‰ˆæœ¬æŠŠoffsetå­˜å‚¨åˆ°æœåŠ¡å™¨ç«¯ä¸€ä¸ªå•ç‹¬çš„topicä¸‹__consumer-offsetsã€‚è¿™ä¸ªtopicé»˜è®¤50ä¸ªåˆ†åŒº
![6630851-00950be49643dd29.png](https://upload-images.jianshu.io/upload_images/6630851-00950be49643dd29.png)
offsetå­˜å‚¨ä½ç½®__consumer-offsets
**2.producer**
ç”Ÿäº§è€…å¾€æŒ‡å®šçš„topicå‘æ¶ˆæ¯ï¼Œç”Ÿäº§è€…å‘æ¶ˆæ¯åˆ°ä¸åŒçš„partitionä¸Šç®—æ³•æœ‰æ ¹æ®keyå€¼hashã€è½®è®­å’Œæ–°ç‰ˆæœ¬æœ€æ–°çš„ç®—æ³•ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°æŒ‡å®špartitionçš„ç­–ç•¥ã€‚
**ç”Ÿäº§è€…å¦‚ä½•æŒ‡å®šå‘é€çš„partitionï¼Ÿå¦‚ä½•æŒ‡å®šå‘é€çš„ç­–ç•¥ï¼Ÿ**
**3.consumer and consumer group**
![6630851-91a6ca80519cbc1a.png](https://upload-images.jianshu.io/upload_images/6630851-91a6ca80519cbc1a.png)
consumer groupï¼Œconsumerï¼Œpartitionçš„å…³ç³»
> 
1.æ¶ˆè´¹è€…æ¶ˆè´¹topicï¼Œå¿…é¡»æŒ‡å®šconsumer groupï¼Œå…¶ä¸­é…ç½®æ–‡ä»¶group.idå”¯ä¸€æ ‡è¯†ä¸€ä¸ªconsumer group
2.topicä¸Šå¯ä»¥æœ‰å¤šä¸ªconsumer groupå»è®¢é˜…ï¼Œkafkaä½¿ç”¨è¿™ä¸ªæ¦‚å¿µå®ç°JMSè§„èŒƒé‡Œè¾¹å‘å¸ƒè®¢é˜…åŠŸèƒ½ï¼Œå³ä¸åŒçš„æ¥å…¥æ–¹æƒ³å®ç°è®¢é˜…åŠŸèƒ½ï¼Œåªéœ€è¦æŒ‡å®šä¸åŒçš„consumer groupå³å¯ã€‚
3.consumer groupä¸Šå¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œå¹¶ä¸”ä¸€ä¸ªpartitionåªæœ‰consumer groupçš„å…¶ä¸­ä¸€ä¸ªconsumeråœ¨æ¶ˆè´¹ã€‚ä¸€ä¸ªconsumerå¯ä»¥æ¶ˆè´¹å¤šä¸ªpartition
çœ‹åˆ°åä¼šæƒ³åˆ°çš„é—®é¢˜ï¼š**consumer groupé‡Œçš„consumerå¦‚ä½•åˆ†é…æ¶ˆè´¹partitionçš„å…³ç³»ï¼Ÿ**
4.replica å‰¯æœ¬
HAè®¾è®¡çš„æ¦‚å¿µï¼Œ**å‰¯æœ¬å¯¹åº”çš„æ˜¯partitionçš„æ¦‚å¿µ**ã€‚æ¯ä¸ªpartitionçš„å‰¯æœ¬ä¸ªæ•°ï¼Œåœ¨é…ç½®æ–‡ä»¶æœ‰æŒ‡å®šã€‚å¦‚æœæœ‰3æœºå™¨ï¼Œ3å‰¯æœ¬èƒ½ä¿è¯ï¼ˆ3-1ï¼‰ä¸ªserver failçš„æƒ…å†µä¸‹ï¼Œä¸ä¸¢æ¶ˆæ¯ã€‚[è§kafkaçš„HAè®¾è®¡](https://www.jianshu.com/p/8ba38874fcb4)
**é—®é¢˜ï¼škafkaæ˜¯å¦‚ä½•åˆ©ç”¨replicaæ¦‚å¿µè®¾è®¡HAçš„ï¼Ÿ**
**äºŒ.æœåŠ¡ç«¯æ¶ˆæ¯logå­˜å‚¨è®¾è®¡**
> 
é€‰æ‹©çš„æ˜¯ç£ç›˜æ–‡ä»¶çš„æŒä¹…åŒ–æ–¹å¼ï¼Œæ²¡æœ‰æä¾›ä¸æŒä¹…åŒ–çš„é€‰æ‹©ã€‚
![6630851-efd8fc4e6875c62a.png](https://upload-images.jianshu.io/upload_images/6630851-efd8fc4e6875c62a.png)
3ä¸ªpartitionæ–‡ä»¶å¤¹
å¯ä»¥çœ‹åˆ°kafka10-topic-20170924æœ‰ä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼Œæ¯ä¸ªæ–‡ä»¶å¤¹ä»£è¡¨ä¸€ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºä¸‹çš„å­˜å‚¨ç”±segmentç»„æˆï¼Œä¸€ä¸ªsegmentåŒ…æ‹¬indexç´¢å¼•æ–‡ä»¶ï¼Œæ—¶é—´æˆ³indexç´¢å¼•æ–‡ä»¶å’Œå®é™…å­˜å‚¨æ•°æ®çš„logæ–‡ä»¶ç»„æˆã€‚
æ¯ä¸ªlogæ–‡ä»¶çš„å¤§å°é»˜è®¤æ˜¯10Mï¼ˆå¯é…ç½®ï¼‰ï¼Œè¶…è¿‡10Mï¼Œæ–°å»ºæ–‡ä»¶ï¼Œæ–‡ä»¶çš„åå­—æ˜¯ç¬¬ä¸€ä¸ªæ¶ˆæ¯çš„offsetå€¼ã€‚
**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿå¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ**
![6630851-345254f2581efb03.png](https://upload-images.jianshu.io/upload_images/6630851-345254f2581efb03.png)
segmentç»“æ„
![6630851-2e6f6ac93b9c982a.png](https://upload-images.jianshu.io/upload_images/6630851-2e6f6ac93b9c982a.png)
segmentç»“æ„
![6630851-3bdfcd08a47edbe7.png](https://upload-images.jianshu.io/upload_images/6630851-3bdfcd08a47edbe7.png)
ç´¢å¼•æ–‡ä»¶å’Œlogæ–‡ä»¶å…³ç³»
ç´¢å¼•æ–‡ä»¶çš„ç»“æ„æ˜¯ä¸€ä¸ªmapï¼Œkeyæ˜¯å½“å‰segmentçš„offsetçš„åç§»é‡ï¼Œä»0å¼€å§‹ã€‚valueæ˜¯å¯¹åº”çš„logæ–‡ä»¶ä¸­æ¶ˆæ¯å¼€å§‹ä½ç½®çš„å®é™…ç‰©ç†ä½ç½®åç§»é‡ã€‚ç´¢å¼•æ–‡index fileé‡‡å–ç¨€ç–ç´¢å¼•å­˜å‚¨æ–¹å¼ï¼Œå®ƒå‡å°‘ç´¢å¼•æ–‡ä»¶å¤§å°ï¼Œé€šè¿‡mmapå¯ä»¥ç›´æ¥å†…å­˜æ“ä½œï¼Œç¨€ç–ç´¢å¼•ä¸ºæ•°æ®æ–‡ä»¶çš„æ¯ä¸ªå¯¹åº”messageè®¾ç½®ä¸€ä¸ªå…ƒæ•°æ®æŒ‡é’ˆ,å®ƒæ¯”ç¨ å¯†ç´¢å¼•èŠ‚çœäº†æ›´å¤šçš„å­˜å‚¨ç©ºé—´ï¼Œä½†æŸ¥æ‰¾èµ·æ¥éœ€è¦æ¶ˆè€—æ›´å¤šçš„æ—¶é—´ã€‚
ä¸¾ä¸ªğŸŒ°ï¼Œæ¶ˆæ¯çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼Œæ¯”å¦‚offsetçš„å€¼æ˜¯368772ï¼Œå¦‚ä½•æŸ¥æ‰¾æ¶ˆè´¹å¯¹åº”æ¶ˆæ¯å†…å®¹ã€‚
> 
1.æ ¹æ®offsetæ‰¾åˆ°æ‰€åœ¨çš„segmentï¼Œæ ¹æ®äºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°æ¶ˆæ¯æ‰€åœ¨çš„logæ–‡ä»¶0000000000000368769.logå’Œç´¢å¼•æ–‡ä»¶0000000000000368769.index
2.è®¡ç®—ä¸‹å·®368772-368769=3ï¼Œåœ¨ç´¢å¼•æ–‡ä»¶ä¸­ä¹Ÿæ˜¯äºŒåˆ†æŸ¥æ‰¾ï¼Œå®šä½åˆ°æ˜¯<3,497>è®°å½•ï¼Œå³å¯¹åº”çš„ç‰©ç†ä½ç½®æ˜¯497ï¼Œä»è€Œæ‰¾åˆ°æ¶ˆæ¯
3.æ ¹æ®ç‰©ç†ä½ç½®497åœ¨0000000000000368769.logæ–‡ä»¶æ‰¾åˆ°æ¶ˆæ¯ã€‚
**é—®é¢˜ï¼šå¦‚æœç¨€ç–ç´¢å¼•æ²¡æœ‰æ‰¾åˆ°æ€ä¹ˆåŠï¼Ÿ**
å¦‚æœæ˜¯ç´¢å¼•æ–‡ä»¶æ²¡æœ‰å‘½ä¸­æ€ä¹ˆåŠã€‚è¿™å°±è¦ç»§ç»­åœ¨çœ‹ä¸‹æ¯æ¡logçš„æ¶ˆæ¯æ ¼å¼ï¼š
![6630851-bcc7d0e0dc33abff.png](https://upload-images.jianshu.io/upload_images/6630851-bcc7d0e0dc33abff.png)
æ¯æ¡æ¶ˆæ¯æ—¥å¿—çš„åè®®æ ¼å¼
å­—æ®µè§£é‡Šï¼š
> 
offsetï¼š8bytesé•¿åº¦çš„åç§»é‡ï¼Œå”¯ä¸€è¡¨ç¤ºä¸€æ¡æ¶ˆæ¯
message length ï¼šæ¶ˆæ¯é•¿åº¦
crcï¼šCRC32æ ¡éªŒæ¶ˆæ¯
magic valueï¼šæ ‡ç¤ºæ˜¯å¦å…è®¸æ ¼å¼åŒ–æ”¹å˜
attributesï¼šbit 0ï½2ï¼šå‹ç¼©æ–¹æ³•ï¼Œ0æ²¡æœ‰å‹ç¼© 1gzip 2 snappy 3 lz4ï¼›bit 3ï¼šæ—¶é—´æˆ³ç±»å‹ï¼Œ0åˆ›å»ºæ—¶é—´ 1æ—¥å¿—çš„è¿½åŠ æ—¶é—´ï¼›bit 4ï½7é¢„ç•™
timestampï¼šå½“æ—¶magic valueçš„å€¼æ˜¯1æ˜¯ï¼Œæœ‰æ•ˆã€‚è¡¨ç¤ºæ—¶é—´æˆ³ã€‚è¿™ä¸ªæ–°ç‰ˆæœ¬å¼•å…¥çš„å­—æ®µ
key lengthï¼šæ¶ˆæ¯keyçš„é•¿åº¦
keyï¼škeyçš„å€¼
value lengthï¼šæ¶ˆæ¯å†…å®¹çš„é•¿åº¦
valueï¼šæ¶ˆæ¯çš„å…·ä½“å†…å®¹
æ‰€ä»¥æ²¡æœ‰ç´¢å¼•åˆ°çš„æŸ¥æ‰¾ï¼Œå°±å…ˆæ ¹æ®äºŒåˆ†æ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¡å†…å®¹ï¼Œ**ç„¶åæ ¹æ®æ¯æ¡æ¶ˆæ¯çš„æ ¼å¼ï¼ŒçŸ¥é“æ¶ˆæ¯çš„é•¿åº¦ã€‚ä¾æ¬¡è®¡ç®—å‡ºä¸‹ä¸€æ¡æ¶ˆæ¯çš„ä½ç½®ï¼Œç›´åˆ°æ‰¾åˆ°offsetç›¸ç­‰çš„é‚£æ¡è®°å½•ã€‚**
æœåŠ¡å™¨ä¸Šçš„æ—¥å¿—æ–‡ä»¶æ˜¯äºŒè¿›åˆ¶çš„ï¼Œkafkaæä¾›å¾ˆå¤šæ–¹ä¾¿çš„è„šæœ¬å·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨kafkaçš„å·¥å…·ç±»DumpLogSegmentsç±»è§£ææŸ¥çœ‹ä¸€ä¸‹ç»“æ„å¦‚å›¾
![6630851-ac4cf9a9d488ec54.png](https://upload-images.jianshu.io/upload_images/6630851-ac4cf9a9d488ec54.png)
logäºŒè¿›åˆ¶æ–‡ä»¶è½¬æ¢åçš„ç»“æ„è¾“å‡º
è½¬æ¢è„šæœ¬æŒ‡ä»¤ï¼Œè¦åŠ ä¸Š--print-data-logå‚æ•°ï¼Œä¸åŠ çš„è¯ï¼Œé»˜è®¤ä¸è¾“å‡ºkeyå€¼å’Œvalueå€¼ã€‚å…¶ä¸­å›¾ä¸­payloadæ˜¯valueå€¼ã€‚
> 
./kafka-run-class.shÂ  kafka.tools.DumpLogSegments --print-data-log --files /tmp/kafka-logs/kafka10-topic-20170924-0/000000000000000000.log
åŒæ ·çš„çœ‹ä¸‹offsetç´¢å¼•æ–‡ä»¶å’Œæ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶ï¼Œå—¯ï¼Œè·Ÿå®˜ç½‘æ–‡æ¡£æè¿°çš„ä¸€æ ·ï¼Œå°±æ”¾å¿ƒäº†ã€‚
![6630851-9587a4a0902f63a9.png](https://upload-images.jianshu.io/upload_images/6630851-9587a4a0902f63a9.png)
offsetç´¢å¼•æ–‡ä»¶
![6630851-196eb9c0628e217f.png](https://upload-images.jianshu.io/upload_images/6630851-196eb9c0628e217f.png)
æ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶
