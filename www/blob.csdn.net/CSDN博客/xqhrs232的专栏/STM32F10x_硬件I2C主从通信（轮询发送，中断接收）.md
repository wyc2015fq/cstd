# STM32F10x_硬件I2C主从通信（轮询发送，中断接收） - xqhrs232的专栏 - CSDN博客
2017年11月08日 22:47:41[xqhrs232](https://me.csdn.net/xqhrs232)阅读数：457
原文地址::[https://www.cnblogs.com/strongerHuang/p/5787392.html](https://www.cnblogs.com/strongerHuang/p/5787392.html)
相关文章
1、STM32 I2C从机发送数据_中断方式----[http://blog.csdn.net/sljtfyt/article/details/39345551](http://blog.csdn.net/sljtfyt/article/details/39345551)
2、STM32’s
 I2C 硬件BUG引发的血案（转来的资料）----[https://www.mianbaoban.cn/blog/post/21082](https://www.mianbaoban.cn/blog/post/21082)
3、【STM32 IIC详解】stm32
 IIC从机模式(中断方式收发数据)----[http://m.blog.csdn.net/liwei16611/article/details/75258222](http://m.blog.csdn.net/liwei16611/article/details/75258222)
Ⅰ、写在前面
关注我分享文章的朋友应该知道我在前面讲述过（软件、硬件）I2C主机控制从机EEPROM的例子。在I2C通信主机控制程序是比较常见的一种，可以说在实际项目中，很多应用都会使用到I2C通信。但在实际项目中作为I2C从机的应用相对要少的多，本文主要讲述关于【STM32F10x_硬件I2C主从通信】中STM32作为从机的例子。
在学习本问内容之前，如果对I2C协议还不太了解的朋友请先去了解一下I2C协议，或看我之前关于I2C通信的文章（我微信公众号和博客都有）。
关于STM32硬件I2C作为从机的文章网上很少（我在写本文之前也在百度、谷歌等网站上搜索了解过），我猜测大概的原因主要是两点：1.使用该功能的人比较少； 2.说STM32硬件I2C存在BUG。
“使用该功能的人比较少”这个可以理解。其实我不能理解的是，普遍说这个有BUG的现象。我只觉得，你选择了使用这个芯片来作为开发，你选择之前应该是认可它的，什么东西都不可能尽善尽美，一点小的瑕疵，只要可以避免就行。就像Windos系统一样，偶尔死机、蓝屏，但是你还是依然会选择使用它。
关于STM32硬件I2C自身BUG也不否认，但官方给出了解决的办法，作为程序员，解决一项BUG，也是对自身能力的一种提升。所以，遇到困难，勇于面对才是正确的做法。
实例实验：
本文提供两个实例：一个主机发送（硬件I2C轮询发送数据）、一个从机接收并打印接收数据（硬件I2C中断接收数据）。
主机间隔500ms发送10字节，从机接收10字节检测到I2C停止，将收到的数据通过串口打印出来。【发送的数据及长度可修改，从机自动检测停止条件，也就是可以检测得到主机发送了多少字节数据】
![](http://images2015.cnblogs.com/blog/957778/201608/957778-20160819140151125-1022500048.png)
关于本文的更多详情请往下看。
Ⅱ、实例工程下载
笔者针对于初学者提供的例程都是去掉了许多不必要的功能，精简了官方的代码，对初学者一看就明白，以简单明了的工程供大家学习。
笔者提供的实例工程都是在板子上经过多次测试并没有问题才上传至360云盘，欢迎下载测试、参照学习。
提供下载的软件工程是基于Keil（MDK-ARM） V5版本、STM32F103ZE芯片，但F1其他型号也适用（适用F1其他型号：
 关注微信，回复“修改型号”）。
STM32F10x_硬件I2C主机（发送数据 - 轮询方式）实例源代码工程：
[https://yunpan.cn/cMKS6muF6643V](https://yunpan.cn/cMKS6muF6643V)[访问密码](http://mp.weixin.qq.com/s?__biz=MzI4MDI4MDE5Ng==&mid=100000341&idx=1&sn=2e8058f2ec226d47b4b0cbb92ff3d257#rd)
STM32F10x_硬件I2C从机（接收数据 - 中断方式）实例源代码工程：
[https://yunpan.cn/cMKSMCkcn8tKv](https://yunpan.cn/cMKSMCkcn8tKv)[访问密码](http://mp.weixin.qq.com/s?__biz=MzI4MDI4MDE5Ng==&mid=100000341&idx=1&sn=2e8058f2ec226d47b4b0cbb92ff3d257#rd)
STM32F1资料：
[https://yunpan.cn/crBUdUGdYKam2](https://yunpan.cn/crBUdUGdYKam2)  访问密码 ca90
Ⅲ、关于I2C协议
这里再次提示一下I2C协议重要的几点：
1.开始和停止条件
SCL时钟电平为高：
SDA数据线由高 -> 低 为总线开始条件；
SDA数据线由低 -> 高 为总线结束条件；
（IO模拟I2C时注意：开始之后将SCL变为低电平，防止误操作SDA使其通信停止）
时序图：
![](http://images2015.cnblogs.com/blog/957778/201608/957778-20160819140157765-615923815.png)
2.数据位传输
SCL时钟电平为低， 可以改换SDA数据线的电平，在SCL上升沿的过程将SDA数据发送出去。
（IO模拟I2C时切记：请先将SCL变为低电平，再改变SDA电平状态）
时序图：
![](http://images2015.cnblogs.com/blog/957778/201608/957778-20160819140215046-931952380.png)
3.数据传输
I2C是以字节（8位）的方式进行传输，总线上每传输完1字节之后会有一个应答信号，主器件(主机)需要产生对应的一个额外时钟。
传输格式：8位数据 + 1位应答
数据传输必须带响应，相关的响应时钟脉冲由主机产生，在响应的时钟脉冲期间，发送器释放 SDA 线（高）。
在响应的时钟脉冲期间 接收器必须将 SDA 线拉低，使它在这个时钟脉冲的高电平期间保持稳定的低电平。
应答位的产生及接收：
1.在（主机）写数据的时候是从机应答（给主机），主机检测；
2.在（主机）读数据的时候是主机应答（给从机），从机检测；
（这里可以借助I2C读写函数一起理解）
1.时序图（主机写，从机应答，主机读取应答）：
![](http://images2015.cnblogs.com/blog/957778/201608/957778-20160819140228968-1205258491.png)
2.时序图（主机读，主机产生应答）：
![](http://images2015.cnblogs.com/blog/957778/201608/957778-20160819140234781-2103653569.png)
更多关于I2C协议的文档可以网上查询，也可以参看我下面下载链接的文档（周立功翻译的版本）：[https://yunpan.cn/cMJxKJzpWFtHE](https://yunpan.cn/cMJxKJzpWFtHE)  访问密码 82f3
Ⅳ、硬件I2C主机发送数据
硬件I2C主机的配置其实很简单，和前面读写EEPROM的（主机）配置一样。
可参考我之前的文章：[STM32F10x_模拟I2C读写EEPROM](http://www.cnblogs.com/strongerHuang/p/5749422.html)
这里就不再描述。主要讲述一下主机发送数据这一块的代码。
我封装的发送数据函数：
I2C_Master_BufferWrite(uint8_t* pBuffer, uint32_t NumByteToWrite, uint8_t SlaveAddress)
主要就是3个参数：数据BUF、数据长度、从设备地址
![](http://images2015.cnblogs.com/blog/957778/201608/957778-20160819140303890-213422175.png)
看过我前面主机读写EEPEOM代码的人应该很清楚，这里很相似。读写EEPROM比这里多了一个步骤，那就是多了写数据地址的步骤。
必须要有的三大步骤：
1.开始
2.设备地址/写
3.停止
主程序间隔500ms调用一次该函数，发送一串（我们定义10字节），从机也是间隔500ms收到一串数据并打印出来。
Ⅴ、硬件I2C从机中断接收数据
硬件I2C的从机接收数据一般分为三类：中断接收、DMA接收和轮询接收；
在实际项目中中断接收和DMA接收比较常见，因为不用占据CPU资源，有数据来了才响应接收【需要CPU具有硬件I2C功能】。
而轮询接收数据很占用CPU资源，一般是CPU没有硬件I2C资源，处理的数据不多的情况下。
硬件I2C从机配置I2C这一块比较简单，和上面主机类似，请参看源代码或参考我之前文章的讲述。
可参考我之前的文章：[STM32F10x_模拟I2C读写EEPROM](http://www.cnblogs.com/strongerHuang/p/5749422.html)
提醒：配置中注意关于I2C事件中断这一块（请看源代码）。
中断接收函数源代码如下：
![](http://images2015.cnblogs.com/blog/957778/201608/957778-20160819140313531-1870172023.png)
位于stm32f10x_it.c文件下。
进入I2C事件中断，判断是I2C从机事件，此时，作为从机接收数据需要检测三个标示：
1.检测主机已发生地址（ADDR = 1）；
2.检测有接收数据（RXNE = 1）；
3.检测到停止条件（STOPF =1）。
硬件I2C通信中，起始条件由硬件判断完成，我们检测的就需要这几步就能完成基本的接收数据功能。
Ⅵ、说明
理解本文之前请先理解I2C协议。
更多关于硬件I2C主从通信的例子（如：DMA发送、DMA接收等）就不再单独写文章讲述了，可以在微信公众号联系我。
以上总结仅供参考，若有不对之处，敬请谅解。
Ⅶ、最后
更多精彩文章我将第一时间在微信公众号里面分享，对本文有什么疑问可微信留言。
本着免费分享的原则，方便大家手机学习知识，定期在微信平台分享技术知识。如果你觉得分享的内容对你有用，又想了解更多相关的文章，请用微信搜索“EmbeddDeveloper” 或者扫描下面二维码、关注，将有更多精彩内容等着你。

