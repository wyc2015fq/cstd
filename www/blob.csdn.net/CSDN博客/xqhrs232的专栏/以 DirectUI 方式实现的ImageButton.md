# 以 DirectUI 方式实现的ImageButton - xqhrs232的专栏 - CSDN博客
2012年08月22日 21:34:16[xqhrs232](https://me.csdn.net/xqhrs232)阅读数：900标签：[windows																[图像处理																[工作																[程序开发																[command																[button](https://so.csdn.net/so/search/s.do?q=button&t=blog)](https://so.csdn.net/so/search/s.do?q=command&t=blog)](https://so.csdn.net/so/search/s.do?q=程序开发&t=blog)](https://so.csdn.net/so/search/s.do?q=工作&t=blog)](https://so.csdn.net/so/search/s.do?q=图像处理&t=blog)](https://so.csdn.net/so/search/s.do?q=windows&t=blog)
个人分类：[DirectUI界面技术](https://blog.csdn.net/xqhrs232/article/category/1243806)
原文地址::[http://www.cnblogs.com/hoodlum1980/archive/2011/02/15/1954779.html](http://www.cnblogs.com/hoodlum1980/archive/2011/02/15/1954779.html)
【文章归类】 C++，Windows 应用程序开发。
　　　　这是一篇比较简单的文章，主要讲解的是用 DirectUI 方式实现的对话框上的按钮。例如，QQ界面上的按钮。我在前一篇文章中讲解的 PS 油画滤镜的参数对话框中使用这种方式实现了放大缩小按钮。界面截图如下所示：
![](http://pic002.cnblogs.com/images/2011/22214/2011021500022981.jpg)
　　　　这种实现在早期我是直接写在窗口过程中的，这样的话是面向过程的方式，代码不容易移植复用。因此现在我在以前实现的基础上，把代码逻辑提取出来，放到一个类中，这样就会很方便在不同项目和场合使用。当然，由于窗口过程和考虑到代码效率的关系，实际上我封装的并不彻底，对于使用者来说依然需要做一些工作。
　　　　按钮通常有三种状态：普通，悬浮，按下，如果再加上禁用（灰化），则一共是四种状态，这里简称其为四态按钮。为此，我们需要为每种状态准备一个图片，这里我们把四副图片横向拼合成一副位图（宽度是高度的四倍）。同时，考虑到和背景融合的关系，简单的话，我们可以采用 TransparentBlt 做透明色贴图，但这样和背景的融合会有锯齿感。因此我使用的是 AlphaBlend 函数，这样就要求提供的图片是 32 BPP 且已经预先应用了 Alpha 通道的位图（预应用Alpha 这一部是我用之前的 DEMO 程序完成的）。
　　　　按钮的四个状态图片的内容和按钮的大小，都可以由用户随意定制。这里我采用的制作方法是：其他三种状态以普通状态位图为基准进行制作。悬浮状态比其他状态向左上角各移动1个像素距离（这样鼠标移动到上面和移开时，按钮产生一种浮起动画效果），灰色状态的位图是普通状态的去色结果。制作好的位图资源如下所示：
![](http://pic002.cnblogs.com/images/2011/22214/2011021500112118.jpg)
　　　　这样我们在项目中添加一个类，取名为CImgButton。其实现代码如下：
　　　　（1）头文件：
```
ImgButton.h
```
　　　　（2）代码文件：
```
ImgButton.cpp
```
　　　　注意，这个类我们主要需要做的工作如下，处理以下消息：WM_PAINT, WM_LBUTTONDOWN / WM_LBUTTONDBLCLK, WM_MOUSEMOVE, WM_LBUTTONUP,  WM_MOUSELEAVE。需要说明的是以下几点：
　　　　（A）关于 WM_MOUSELEAVE 消息。
　　　　该消息在鼠标离开窗口时发送给窗口，我们需要处理这个消息主要是基于鼠标移动时间的“离散性”。即鼠标事件有以下特点，当鼠标移动的速度很快时，相邻的鼠标移动消息的跨距就会比较大。通常我们是用鼠标移动消息去更新按钮的状态的，如果按钮正处于热点跟踪的悬浮状态时，当鼠标快速离开时，很可能无法恢复成正常状态（因为未能收到后续鼠标移动消息），因此我们需要处理鼠标离开的消息。在这个消息里我们主要是把悬浮状态的按钮复原成正常状态。
　　　　另外必须注意的是，处于效率考虑，系统默认不会给窗口发送该消息。因此我们必须用 TrackMouseEvent 函数请求系统为我们发送该消息，且该函数是一次性的，即消息收到一次以后，TrackMouseEvent 就会失效。所以我们需要在鼠标移动事件中重复调用该函数。
　　　　（B）关于 WM_LBUTTONDBLCLK 消息。
　　　　这是鼠标双击事件，当鼠标以很快频率在对话框窗口上双击时，窗口过程就会收到这个消息（因为窗口类中含有 CS_DBLCLK 样式）。这样可能和点击按钮的预期不符（用户希望的是连续快速的点击按钮），即我们不希望系统把快速点击转换成双击事件。考虑双击事件的消息顺序是：按下，抬起，双击，抬起。因此我们在这里只要把双击消息等效的看着鼠标按下事件处理即可。
　　　　（C）按钮在按下时的追踪（m_bIsTracking）
　　　　在上面的类中有这样一个成员变量：m_bIsTracking。这个变量是干什么用的呢，我需要更多的解释以下。观察 windows 操作系统的按钮的交互方式可知，用户在按钮上按下鼠标并保持按下状态，这时不要放开鼠标并移动鼠标时，按钮的外观就会根据鼠标是否停留在按钮上而发生变化。如果用户在按钮以外抬起鼠标，按钮事件不会触发。如果在按钮之内抬起鼠标，就会触发按钮事件。注意，这是 windows 系统中按钮的用户交互的一个小细节（我在之前写的文章中提到过），这样做的主要好处是给用户提供了一种“撤销点击按钮事件”的选择，即按下按钮以后如果不希望点击按钮，则把鼠标从按钮上滑开再放开鼠标按键即可。
　　　　注意，我们通常说的热点跟踪通常是指鼠标在没有按下时进行移动。这时对话框上所有按钮都会对鼠标移动进行外观反馈，我把这种情况（普通热点跟踪）称为当前没有需要跟踪外观反馈的对象。如果鼠标在某个按钮上按下然后保持，这时该按钮就成为一个被跟踪外观反馈的对象，这时只有该对象会对鼠标移动进行外观上的响应，所有其他非跟踪对象一律不对鼠标移动做任何反馈。因此，这是该按钮的 m_bIsTracking 变量就会为 TRUE，表示该按钮是一个被跟踪反馈的对象（鼠标按下时期），该对象应该是具有排他性的，即鼠标按下时，任何时刻至多只有一个按钮被跟踪。这里的
 Tracking 专指鼠标按下时期的跟踪对象。同时这个变量也有另一个含义，即表示鼠标按下时是否在该按钮内部按下，如果该变量为 TRUE，则表示鼠标一定是在该按钮上按下的。如果是这样，则只要鼠标抬起时仍然处于按钮内部，即触发按钮事件。
　　　　有了以上代码以后，我们把它加入已有项目就会很方便了。但是我们依然需要在窗口过程中做一些手工工作。主要有以下步骤：
　　　　（1）把ImgButton代码添加到项目。
　　　　（2）用图像处理软件制作一个预先应用了Alpha通道的位图资源，添加到项目中。
　　　　（2）按照如下方式修改窗口过程（假设我们添加一个放大按钮到对话框上）：
```
wndproc
```
　　　　在上面的使用过程中，主要是初始化工作，即设置按钮的坐标位置，图片资源。以及按钮的ID（相当于普通控件的ID，通过这个数字，向所在窗口发送 WM_COMMAND 消息）。在WM_PAINT消息中，我主动创建了一个内存DC，目的是当有多个这样的 ImageButton 时，可以重复使用该内存DC，而不必每次都再次创建。
　　　　当修改窗口过程时，原窗口过程中没有列出的消息可以简单的添加到窗口过程里，而有的消息可能在窗口过程中已经列出，这就需要和已有代码进行合并。这里可能需要一些和现有代码逻辑的配合，但总体来讲这个融合过程依然是比较容易的。
　　　　通过以上步骤，我们就用 DirectUI 方式实现了标准四态按钮。以上代码原理并不复杂，这里再提供一个很小的DEMO程序：
[http://files.cnblogs.com/hoodlum1980/ImgButtonDemo.rar](http://files.cnblogs.com/hoodlum1980/ImgButtonDemo.rar)
　　　　【补充--by hoodlum1980；on 2011年5月15日】
　　　　上面的代码中仅仅是一个比较简单的演示，后续过程中我又在代码中增加了对 Toggle Button（行为类似CheckBox），ShowWindow， EnableWindow 等方法的支持，增加了从 PNG 文件加载按钮图片的支持，增加了 ApplyAlpha 方法（这样就不必对图片资源预先应用alpha通道，只要是 32 bpp的图片即可）。
　　　　改进后的 CImgButton 代码和使用说明请从下面下载：
[http://files.cnblogs.com/hoodlum1980/CImgButton.rar](http://files.cnblogs.com/hoodlum1980/CImgButton.rar)
