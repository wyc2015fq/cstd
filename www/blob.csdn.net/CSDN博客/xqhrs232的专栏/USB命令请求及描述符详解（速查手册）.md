# USB命令请求及描述符详解（速查手册） - xqhrs232的专栏 - CSDN博客
2017年08月31日 17:19:03[xqhrs232](https://me.csdn.net/xqhrs232)阅读数：2663
原文地址::[http://usb.baiheee.com/usb_article/usb_spec/usb_cmd_desc.html](http://usb.baiheee.com/usb_article/usb_spec/usb_cmd_desc.html)
注：本文系百合电子工作室原创文章，09年发表于本工作室主站，本文浏览非常大，我自己在实际工作中也经常打开此文章作为快速参考手册用，这次经过修改后发表在[百合电子工作室USB专题站](http://usb.baiheee.com/)。
　　USB 协议规范本身有几百页的内容，这还不包括各种设备类等子文档，但我觉得USB协议基础部分除了需要了解一下USB物理传输模型外，最重要的内容是USB的各种请求（即命令）和各种描述符，这篇文章就是介绍这些命令及描述符的。初学者可以结合百合电子工作室的另一篇文章《实例讲解USB的枚举（配置）过程》能够加深理解本文内容。
　　USB设备从插入主机到建立通讯要经历两个阶段：1、USB设备的插入动作识别，有关这方面内容可参考百合电子工作室USB专题站另一篇文章《[搭个简单电路验证USB主机是如何检测USB设备的插入和拨出动作的](http://usb.baiheee.com/usb_article/usb_spec/usb_plug_detect.html)》。2、USB设备的枚举，能过枚举过程，USB主机可以判断USB设备属于哪种类别（如USB鼠标、USB键盘、USB游戏杆、优盘等）并为之安装合适的驱动程序，有关USB设备的枚举过程请参考本站文章《实例讲解USB的枚举（配置）过程》。正确识别USB设备后则可正常使用了。本文所述内容是USB设备枚举过程中涉及到的USB命令和USB描述符。
一、USB命令
　　USB是一种主从结构，主机叫Host，从机叫Device，所以我们经常把从机叫做设备。USB数据通信只能发生在主机与从机之间（新的USB扩展规范USB OTG可以实现主机与主机之间通信，但实质也是通过设备作为媒介实现），所有的数据通信都由主机发起，而从机只能被动地应答。
在USB规范里，对命令一词提供的英文单词为“Request”，意为请求的意思，但这里为了更好的理解主机与设备之间的主从关系，将它解释成“命令”。
　　当USB设备的识别过程（即枚举）也是一个数据通信过程，在这一过程中，USB规范规定了一个标准的过程，主机在这一过程中发也不同的命令，设备对这些命令作出正确响应以完成设备的识别过程（即我们经常说的枚举过程），所以本文前面提到在学习本文过程中可以参考另一篇文章《实例讲解USB的枚举（配置）过程》以加深理解。
　　所有的USB设备都要求对主机发给自己的控制命令作出响应，USB规范定义了11个标准命令，它们分别是：Clear_Feature、Get_Configuration、Get_Descriptor、Get_Interface、Get_Status、Set_Address、Set_Configuration、Set_Descriptor、Set_Interface、Set_Feature、Synch_Frame。所有USB设备都必须支持这些命令（个别命令除外，如Set_Descriptor、Synch_Frame）。
　　不同的命令虽然有不同的数据和使用目的，但所有的USB命令结构是一样的。下表所示为USB命令的结构（偏移量低的先发送）： 
6wLength
2如有数据传送阶段，此为数据字节数。
下表举例列出了USB的11种标准命令的结构（命令类型由bRequest字段指出，共有11种标准命令，见表3）
Synch_Frame
100000010B
SYNCH_FRAME
零
端点号
二
帧号
其中bRequest为命令编码值，共有11种标准命令，含意见表3：
SYNCH_FRAME
12
 在USB设备识别（枚举）过程中，USB主机会发出不同命令来完成这一过程。
二、USB描述符
　　在USB设备的枚举过程中，USB设备需要对主机发来的命令请求作出正确回应，这些应答数据都有规定的数据格式，在USB规范里把这些有固定结构的数据包称为描述符。
USB协议为USB设备定义了一套描述设备功能和属性的有固定结构的描述符，包括标准的描述符即设备描述符、配置描述符、接口描述符、端点描述符和字符串描述符，还有非标准描述符，如类描述符。USB设备通过这些描述符向USB主机汇报设备的各种属性，主机通过对这些描述符的访问对设备进行类型识别、配置并为其提供相应的客户端驱动程序。
　　USB设备通过描述符反映自己的设备特性。USB描述符是由特定格式排列的一组数据结构组成。
　　在USB设备枚举过程中，主机端的协义软件需要解析从USB设备读取的所有描述符信息。在USB主向设备发送读取描述符的请求后，USB设备将所有的描述符以连续的数据流方式传输给USB主机。主机从第一个读到的字符开始，根据双方规定好的数据格式，顺序地解析读到的数据流。
　　USB描述符包含标准描述符、类描述符和厂商特定描述３种形式。它们都是必须的（除标准描述符里的字符串描述符可选外）。
　　在USB1.X中，规定了5种标准描述符：设备描述符（Device Descriptor)、配置描述符（Configuration Descriptor）、接口描述符（Interface Descriptor）、端点描述符（Endpoint Descriptor）和字符串描述符（String Descriptor）。
　　每个USB设备只有一个设备描述符，而一个设备中可包含一个或多个配置描述符，即USB设备可以有多种配置。设备的每一个配置中又可以包含一个或多个接口描述符，即USB设备可以支持多种功能（接口），接口的特性通过描述符提供。
　　在USB主机访问USB设备的描述符时，USB设备依照设备描述符、配置描述符、接口描述符、端点描述符、字符串描述符顺序将所有描述符传给主机。一设备至少要包含设备描述符、配置描述符和接口描述符，如果USB设备没有端点描述符，则它仅仅用默认管道与主机进行数据传输。
１、设备描述符
　　设备描述符给出了USB设备的一般信息，包括对设备及在设备配置中起全程作用的信息，包括制造商标识号ID、产品序列号、所属设备类号、默认端点的最大包长度和配置描述符的个数等。一个USB设备必须有且仅有一个设备描述符。设备描述符是设备连接到总线上时USB主机所读取的第一个描述符，它包含了14个字段，结构如下：
17
bNumConfigurations
1
数字
可能的配置描述符数目
其中bDescriptorType为描述符的类型，其含义可查下表（此表也适用于标准命令Get_Descriptor中wValue域高字节的取值含义）：
厂商定义的描述符0xFF
设备类代码bDeviceClass可查下表：
255
0xFF
厂商定义的设备类
下表列出了一个USB鼠标的设备描述符的例子，供大家分析一下：
bNumConfigurations
0x01
2、配置描述符
　　配置描述符中包括了描述符的长度（属于此描述符的所有接口描述符和端点描述符的长度的和）、供电方式（自供电/总线供电）、最大耗电量等。主果主机发出USB标准命令Get_Descriptor要求得到设备的某个配置描述符，那么除了此配置描述符以外，此配置包含的所有接口描述符与端点描述符都将提供给USB主机。
      8
MaxPower
1
    mA
在此配置下的总线电源耗费量。以 2mA 为一个单位。
下面是一种硬盘的配置描述符示例：
MaxPower
0x32
3、接口描述符
　　配置描述符中包含了一个或多个接口描述符，这里的“接口”并不是指物理存在的接口，在这里把它称之为“功能”更易理解些，例如一个设备既有录音的功能又有扬声器的功能，则这个设备至少就有两个“接口”。
　　如果一个配置描述符不止支持一个接口描述符，并且每个接口描述符都有一个或多个端点描述符，那么在响应USB主机的配置描述符命令时，USB设备的端点描述符总是紧跟着相关的接口描述符后面，作为配置描述符的一部分被返回。接口描述符不可直接用Set_Descriptor和Get_Descriptor来存取。
　　如果一个接口仅使用端点0，则接口描述符以后就不再返回端点描述符，并且此接口表现的是一个控制接口的特性，它使用与端点0相关联的默认管道进行数据传输。在这种情况下bNumberEndpoints域应被设置成0。接口描述符在说明端点个数并不把端点0计算在内。
       8
iInterface
        1
索引
描述此接口的字串描述表的索引值。
对于bInterfaceClass字段，表示接口所属的类别，USB协议根据功能将不同的接口划分成不的类，其具体含义如下表所示：
0xFF厂商定义的设备
4、端点描述符
　　端点是设备与主机之间进行数据传输的逻辑接口，除配置使用的端点0（控制端点，一般一个设备只有一个控制端点）为双向端口外，其它均为单向。端点描述符描述了数据的传输类型、传输方向、数据包大小和端点号（也可称为端点地址）等。
　　除了描述符中描述的端点外，每个设备必须要有一个默认的控制型端点，地址为0，它的数据传输为双向，而且没有专门的描述符，只是在设备描述符中定义了它的最大包长度。主机通过此端点向设备发送命令，获得设备的各种描述符的信息，并通过它来配置设备。
6
bInterval
1
数字
周期数据传输端点的时间间隙。 
此域的值对于批传送的端点及控制传送的端点无意义。对于同步传送的端点此域必需为1，表示周期为1ms。对于中断传送的端点此域值的范围为1ms到255ms。
下表是一种鼠标的端点描述符的示例，该端点是一个中断端点：
bInterval
0x0A
5、字符串描述符
　　字符串描述符是一种可选的USB标准描述符，描述了如制商、设备名称或序列号等信息。如果一个设备无字符串描述符，则其它描述符中与字符串有关的索引值都必须为0。字符串使用的是Unicode编码。
　　主机请示得到某个字符串描述符时一般分成两步：首先主机向设备发出USB标准命令Get_Descriptor，其中所使用的字符串的索引值为0，设备返回一个字符串描述符，此描述符的结构如下：
N
wLANGID[x]
2
数字
语言标识（LANGID） 
码X
该字符串描述符双字节的语言ID的数组，wLANGID[0]~wLANGID[x]指明了设备支持的语言，具体含义可查看USB_LANGIDs.pdf。
　　主机根据自己需要的语言，再次向设备发出USB标准命令Get_Descriptor，指明所要求得到的字符串的索引值和语言。这次设备所返回的是Unicode编号的字符串描述符，其结构如下：
2
bString
N
数字
UNICODE 编码的字串
bString域为设备实际返回的以UNICODE编码的字符串流，我们在编写设备端硬件驱动的时候需要将字符串转换为UNICODE编码，您可以通过一些UNICODE转换工具进行转换。这里推荐由[百合电子工作室](http://www.baiheee.com/)开发的一款USB描述符生成工具“[USB
 Unicode 字符串描述符生成器](http://usb.baiheee.com/uploads/soft/120822/1-120R2120128.rar) ”，它专门为编写设备端驱动程序的需要而定制，可以非常方便将您需要的字符串转换成UNICODE格式，进而导入您的C或汇编程序代码中，以下是它的界面：
![](http://usb.baiheee.com/uploads/allimg/120627/211JA264-0.jpg)
USB Unicode 字符串描述符生成器－生成C语言格式
![](http://usb.baiheee.com/uploads/allimg/120627/211J62V5-1.jpg)
USB Unicode 字符串描述符生成器－生成汇编格式
