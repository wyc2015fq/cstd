# 触摸屏驱动程序的设计和实现 - xqhrs232的专栏 - CSDN博客
2010年02月26日 16:05:00[xqhrs232](https://me.csdn.net/xqhrs232)阅读数：1137
原文地址：：[http://www.dzsc.com/data/html/2009-8-28/78405.html](http://www.dzsc.com/data/html/2009-8-28/78405.html)
嵌入式设备触摸屏按其技术原理可分为五类：矢量压力传感式、电阻式、电容式、红外线式和表面声波式。其中电阻式触摸屏在嵌入式系统中用的较多，电阻式触摸屏可分为四线、五线、七线等几种。一般来说，WinCE触摸屏驱动的设计和实现有以下几个步骤：
***广告插播信息**维库最新热卖芯片： [X25330](http://writeblog.csdn.net/stock-ic/X25330.html)[LMC6036IMT](http://writeblog.csdn.net/icstock/395/LMC6036IMT.html)[LTC1436IGN-PLL](http://writeblog.csdn.net/stock-ic/LTC1436IGN-PLL.html)[K4S561632E-UC75](http://writeblog.csdn.net/stock-ic/K4S561632E-UC75.html)[A2531](http://writeblog.csdn.net/icstock/103/A2531.html)[SST39VF088-70-4C-EK](http://writeblog.csdn.net/icstock/649/SST39VF088-70-4C-EK.html)[AS2000P](http://writeblog.csdn.net/stock-ic/AS2000P.html)[1.5KE33A](http://writeblog.csdn.net/icstock/337/1.5KE33A.html)[LM338K](http://writeblog.csdn.net/icstock/391/LM338K.html)[MAX8215ESD](http://writeblog.csdn.net/stock-ic/MAX8215ESD.html)*
　　（1）配置和初始化触摸屏
　　触摸屏驱动在初始化过程会调用TouchPanelEnable函数，该函数调用的DDSI函数为DdsiTouchPanelEnable和 DdsiTouchPanelDisable。这两个DDSI接口函数是驱动实现的关键所在，分别用于打开和关闭触摸屏硬件。但是为了降低功耗，这两个函数其实可以不真正操作硬件，而只是实现软件上的控制。
　　同时，在初始化时还需要进行这几个配置和初始化：一是创建事件hTouchPanelEvent和 hCalibrationSampleAvailable，前者是在正常状态下当有触摸笔按下或者按下后需要定时采集数据时被触发；而后者是在校准状态下当有校准数据输入时被触发。二是检查初始化所需的中断gIntrTouch（触摸屏中断）和gIntrTouchChanged（定时器中断），并将这两个中断关联到事件hTouchPanelEvent。三是创建一个ISR线程TouchPanelpISR，用于等待和处理触摸屏事件
 hTouchPanelEvent，它也是整个驱动程序中唯一的事件源。
　　（2）校准触摸屏基准参数
　　完成前面繁琐的工作后，驱动程序的各种功能就都已经准备就绪了，现在就可以实际操作触摸屏幕了。但一般来说，电阻式触摸屏需要校准，也就是说在驱动启动过程中MDD层要调用相应的DDSI函数来读取注册表中的校正数据校正触摸屏。理想情况下，校准程序只要在嵌入式设备初次加电测试过程中运行一次就可以了，参考值会被存储在非易失性存储器中，以免让用户在以后的加电启动期间再做校准。不过，高质量的触摸屏驱动程序是应该要向用户提供一种进入校准例程的途径，从而在由于温度漂移或其它因素造成校准不准确时进行重新校准。
　　在理想情况下，校正触摸屏基准只需两组原始数据，即在屏幕对角读取的最小和最大值。但在实际应用中，因为许多电阻式触摸屏存在明显的非线性，如果只在最小和最大值之间简单的插入位置数值会导致驱动程序非常的不精确。因此，在WinCE中需要获取多个校准点，常用的校准点数量为5个。
　　方法是：①首先驱动程序在函数DdsiTouchPanelGetDeviceCaps 中设置校准点的个数；②是系统在 TouchDriverCalibrationPointGet中获取每个校准点的屏幕坐标；③是在屏幕界面的校准点坐标处显示一个位置符号，用户需要精确地在位置符号按下触摸屏；④驱动程序通过TouchPanelReadCalibrationPoint函数读取相应的触摸屏坐标值；⑤然后再开始下一个校准点，直到循环设定的次数后将采集到的触摸屏坐标值和校准点屏幕坐标送到TouchPanelSetCalibration函数中进行处理，该函数将产生校准基准参数。校准完成之后，触摸屏便可以开始正常的操作了。
　　（3）判断屏幕是否被触摸
　　一旦完成了触摸屏硬件设置、初始化和基准参数校准后，接下来就需要用一种可靠的方法来判断屏幕是否被触摸了。WinCE提供了屏幕是否被触摸的检测机制，而且当触摸事件发生时还可选择是否中断主处理器。判断屏幕是否被触摸的驱动程序的函数名叫WaitForTouchState()。当屏幕被初次触摸时唤醒主机的中断，称为PEN_DOWN中断。这样做可以让驱动程序在屏幕没有被触摸时中断自己的执行，而不消耗任何CPU资源，而一旦用户触摸屏幕，驱动程序就被唤醒并进入转换模式。
　　当被唤醒后就有一组模数数据等待转换并产生中断信号。中断是硬件与软件打交道的重要方法，所以大多数驱动程序都涉及到中断处理。就中断处理而言， WinCE采用了一种独特的方法。它将中断处理分为两步：中断服务例程(ISR)和中断服务线程(IST)。具体来讲就是把每个硬件的设备中断请求 (IRQ) 和一个ISR 联系起来，当一个中断发生并未被屏蔽时，内核调用该中断注册的ISR。因为ISR 运行于内核模式，所以应该被设计得尽可能的短，ISR 的基本职责是引导内核调度和启动合适的IST。IST 在设备驱动程序软件模块中编写，它从硬件获取或向硬件发送数据和控制代码，并进一步处理设备中断。
　　WinCE触摸屏驱动程序是采用中断方式对触摸笔的按下状态进行检测，当检测到触摸笔按下时产生的中断，就会触发一个事件通知一个工作线程开始采集数据。同时，驱动将打开一个硬件定时器，只要检测到触摸笔仍然在按下状态，将定时触发同一个事件通知这个工作线程继续采集数据，直到触摸笔抬起后关闭该定时器。简单的说，就是驱动程序会同时采用触摸屏中断和定时器中断这两个中断源。目的在于不仅可以监控触摸笔按下和抬起状态，而且可以检测触摸笔按下时的拖动轨迹。触摸屏中断的两个逻辑中断分别是：SYSINTR_TOUCH是用于触摸笔点击触摸屏时产生相应的中断；SYSINTR_TOUCH_CHANGE
 则用于触摸笔离开时产生相应的中断。
　　（4）获得稳定的、去抖动的测量数据
　　在进行触摸屏程序开发时，一定要注意原始的触摸测量数据经常会有一些噪声和偏差，这是正常的。一般来说，只有用户紧紧压住电阻触摸屏才能得到两个连续的读数，然而我们会发现当触控笔或手指按上或离开触摸屏时，读数的变化要比保持稳定压力时大得多。这是因为用户是以机械的方式连通二个平面电阻-触摸层，当用户按压和释放触摸屏时，在很短的一段时间内触摸屏的电气连接均处于临界状态。这时，我们需要丢弃这些读数直到系统稳定下来，否则提交的触摸位置读数会产生大幅跳跃，导致严重的失真或触摸位置漂移。
　　这时就需要进行折衷考虑，这也是触摸屏驱动设计的关键所在。如果我们要求较窄的稳定窗口，那么驱动程序将无法跟踪快速的“拖曳”操作；如果加宽稳定窗口，就可能面临着许多风险，这些风险包括接收到不精确的触摸数据，或上面描述处于临界状态的层连接结果。这时，就需要通过实验来确定适合系统的最佳值。
　　在正常情况下，当屏幕被触摸时驱动程序应会得到每个稳定的读数，并利用简单的线性插值法将原始数据转换成像素坐标。读取触摸点的坐标是由 DdsiTouchPanalGetPoint()函数实现的。另外，在每个转换过程的前后，驱动程序必须检查并确认屏幕仍处于被触摸状态。因为我们不希望采集到实际上是处于“开路状态”的稳定读数。因此，在读取触摸数据时，我们需要对原始数据进行去抖动处理，然后确定屏幕被触摸时是否有稳定的读数；如果不稳定就要继续读取数据并进行去抖动处理，直到得到稳定的数据为止。
　　最后，触摸屏驱动程序应将触摸状态和位置变化信息发送给更高层的应用软件，以完成一次完整的触摸操作。
