# TCP报文格式 - 深之JohnChen的专栏 - CSDN博客

2007年08月01日 13:21:00[byxdaz](https://me.csdn.net/byxdaz)阅读数：16398


　　传输控制协议（TCP）向上与用户应用程序进程接口，向下与网络层协议IP接口。用户应用程序采用首先调用TCP（或UDP），然后将应用程序数据递交给TCP这一方式，在IP网络上传送数据。TCP将这些数据打包分段并调用IP模块向目的主机传送每个数据段。接收方的TCP将段中的数据放入接收缓冲器，然后将段重装为应用程序数据，再将这些数据发送到目的的应用程序进程。
       尽管T C P和U D P都使用相同的网络层（I P），T C P却向应用层提供与U D P完全不同的服务。
T C P提供一种面向连接的、可靠的字节流服务。

![](http://x5meghwa.onlyblog.com/UploadFiles/2007-5/84291.11300840.jpg)

　　源端口号（16位），标识主机上发起传送的应用程序；目的端口（16位）标识主机上传送要到达的应用程序。源端和目的端的端口号，用于寻找发端和收端应用进程。这两个值加上I P首部中的源端I P地址和目的端I P地址唯一确定一个T C P连接。一个I P地址和一个端口号有时也称为一个插口（ s o c k e t），插口对（s o c k e t　p a i r）(包含客户I P地址、客户端口号、服务器 I P地址和服务器端口号的四元组 )可唯一确定互联网络中每个T C P连接的双方。IP+TCP端口唯一确定一个TCP连接。

TCP协议通过使用"端口"来标识源端和目标端的应用进程。端口号可以使用0到65535之间的任何数字。在收到服务请求时，操作系统动态地为客户端的应用程序分配端口号。在服务器端，每种服务在"众所周知的端口"（Well-Know Port）为用户提供服务。

　　●顺序号字段：占32比特。用来标识从TCP源端向TCP目标端发送的数据字节流，它表示在这个报文段中的第一个数据字节。

　　●确认号字段：占32比特。只有ACK标志为1时，确认号字段才有效。它包含目标端所期望收到源端的下一个数据字节。

　　●头部长度字段：占4比特。给出头部占32比特的数目。没有任何选项字段的TCP头部长度为20字节；最多可以有60字节的TCP头部。

　　预留：由跟在数据偏移字段后的6位构成，预留位通常为0.

　　●标志位字段（U、A、P、R、S、F）：占6比特。各比特的含义如下：

　　◆URG：紧急指针（urgent pointer）有效。

　　◆ACK：确认序号有效。

　　◆PSH：接收方应该尽快将这个报文段交给应用层。

　　◆RST：重建连接。

　　◆SYN：发起一个连接。

　　◆FIN：释放一个连接。

　　●窗口大小字段：占16比特。此字段用来进行流量控制。单位为字节数，这个值是本机期望一次接收的字节数。

　　●TCP校验和字段：占16比特。对整个TCP报文段，即TCP头部和TCP数据进行校验和计算，并由目标端进行验证。

　　●紧急指针字段：占16比特。它是一个偏移量，和序号字段中的值相加表示紧急数据最后一个字节的序号。

　　●选项字段：占32比特。可能包括"窗口扩大因子"、"时间戳"等选项。

三次握手:

![](http://x5meghwa.onlyblog.com/UploadFiles/2007-5/45666.89248051.jpg)

四次握手:

![](http://x5meghwa.onlyblog.com/UploadFiles/2007-5/45738.58165653.jpg)

//定义TCP报头

typedef struct _tcphdr
{
 byte source_port[2]; //发送端端口号,16位
 byte dest_port[2];  //接收端端口号,16位
 byte sequence_no[4]; //32位，标示消息端的数据位于全体数据块的某一字节的数字
 byte ack_no[4];   //32位，确认号,标示接收端对于发送端接收到数据块数值
 byte offset_reser_con[2];//数据偏移4位，预留6位，控制位6为
 byte window[2];   //窗口16位
 byte checksum[2];  //校验码,16位
 byte urgen_pointer[2]; //16位，紧急数据指针
 byte options[3];  //选祥和填充,32位
}TCP_HEADER;

