# 时间函数 - 深之JohnChen的专栏 - CSDN博客

2018年12月11日 20:51:49[byxdaz](https://me.csdn.net/byxdaz)阅读数：436
个人分类：[常见代码](https://blog.csdn.net/byxdaz/article/category/6893276)



一、时间函数

C标准库时间函数

头文件：

#include <time.h>

1. time()

函数功能：

获取当前的系统时间

函数原型：

time_t time( time_t *timer );

参数：

timer

存储时间的内存空间；

返回值：

返回的结果是一个time_t结构体

注意：没有错误会返回

关于time_t的说明如下：

time_t数据类型用来表示日历时间（Calendar Time），即从一个时间点（1970年1月1日0时0分0秒）到此时的秒数。

使用方法：

1> 传入参数为NULL

time_t t=time(NULL);

2>  传入参数为time_t类型的指针

time_t t;

time(&t);

2. localtime()/gmtime()

功能：

此函数将tm结构体保存的时间，转化为本地时间/格林威治时间。 

函数原型：

struct tm *localtime( const time_t *timer );

struct tm *gmtime( const time_t *timer );

struct tm的定义如下：

struct tm 

{

    int tm_sec;            /* 秒 – 取值区间为[0,59] */

    int tm_min;            /* 分 - 取值区间为[0,59] */

    int tm_hour;        /* 时 - 取值区间为[0,23] */

    int tm_mday;        /* 一个月中的日期 - 取值区间为[1,31] */

    int tm_mon;            /* 月份（从一月开始，0代表一月） - 取值区间为[0,11] */

    int tm_year;        /* 年份，其值等于实际年份减去1900 */

    int tm_wday;        /* 星期 – 取值区间为[0,6]，其中0代表星期天，1代表星期一，以此类推 */

    int tm_yday;        /* 从每年的1月1日开始的天数 – 取值区间为[0,365]，其中0代表1月1日，1代表1月2日，以此类推 */

    int tm_isdst;        /* 夏令时标识符，实行夏令时的时候，tm_isdst为正。不实行夏令时的进候，tm_isdst为0；不了解情况时，tm_isdst()为负。*/

};

3. mktime()

功能：

将时间结构数据转换成日历日期（与localtime()的作用刚好相反）

函数原型：

time_t mktime( struct tm *timeptr );

4. strftime()/wcsftime()

函数功能：

将时间格式化一个时间字符串

函数原型：

size_t strftime( char *strDest, size_t maxsize, const char *format, const struct tm *timeptr );

size_t wcsftime( wchar_t *strDest, size_t maxsize, const wchar_t *format, const struct tm *timeptr );

参数：

strDest：指针，指向输出字符串的首地址；

maxsize：字符串的最大长度；

format：转换格式；

timeptr：tm结构体指针；

可以采用的格式：

%a：星期几的英文名字的缩写；

%A：星期几的英文名字；

%b：月的英文名字缩写；

%B：月的英文名字；

%c：日期和时间的本地表示；

如：04/24/12 13:08:57

%d：一月中的多少天（01-31）

%H：24小时制的小时

%I：12小时制的小时

%j：一年中的多少天

%m：月

%M：分钟

%p：12小时制的本地A.M/P.M

%S：秒

%U：一年中的第几周（以周日为一周的第一天）

%w：星期几（周日为0）

%W：一年中的第几周（以周一为一周的第一天）

%x：日期；

%X：时间（时：分：秒）

%y：不带有世纪的年数（取值0-99），如12

%Y：带有世纪的年数，如2012

%z, %Z：时区名字（如果时区不明的话，不会输出字符串）

%%：百分号

返回值：

如果调用成功：

strftime 返回放到strDest中的字符数（包括终结符null），最大不超过maxsize

wcsftime 返回对应的宽字符数；

调用失败：

返回0，strDest中的内容不确定；

5. asctime()/ctime()

功能：

把时间结构体转换为字符串；

函数原型：

char *asctime( const struct tm *timeptr );

wchar_t *_wasctime( const struct tm *timeptr );

char *ctime( const time_t *timer );

wchar_t *_wctime( const time_t *timer );

Windows提供的函数API

GetLocalTime()

功能：该函数用来获取当地的当前系统日期和时间

函数原型：

void GetLocalTime( LPSYSTEMTIME lpSystemTime );

参数：lpSystemTime：用来指向SYSTEMTIME结构体，以存储现在的本地日期和时间 

返回值：

没有返回值

其中，SYSTEMTIME结构体是Windows提供的，其定义如下：

typedef struct _SYSTEMTIME 

{

    WORD wYear; 

    WORD wMonth; 

    WORD wDayOfWeek; 

    WORD wDay; 

    WORD wHour; 

    WORD wMinute; 

    WORD wSecond; 

    WORD wMilliseconds; 

}SYSTEMTIME;

SystemTimeToFileTime

功能：系统时间转换成文件时间

FileTimeToSystemTime

功能：文件时间转换成系统时间

二、Windows的本地时间(LocalTime)、系统时间（SystemTime）、格林威治时间(UTC-Time)、文件时间(FileTime)之间的转换 

本地时间(LocalTime)，也就是系统设置时区的当前时间！比如说当前系统设置的时区为“(UTC+08:00)北京，重庆，香港特别行政区，乌鲁木齐”（东八区），系统的右下角通知区域显示的时间为“2012/5/18 16:57”，那么这个时间就是当前系统的本地时间。

格林威治时间，本初子午线被定义为通过格林威治经线的位置，相对这条经线的时区向东递增，向西递减，每隔一个时区，相差一个小时。那么，上面例子中的东八区的时间就是相对于格林威治时间加上了八个小时！而Windows的系统时间是就是格林威治时间。将上面的本地时间“2012/5/18 16:57”转换到系统时间只要减去八个小时就行了！转换结果为“2012/5/18 8:57”。

本地时间与系统时间的都是用SYSTEMTIME结构来存储的。

文件时间(FileTime)的存储方式则与本地时间、系统时间有些不同，它使用64位的数据长度存储。引用MSDN上面的一句原话“A file time is a 64-bit value that represents the number of 100-nanosecond intervals that have elapsed since 12:00 A.M. January 1, 1601 Coordinated Universal Time (UTC).”这个64位的值记录了自1601年1月1日0点以来的以100纳秒（ns）为单位的格林威治时间间隔。将这个数据转换为秒的话要除以10^7（1秒 = 10^9纳秒，这里是100纳秒单位）。

本地时间与系统时间之间的转换可以通过SystemTimeToTzSpecificLocalTime、TzSpecificLocalTimeToSystemTime两个函数来完成，这两个函数在转换时都要指定时区信息，具体用法参考MSDN。下面谈谈系统时间与文件时间、本地时间与文件时间之间的转换。因为用到文件时间的地方不仅仅限于记录文件的创建、修改时间。

1. 系统时间与文件时间的转换：SystemTimeToFileTime、FileTimeToSystemTime

2. 本地时间与文件时间的转换：LocalFileTimeToFileTime、FileTimeToLocalFileTime

三、时间函数集合

```
#include <time.h>
#include <sys/timeb.h>

//获取当前时间(本地系统时区)
void GetCurrentSystemTime(SYSTEMTIME & st)
{
	GetLocalTime(&st);
}
//获取当前时间，带毫秒(本地系统时区)
long long GetCurrentTimeStamp()
{
	timeb t;
	ftime(&t);
	return t.time * 1000 + t.millitm;
}
//当前时间（带毫秒）转换成SYSTEMTIME
void TimeStampToSystemTime(long long llt, SYSTEMTIME * st)
{
	time_t t = (time_t)llt/1000;
	int nMillsSeconds = llt % 1000;
	struct tm* temptm = localtime(&t);
	SYSTEMTIME stinner = { 1900 + temptm->tm_year,
		1 + temptm->tm_mon,
		temptm->tm_wday,
		temptm->tm_mday,
		temptm->tm_hour,
		temptm->tm_min,
		temptm->tm_sec,
		nMillsSeconds };
	*st = stinner;
}
//当前时间（带毫秒）转换成SYSTEMTIME(格林威治标准时间的SYSTEMTIME)
void TimeStampToGreenwichTime(long long llt, SYSTEMTIME * st)
{
	time_t t = (time_t)llt / 1000;
	int nMillsSeconds = llt % 1000;
	struct tm* temptm = gmtime(&t);
	SYSTEMTIME stinner = { 1900 + temptm->tm_year,
		1 + temptm->tm_mon,
		temptm->tm_wday,
		temptm->tm_mday,
		temptm->tm_hour,
		temptm->tm_min,
		temptm->tm_sec,
		nMillsSeconds };
	*st = stinner;
}
//获取当前时间(本地时区)
void GetCurrentTimeT(time_t & t)
{
	t = time(NULL);
}

//获取当前时间(格林威治标准时间)
void GetCurrentGreenwichTime(SYSTEMTIME* st)
{
	time_t timep;
	time(&timep);
	struct tm* tmGreenwichTime = gmtime(&timep);
	st->wYear = tmGreenwichTime->tm_year + 1900;
	st->wMonth = tmGreenwichTime->tm_mon + 1;
	st->wDay = tmGreenwichTime->tm_mday;
	st->wHour = tmGreenwichTime->tm_hour;
	st->wMinute = tmGreenwichTime->tm_min;
	st->wSecond = tmGreenwichTime->tm_sec;
	st->wMilliseconds = 0;
}
//获取当前时间，带毫秒(格林威治标准时间)
void GetCurrentGreenwichTimeStamp(SYSTEMTIME* st)
{
	timeb t;
	ftime(&t);
	time_t timep = t.time;
	struct tm* tmGreenwichTime = gmtime(&timep);
	st->wYear = tmGreenwichTime->tm_year + 1900;
	st->wMonth = tmGreenwichTime->tm_mon + 1;
	st->wDay = tmGreenwichTime->tm_mday;
	st->wHour = tmGreenwichTime->tm_hour;
	st->wMinute = tmGreenwichTime->tm_min;
	st->wSecond = tmGreenwichTime->tm_sec;
	st->wMilliseconds = 0;
}

//time_t转换成文件时间LPFILETIME
void UnixTimeToFileTime(time_t t, LPFILETIME pft)
{
	LONGLONG ll;

	ll = Int32x32To64(t, 10000000) + 116444736000000000;
	pft->dwLowDateTime = (DWORD)ll;
	pft->dwHighDateTime = ll >> 32;
}

//time_t转换成SYSTEMTIME(格林威治时间的SYSTEMTIME)
void UnixTimeToSystemTime(time_t t, SYSTEMTIME* st)
{
	FILETIME ft;
	UnixTimeToFileTime(t, &ft);
	FileTimeToSystemTime(&ft, st);
}
//系统时间SYSTEMTIME(格林威治时间的SYSTEMTIME)转换成time_t
void SystemTimeToUnixTime(SYSTEMTIME st, time_t *pt)
{
	FILETIME ft;
	SystemTimeToFileTime(&st, &ft);

	LONGLONG ll;

	ULARGE_INTEGER ui;
	ui.LowPart = ft.dwLowDateTime;
	ui.HighPart = ft.dwHighDateTime;

	ll = (ft.dwHighDateTime << 32) + ft.dwLowDateTime;

	*pt = (DWORD)((LONGLONG)(ui.QuadPart - 116444736000000000) / 10000000);
}
//time_t转换成系统时间SYSTEMTIME(本地系统时间的SYSTEMTIME)
void UnixTimeToLocalSystemTime(time_t t, SYSTEMTIME* st)
{
	tm temptm = *localtime(&t);

	SYSTEMTIME stinner = { 1900 + temptm.tm_year,
		1 + temptm.tm_mon,
		temptm.tm_wday,
		temptm.tm_mday,
		temptm.tm_hour,
		temptm.tm_min,
		temptm.tm_sec,
		0 };
	*st = stinner;
}
//本地系统时间SYSTEMTIME转换time_t(格林威治时间的time_t)
void SystemTimeToGreenwichUnixTime(SYSTEMTIME st, time_t *pt)
{
	tm temptm = { st.wSecond,
		st.wMinute,
		st.wHour,
		st.wDay,
		st.wMonth - 1,
		st.wYear - 1900,
		st.wDayOfWeek,
		0,
		0 };

	*pt = mktime(&temptm);
}

//本地系统时间time_t转换到格林威治时间(格林威治时间的SYSTEMTIME)
void TimeTToGreenwichTime(time_t t, SYSTEMTIME* st)
{
	struct tm * tmGreenwichTime = gmtime(&t);
	st->wYear = tmGreenwichTime->tm_year + 1900;
	st->wMonth = tmGreenwichTime->tm_mon + 1;
	st->wDay = tmGreenwichTime->tm_mday;
	st->wHour = tmGreenwichTime->tm_hour;
	st->wMinute = tmGreenwichTime->tm_min;
	st->wSecond = tmGreenwichTime->tm_sec;
	st->wMilliseconds = 0;
}
//本地系统时间SYSTEMTIME转换到格林威治时间SYSTEMTIME
void SystemTimeToGreenwichTime(SYSTEMTIME ss, SYSTEMTIME* sd)
{
	tm temptm = { ss.wSecond,
		ss.wMinute,
		ss.wHour,
		ss.wDay,
		ss.wMonth - 1,
		ss.wYear - 1900,
		ss.wDayOfWeek,
		0,
		0 };
	time_t t = mktime(&temptm);
	struct tm * tmGreenwichTime = gmtime(&t);
	sd->wYear = tmGreenwichTime->tm_year + 1900;
	sd->wMonth = tmGreenwichTime->tm_mon + 1;
	sd->wDay = tmGreenwichTime->tm_mday;
	sd->wHour = tmGreenwichTime->tm_hour;
	sd->wMinute = tmGreenwichTime->tm_min;
	sd->wSecond = tmGreenwichTime->tm_sec;
	sd->wMilliseconds = ss.wMilliseconds;
}
//格林威治时间SYSTEMTIME转换到本地系统时间SYSTEMTIME
void GreenwichTimeToSystemTime(SYSTEMTIME ss, SYSTEMTIME* sd)
{
	time_t t;
	SystemTimeToUnixTime(ss, &t);
	struct tm* temptm = localtime(&t);
	SYSTEMTIME stinner = { 1900 + temptm->tm_year,
		1 + temptm->tm_mon,
		temptm->tm_wday,
		temptm->tm_mday,
		temptm->tm_hour,
		temptm->tm_min,
		temptm->tm_sec,
		ss.wMilliseconds };
	*sd = stinner;
}
```

