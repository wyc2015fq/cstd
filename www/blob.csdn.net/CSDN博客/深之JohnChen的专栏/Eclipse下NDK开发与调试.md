# Eclipse下NDK开发与调试 - 深之JohnChen的专栏 - CSDN博客

2014年09月18日 00:09:28[byxdaz](https://me.csdn.net/byxdaz)阅读数：19665


**Eclipse下NDK开发**

一、关于NDK:

NDK全称：Native Development Kit。 

1、NDK是一系列工具的集合。 

NDK提供了一系列的工具，帮助开发者快速开发C（或C++）的动态库，并能自动将so和java应用一起打包成apk。这些工具对开发者的帮助是巨大的。 

NDK集成了交叉编译器，并提供了相应的mk文件隔离CPU、平台、ABI等差异，开发人员只需要简单修改mk文件（指出“哪些文件需要编译”、“编译特性要求”等），就可以创建出so。

NDK可以自动地将so和Java应用一起打包，极大地减轻了开发人员的打包工作。

2、NDK提供了一份稳定、功能有限的API头文件声明。 

Google明确声明该API是稳定的，在后续所有版本中都稳定支持当前发布的API。从该版本的NDK中看出，这些API支持的功能非常有限，包含有：C标准库（libc）、标准数学库（libm）、压缩库（libz）、Log库（liblog）。

二、NDK实例的实现：

对于Windows环境下NDK的开发，如果使用的NDK是r7之前的版本，必须要安装Cygwin才能使用NDK，所以为Eclipse需要配置的builder，其实是执行Cygwin，然后传递ndk-build作为参数。在NDKr7开始，Google的Windows版的NDK提供了一个ndk-build.cmd的脚本，这样，就可以直接利用这个脚本编译，而不需要使用Cygwin了。只需要为Eclipse Android工程添加一个Builders，就能让Eclipse自动编译NDK。

本文是讲述NDK-r7下的实现实例。

下面是使用NDK-r7在windows下配置自动编译的builders的过程（实际上对于Linux，只需要修改ndk-build.cmd为ndk-build就可以了。）。
（1）先下载安装NDK-r7。

下载地址：[http://developer.android.com/sdk/ndk/index.html](http://developer.android.com/sdk/ndk/index.html)

下载后解压缩就可以用了。
（2）打开Eclipse，新建一个Android工程（我的取名为TestNdk），在工程目录TestNdk下新建jni文件夹，该文件夹就用来保存NDK需要编译的文件代码等。
（3）新建并配置一个Builder：
（a）Project->Properties->Builders->New，新建一个Builder。 

（b）在弹出的【Choose configuration type】对话框，选择【Program】，点击【OK】： 

（c）在弹出的【Edit Configuration】对话框中，配置选项卡【Main】。

在“Name“中输入新builders的名称（我取名为Ndk_Builder）。

在“Location”中输入nkd-build.cmd的路径。

（我的是D:\AndroidDev\android-ndk-r7\ndk-build.cmd，根据各自的ndk路径设置，也可以点击“Browser File System…”来选取这个路径）。

在“Working Diretcoty”中输入${workspace_loc:/TestNdk}（也可以点击“Browse Workspace”来选取TestNdk目录）。

（d）【Edit Configuration】对话框中，配置选项卡【Refresh】。

勾选“Refresh resources upon completion”，

勾选“The entire workspace”，

勾选“Recuresively include sub-folders”。

（e）【Edit Configuration】对话框中，配置选项卡【Build options】。

勾选“After a “Clean””，

勾选“During manual builds”，

勾选“During auto builds”，

勾选“Specify working set of relevant resources”。

点击“Specify Resources…”

勾选TestNdk工程的“jni“目录，点击”finish“。 

点击“OK“，完成配置。

OK，到这里Eclipse就能够自动调用NDK编译jin目录下的C/C++代码了。
（4）在TestNdk工程中新建一个JniClient.class（为了调用C/C++代码），其内容如下：
package com.ndk.test;

public class JniClient {

static public native String AddStr(String strA, String strB);

static public native int AddInt(int a, int b);

}
（5）用cmd命令定位到JniClient.class 所在目录，输入“javac JniClient.java“后回车，生成JniClinet.class文件（如果是用的Eclipse建的工程，在TestNdk\bin\classes\com\ndk\test目录下就已经有JniClinet.class文件了）。
（6）将JniClinet.class拷贝到TestNdk\bin\classes\com\ndk\test目录，将cmd命令定位到TestNdk\bin\classes目录，输入”javah com.ndk.test.JniClient“后回车，在TestNdk\bin\classes目录下就生成了C++头文件com_ndk_test_JniClient.h。com_ndk_test_JniClient.h的文件内容如下：

/* DO NOT EDIT THIS FILE - it is machine generated */

#include <jni.h>

/* Header for class com_ndk_test_JniClient */

#ifndef _Included_com_ndk_test_JniClient

#define _Included_com_ndk_test_JniClient

#ifdef __cplusplus

extern "C" {

#endif

/*

* Class: com_ndk_test_JniClient

* Method: AddStr

* Signature: (Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;

*/

JNIEXPORT jstring JNICALL Java_com_ndk_test_JniClient_AddStr

(JNIEnv *, jclass, jstring, jstring);

/*

* Class: com_ndk_test_JniClient

* Method: AddInt

* Signature: (II)I

*/

JNIEXPORT jint JNICALL Java_com_ndk_test_JniClient_AddInt

(JNIEnv *, jclass, jint, jint);

#ifdef __cplusplus

}

#endif

#endif

（7）在jni目录下新建一个Android.mk文件，其内容如下（详细的语法以后再另外解释）：
LOCAL_PATH := $(call my-dir)

include $(CLEAR_VARS)

LOCAL_MODULE := TestNdk

LOCAL_SRC_FILES := com_ndk_test_JniClient.c

include $(BUILD_SHARED_LIBRARY)

（8）将com_ndk_test_JniClient.h拷贝到TestNdk工程的jni目录下， 然后新建一个com_ndk_test_JniClient.c文件完成头文件中函数的实现，其内容如下（本来Java_com_ndk_test_JniClient_AddStr是想完成字符串相加的功能的，但数据转换有点问题，想先写完本文档，后续再研究jni数据类型的问题，所以只简单的返回一个字符串。）：
#include "com_ndk_test_JniClient.h"

#include <stdlib.h>

#include <stdio.h>

#ifdef __cplusplus 

extern "C" 

{ 

#endif 

/*

* Class: com_ndk_test_JniClient

* Method: AddStr

* Signature: (Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;

*/

JNIEXPORT jstring JNICALL Java_com_ndk_test_JniClient_AddStr

(JNIEnv *env, jclass arg, jstring instringA, jstring instringB)

{

jstring str = (*env)->NewStringUTF(env, "HelloWorld from JNI !");

return str; 

}

/*

* Class: com_ndk_test_JniClient

* Method: AddInt

* Signature: (II)I

*/

JNIEXPORT jint JNICALL Java_com_ndk_test_JniClient_AddInt

(JNIEnv *env, jclass arg, jint a, jint b)

{

return a + b;

}

#ifdef __cplusplus 

} 

#endif

编辑com_ndk_test_JniClient.c并保存后，可以看到TestNkd工程下的obj/local/armeabi目录下将自动生成libTestNdk.so库。

（9）在TestNdkActivity.java中完成对JniClient.java中函数的调用：
package com.ndk.test;

import android.app.Activity;

import android.os.Bundle;

import android.widget.TextView;

public class TestNdkActivity extends Activity {

static {

System.loadLibrary("TestNdk");

}

/** Called when the activity is first created. */

@Override

public void onCreate(Bundle savedInstanceState) {

super.onCreate(savedInstanceState);

// setContentView(R.layout.main);

String str = JniClient.AddStr("prefix", "suffix");

int iSum = JniClient.AddInt(5, 2); 

String strSum = "5 + 7 = " + iSum;

TextView tv1 = new TextView(this);

tv1.setText(str);

setContentView(tv1);

}

}
（10）运行TestNdk工程，在模拟器中可以看到界面输出来自com_ndk_test_JniClient.c 文件中的“HelloWorld from JNI ! “。

OK，NDK实例到此完成。后续就可以深入的学习NDK/JNI了，比如C/C++与Java的数据类型转换，Android.mk文件的编写格式等。

**Eclipse下NDK调试C++代码**

转载 [http://download.csdn.net/download/bigmaxim/5474055](http://download.csdn.net/download/bigmaxim/5474055)

**1. 相关软件**

adt-bundle-windows-x86.zip --- Eclipse集成ADT插件，需要联网安装相应的Android SDK。

jdk-6u43-windows-i586.exe --- JDK6Eclipse运行需要JAVA环境，编译ANDROID应用也需要JAVA编译器。

android-ndk-r8e-windows-x86.zip --- NDK r8e，支持在ANDROID应用中用C语言进行开发。说明：ndk-build可以不需要cygwin环境。

Cygwin --- 使用ndk-gdb调试C源码，需要Cygwin环境的支持。

**2. WinXP系统环境变量配置**

ADB_PATH=D:\GreenProgram\adt-bundle-windows-x86\sdk\platform-tools

classpath=.;%JAVA_HOME%\lib;%JAVA_HOME\lib\tools.jar

CYGWIN_BIN=C:\cygwin\bin

ECLIPSE_PATH=D:\GreenProgram\adt-bundle-windows-x86\eclipse

JAVA_HOME=C:\Program Files\Java\jdk1.6.0_43

NDK_ROOT=D:\GreenProgram\adt-bundle-windows-x86\android-ndk-r8e

Path=%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;%NDK_ROOT%;%ADB_PATH%;%CYGWIN_BIN%;%ECLIPSE_PATH%

**3. Cygwin配置**

在当前用户的home目录下文件.bash_profile末尾添加以下2行

NDK_ROOT=/cygdrive/d/GreenProgram/adt-bundle-windows-x86/android-ndk-r8e

export NDK_ROOT

为方便调试程序，可添加以下一行。当启动cygwin时，直接进入项目目录。

cd /cygdrive/f/EclipseWorkspace/01_Capella/05_Test/01_L1Test/EMVTest

**4. 应用工程配置**

在“window –> preferences ->Android -> NDK”中添加NDK的路径。

![](https://img-blog.csdn.net/20130809170705437?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

AndroidManifest.xml文件中Debuggable设为true。

![](https://img-blog.csdn.net/20130809165512750?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

NDK编译设置：ndk-build NDK_DEBUG=1 V=1。

![](https://img-blog.csdn.net/20130809165612937?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

在android工程中的项目上点击右键，选择android tools中的add natie support，这样会增加c/c++等的编译链接选项。

![](https://img-blog.csdn.net/20130809171643625?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

**5. Native方法中C源码级调试**

**5.1. 编译完应用，生成文件。**

![](https://img-blog.csdn.net/20130809165658921?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

**5.2. 右键点击工程 ->Run As->Android Application。**

![](https://img-blog.csdn.net/20130809165737640?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

下载安装应用程序到开发板（或模拟器）中，并启动应用程序。

注意：这里只是要将生成的应用程序安装到开发板（或模拟器）

**5.3. 启动Cygwin进入当前工程目录。**

![](https://img-blog.csdn.net/20130809165813828?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

执行命令 ndk-gdb --force --verbose –start

在提示符<gdb>下输入quit退出。

在目录obj\local\ armeabi下增加了4个文件。

![](https://img-blog.csdn.net/20130809165851421?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

**5.4. 右键点击工程 ->Debug As->Android Native Application。**

![](https://img-blog.csdn.net/20130809165922781?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

在需要调试的位置设好断点，开始C源码级调试。

![](https://img-blog.csdn.net/20130809165958531?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWlueWh5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

**6.参考资料**

[http://download.csdn.net/download/bigmaxim/5474055](http://download.csdn.net/download/bigmaxim/5474055)

[http://xzhoumin.blog.163.com/blog/static/408811362013230517254/](http://xzhoumin.blog.163.com/blog/static/408811362013230517254/)

