# HTTPS原理与应用 - 零度的博客专栏 - CSDN博客
2017年06月12日 15:49:06[零度anngle](https://me.csdn.net/zmx729618)阅读数：632
### 第一部分：HTTPS原理
## 一、什么是HTTPS
在说HTTPS之前先说说什么是HTTP，HTTP就是我们平时浏览网页时候使用的一种协议。HTTP协议传输的数据都是未加密的，也就是明文的，因此使用HTTP协议传输隐私信息非常不安全。为了保证这些隐私数据能加密传输，于是网景公司设计了SSL（Secure Sockets Layer）协议用于对HTTP协议传输的数据进行加密，从而就诞生了HTTPS。SSL目前的版本是3.0，被IETF（Internet Engineering Task Force）定义在RFC 6101中，之后IETF对SSL 3.0进行了升级，于是出现了TLS（Transport
 Layer Security） 1.0，定义在RFC 2246。实际上我们现在的HTTPS都是用的TLS协议，但是由于SSL出现的时间比较早，并且依旧被现在浏览器所支持，因此SSL依然是HTTPS的代名词，但无论是TLS还是SSL都是上个世纪的事情，SSL最后一个版本是3.0，今后TLS将会继承SSL优良血统继续为我们进行加密服务。目前TLS的版本是1.2，定义在RFC 5246中，暂时还没有被广泛的使用。
对历史感兴趣的朋友可以参考[http://en.wikipedia.org/wiki/Transport_Layer_Security](http://en.wikipedia.org/wiki/Transport_Layer_Security)，这里有对TLS/SSL详尽的叙述。   
## 二、HTTPS到底安全吗？
这个答案是肯定的，很安全。谷歌公司已经行动起来要大力推广HTTPS的使用，在未来几周，谷歌将对全球所有本地域名都启用HTTPS，用户只要在搜索前用Google帐号登录，之后所有的搜索操作都将使用TLS协议加密，见：[http://thenextweb.com/google/2012/03/05/google-calls-for-a-more-secure-web-expands-ssl-encryption-to-local-domains/](http://thenextweb.com/google/2012/03/05/google-calls-for-a-more-secure-web-expands-ssl-encryption-to-local-domains/)。   
## 三、HTTPS的工作原理
HTTPS在传输数据之前需要客户端（浏览器）与服务端（网站）之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL协议不仅仅是一套加密传输的协议，更是一件经过艺术家精心设计的艺术品，TLS/SSL中使用了非对称加密，对称加密以及HASH算法。握手过程的简单描述如下：
- 浏览器将自己支持的一套加密规则发送给网站。
- 网站从中选出一组加密算法与HASH算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。
- 获得网站证书之后浏览器要做以下工作：
- 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。
- 如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码，并用证书中提供的公钥加密。
- 使用约定好的HASH计算握手消息，并使用生成的随机数对消息进行加密，最后将之前生成的所有信息发送给网站。
   4.  网站接收浏览器发来的数据之后要做以下的操作：
- 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手消息，并验证HASH是否与浏览器发来的一致。
- 使用密码加密一段握手消息，发送给浏览器。
   5.  浏览器解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密。
这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的密码，并且可以正常的加密解密数据，为后续真正数据的传输做一次测试。另外，HTTPS一般使用的加密与HASH算法如下：
- 非对称加密算法：RSA，DSA/DSS
- 对称加密算法：AES，RC4，3DES
- HASH算法：MD5，SHA1，SHA256
其中非对称加密算法用于在握手过程中加密生成的密码，对称加密算法用于对真正传输的数据进行加密，而HASH算法用于验证数据的完整性。由于浏览器生成的密码是整个数据加密的关键，因此在传输的时候使用了非对称加密算法对其加密。非对称加密算法会生成公钥和私钥，公钥只能用于加密数据，因此可以随意传输，而网站的私钥用于对数据进行解密，所以网站都会非常小心的保管自己的私钥，防止泄漏。
TLS握手过程中如果有任何错误，都会使加密连接断开，从而阻止了隐私信息的传输。正是由于HTTPS非常的安全，攻击者无法从中找到下手的地方，于是更多的是采用了假证书的手法来欺骗客户端，从而获取明文的信息，但是这些手段都可以被识别出来，我将在后续的文章进行讲述。不过2010年还是有安全专家发现了TLS 1.0协议处理的一个漏洞：[http://www.theregister.co.uk/2011/09/19/beast_exploits_paypal_ssl/](http://www.theregister.co.uk/2011/09/19/beast_exploits_paypal_ssl/)，实际上这种称为BEAST的攻击方式早在2002年就已经被安全专家发现，只是没有公开而已。目前微软和Google已经对此漏洞进行了修复。见：[http://support.microsoft.com/kb/2643584/en-us](http://support.microsoft.com/kb/2643584/en-us)[https://src.chromium.org/viewvc/chrome?view=rev&revision=90643](https://src.chromium.org/viewvc/chrome?view=rev&revision=90643)
HTTPS简化版的工作原理也可以参见[《对称加密与非对称加密 》](http://www.cnblogs.com/jfzhu/p/4020928.html)。
## 第二部分：SSL证书
第一部分[HTTPS原理](http://www.guokr.com/post/114121/)中，我们可以了解到HTTPS核心的一个部分是数据传输之前的握手，握手过程中确定了数据加密的密码。在握手过程中，网站会向浏览器发送SSL证书，SSL证书和我们日常用的身份证类似，是一个支持HTTPS网站的身份证明，SSL证书里面包含了网站的域名，证书有效期，证书的颁发机构以及用于加密传输密码的公钥等信息，由于公钥加密的密码只能被在申请证书时生成的私钥解密，因此浏览器在生成密码之前需要先核对当前访问的域名与证书上绑定的域名是否一致，同时还要对证书的颁发机构进行验证，如果验证失败浏览器会给出证书错误的提示。在这一部分我将对SSL证书的验证过程以及个人用户在访问HTTPS网站时，对SSL证书的使用需要注意哪些安全方面的问题进行描述。
一、证书的类型
实际上，我们使用的证书分很多种类型，SSL证书只是其中的一种。证书的格式是由[X.509](http://en.wikipedia.org/wiki/X.509)标准定义。SSL证书负责传输公钥，是一种[PKI](http://en.wikipedia.org/wiki/Public_key_infrastructure)（Public Key
 Infrastructure，公钥基础结构）证书。
我们常见的证书根据用途不同大致有以下几种：
1、SSL证书，用于加密HTTP协议，也就是HTTPS。
2、代码签名证书，用于签名二进制文件，比如Windows内核驱动，Firefox插件，Java代码签名等等。
3、客户端证书，用于加密邮件。
4、双因素证书，网银专业版使用的USB Key里面用的就是这种类型的证书。
这些证书都是由受认证的证书颁发机构——我们称之为CA（[Certificate Authority](http://en.wikipedia.org/wiki/Certificate_authority)）机构来颁发，针对企业与个人的不同，可申请的证书的类型也不同，价格也不同。CA机构颁发的证书都是受信任的证书，对于SSL证书来说，如果访问的网站与证书绑定的网站一致就可以通过浏览器的验证而不会提示错误。
二、SSL证书申请与规则
SSL证书可以向CA机构通过付费的方式申请，也可以自己制作。
CA机构颁发的证书价格非常昂贵，而且有效期一般只有一年到三年不等（年数不同，价格也不同），过期之后还要再次交钱申请，因此一般只有企业才会申请证书。但是随着个人网站的增多，目前也有针对个人的SSL证书服务，价格相对便宜一些，国内的话400多块钱就能申请到一个，国外更是有免费的SSL证书可以申请。
在申请SSL证书时需要向CA机构提供网站域名，营业执照，以及申请人的身份信息等。网站的域名非常重要，申请人必须证明自己对域名有所有权，如果支持Hotmail.com，Gmail.com的SSL证书都可以随便申请，黑客们就不用做假证书欺骗了。此外，一个证书一般只绑定一个域名，如果CA机构心情好的话，会免费再绑一个，比如你要申请域名时绑定的域名是guokr.com，那么只有在浏览器地址是https://guokr.com的时候，这个证书才是受信任的，如果地址是https://www.guokr.com或者https://login.guokr.com，那么这个证书由于访问的域名与证书绑定的域名不同，仍然会被浏览器显示为不受信任的。CA机构也提供申请通配符域名（例如，*.guokr.com），通配符域名相当于绑定了主域名下的所有域名，因此使用起来非常方便，但是价格也超级昂贵，一个通配符域名一年大概得5000块钱，只有企业才可以申请。
下面就来看看一个证书的信息：
![](http://3.im.guokr.com/R-OslhS49QSoGyqVC8Wui3_mGh-wNb9y4DJ3zJj2IRajAQAACQIAAEpQ.jpg)
在访问hotmail的时候会跳转到login.live.com，这时IE浏览器上会有一个小锁头，点一下那个小锁头再点击里面的“查看证书”就会出现上图的证书窗口，这里面我们可以看到这个证书只有一个用途——向远程计算机证明身份信息，证书的用途会有很多，SSL只是其中之一。在“颁发给”这一项就是这个证书在申请时绑定的域名；下面的“颁发者”是证书的颁发机构。最下面的两个日期是证书申请时间以及过期的时间。这里我们可以注意一下“颁发者”的信息，里面有“Extended Validation SSL”的字样，表明了这个证书是一个EV
 SSL证书（扩展验证SSL证书），EV SSL证书有个特点就是可以让浏览器的地址栏变绿，同时显示出来证书所属公司的名称，如下图所示：
![](http://2.im.guokr.com/wqUuVQChlFGgN6TwqrFbVGAxcffFGFdChPF4vdOLRizaAQAAKwAAAEpQ.jpg)
![](http://3.im.guokr.com/Q4n1IQdUVromTQd9teGJ4zA-kUcytpFdbo5zFyuvpAklAgAAIgAAAEpQ.jpg)
EV SSL证书与其他的证书相比，费用更高。
以上说的是向CA机构申请证书的情况，如果个人网站只为加密传输也可以自己制作SSL证书，自己制作的证书不会受到浏览器的信任，在访问的时候由于证书验证失败而给出警告。
三、证书的验证过程
证书以证书链的形式组织，在颁发证书的时候首先要有根CA机构颁发的根证书，再由根CA机构颁发一个中级CA机构的证书，最后由中级CA机构颁发具体的SSL证书。我们可以这样理解，根CA机构就是一个公司，根证书就是他的身份凭证，每个公司由不同的部门来颁发不同用途的证书，这些不同的部门就是中级CA机构，这些中级CA机构使用中级证书作为自己的身份凭证，其中有一个部门是专门颁发SSL证书，当把根证书，中级证书，以及最后申请的SSL证书连在一起就形成了证书链，也称为证书路径。在验证证书的时候，浏览器会调用系统的证书管理器接口对证书路径中的所有证书一级一级的进行验证，只有路径中所有的证书都是受信的，整个验证的结果才是受信。我们还是以login.live.com这个证书举例，在查看证书的时候，点击“证书路径”标签就会有下图的显示：
![](http://3.im.guokr.com/jOgm5Z07bBKA5FNVJFzuI99LxGzyg2U-8U_c7sYqn4GjAQAACQIAAEpQ.jpg)
根证书是最关键的一个证书，如果根证书不受信任，它下面颁发的所有证书都不受信任。操作系统在安装过程中会默认安装一些受信任的CA机构的根证书，可以在“运行”里面运行“certmgr.msc”启动证书管理器，如下图所示：
![](http://3.im.guokr.com/tQGTE_tnxxP0fsE4gtvnAXSl6E2MaSe_A9Qdockrn3ucAwAAGgIAAEpQ.jpg?imageView2/2/w/592)
根证书的有效期长，支持的用途多以方便颁发不同用途类型的中级证书；中级证书用途单一，有效期相对短一些，但是比具体的SSL证书要长很多。
如果SSL证书验证失败根据浏览器的不同会有以下的错误提示：
![](http://2.im.guokr.com/EmdncPaZhVS65SfPqhIaabLfdQ5wMNsy-3Hu1hOG8m4gAwAAMAIAAEpQ.jpg?imageView2/2/w/592)
![](http://2.im.guokr.com/GZLvVaGauRJDk79ESMv5P6G42ocWSjDTmIbsw2FRq30lAwAAGQIAAEpQ.jpg?imageView2/2/w/592)
SSL证书验证失败有以下三点原因：
1、SSL证书不是由受信任的CA机构颁发的
2、证书过期
3、访问的网站域名与证书绑定的域名不一致
这三点原因也是IE浏览器给出的提示。
> **小提示：如果你对哪个根证书CA机构比较憎恨，可以将它的根证书删除，这样所有它颁发的证书都不会受信任。**
四、SSL证书的安全问题
对HTTPS最常见的攻击手段就是SSL证书欺骗或者叫SSL劫持，是一种典型的中间人攻击。不过SSL劫持并非只是用于攻击目的，在一些特殊情况下利用SSL劫持我们可以更顺畅的访问网络，我会在后文提到。
以攻击为目的的SSL劫持如果不注意浏览器安全提示的话，很容易就中招。当网络中有中间人发起SSL劫持攻击时，攻击者需要伪造一个SSL证书发给浏览器，这个时候由于伪造的SSL证书不受信任，浏览器会给出提示。
这里有一个误区，当SSL证书不受信任的时候，并不一定就是有SSL劫持发生，有种例外情况是：一些个人网站买不起合法的SSL证书，因此会自己制作一个SSL证书来加密传输的数据。如果你经常访问某个个人网站，而且你知道这个网站是干什么的，那么这种情况可以不用担心。但是如果你访问的是网银，在线支付，或者是hotmail.com，gmail.com等，这类公司性质的网站一定会申请合法的SSL证书（12306.cn除外），一旦SSL证书不受信任，应该果断的终止访问，这个时候网络中一定会存在异常行为，对于一些小区宽带的用户一定要注意这点。
所以作为个人用户，你一定要知道你访问的是什么网站，如果你只是一个没有多少计算机只是的普通网民，我相信你不会经常上那些自己制作SSL证书的个人网站（12306.cn除外），因此如果你没有办法判断网络是不是有异常，只要是证书有问题的，干脆就别再访问了。
> **小提示：对于12306.cn，一定要按照网站说的那样，“为保障您顺畅购票，请下载安装根证书”。**
最后我们总结一下使用SSL证书要注意的问题：
1、除非必要，不要随意安装根证书。安装根证书的时候一定要明确证书的来源。
2、对于网银，在线支付，重要邮箱等网站，一定要确保SSL证书是没有问题的，如果浏览器给出SSL证书错误的警告，一定要拒绝访问。一些小区宽带用户一定要注意这点。
3、由于现在个人申请SSL证书比较便宜，一定要注意挂着合法SSL证书的钓鱼网站（国外比较常见）。对于钓鱼网站，一定要看清域名，另外别相信什么中奖的消息，同时要安装带有钓鱼防护功能的安全软件。
## 第三部分：HTTPS攻击实例与防御
前文描述了使用SSL证书时一些需要注意的安全问题，下面演示一下针对HTTPS攻击的一些实例，通过这些实例能更安全的使用HTTPS。知己知彼百战不殆。先说一下我的测试环境，WIFI局域网，两台计算机，其中一台是Windows 7用于发起攻击。另一台测试机用于测试攻击，配置为Windows XP SP3，IE8，Chrome 17。
在开始之前，再回顾一下SSL证书验证失败的三点原因：
- SSL证书不是由受信任的CA机构颁发的
- 证书过期
- 访问的网站域名与证书绑定的域名不一致
一、SSL劫持攻击
SSL劫持也就是SSL证书欺骗攻击，攻击者为了获得HTTPS传输的明文数据，需要先将自己接入到浏览器与目标网站之间（中间人），在传输数据的过程中，替换目标网站发给浏览器的证书，之后解密传输中的数据，简单的图示如下：
[浏览器] <======> [目标网站] （正常情况）
[浏览器] <======> 中间人 <======> [目标网站] （中间人攻击）
中间人攻击最好的环境是在局域网中，局域网中所有的计算机需要通过一个固定的出口（网关）来接入互联网，因此攻击者只需要在局域网中实施一次中间人攻击就可以顺利的截获所有计算机与网关之间传输的数据。
下图就是在我的测试环境中实施一次中间人攻击之后进行的SSL证书欺骗工具，可以看到此时被欺骗的机器，浏览器已经给出证书错误的安全提示：
![](http://1.im.guokr.com/gkimage/f9/2u/w0/f92uw0.jpg)
![](http://2.im.guokr.com/gkimage/cf/fx/7y/cffx7y.jpg)
看到这样的提示，正常情况应该停止访问，如果继续访问，所有加密传输的数据都可以被攻击者解密。在这里我选择继续访问来看一下伪造的SSL证书信息。
![](http://1.im.guokr.com/gkimage/94/xe/lx/94xelx.jpg)
这里可以看到，假证书中“颁发给”，“颁发者”，“有效日期”与真证书一样（见下图），攻击者可以在生成证书的时候给假证书写入与原始证书一样的信息来迷惑用户，但是迷惑不了证书的验证机制。对于普通用户来说，一定要看清浏览器的警告信息，如果有问题，就不要再继续访问。
![](http://2.im.guokr.com/gkimage/2q/tk/94/2qtk94.jpg)
二、SSLStrip攻击
SSLStrip攻击也需要将攻击者设置为中间人，之后将HTTPS访问替换为HTTP返回给浏览器，由于HTTP协议传输的数据是未加密的，从而截获用户访问的数据。举个例子，当我们访问hotmail.com的时候会重定向到一个https://login.live.com的一个HTTPS的地址上，SSLStrip会代替用户与服务器通信，并将这个地址改为[http://login.live.com](http://login.live.com/)（注意这个地址在http后面**没有**s）返回给浏览器，此时如果用户继续登录的话，攻击者就会截取到用户的密码。这种攻击对普通用户非常具有迷惑性，但是防御却非常的简单：
- 对于网站来说，在配置HTTPS服务的时候加上“[HTTP Strict Transport Security](http://en.wikipedia.org/wiki/Strict_Transport_Security)”配置项；或者是在代码中将所有HTTP的请求强制转移到HTTPS上，使用URL REWRITE也可以达到同样的效果。
- 对于关键的信息，例如用户登录网站的ID和密码，在发送之前先用JavaScript进行一次加密处理，这种方法不但是对SSLStrip有效，对SSL劫持攻击也有效，甚至是即便使用HTTP协议来传输用户登录的ID和密码都是安全的。
- 对于用户来说，在访问那些支持HTTPS的网站的时候，在浏览器的地址栏输入URL时强制的加上“https://”，大多数用户平时不注意这点，比如访问gmail，我们一般就输入“gmail.com”，如果是输入“[https://gmail.com](https://gmail.com/)”就可以避免SSLStrip的攻击。对于使用脚本实现地址跳转也需要注意这个问题，location.href之后的URL，一定要强制加上“https://”。
由于防御SSLStrip攻击比较简单，大多数的网站都已经做好了安全方面的配置，但也有少数的网站仍然没有重视这个问题。
三、第三类攻击
所谓第三类攻击，完全就是软件厂商在软件的设计过程中忽略的了安全的问题，比如说前段时间某个手机浏览器就干了这么一件糗事。实际上这也是一种普遍存在的情况，程序的bug、漏洞，设计缺陷，都会打破一些安全模型。对于这种情况，软件厂商在软件设计阶段要充分考虑安全的问题，并且及时更新程序中的缺陷与安全漏洞；作为用户要及时的更新应用程序或者系统补丁，从而减少安全威胁。
目前最为常见的手段仍然是SSL劫持攻击，但无论是什么攻击手段，基础的利用都是局域网的中间人攻击，这种攻击手段非常的实用，尤其是在公共网络中。针对SSL的中间人攻击对普通用户来说或许还好识别一些，但是我们大多数情况访问的都是HTTP网站，传输的数据都是明文的，在这种情况下中间人攻击是不容易被发现的。对于普通用户，可以用以下的办法来防御局域网中间人攻击：
- 公司办公网络一定要在交换机上进行MAC地址绑定，对于一些规模不大，暂时不考虑加固内网的公司可以采取下面我说的方法。
- 临时接入公共网络的计算机，可以临时开启安全软件内的ARP防火墙。或者是使用VPN。
- 对于一些不喜欢安装安全软件的用户，可以使用stunnel配置代理或者是使用SSH转SOCKS 5代理。但是这需要用户有独立的服务器。
- 使用GoAgent代理工具，GoAgent与stunnel类似，都是一种使用ssl tunnel对传输进行加密的工具。即便是访问HTTP网站，GoAgent也可以像stunnel那样对传输进行加密，可以保证浏览网页，访问WEB邮箱的安全。GoAgent使用的是Google App Engine服务器，因此访问国内网站的速度会比较慢，对于这种情况可以使用Sina App Engine，具体配置方法可以在搜索引擎中用“goagent sae”作为关键字进行搜索。
- 在公共网络如果要进行商务办公，最好是用公司提供的VPN来对传输进行加密。
最后再说说手机上网，目前公共WIFI越来越普及，手机上网也越来越方便，因此也需要重视数据传输过程中的安全问题。虽然GoAgent也有支持Android和iOS的版本，但如果要使用在线支付之类的功能，最好是利用官方出的应用来进行操作。针对手机的安全防护目前还没有计算机那么强大，因此在没有办法保证传输加密数据之前，最好不要用手机来做什么涉及到隐私或者是商业保密的工作。
