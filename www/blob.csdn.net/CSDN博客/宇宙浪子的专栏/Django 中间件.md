# Django 中间件 - 宇宙浪子的专栏 - CSDN博客
2016年02月26日 17:04:11[_宇宙浪子_](https://me.csdn.net/bluehawksky)阅读数：1746
转自：[http://www.ziqiangxuetang.com/django/django-middleware.html](http://www.ziqiangxuetang.com/django/django-middleware.html)
Middleware也就是所谓的中间件 Django的中间件的这个中间指的是 服务器接受到Request ---- View处理，以及View处理完 ---- 发送Response到客户端 这两个中间。
### 1.中间件只是实现了某些特定方法的普通对象
所以定义一个中间件很容易，你只需要定义一个普通的python类，然后实现如下四个方法中的某一个或者某几个各个函数执行的时机
process_request   # 接受request之后确定所执行的view之前  
process_view        # 确定了所要执行的view之后 view真正执行之前
process_response   # view 执行之后 
process_exception(self, request, exception)  # view抛出异常
### 2.安装中间件
通过django-admin生成的项目的setting.py的配置文件中默认有如下设置，
如果你需要添加自己的中间件，你需要在这个地方进行指定。
- MIDDLEWARE_CLASSES = (  
- 'django.middleware.common.CommonMiddleware',
  
- 'django.contrib.sessions.middleware.SessionMiddleware',
  
- 'django.middleware.csrf.CsrfViewMiddleware',
  
- 'django.contrib.auth.middleware.AuthenticationMiddleware',
  
- ) 
这里指定的顺序和实际运行时运行的顺序相关，
在request阶段：process_request，process_view 按照其所在类在配置中的先后顺序进行，
在response阶段：process_response，process_exception 则按照相反的顺序进行。
还有一点就是在整个流程中，每一个process_response都会执行到，
而其余三种，都可能会因为其他的直接retuen response或者不发生异常而不被执行到。
---------------------------------------------------------------------------------------------------------------------------------
我们从浏览器发出一个请求 Request，得到一个响应后的内容 HttpResponse ，这个请求传递到 Django的过程如下：
也就是说，每一个请求都是先通过中间件中的 process_request 函数，这个函数返回 None 或者 HttpResponse 对象，如果返回前者，继续处理其它中间件，如果返回一个 HttpResponse，就处理中止，返回到网页上。
中间件不用继承自任何类（可以继承 object ），下面一个中间件大概的样子：
```
```python
class
```
```python
CommonMiddleware(
```
```python
object
```
```python
):
```
```python
```
```python
def
```
```python
process_request(
```
```python
self
```
```python
, request):
```
```python
```
```python
return
```
```python
None
```
```python
```
```python
def
```
```python
process_response(
```
```python
self
```
```python
, request, response):
```
```python
```
```python
return
```
```python
response
```
```
还有 process_view, process_exception 和 process_template_response 函数。
一，比如我们要做一个 拦截器，发生有恶意访问网站的人，就拦截他！
假如我们通过一种技术，比如统计一分钟访问页面数，太多就把他的 IP 加入到黑名单 BLOCKED_IPS（这部分没有提供代码，主要讲中间件部分）
```
```python
#项目 zqxt 文件名 zqxt/middleware.py
```
```python
class
```
```python
BlockedIpMiddleware(
```
```python
object
```
```python
):
```
```python
```
```python
def
```
```python
process_request(
```
```python
self
```
```python
, request):
```
```python
```
```python
if
```
```python
request.META[
```
```python
'REMOTE_ADDR'
```
```python
]
```
```python
in
```
```python
getattr
```
```python
(settings,
```
```python
"BLOCKED_IPS"
```
```python
, []):
```
```python
```
```python
return
```
```python
http.HttpResponseForbidden(
```
```python
'<h1>Forbidden</h1>'
```
```python
)
```
```
这里的代码的功能就是 获取当前访问者的 IP (request.META['REMOTE_ADDR'])，如果这个 IP 在黑名单中就拦截，如果不在就返回 None (函数中没有返回值其实就是默认为 None)，把这个中间件的 Python 路径写到settings.py中
```
```python
MIDDLEWARE_CLASSES
```
```python
=
```
```python
(
```
```python
```
```python
'zqxt.middleware.BlockedIpMiddleware'
```
```python
,
```
```python
```
```python
...其它的中间件
```
```python
)
```
```
Django 会从 MIDDLEWARE_CLASSES 中按照从上到下的顺序一个个执行中间件中的 process_request 函数，而其中 process_response 函数则是最前面的最后执行。
二，再比如，我们在网站放到服务器上正式运行后，DEBUG改为了 False，这样更安全，但是有时候发生错误不能显示错误详情页面，有没有办法处理好这两个事情呢？
- 
普通访问者看到的是友好的报错信息
- 
管理员看到的是错误详情，以便于修复 BUG
当然可以有，利用中间件就可以做到！代码如下：
```
```python
import
```
```python
sys
```
```python
from
```
```python
django.views.debug
```
```python
import
```
```python
technical_500_response
```
```python
from
```
```python
django.conf
```
```python
import
```
```python
settings
```
```python
class
```
```python
UserBasedExceptionMiddleware(
```
```python
object
```
```python
):
```
```python
```
```python
def
```
```python
process_exception(
```
```python
self
```
```python
, request, exception):
```
```python
```
```python
if
```
```python
request.user.is_superuser
```
```python
or
```
```python
request.META.get(
```
```python
'REMOTE_ADDR'
```
```python
)
```
```python
in
```
```python
settings.INTERNAL_IPS:
```
```python
```
```python
return
```
```python
technical_500_response(request,
```
```python
*
```
```python
sys.exc_info())
```
```
把这个中间件像上面一样，加到你的 settings.py 中的 MIDDLEWARE_CLASSES 中，可以放到最后，这样可以看到其它中间件的 process_request的错误。
当访问者为管理员时，就给出错误详情，比如访问本站的不存在的页面：[http://www.ziqiangxuetang.com/admin/](http://www.ziqiangxuetang.com/admin/)
普通人看到的是普通的 404（自己点开看看），而我可以看到：
![django_debug_admin.png](http://www.ziqiangxuetang.com/media/uploads/images/django_debug_admin_20150509150941_949.png)
三，分享一个简单的识别手机的中间件，更详细的可以参考这个：[django-mobi](https://pypi.python.org/pypi/django-mobi/) 或 [django-mobile](https://pypi.python.org/pypi/django-mobile/)
```
```python
MOBILE_USERAGENTS
```
```python
=
```
```python
(
```
```python
"2.0 MMP"
```
```python
,
```
```python
"240x320"
```
```python
,
```
```python
"400X240"
```
```python
,
```
```python
"AvantGo"
```
```python
,
```
```python
"BlackBerry"
```
```python
,
```
```python
```
```python
"Blazer"
```
```python
,
```
```python
"Cellphone"
```
```python
,
```
```python
"Danger"
```
```python
,
```
```python
"DoCoMo"
```
```python
,
```
```python
"Elaine/3.0"
```
```python
,
```
```python
"EudoraWeb"
```
```python
,
```
```python
```
```python
"Googlebot-Mobile"
```
```python
,
```
```python
"hiptop"
```
```python
,
```
```python
"IEMobile"
```
```python
,
```
```python
"KYOCERA/WX310K"
```
```python
,
```
```python
"LG/U990"
```
```python
,
```
```python
```
```python
"MIDP-2."
```
```python
,
```
```python
"MMEF20"
```
```python
,
```
```python
"MOT-V"
```
```python
,
```
```python
"NetFront"
```
```python
,
```
```python
"Newt"
```
```python
,
```
```python
"Nintendo Wii"
```
```python
,
```
```python
"Nitro"
```
```python
,
```
```python
```
```python
"Nokia"
```
```python
,
```
```python
"Opera Mini"
```
```python
,
```
```python
"Palm"
```
```python
,
```
```python
"PlayStation Portable"
```
```python
,
```
```python
"portalmmm"
```
```python
,
```
```python
"Proxinet"
```
```python
,
```
```python
```
```python
"ProxiNet"
```
```python
,
```
```python
"SHARP-TQ-GX10"
```
```python
,
```
```python
"SHG-i900"
```
```python
,
```
```python
"Small"
```
```python
,
```
```python
"SonyEricsson"
```
```python
,
```
```python
"Symbian OS"
```
```python
,
```
```python
```
```python
"SymbianOS"
```
```python
,
```
```python
"TS21i-10"
```
```python
,
```
```python
"UP.Browser"
```
```python
,
```
```python
"UP.Link"
```
```python
,
```
```python
"webOS"
```
```python
,
```
```python
"Windows CE"
```
```python
,
```
```python
```
```python
"WinWAP"
```
```python
,
```
```python
"YahooSeeker/M1A1-R2D2"
```
```python
,
```
```python
"iPhone"
```
```python
,
```
```python
"iPod"
```
```python
,
```
```python
"Android"
```
```python
,
```
```python
```
```python
"BlackBerry9530"
```
```python
,
```
```python
"LG-TU915 Obigo"
```
```python
,
```
```python
"LGE VX"
```
```python
,
```
```python
"webOS"
```
```python
,
```
```python
"Nokia5800"
```
```python
)
```
```python
class
```
```python
MobileTemplate(
```
```python
object
```
```python
):
```
```python
```
```python
"""
```
```python
```
```python
If a mobile user agent is detected, inspect the default args for the view
```
```python
```
```python
func, and if a template name is found assume it is the template arg and
```
```python
```
```python
attempt to load a mobile template based on the original template name.
```
```python
```
```python
"""
```
```python
```
```python
def
```
```python
process_view(
```
```python
self
```
```python
, request, view_func, view_args, view_kwargs):
```
```python
```
```python
if
```
```python
any
```
```python
(ua
```
```python
for
```
```python
ua
```
```python
in
```
```python
MOBILE_USERAGENTS
```
```python
if
```
```python
ua
```
```python
in
```
```python
```
```python
request.META[
```
```python
"HTTP_USER_AGENT"
```
```python
]):
```
```python
```
```python
template
```
```python
=
```
```python
view_kwargs.get(
```
```python
"template"
```
```python
)
```
```python
```
```python
if
```
```python
template
```
```python
is
```
```python
None
```
```python
:
```
```python
```
```python
for
```
```python
default
```
```python
in
```
```python
view_func.func_defaults:
```
```python
```
```python
if
```
```python
str
```
```python
(default).endswith(
```
```python
".html"
```
```python
):
```
```python
```
```python
template
```
```python
=
```
```python
default
```
```python
```
```python
if
```
```python
template
```
```python
is
```
```python
not
```
```python
None
```
```python
:
```
```python
```
```python
template
```
```python
=
```
```python
template.rsplit(
```
```python
".html"
```
```python
,
```
```python
1
```
```python
)[
```
```python
0
```
```python
]
```
```python
+
```
```python
".mobile.html"
```
```python
```
```python
try
```
```python
:
```
```python
```
```python
get_template(template)
```
```python
```
```python
except
```
```python
TemplateDoesNotExist:
```
```python
```
```python
pass
```
```python
```
```python
else
```
```python
:
```
```python
```
```python
view_kwargs[
```
```python
"template"
```
```python
]
```
```python
=
```
```python
template
```
```python
```
```python
return
```
```python
view_func(request,
```
```python
*
```
```python
view_args,
```
```python
*
```
```python
*
```
```python
view_kwargs)
```
```python
```
```python
return
```
```python
None
```
```
参考文档：[https://docs.djangoproject.com/en/1.8/topics/http/middleware/](https://docs.djangoproject.com/en/1.8/topics/http/middleware/)
