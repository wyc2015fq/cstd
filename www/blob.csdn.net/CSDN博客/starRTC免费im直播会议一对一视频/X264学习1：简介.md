# X264学习1：简介 - starRTC免费im直播会议一对一视频 - CSDN博客
2017年08月21日 14:02:13[starRTC免费IM直播会议一对一视频](https://me.csdn.net/elesos)阅读数：200
H.264是视频编码标准。
X264是它的开源实现，是视频编码器。
## 目录
 [[隐藏](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#)] 
- [1 编码器特性](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#.E7.BC.96.E7.A0.81.E5.99.A8.E7.89.B9.E6.80.A7)
- [2 输入输出文件类型](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#.E8.BE.93.E5.85.A5.E8.BE.93.E5.87.BA.E6.96.87.E4.BB.B6.E7.B1.BB.E5.9E.8B)- [2.1 输入](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#.E8.BE.93.E5.85.A5)
- [2.2 输出](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#.E8.BE.93.E5.87.BA)
- [3 preset和tune系统](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#preset.E5.92.8Ctune.E7.B3.BB.E7.BB.9F)- [3.1 --preset](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#--preset)
- [3.2 --tune](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#--tune)
- [4 码率控制](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#.E7.A0.81.E7.8E.87.E6.8E.A7.E5.88.B6)- [4.1 crf](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#crf)
- [4.2 2pass bitrate](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#2pass_bitrate)
- [5 艺搜参考](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B#.E8.89.BA.E6.90.9C.E5.8F.82.E8.80.83)
## [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=1)]编码器特性
- 8x8 and 4x4 adaptive spatial transform
- Adaptive B-frame placement
- B-frames as references / arbitrary frame order
- CAVLC/CABAC entropy coding
- Custom quantization matrices
- Intra: all macroblock types (16x16, 8x8, 4x4, and PCM with all predictions)
- Inter P: all partitions (from 16x16 down to 4x4)
- Inter B: partitions from 16x16 down to 8x8 (including skip/direct)
- Interlacing (MBAFF)
- Multiple reference frames
- Ratecontrol: constant quantizer, constant quality, single or multipass ABR, optional VBV
- Scenecut detection
- Spatial and temporal direct mode in B-frames, adaptive mode selection
- Parallel encoding on multiple CPUs
- Predictive lossless mode
- Psy optimizations for detail retention (adaptive quantization, psy-RD, psy-trellis)
- Zones for arbitrarily adjusting bitrate distribution
- 
- 8x8与4x4自适应空间域转换
- 自适应B帧选择
- B帧可作为参考帧/自由的帧顺序
- CAVLC/CABAC熵编码
- 自定义精确的矩阵模板
- I帧：所有宏块格式（16x16, 8x8, 4x4, 以及有全部预测的PCM）
- P帧：所有的分割块（从16x16到4x4）
- B帧：分割块从16x16到8x8（包括skip/direct）
- 隔行扫描([MBAFF](http://192.168.1.100/elesos_com/index.php?title=MBAFF&action=edit&redlink=1))
- 多个参考帧
- 码率控制：固定量化，固定质量，一次或者多次编码的平均码率，可选的VBV参数
- 场景变换检测
- B帧时间域、空间域direct模式自适应选择
- 可在多个CPU平行编码
- 预测性的无损编码
- 心理视觉优化，保留更多的细节（自适应量化，psy-RD，psy-trellis）
- 可用于手动调整码率分配的zones参数
在ITU的标准里称为H.264，在MPEG的标准里是MPEG-4的一个组成部分:MPEG-4 Part 10，又叫Advanced Video Codec，因此常常又称为MPEG-4 AVC或直接叫AVC。
适用于从超低码率低延迟的电话会议到高码率的BluRay光盘和HDTV码流。
## [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=2)]输入输出文件类型
在加入了ffms/lavf（libavformat或ffmpegsource这两个库）后，x264可以直接输入几乎所有类型的片子，而不是像原来一样必须借助于avs。下面所讲的是输入输出的片子类型，除此之外的输入输出还有 多pass中的stats文件、qp file、量化矩阵和tc file。
### [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=3)]输入
x264支持输入的文件类型有raw yuv、y4m、avs和任何可以由ffms或lavf打开的文件。raw yuv会用在64位的x264里。由ffms/lavf打开的片子会自动正确的处理vfr问题。avs和ffms/lavf输入不需要指定片子的分辨率。
（注：[YUV](http://192.168.1.100/elesos_com/index.php?title=YUV&action=edit&redlink=1)是被欧洲电视系统所采用的一种颜色编码方法）
### [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=4)]输出
x264可以输出没有封装的H.264视频流，扩展名是.264；matroska视频，扩展名是.mkv；flash视频，扩展名是.flv；mp4视频，扩展名是.mp4。mkv、mp4和flv可以是vfr的。 （VFR即Variable Frame Rate(可变帧率)的视频编码，这种VFR视频的帧率是不固定的，它可在动态画面中使用较大的帧率，而在静态画面中使用较小的帧率，这样可以有效的减少视频文件的体积，并改善动态画面的质量。它的作用比目前广泛使用的VBR（可变码率）更为明显。）
x264通过输出文件的扩展名判断输出文件类型。
## [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=5)]preset和tune系统
x264的参数繁多，开发者为了方便使用者、简化输入和提出编码建议，设计了一套快速调用参数的系统。如果没有特别的需要，请尽量使用preset和tune系统。这套开发者推荐的参数比各种道听途说的参数更合理。
在使用了preset和tune以后，依然可以指定里面已经有的参数。手动指定的参数会覆盖preset和tune里的参数。
### [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=6)]--preset
通过--preset的参数调节编码速度和质量的平衡。
--preset的值有ultrafast、superfast、veryfast、faster、fast、medium、slow、slower、veryslow、placebo。从快到慢，参数越来越EP。默认是medium。
### [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=7)]--tune
通过--tune的参数值指定片子的类型，是和视觉优化的参数，或有特别的情况。
--tune的值有
- film：电影、真人类型；
- animation：动画；
- grain：需要保留大量的grain时用；
- stillimage：静态图像编码时使用；
- psnr：为提高psnr做了优化的参数；
- ssim：为提高ssim做了优化的参数；
（structural similarity (SSIM) index measurement system一种衡量两幅图像相似度的新指标，其值越大越好，最大为1）
- fastdecode：可以快速解码的参数；
- zerolatency：零延迟，用在需要非常低的延迟的情况下，比如电视电话会议的编码。
## [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=8)]码率控制
视频的码率直接影响到了片子的编码质量。要想效果好，码率足够是最重要的必要条件之一。但是想实现更好的效果和控制文件的体积（码率）之间始终是一对矛盾。这就需要我们通过实践，在强大的编码器的帮助下总结出合适的码率，实现尽量好的效果。
x264有4种码率控制方式，分别是1pass bitrate、crf、qp和2pass bitrate。其中2pass bitrate包含npass bitrate。
1pass bitrate和qp（恒定量化值）一般不推荐使用。
### [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=9)]crf
--crf 23 （默认）
一种根据片子质量自动分配码率的vbr码率控制方式。一遍编码，如果对码率没要求请尽量使用crf模式。（VBR（Variable Bit Rate）动态比特率）
可用的值从1到51，越小编码质量越好，码率越高。一般使用16到24，可以为浮点。
crf并不是恒定质量的方式，同一片子同一crf值，其他参数不同可能码率和质量能差比较大，不同的片子之间就更没有可比性了。
### [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=10)]2pass bitrate
这种方式可以精确的得到想要的平均码率，2pass代表需要做2次编码，第一遍编码x264先分析全片，得到一个stats文件和一个mbtree文件（默认使用mbtree）。第二遍编码以这两个文件作参考分配合理的码率。需要特定的码率（或文件大小）一定要用2pass（或多pass）编码。
除了2pass，还有多pass模式，在之前分析的基础上再继续分析，理论上会使码率分配更加合理，但实际上2pass已经足够了。
--bitrate 1000 （以1000kbps码率为例）
**>**x264 --bitrate1000--pass1--tune animation --preset slower --stats"1pass.stats"-o NUL input.avs
 
**>**x264 --bitrate1000--pass2--tune animation --preset slower --stats"1pass.stats"-o output.264 input.avs
先输入第一行，等1pass跑完之后再输入第二行跑2pass。1pass主要为了得到1pass.stats和1pass.stats.mbtree两个文件，2pass需要这两个文件已完成最后的编码，最后输出文件。
默认情况下，1pass是以“快速”参数跑的，而不是以指定的参数跑。因此一般1pass会比2pass的速度快上很多。而这里1pass指定输出的文件名是NUL，在Windows里，这个文件名是保留的，因此不会有任何输出的已编码的文件。
尽量让1pass和2pass的视频一致，如果改变了视频，分析的结果就会变得比较不准确。
此外，1pass可以用crf方式跑，而且可以输出编码的结果，也就是说先跑个1pass看看，如果大小和预想的偏差太多，就再跑个2pass。但由于1pass默认用“快速”参数跑，因此这里的1pass需要加上--slow-firstpass强制x264用我们给的参数跑。
**>**x264 --crf20--pass1--slow-firstpass--tune animation --preset slower --stats"1pass.stats"-o output1pass.264 input.avs
 
**>**x264 --bitrate1000--pass2--tune animation --preset slower --stats"1pass.stats"-o output2pass.264 input.avs
1pass会输出3个文件：1pass.stats、1pass.stats.mbtree和output1pass.264。前两个是分析文件，后一个是编码的结果。如果对编码结果不满意，则继续用分析的结果跑2pass。
2pass必须用bitrate模式跑，不能用crf。
## [[编辑](http://192.168.1.100/elesos_com/index.php?title=X264%E7%AE%80%E4%BB%8B&action=edit&section=11)]艺搜参考
[官方网站](http://www.videolan.org/developers/x264.html)
[http://download.videolan.org/pub/videolan/x264/snapshots/](http://download.videolan.org/pub/videolan/x264/snapshots/)
