# 关于Winsock：Winsock编程注意事项：共享套接字 - 一世豁然的专栏 - CSDN博客





2018年10月11日 10:13:46[一世豁然](https://me.csdn.net/Explorer_day)阅读数：63








引入了WSADuplicateSocket函数以启用跨进程的套接字共享。 源进程调用WSADuplicateSocket以获取目标进程标识符的特殊WSAPROTOCOL_INFO结构。 它使用一些进程间通信（IPC）机制将此结构的内容传递给目标进程。 然后，目标进程在调用WSPSocket时使用WSAPROTOCOL_INFO结构。 此函数返回的套接字描述符将是底层套接字的附加套接字描述符，从而变为共享。 套接字可以在给定进程中的线程之间共享，而不使用WSADuplicateSocket函数，因为套接字描述符在进程的所有线程中都有效。

就I / O而言，引用共享套接字的两个（或更多）描述符可以独立使用。 但是，Winsock接口不实现任何类型的访问控制，因此进程必须协调共享套接字上的任何操作。 共享套接字的典型示例是使用一个进程来创建套接字和建立连接。 然后，此过程将套接字移交给负责信息交换的其他进程。

WSADuplicateSocket函数创建套接字描述符而不是底层套接字。 结果，与套接字相关联的所有状态在所有描述符中保持共同。 例如，随后使用来自任何或所有描述符的getsockopt可以看到使用一个描述符执行的setsockopt操作。 进程可以在重复的套接字上调用closesocket，并且描述符将被取消分配。 但是，底层套接字保持打开状态，直到使用最后一个剩余描述符调用closesocket。

共享套接字上的通知受WSAAsyncSelect和WSAEventSelect函数的通常约束。 使用任何共享描述符发出这些调用中的任何一个都会取消套接字的任何先前事件注册，无论使用哪个描述符进行该注册。 因此，例如，不可能使进程A接收FD_READ事件并且进程B接收FD_WRITE事件。 对于需要这种紧密协调的情况，建议开发人员使用线程而不是单独的进程。



