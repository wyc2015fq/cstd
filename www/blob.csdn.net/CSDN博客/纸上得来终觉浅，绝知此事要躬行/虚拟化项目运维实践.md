# 虚拟化项目运维实践 - 纸上得来终觉浅，绝知此事要躬行 - CSDN博客





2016年05月30日 14:54:05[boonya](https://me.csdn.net/boonya)阅读数：2977








文章地址：[http://mp.weixin.qq.com/s?__biz=MjM5NDE0MjI4MA==&mid=2656298704&idx=2&sn=68d5d42a9c26640a21eebd3253ca81c3&scene=1&srcid=0519IBq6Q2k77kYAQmXuofuV&from=groupmessage&isappinstalled=0#wechat_redirect](http://mp.weixin.qq.com/s?__biz=MjM5NDE0MjI4MA==&mid=2656298704&idx=2&sn=68d5d42a9c26640a21eebd3253ca81c3&scene=1&srcid=0519IBq6Q2k77kYAQmXuofuV&from=groupmessage&isappinstalled=0#wechat_redirect)

肖力，KVM运维专家。金山西山居系统运维经理，前盛大游戏研究员。15年工作经验，10年游戏行业运维经验，5年KVM虚拟化运维经验维护有微信订阅号：“KVM虚拟化实践”著有《深度实践KVM》一书。

**本文主要截取非技术因素、业务压力模型构建、如何将业务迁移到虚拟化环境、软硬件选型和灾备方案方面进行整理。**




**一、非技术因素**

2015年是云计算大爆发的一年，对云计算虚拟化的直观感受是人才需求量越来越大、职业待遇逐步提高，云计算招聘的微信群异常活跃。第二个感受是做云计算的朋友在公司内部越来越受重视。

**总体来说：**

**1.云是更高级的资源利用的方式；**

**2.云使业务部署更高效便捷；**

**3. 随着这几年的发展，云真的成为基础架构和生态系统，在大数据、视频、教育、医疗等各个方面得到应用。**

现在的问题，**已从企业要不要上云的问题，变成为如何上云的问题**。企业上云可以选择使用公有云，可以选择自建私有云，也可以选择使用混合云，大部分使用云的方式以后应该是混合云。

**云计算对运维人带来的影响最为明显的是分工更专业、要求更高**，比如原来你在一个公司的内部，可能是计算或业务方面的运维；在上云后，可能会把系统、底层方面的运维工作都交到云，从而将更多精力关注到业务，将业务做得更好、更专业。如果去做私有云，也就是**IaaS层的运维**，包括数据中心、网络、安全等，只在大型企业存在，。此外，因为云计算平台有众多的API，如果你利用好这些API，可以实现从底层到上层的全面打通，运维方面的趋势是**更强调自动化**。



**二、业务如何迁移到虚拟化环境**

**第一步**，要**说服老板和同事支持做虚拟化。**随着云计算虚拟化概念的普及，很多人对云已然不再如开始般排斥，但是去做第一个项目时，一定要保证它的成功，树立好榜样。

**第二步，如何选择潜力股**

如何保证第一个项目成功虚拟化呢？一定要**选择潜力股**，找到一个比较好做成功的虚拟化项目，它有很多特征：
- 
**单进程**，现在CPU都是多核的，单进程可以非常容易去做；

- 
其次是**利用率不高的业务**，比如常年那些利用率只有20~30%的业务，可通过将几个业务合并到一个宿主机上，从而提高它的利用率；

- 
**频繁变动的业务**，通常非常喜欢做虚拟化，因为虚拟化快速部署的提点，解决了业务频繁变动这样的痛点；

- 
**非核心业务**，如果一开始就着手核心业务做虚拟化，一旦出现问题，将面临着很大的压力，甚而会影响到整个公司对于虚拟化的信心，所以第一个虚拟化项目从非核心业务开始。


另外，不是所有业务时候做虚拟化，在物理机上压力已经非常高的业务，就很难通过虚拟化来做整合。

**第三步，虚拟化项目实施周期。**实施虚拟化一般应该遵循以下样的流程：**业务性能需求评估**、根据压力模型**设计一个虚拟化方案、搭建测试环境、系统综合测试、业务测试、小规模部署、全面部署、全面部署好最终的虚拟化运维。**

**第四步，解决实施中的问题。**在实施过程中有一些问题需要注意，首要关注**虚拟化层的稳定性**，然后**虚拟机快速自动管理维护**，接着解决**与业务更紧密的结合**，最重要的是需要拥有一套监控、健康、报警、应急习响应预案。




**三、业务压力模型分析**

**![](http://mmbiz.qpic.cn/mmbiz/L7VCLLMFOH20wbYgaWqvgYM7ykib1URyjE5sgsvudslViaicD6AIk1mmtBJ3rC1Ubz7cUsA5DVuA3pCrJBGcxBficw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1)**构建业务压力模型的时候，如何具体地做。首先要对业务架构熟悉，它的**逻辑角色类型**是怎样的，最好**画一个图**出来做到心中有数，明确**角色间的关系**。

然后进行性能数据收集与分析，有两种方法：
- 
一是**收集每个项目的服务器数量和角色**，看长期的监控数据、CPU内存等压力情况，一般观察两个月；

- 
二是通过脚本收集现有服务器性能，这个主要为了收集更细的数据；

- 
通过收集的压力数据，得出压力模型，根据压力模型，确定虚拟化比例




**四、软硬件选型**

**软件方面，**对于生产环境我们一般肯定要选择稳定版本。但是，在稳定版本的基础上，内存版本越高越好，为什么？这里有一个数据，数据时间比较长，同样配置情况下CentOS
 6.1和 CentOS 5.6的CPU计算能力的对比，CentOS 6.1要比CentOS 5.6好9%，就是内核版本越高，它的CPU中断和上下文切换优化得越好，同时网络IO、磁盘IO也优化得越好。

**硬件方面，**尽量一开始配置要稍微好一点，因为配置得越强悍，你可以虚拟的虚拟机越多，你最终肯定节省成本；另外，内存也要稍微大一点，因为你的宿主机跑上一段时间以后，往往你会发现内存不够，到时候又要加内存。最后，尽量选择主流品牌。




**五、灾备方案**

虚拟机灾备策略—应用层备份（在线迁移不是灾备手段）

灾备有两种思路：
- 
应用层灾备，基本上跟原来物理机上一样，你在物理机上怎么做灾备，在虚拟机上用同样的方法做灾备；

- 
虚拟化灾备，做快照，做多份的镜像复制。


一般建议在应用层次做灾备，因为在应用层做灾备消耗的资源要少很多。注意的是，灾备要定期演练，一方面让大家熟悉过程，再来验证一下灾备这个机制到底是不是生效，可总结为两点：
- 
所有的虚拟机xml描述文件应定时交叉备份；

- 
XML 描述文件与IP 地址信息需要同时备份；

- 
定期演练，我们自己要熟悉过程，相关的业务也需要让他们去演练一下，出现问题的时候我们可以很快的恢复。




**总结**

第一个上**云是趋势，虚拟化是第一步**；然后在生产环境，我们尽量**选成熟的技术、完善的预案**，因为对生产环境要有定位；**虚拟化是基本的IT技能**，不管原来做哪方面的运维，可能或多或少用到虚拟化的运维。此外，我们在企业内部推荐虚拟化的时候，**口碑**也是非常重要的，一旦有问题就会影响我们口碑去推需虚拟化。

KVM实战开源脚本：[https://github.com/search?utf8=%E2%9C%93&q=kvm_vm_setup](https://github.com/search?utf8=%E2%9C%93&q=kvm_vm_setup)







