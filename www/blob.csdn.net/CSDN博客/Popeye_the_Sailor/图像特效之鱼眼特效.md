# 图像特效之鱼眼特效 - Popeye_the_Sailor - CSDN博客
2017年10月17日 20:23:06[_Sailor_](https://me.csdn.net/lz0499)阅读数：711
## 图像特效之鱼眼特效
### 1.关键代码
```cpp
/*
*Function: 鱼眼特效
*/
int Fisheye(IMAGE_TYPE *BMP24_img,int m_iCurvature,T_BOOL m_bInverse,int m_iBackground)
{
	DWORD width,height,bfsize;
	WORD  biBitCount = 3;
	T_U8 *dst_data,*bmp,*img_data;
	T_U32 line_byte,src_Imgindex,dst_Imgindex,R;
	int Xoffset,Yoffset,MidX,MidY,X,Y,x,y;
	double radius,radian,s,w;
	enum backgroundtype
	{
		leave = 0,
		white,
		black
	};
	
	BITMAPFILEHEADER bf;
	BITMAPINFOHEADER bi;
	
	FILE *Fisheye_fp = fopen("Fisheye.bmp","wb");
	
	if(NULL == Fisheye_fp)
	{
		printf("Can't open Fisheye.bmp\n");
		return -1;
	}
	memset(&bf, 0, sizeof(bf));
	memset(&bi, 0, sizeof(bi));
	
	bmp = BMP24_img;
	memcpy(&bf,bmp,14);
	memcpy(&bi,&bmp[14],40);
	
	fwrite(&bf,sizeof(BITMAPFILEHEADER),1,Fisheye_fp);
	fwrite(&bi,sizeof(BITMAPINFOHEADER),1,Fisheye_fp);
	
	height = bi.biHeight;
	width  = bi.biWidth;
	bfsize = bf.bfSize;
	biBitCount = bi.biBitCount;
	line_byte =  (width*3+3) & ~0x3;
	img_data = bmp+54;
	
	dst_data = (T_U8 *)malloc(line_byte*height);
	if (NULL == dst_data)
	{
		printf("Can't malloc for dst image!\n");
		return -1;
	}
	memset(dst_data,0,line_byte*height);
	
	MidX = width/2;
	MidY = height/2;
	R = MIN(width,height)/2;
	w = 0.001*m_iCurvature;
	s = R/log(w*R+1);
	
	for(y = 0; y < (height); y+= 1)
	{
		dst_Imgindex = y*line_byte;
		for(x=0; x <(width); x+= 1)
		{
			Yoffset = y - MidY;
			Xoffset = x - MidX;
			
			radian = atan2((double)Yoffset,(double)Xoffset);
			radius = sqrt(Xoffset*Xoffset+Yoffset*Yoffset);
			
			if (radius <= R)
			{
				if (!m_bInverse)
				{
					radius =  (exp(radius/s)-1)/w;
				}
				else
				{
					radius = s * log(1+w*radius);
				}
				X = (int)(radius*cos(radian)+MidX);
				Y = (int)(radius*sin(radian)+MidY);
				
				if (X >= width) X = width-1;
				if (X < 0)	   X = 0;
				if (Y >= height)Y = height-1;
				if (Y < 0)	   Y = 0;
				src_Imgindex = Y*line_byte+3*X;
				
				dst_data[dst_Imgindex] = img_data[src_Imgindex];
				dst_data[dst_Imgindex+1] = img_data[src_Imgindex+1];
				dst_data[dst_Imgindex+2] = img_data[src_Imgindex+2];
			}
			else
			{
				switch (m_iBackground)
				{
				case leave:
					{
						dst_Imgindex = y*line_byte+x*3;
						dst_data[dst_Imgindex] = img_data[dst_Imgindex];
						dst_data[dst_Imgindex+1] = img_data[dst_Imgindex+1];
						dst_data[dst_Imgindex+2] = img_data[dst_Imgindex+2];
						break;
					}
				case white:
					{
						dst_Imgindex = y*line_byte+x*3;
						dst_data[dst_Imgindex] = 255;
						dst_data[dst_Imgindex+1] = 255;
						dst_data[dst_Imgindex+2] = 255;
						break;
					}
				case black:
					{
						dst_Imgindex = y*line_byte+x*3;
						dst_data[dst_Imgindex] = 0;
						dst_data[dst_Imgindex+1] = 0;
						dst_data[dst_Imgindex+2] = 0;
						break;
					}
				default:
					break;
					
				}
			
			}
					
			dst_Imgindex +=3;
		}
	}
	
	
	fwrite(dst_data,line_byte*height,1,Fisheye_fp);
	fclose(Fisheye_fp);
	Fisheye_fp = NULL;
	free(dst_data);
	return 0;
}
```
### 2.图像效果
![](https://img-blog.csdn.net/20171017202551626)![](https://img-blog.csdn.net/20171017202446267)
