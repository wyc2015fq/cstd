# MediaPlayer播放网络视频 - u013366022的专栏 - CSDN博客
2014年08月13日 14:26:34[slitaz](https://me.csdn.net/u013366022)阅读数：710
本文来自[http://blog.csdn.net/hellogv/](http://blog.csdn.net/hellogv/) ，引用必须注明出处！
       上次讲解了[MediaPlayer播放网络音频](http://blog.csdn.net/hellogv/archive/2011/05/09/6406732.aspx)，介绍了MediaPlayer关于网络音频的缓冲和进度条控制的方法，这次再讲解MediaPlayer播放网络视频。播放网络视频比播放网络音频多需要一个SurfaceView而已，已经熟悉MediaPlayer播放网络音频之后，相信大家对播放网络视频也能很快地掌握。先来看看本文程序运行截图：
![](http://hi.csdn.net/attachment/201105/18/0_1305698559n4Z6.gif)
本文程序的视频来自[http://daily3gp.com](http://daily3gp.com/)，大家可以替换程序中的视频链接，试试其他影片。
main.xml的源码如下：
**[xhtml]**[view
 plain](http://blog.csdn.net/hellogv/article/details/6429455#)[copy](http://blog.csdn.net/hellogv/article/details/6429455#)[print](http://blog.csdn.net/hellogv/article/details/6429455#)[?](http://blog.csdn.net/hellogv/article/details/6429455#)
- <?xmlversion="1.0"encoding="utf-8"?>
- <FrameLayoutxmlns:android="http://schemas.android.com/apk/res/android"
- android:layout_height="fill_parent"android:layout_width="fill_parent">
- <SurfaceViewandroid:id="@+id/surfaceView1"
- android:layout_height="fill_parent"android:layout_width="fill_parent"></SurfaceView>
- <LinearLayoutandroid:layout_height="wrap_content"
- android:layout_width="fill_parent"android:layout_gravity="bottom"
- android:orientation="vertical">
- <LinearLayoutandroid:orientation="horizontal"
- android:layout_gravity="center_horizontal"android:layout_marginTop="4.0dip"
- android:layout_height="wrap_content"android:layout_width="wrap_content">
- <Buttonandroid:layout_width="wrap_content"
- android:layout_height="wrap_content"android:id="@+id/btnPlayUrl"
- android:text="播放网络视频"></Button>
- <Buttonandroid:layout_height="wrap_content"android:id="@+id/btnPause"
- android:text="暂停"android:layout_width="80dip"></Button>
- <Buttonandroid:layout_height="wrap_content"
- android:layout_width="80dip"android:text="停止"android:id="@+id/btnStop"></Button>
- </LinearLayout>
- <LinearLayoutandroid:orientation="horizontal"
- android:layout_width="fill_parent"android:layout_height="wrap_content"
- android:layout_marginBottom="20dip">
- <SeekBarandroid:paddingRight="10dip"android:layout_gravity="center_vertical"
- android:paddingLeft="10dip"android:layout_weight="1.0"
- android:layout_height="wrap_content"android:layout_width="wrap_content"
- android:id="@+id/skbProgress"android:max="100"></SeekBar>
- </LinearLayout>
- </LinearLayout>
- </FrameLayout>
Player.java是本文的核心，Player.java实现了“进度条更新”、“数据缓冲”、“SurfaceHolder生命周期”等功能，其中“SurfaceHolder生命周期”是视频与音频播放的最大区别，通过surfaceCreated()、surfaceDestroyed()、surfaceChanged()可以创建/释放某些资源。下面这个地方需要注意一下：
**[java]**[view
 plain](http://blog.csdn.net/hellogv/article/details/6429455#)[copy](http://blog.csdn.net/hellogv/article/details/6429455#)[print](http://blog.csdn.net/hellogv/article/details/6429455#)[?](http://blog.csdn.net/hellogv/article/details/6429455#)
- videoWidth = mediaPlayer.getVideoWidth();  
-         videoHeight = mediaPlayer.getVideoHeight();  
- if (videoHeight != 0 && videoWidth != 0) {  
-             arg0.start();  
-         }  
有些视频是android播放器不能播放的，不能播放时videoHeight=0，videoWidth=0，以此来判断是否播放视频。
Player.java源码如下：
**[java]**[view
 plain](http://blog.csdn.net/hellogv/article/details/6429455#)[copy](http://blog.csdn.net/hellogv/article/details/6429455#)[print](http://blog.csdn.net/hellogv/article/details/6429455#)[?](http://blog.csdn.net/hellogv/article/details/6429455#)
- package com.videoplayer;  
- 
- 
- import java.io.IOException;  
- import java.util.Timer;  
- import java.util.TimerTask;  
- import android.media.AudioManager;  
- import android.media.MediaPlayer;  
- import android.media.MediaPlayer.OnBufferingUpdateListener;  
- import android.media.MediaPlayer.OnCompletionListener;  
- import android.os.Handler;  
- import android.os.Message;  
- import android.util.Log;  
- import android.view.SurfaceHolder;  
- import android.view.SurfaceView;  
- import android.widget.SeekBar;  
- 
- publicclass Player implements OnBufferingUpdateListener,  
-         OnCompletionListener, MediaPlayer.OnPreparedListener,  
-         SurfaceHolder.Callback {  
- privateint videoWidth;  
- privateint videoHeight;  
- public MediaPlayer mediaPlayer;  
- private SurfaceHolder surfaceHolder;  
- private SeekBar skbProgress;  
- private Timer mTimer=new Timer();  
- public Player(SurfaceView surfaceView,SeekBar skbProgress)  
-     {  
- this.skbProgress=skbProgress;  
-         surfaceHolder=surfaceView.getHolder();  
-         surfaceHolder.addCallback(this);  
-         surfaceHolder.setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);  
-         mTimer.schedule(mTimerTask, 0, 1000);  
-     }  
- 
- /*******************************************************
-      * 通过定时器和Handler来更新进度条
-      ******************************************************/
-     TimerTask mTimerTask = new TimerTask() {  
- @Override
- publicvoid run() {  
- if(mediaPlayer==null)  
- return;  
- if (mediaPlayer.isPlaying() && skbProgress.isPressed() == false) {  
-                 handleProgress.sendEmptyMessage(0);  
-             }  
-         }  
-     };  
- 
-     Handler handleProgress = new Handler() {  
- publicvoid handleMessage(Message msg) {  
- 
- int position = mediaPlayer.getCurrentPosition();  
- int duration = mediaPlayer.getDuration();  
- 
- if (duration > 0) {  
- long pos = skbProgress.getMax() * position / duration;  
-                 skbProgress.setProgress((int) pos);  
-             }  
-         };  
-     };  
- //*****************************************************
- 
- publicvoid play()  
-     {  
-         mediaPlayer.start();  
-     }  
- 
- publicvoid playUrl(String videoUrl)  
-     {  
- try {  
-             mediaPlayer.reset();  
-             mediaPlayer.setDataSource(videoUrl);  
-             mediaPlayer.prepare();//prepare之后自动播放
- //mediaPlayer.start();
-         } catch (IllegalArgumentException e) {  
- // TODO Auto-generated catch block
-             e.printStackTrace();  
-         } catch (IllegalStateException e) {  
- // TODO Auto-generated catch block
-             e.printStackTrace();  
-         } catch (IOException e) {  
- // TODO Auto-generated catch block
-             e.printStackTrace();  
-         }  
-     }  
- 
- 
- publicvoid pause()  
-     {  
-         mediaPlayer.pause();  
-     }  
- 
- publicvoid stop()  
-     {  
- if (mediaPlayer != null) {   
-             mediaPlayer.stop();  
-             mediaPlayer.release();   
-             mediaPlayer = null;   
-         }   
-     }  
- 
- @Override
- publicvoid surfaceChanged(SurfaceHolder arg0, int arg1, int arg2, int arg3) {  
-         Log.e("mediaPlayer", "surface changed");  
-     }  
- 
- @Override
- publicvoid surfaceCreated(SurfaceHolder arg0) {  
- try {  
-             mediaPlayer = new MediaPlayer();  
-             mediaPlayer.setDisplay(surfaceHolder);  
-             mediaPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);  
-             mediaPlayer.setOnBufferingUpdateListener(this);  
-             mediaPlayer.setOnPreparedListener(this);  
-         } catch (Exception e) {  
-             Log.e("mediaPlayer", "error", e);  
-         }  
-         Log.e("mediaPlayer", "surface created");  
-     }  
- 
- @Override
- publicvoid surfaceDestroyed(SurfaceHolder arg0) {  
-         Log.e("mediaPlayer", "surface destroyed");  
-     }  
- 
- 
- @Override
-     /**  
-      * 通过onPrepared播放  
-      */  
- publicvoid onPrepared(MediaPlayer arg0) {  
-         videoWidth = mediaPlayer.getVideoWidth();  
-         videoHeight = mediaPlayer.getVideoHeight();  
- if (videoHeight != 0 && videoWidth != 0) {  
-             arg0.start();  
-         }  
-         Log.e("mediaPlayer", "onPrepared");  
-     }  
- 
- @Override
- publicvoid onCompletion(MediaPlayer arg0) {  
- // TODO Auto-generated method stub
- 
-     }  
- 
- @Override
- publicvoid onBufferingUpdate(MediaPlayer arg0, int bufferingProgress) {  
-         skbProgress.setSecondaryProgress(bufferingProgress);  
- int currentProgress=skbProgress.getMax()*mediaPlayer.getCurrentPosition()/mediaPlayer.getDuration();  
-         Log.e(currentProgress+"% play", bufferingProgress + "% buffer");  
- 
-     }  
- 
- }  
test_videoplayer.java是主程序，负责调用Player类，其中关键部分是SeekBarChangeEvent这个SeekBar拖动的事件：SeekBar的Progress是0~SeekBar.getMax()之内的数，而MediaPlayer.seekTo()的参数是0~MediaPlayer.getDuration()之内数，所以MediaPlayer.seekTo()的参数是(progress/seekBar.getMax())*MediaPlayer.getDuration()。
test_videoplayer.java源码如下：
**[java]**[view
 plain](http://blog.csdn.net/hellogv/article/details/6429455#)[copy](http://blog.csdn.net/hellogv/article/details/6429455#)[print](http://blog.csdn.net/hellogv/article/details/6429455#)[?](http://blog.csdn.net/hellogv/article/details/6429455#)
- package com.videoplayer;  
- 
- import android.app.Activity;  
- import android.content.pm.ActivityInfo;  
- import android.net.Uri;  
- import android.os.Bundle;  
- import android.util.Log;  
- import android.view.SurfaceView;  
- import android.view.View;  
- import android.view.View.OnClickListener;  
- import android.widget.Button;  
- import android.widget.SeekBar;  
- 
- publicclass test_videoplayer extends Activity {  
- private SurfaceView surfaceView;  
- private Button btnPause, btnPlayUrl, btnStop;  
- private SeekBar skbProgress;  
- private Player player;  
- 
- /** Called when the activity is first created. */
- @Override
- publicvoid onCreate(Bundle savedInstanceState) {  
- super.onCreate(savedInstanceState);  
-         setContentView(R.layout.main);  
-         setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);  
-         surfaceView = (SurfaceView) this.findViewById(R.id.surfaceView1);  
- 
-         btnPlayUrl = (Button) this.findViewById(R.id.btnPlayUrl);  
-         btnPlayUrl.setOnClickListener(new ClickEvent());  
- 
-         btnPause = (Button) this.findViewById(R.id.btnPause);  
-         btnPause.setOnClickListener(new ClickEvent());  
- 
-         btnStop = (Button) this.findViewById(R.id.btnStop);  
-         btnStop.setOnClickListener(new ClickEvent());  
- 
-         skbProgress = (SeekBar) this.findViewById(R.id.skbProgress);  
-         skbProgress.setOnSeekBarChangeListener(new SeekBarChangeEvent());  
-         player = new Player(surfaceView, skbProgress);  
- 
-     }  
- 
- class ClickEvent implements OnClickListener {  
- 
- @Override
- publicvoid onClick(View arg0) {  
- if (arg0 == btnPause) {  
-                 player.pause();  
-             } elseif (arg0 == btnPlayUrl) {  
-                 String url="http://daily3gp.com/vids/family_guy_penis_car.3gp";  
-                 player.playUrl(url);  
-             } elseif (arg0 == btnStop) {  
-                 player.stop();  
-             }  
- 
-         }  
-     }  
- 
- class SeekBarChangeEvent implements SeekBar.OnSeekBarChangeListener {  
- int progress;  
- 
- @Override
- publicvoid onProgressChanged(SeekBar seekBar, int progress,  
- boolean fromUser) {  
- // 原本是(progress/seekBar.getMax())*player.mediaPlayer.getDuration()
- this.progress = progress * player.mediaPlayer.getDuration()  
-                     / seekBar.getMax();  
-         }  
- 
- @Override
- publicvoid onStartTrackingTouch(SeekBar seekBar) {  
- 
-         }  
- 
- @Override
- publicvoid onStopTrackingTouch(SeekBar seekBar) {  
- // seekTo()的参数是相对与影片时间的数字，而不是与seekBar.getMax()相对的数字
-             player.mediaPlayer.seekTo(progress);  
-         }  
-     }  
- 
- }  
