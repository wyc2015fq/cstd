# 使用hadoop进行大规模数据的全局排序 - aisoo的专栏 - CSDN博客
2012年11月20日 14:43:27[aisoo](https://me.csdn.net/aisoo)阅读数：1050
# 转自：[http://stblog.baidu-tech.com/?p=397](http://stblog.baidu-tech.com/?p=397)
# 1.   Hellow hadoop~~!
Hadoop（某人儿子的一只虚拟大象的名字）是一个复杂到极致，又简单到极致的东西。
说它复杂，是因为一个hadoop集群往往有几十台甚至成百上千台low cost的计算机组成，你运行的每一个任务都要在这些计算机上做任务的分发，执行中间数据排序以及最后的汇总，期间还包含节点发现，任务的重试，故障节点替换等等等等的维护以及异常情况处理。谁叫hadoop集群往往都是由一些平民计算机组成，没事儿罢个工什么的，实在是再寻常不过的事情。
而说其简单，则是因为，上面说到的那些，你通通不用管，你所需要做的，就是写一个程序，当然也可以是脚本，从标准输入读入一条数据，处理完之后，把结果输出到标准输出。
现在，或许你就明白了，hadoop就是一个计算模型。一个分布式的计算模型。
# 1.1Map和reduce
天下大事，分久必合、合久必分。
所谓分布式计算，就是把一大堆用于计算的数据材料切了，扔到多个锅里面，该焯水的焯水，该油炸的油炸。然后都准备的差不多了，按着一定的先后顺序，比如不好熟的先放，好熟的后放什么的，一块下锅炒成一盘菜出来，端出来上桌。
前面的步骤，就是map，分发。Map的作用就是把输入数据打散，做简单的处理，输出。而hadoop则要先将中间数据排序，这个称为shuffle，然后由reduce把中间数据合并到一起。将最终结果输出。
举个简单的例子：公安局要根据数据库内身份证号获得全国每个地市人口数情况（好吧，这个应该是统计局做的），这个任务落到你的头上了，你应该先把所有的身份证号导出到文件中，每行一个，然后把这些文件交给map。Map中的要做的就是截取身份证号的前面六位，把这六位数字直接输出。然后hadoop会把这些身份证号的前六位排序，把相同的数据都排到一起，交给reduce，reduce判断每次输入的号码是否与上一个处理的相同，相同则累加，不同则把之前的号码，和统计的数值输出。这样，你就获得了各地市的人口数统计。
下面这个图就是map和reduce处理的图示。
![](http://stblog.baidu-tech.com/wp-content/uploads/wp-display-data.php?filename=11304573729.jpg&type=image%2Fjpeg&width=495&height=471)
上图是MapReduce的数据处理视图。分为map，shuffle，reduce三个部分。各map任务读入切分后的大规模数据进行处理并将数据作为一系列key:value对输出，输出的中间数据按照定义的方式通过shuffle程序分发到相应的reduce任务。Shuffle程序还会按照定义的方式对发送到一个reduce任务的数据进行排序。Reduce进行最后的数据处理。
MapReduce计算框架适用于超大规模的数据（100TB量级）且各数据之间相关性较低的情况。
# 1.2HDFS
之前，或许你听说过NTFS，VFS，NFS等等等等，没错，HDFS就是hadoop file system。
为什么需要一种专门的文件系统呢？
这是因为hadoop使用过网络松散（说其松散，是因为hadoop集群中的任意一个计算机故障了或是不相干了，都不会对集群造成影响）的组合到一起的。多个计算机需要一个统一的文件访问方式。也就是根据一个路径，不同的计算机可以定位同一个文件。
HDFS就是这样一种分布式文件系统，提供了较好的容错功能和扩展性。
# 1.3节点与槽位
Hadoop集群是由很多low cost的计算机组成的，这些计算机被称为节点。组成hadoop的计算机通常都是全功能的，没有特别的专门用于计算和存储的部分。
这样带来的好处是明显的，因为特别大的硬盘和特别快的cpu，总是意味着难以接受的价格。而且这样一个配置“特别的”节点计算机挂掉了，找个他的替身将是很困难的事情。
计算节点和存储节点统一的另一个好处是，任务在计算过程中产生的文件，可以直接放在本机的存储节点上，减少网络带宽占用和延迟。
在衡量hadoop的map和reduce的处理能力的时候通常都是以槽位为单位的。槽位就是集群内每个计算机的cpu并发数（cpu数*核心数*超线程数）的总和。每个任务都会安排在一个槽位内允许，安排不到槽位的任务则会等待。
# 2.   Hadoop应用实例：大规模数据的排序
Hadoop平台没有提供全局数据排序，而在大规模数据处理中进行数据的全局排序是非常普遍的需求。大量的将大规模数据任务切分成小数据规模的数据处理任务都必须先将大规模数据进行全局排序。例如处理两组大的数据集的属性合并，可以对两组数据进行全局排序然后分解成一系列小的二路归并问题实现。
# 2.1应用hadoop进行大规模数据全局排序的方法
使用hadoop进行大量的数据排序排序最直观的方法是把文件所有内容给map之后，map不做任何处理，直接输出给一个reduce，利用hadoop的自己的shuffle机制，对所有数据进行排序，而后由reduce直接输出。
然而这样的方法跟单机毫无差别，完全无法用到多机分布式计算的便利。因此这种方法是不行的。
利用hadoop分而治之的计算模型，可以参照快速排序的思想。在这里我们先简单回忆一下快速排序。快速排序基本步骤就是需要现在所有数据中选取一个作为支点。然后将大于这个支点的放在一边，小于这个支点的放在另一边。
设想如果我们有N个支点（这里可以称为标尺），就可以把所有的数据分成N+1个part，将这N+1个part丢给reduce，由hadoop自动排序，最后输出N+1个内部有序的文件，再把这N+1个文件首尾相连合并成一个文件，收工。
由此我们可以归纳出这样一个用hadoop对大量数据排序的步骤：
1）  对待排序数据进行抽样；
2）  对抽样数据进行排序，产生标尺；
3）  Map对输入的每条数据计算其处于哪两个标尺之间；将数据发给对应区间ID的reduce
4）  Reduce将获得数据直接输出。
这里使用对一组url进行排序来作为例子：
![](http://stblog.baidu-tech.com/wp-content/uploads/wp-display-data.php?filename=21304573769.jpg&type=image%2Fjpeg&width=480&height=274)
这里还有一点小问题要处理：如何将数据发给一个指定ID的reduce？hadoop提供了多种分区算法。这些算法根据map输出的数据的key来确定此数据应该发给哪个reduce（reduce的排序也依赖key）。因此，如果需要将数据发给某个reduce，只要在输出数据的同时，提供一个key（在上面这个例子中就是reduce的ID+url），数据就该去哪儿去哪儿了。
# 2.2注意事项
1)         标尺的抽取应该尽可能的均匀，这与快速排序很多变种算法均是强调支点的选取是一致的。
2)         HDFS是一种读写性能很不对称的文件系统。应该尽可能的利用其读性能很强的特点。减少对写文件和shuffle操作的依赖。举例来说，当需要根据数据的统计情况来决定对数据的处理的时候。将统计和数据处理分成两轮map-reduce比将统计信息合并和数据处理都放到一个reduce中要快速的多。
# 3.   总结
Hadoop实际是一种以数据为驱动的计算模型，结合MapReduce和HDFS，将任务运行在数据存放的计算节点上，充分利用了计算节点的存储和计算资源，同时也大大节省了网络传输数据的开销。
Hadoop提供了简便利用集群进行并行计算的平台。各种可以隔离数据集之间相关性的运算模型都能够在Hadoop上被良好应用。之后会有更多的利用Hadoop实现的大规模数据基础计算方法的介绍。
